<!-- ===========================================================
     === AIRPORT LIST (EUROPE) ‚Äî AVIATION CAPITAL SIMULATOR ===
     Qatar Luxury Ultra Premium Edition v4
     =========================================================== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Europe Airports - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">
  <link rel="manifest" href="manifest.json">

<style>
/* ============================================================
   === GLOBAL ACS QATAR LUXURY STYLE ===========================
   ============================================================ */

body {
  margin: 0;
  color: #fff;
  font-family: "Poppins", sans-serif;
  background-color: #081530;
}

/* ================= Qatar Luxury Header ================= */
.acs-header {
  position: fixed;
  top: 0;
  width: 100%;
  backdrop-filter: blur(9px);
  background: rgba(12,23,50,0.45);
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffb300;
  z-index: 5000;
}

.acs-logo {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.acs-logo img {
  height: 46px;
}

.acs-logo h1 {
  font-size: 1.15rem;
  margin: 0;
  color: #ffb300;
  letter-spacing: 0.5px;
}

.acs-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 2rem;
}

.acs-nav a {
  position: relative;
  font-size: 1rem;
  letter-letter-spacing: 0.4px;
  color: #dbe4ff; 
  text-decoration: none;
  transition: 0.25s ease;
  padding-bottom: 6px;
}

.acs-nav a:hover,
.acs-nav a.active {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.6);
}

.acs-nav a.active::after,
.acs-nav a:hover::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, #ffb300, #ffe7a0);
  border-radius: 2px;
  box-shadow: 0 0 8px rgba(255,200,60,0.45);
}

/* Logout */
.logout-btn {
  padding: 0.45rem 1.1rem;
  border: 1px solid #ffb300;
  border-radius: 12px;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
}

.logout-btn:hover {
  background: #ffb300;
  color: #0c1f3c;
}

/* Clock */
.acs-clock-header {
  font-family: "Orbitron", monospace;
  padding: 0.4rem 0.8rem;
  background: rgba(0,255,128,0.08);
  border-radius: 8px;
  font-size: 0.95rem;
  color: #00ff80;
}

/* ================= MAIN CONTENT ================= */
.acs-main {
  padding: 110px 2rem 70px;
  text-align: center;
}

.acs-main h2 {
  font-size: 2.1rem;
  font-weight: 600;
  color: #ffca3a;
  margin-top: 18px;
  margin-bottom: 6px;
  text-shadow:
    0 0 6px rgba(255,190,60,0.55),
    0 0 12px rgba(255,190,60,0.35);
}

.sub {
  text-align: center;
  color: #cbd6ff;
  opacity: 0.9;
  font-size: 1.05rem;
  margin-top: 10px;
  margin-bottom: 32px;
}

/* ===== Origin Banner ===== */
.origin-banner {
  margin-top: 12px;
  margin-bottom: 18px;
  font-size: 1.15rem;
  color: #ffca3a;
  font-weight: 600;
  letter-spacing: 0.3px;
  text-shadow: 0 0 8px rgba(255,190,60,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.45rem;
}

.origin-banner .label {
  color: #ffe7a0;
  font-weight: 700;
}

.origin-banner strong {
  color: #ffca3a;
  font-size: 1.2rem;
}

.origin-banner #originCity {
  color: #dbe4ff;
  opacity: 0.95;
  font-weight: 400;
  margin-left: 0.3rem;
}

.origin-banner .icon {
  font-size: 1.25rem;
  margin-right: 0.3rem;
}

/* ============================================================
   === QATAR LUXURY TABLE =====================================
   ============================================================ */

table {
  width: 95%;
  margin: 2rem auto 0 auto;
  border-collapse: collapse;
  background: rgba(14,27,70,0.65);
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 0 25px rgba(0,0,0,0.45);
  backdrop-filter: blur(6px);
}

thead {
  background: rgba(20,40,85,0.85);
  backdrop-filter: blur(6px);
}

th, td {
  padding: 14px 10px;
  text-align: center;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

td.col-action {
  text-align: center !important;   /* Botones se quedan centrados */
}
     
th {
  color: #ffb300;
  cursor: pointer;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.83rem;
}

tr:nth-child(even) {
  background: rgba(255,255,255,0.035);
}

tr:hover {
  background: rgba(255,179,0,0.12);
  transition: 0.15s ease;
  box-shadow: 0 0 14px rgba(255,179,0,0.35) inset;
}

/* Demand bar */
.demand-bar {
  width: 100%;
  height: 8px;
  border-radius: 6px;
  background: linear-gradient(
    to right,
    #1DB954 var(--eco),
    #FFB300 var(--eco) var(--biz),
    #FF6F00 var(--biz) 100%
  );
  box-shadow: 0 0 6px rgba(255,179,0,0.3);
  margin-top: 6px;
}

/* Buttons */
.acs-btn {
  background-color: #00a86b;
  color: #fff;
  border: none;
  padding: 7px 16px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: .25s;
}

.acs-btn:hover {
  background-color: #00794f;
  transform: scale(1.05);
}

.acs-btn-info {
  background: rgba(20,40,85,0.85);
  color: #ffb300;
  border: 1px solid #ffb300;
  padding: 7px 14px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: .25s;
}

.acs-btn-info:hover {
  background: #ffb300;
  color: #081530;
  transform: scale(1.05);
}

/* Back Button */
.back-btn {
  margin: 2.5rem auto;
  background: none;
  border: 1px solid #ffb300;
  color: #ffb300;
  padding: 10px 22px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
}

.back-btn:hover {
  background: #ffb300;
  color: #081530;
}

/* ============================================================
   === SLOT BAR (AGREGADO, COLUMNA 5) ==========================
   ============================================================ */

.slot-bar {
  width: 100%;
  height: 8px;
  border-radius: 6px;
  background: rgba(255,255,255,0.10);
  margin-top: 6px;
  overflow: hidden;
}

.slot-bar-fill {
  height: 100%;
  border-radius: 6px;
  transition: width .25s ease;
  box-shadow: 0 0 6px rgba(255,255,255,0.28);
}

/* ============================================================
   === COUNTRY SELECTOR ‚Äî ORIGINAL STYLE RESTORE ===============
   ============================================================ */

.country-select {
  background: linear-gradient(180deg, #2e3f6e, #1e2d55);
  color: #ffffff;
  border: 2px solid #ffb300;
  padding: 5px 28px 5px 12px;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  box-shadow: 0 0 12px rgba(255,179,0,0.25);
  background-image: url("data:image/svg+xml;utf8,<svg fill='%23ffffff' height='16' width='16' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 13px;
}

.country-filter {
  margin: 4px auto 26px auto;
  display: flex;
  justify-content: center;
}

.country-select {
  width: 160px;
}

/* ============================================================
   === CONTINENT BUTTONS ‚Äî ORIGINAL STYLE RESTORE ==============
   ============================================================ */

.continent-access {
  margin-top: 32px;
  margin-bottom: 38px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 18px;
}

.continent-btn {
  display: inline-block;
  text-decoration: none;
  padding: 8px 18px;
  font-size: 0.9rem;
  font-weight: 600;
  border-radius: 12px;
  border: 2px solid #ffb300;
  background: rgba(20,40,80,0.45);
  color: #ffe7a0;
  cursor: pointer;
  transition: 0.25s ease;
  box-shadow: 0 0 10px rgba(255,179,0,0.25);
}

.continent-btn:hover {
  background: #ffb300;
  color: #081530;
  transform: scale(1.07);
  box-shadow: 0 0 18px rgba(255,179,0,0.55);
}

/* ============================================================
   9Ô∏è‚É£ MODAL AIRPORT INFO & TOOLTIP ‚Äî FIX v1.1
   ============================================================ */

.acs-modal {
  position: fixed;
  inset: 0;
  display: none;                  /* Oculto por defecto */
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.55);
  z-index: 6000;
}

.acs-modal.is-open {
  display: flex;                  /* Se muestra cuando tiene esta clase */
}

.acs-modal-box {
  background: #0d1c3c;
  border-radius: 16px;
  padding: 20px 24px 18px 24px;
  max-width: 520px;
  width: 90%;
  border: 1px solid rgba(255,179,0,0.7);
  box-shadow: 0 0 28px rgba(0,0,0,0.85);
}

/* ============================================================
   ACS HYBRID OPS PANEL ‚Äî AIRBUS + QATAR EXECUTIVE
   Global ‚Äî Responsive ‚Äî Live
   ============================================================ */

.acs-ops-panel{

  background:
    linear-gradient(180deg,
      rgba(8,18,40,0.98),
      rgba(5,12,28,0.98)
    );

  border-radius:16px;

  padding:22px;

  border:1px solid rgba(255,179,0,0.35);

  box-shadow:
    0 0 40px rgba(0,0,0,0.9),
    inset 0 0 40px rgba(0,174,239,0.05);

}


/* section title */

.acs-section-title{

  color:#00AEEF;

  font-size:13px;

  letter-spacing:1.2px;

  margin-top:18px;

  margin-bottom:8px;

  font-weight:600;

}


/* separator */

.acs-separator{

  height:1px;

  background:linear-gradient(
    to right,
    transparent,
    rgba(255,179,0,0.4),
    transparent
  );

  margin:14px 0;

}


/* capacity bar */

.acs-capacity-bar{

  height:6px;

  border-radius:4px;

  background:#0a162f;

  overflow:hidden;

  margin-top:10px;

  border:1px solid rgba(255,255,255,0.06);

}

.acs-capacity-fill{

  height:100%;

  border-radius:4px;

  transition:width 0.6s ease;

  box-shadow:0 0 6px currentColor;

}


/* status chip */

.acs-status-chip{

  display:inline-block;

  padding:4px 10px;

  border-radius:20px;

  font-size:12px;

  font-weight:600;

  margin-top:6px;

}


/* responsive */

@media(max-width:600px){

  .acs-modal-box{

    width:95%;

    padding:14px;

  }

}

     
.acs-modal-box h3 {
  margin-top: 0;
  margin-bottom: 10px;
  color: #ffca3a;
  font-size: 1.25rem;
  text-align: left;
}

.acs-modal-close {
  margin-top: 16px;
  padding: 8px 16px;
  border-radius: 10px;
  border: 1px solid #ffb300;
  background: rgba(255,179,0,0.04);
  color: #ffb300;
  font-weight: 600;
  cursor: pointer;
  font-size: 0.9rem;
}

.acs-modal-close:hover {
  background: #ffb300;
  color: #081530;
}

/* ============================================================
   üü© ACS DEMAND WEEKLY BAR ‚Äî AIRBUS STYLE
   ============================================================ */

.acs-demand-row{
  margin-bottom:14px;
}

.acs-demand-day{
  font-size:13px;
  color:#7f8da3;
  margin-bottom:4px;
  letter-spacing:1px;
}

.acs-demand-bar{
  width:100%;
  height:14px;
  border-radius:6px;
  overflow:hidden;
  background:#0a162f;
  display:flex;
  box-shadow:0 0 10px rgba(0,0,0,0.6);
}

.acs-demand-segY{
  background:#00AEEF;
  box-shadow:0 0 6px rgba(0,174,239,0.7);
}

.acs-demand-segC{
  background:#FF8C00;
  box-shadow:0 0 6px rgba(255,140,0,0.7);
}

.acs-demand-segF{
  background:#FFD700;
  box-shadow:0 0 8px rgba(255,215,0,0.9);
}

.acs-demand-values{
  font-size:12px;
  margin-top:4px;
  color:#cbd6ff;
}

     
</style>

</head>
<body>

  <!-- HEADER -->
  <header class="acs-header">
    <div class="acs-logo">
      <img src="acs_logo.png" alt="ACS Logo" />
      <h1>Aviation Capital Simulator</h1>
    </div>

    <nav class="acs-nav">
      <a href="dashboard.html">Main</a>
      <a href="finance.html">Finance</a>
      <a href="aircraft.html">Aircraft</a>
      <a href="routes.html" class="active">Routes</a>
      <a href="hr.html">HR</a>
      <a href="forum.html">Forum</a>
      <a href="support.html">Support</a>
    </nav>

    <a href="#" class="logout-btn" onclick="handleLogout()">Logout</a>
    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 2025</div>
  </header>

  <!-- MAIN -->
  <main class="acs-main">
    <h2>üåç European Airports</h2>
    <p class="sub">Sort by demand, cost, or runway length. Click ‚ÄúCreate Route‚Äù to plan flights.</p>

    <div class="origin-banner">
      <span class="icon">üõ´</span>
      <span class="label">Base:</span>
      <span id="originFlag">üè≥Ô∏è</span>
      <strong id="originIcao">---</strong>
      <span id="originCity">‚Äî Loading...</span>
    </div>

    <!-- Country selector -->
    <div class="country-filter">
      <select id="countrySelect" class="country-select" onchange="filterByCountry()">
        <option value="ALL">üåç All Countries</option>
      </select>
    </div>

    <!-- ===== CONTINENT QUICK ACCESS (QATAR LUXURY) ===== -->
    <div class="continent-access">
     <a href="airport_list_africa.html" class="continent-btn">Africa</a>
     <a href="airport_list_asia.html" class="continent-btn">Asia</a>
     <a href="airport_list_northamerica.html" class="continent-btn">North America</a>
     <a href="airport_list_southamerica.html" class="continent-btn">South America</a>
     <a href="airport_list_oceania.html" class="continent-btn">Oceania</a>
     <a href="airport_list_middleeast.html" class="continent-btn">Middle East</a>
    </div>

    <!-- ============================================================
         üíé A1 ‚Äî ULTRA PREMIUM TABLE (HTML COMPLETO)
         ============================================================ -->

    <table id="airportTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Airport (ICAO)</th>
          <th onclick="sortTable(1)">Country</th>
          <th onclick="sortTable(2)">Distance (NM)</th>
          <th onclick="sortTable(3)">Demand (Y/C/F)</th>
          <th onclick="sortTable(4)">Slots</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody id="airportTableBody">
        <!-- Rows are injected dynamically by JS -->
      </tbody>
    </table>

    <button class="back-btn" onclick="window.location.href='routes.html'">‚¨Ö Back</button>
  </main>

  <footer>¬© 2026 Aviation Capital Simulator. All rights reserved.</footer>

  <!-- MODAL -->
  <div id="airportInfoModal" class="acs-modal">
    <div class="acs-modal-box">
      <h3 id="modalTitle">Airport Info</h3>
      <div id="modalContent">Loading...</div>
      <button class="acs-modal-close" onclick="closeAirportInfo()">Close</button>
    </div>
  </div>

<!-- ============================================================
     üü© ACS PASSENGER DEMAND MODAL ‚Äî WEEKLY DISTRIBUTION
     Airbus OCC + Qatar Executive Style
     ============================================================ -->
<div id="acsDemandModal" class="acs-modal">
  <div class="acs-modal-box" style="max-width:600px">

    <h3 id="acsDemandTitle">Passenger Demand</h3>

    <div id="acsDemandContent"></div>

    <button class="acs-modal-close"
            onclick="ACS_closeDemandModal()">Close</button>

  </div>
</div>
   
  <!-- SCRIPTS -->
     
<script>
  window.WorldAirportsACS = window.WorldAirportsACS || {};
</script>

<!-- 1) Base de datos del continente -->
<script src="engine/airports/world_airports_eu.js"></script>

<!-- ============================================================
     ‚è≥ ACS TIME ENGINE V12 ‚Äî 24/7 RECOVERY LAYER
     ============================================================ -->
<script src="acs_time_recovery.js"></script>
<script src="time_engine.js"></script>

<!-- üîµ B1 ‚Äî Historical Airport Cost Engine -->
<script src="engine/acs_airport_costs_engine.js?v=1.0"></script>

<!-- 3) üîµ Slot Engine (DEBE IR ANTES DE airports_loader.js) -->
<script src="engine/acs_slots_engine.js?v=2.0"></script>

<!-- 4) Loader de aeropuertos (usa slots, as√≠ que debe ir despu√©s) -->
<script src="engine/airports_loader.js?v=1.0"></script>

<!-- 5) Motor mundial (usa datos ya cargados) -->
<script src="engine/acs_world_engine.js?v=1.0"></script>

<script>
     
/* ============================================================
   üß≠ BASE RESOLVER ‚Äî GLOBAL (ACS STANDARD)
   ============================================================ */
     
function getACSBaseResolved() {

  // 1Ô∏è‚É£ Fuente oficial
  try {
    const user = JSON.parse(localStorage.getItem("ACS_activeUser") || "{}");
    if (user.base && user.base.icao) {
      return {
        icao: user.base.icao.toUpperCase(),
        city: user.base.city || "",
        country: user.base.country || "",
        name: user.base.name || ""
      };
    }
  } catch (e) {
    console.warn("ACS base parse error", e);
  }

  // 2Ô∏è‚É£ Legacy fallback (NO recursivo)
  const legacyICAO = localStorage.getItem("ACS_baseICAO");
  if (!legacyICAO) return null;

  return {
    icao: legacyICAO.toUpperCase(),
    city: localStorage.getItem("ACS_baseCity") || "",
    country: localStorage.getItem("ACS_baseCountry") || "",
    name: localStorage.getItem("ACS_baseName") || ""
  };
}
     
// ============================================================
// üß≠ ACS ‚Äî BASE AUTO-RESTORE (COMPAT MODE)
// ============================================================

(function restoreBaseOnce() {
  try {
    let activeUser = JSON.parse(localStorage.getItem("ACS_activeUser") || "{}");

    if (activeUser.base && activeUser.base.icao) return;

    // ESTE baseICAO ya exist√≠a antes del refactor
    if (typeof baseICAO === "string" && baseICAO.length === 4) {
      activeUser.base = {
        icao: baseICAO,
        city: baseCity || "",
        country: baseCountry || "",
        name: baseName || ""
      };

      localStorage.setItem("ACS_activeUser", JSON.stringify(activeUser));
      console.log("üß≠ ACS base restored from airport_list (compat)");
    }
  } catch (e) {
    console.warn("ACS base restore failed", e);
  }
})();
     
</script>
     
<script>

/* ============================================================
   === DISTANCE ENGINE =============================
   ============================================================ */
function distanceNM(lat1, lon1, lat2, lon2) {
  const R = 3440.065;
  const toRad = deg => deg * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) ** 2;

  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}


/* =============================================================
   === HISTORICAL AIRPORT ENGINE ‚Äî WITH SAFE FALLBACK ==========
   ============================================================= */
function getAirportsEuropeSafe() {
  try {
    if (window.ACS_World &&
        ACS_World.ready &&
        ACS_World.BY_CONTINENT &&
        Array.isArray(ACS_World.BY_CONTINENT["Europe"]) &&
        ACS_World.BY_CONTINENT["Europe"].length > 0) {

      console.log("üü¶ Using ACS_World (historical mode)");
      return ACS_World.BY_CONTINENT["Europe"];
    }
  } catch (err) {
    console.warn("ACS_World failed:", err);
  }

  console.log("üüß Fallback ‚Üí Using WorldAirportsACS (standard mode)");
  return WorldAirportsACS["Europe"] || [];
}

// ============================================================
// === BLOQUE 3 ‚Äî HISTORICAL DEMAND CURVE ======================
function getHistoricalFactor(year) {
  if (year < 1940) return 0.05;
  if (year < 1950) return 0.10;
  if (year < 1958) return 0.25;
  if (year < 1965) return 0.45;
  if (year < 1975) return 0.60;
  if (year < 1990) return 0.80;
  return 1.00;
}

// ============================================================
// === BLOQUE 4 ‚Äî HISTORICAL CLASS ENGINE ======================
function adjustPassengerClasses(demand) {
  const year =
    window.ACS_TIME &&
    window.ACS_TIME.currentTime instanceof Date
      ? window.ACS_TIME.currentTime.getFullYear()
      : 1940;

  let Y = demand.Y;
  let C = demand.C;
  let F = demand.F;

  const factor = getHistoricalFactor(year);
  Y = Math.round(Y * factor);
  C = Math.round(C * factor);
  F = Math.round(F * factor);

  if (year < 1955) {
    C = 0;
    F = 0;
  } else if (year < 1975) {
    F = 0;
  }

  return { Y, C, F };
}

/* ============================================================
   === GET SLOT HTML (bar + values) ‚Äî v1.0 ======================
   ============================================================ */
function ACS_buildSlotCell(icao, category) {

  const max = ACS_getMaxSlotsByCategory(category);  
  if (!max) return "‚Äî"; 

  let usedTotal = 0;
  let count = 0;

  const slots = JSON.parse(localStorage.getItem("ACS_SLOTS") || "{}")[icao];
  if (slots) {
    const days = Object.keys(slots);
    days.forEach(day => {
      const times = Object.keys(slots[day]);
      times.forEach(time => {
        usedTotal += slots[day][time].used || 0;
        count++;
      });
    });
  }

  const usedAvg = count > 0 ? Math.round(usedTotal / count) : 0;
  const free = Math.max(0, max - usedAvg);
  const pct = Math.max(0, Math.min(100, (free / max) * 100));

  let color = "#00FF80";
  if (pct < 50 && pct >= 20) color = "#FFB300";
  if (pct < 20) color = "#FF2E2E";

  return `
    ${free} / ${max}
    <div class="slot-bar">
      <div class="slot-bar-fill"
           style="width:${pct}%; background:${color};"></div>
    </div>
  `;
}

/* ============================================================
   === TABLE BUILDER ‚Äî ALL COUNTRIES (Balanced v2.0) ===========
   ============================================================ */
function loadAirports() {
  const tableBody = document.getElementById("airportTableBody");
  tableBody.innerHTML = "";

  const airports = getAirportsEuropeSafe();
  if (!airports || airports.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="5">No airports available.</td></tr>`;
    return;
  }

  const userBase = localStorage.getItem("ACS_baseICAO") || null;
  const base = airports.find(a => a.icao === userBase);
  let baseLat = null, baseLon = null;

  if (base) {
    baseLat = base.latitude;
    baseLon = base.longitude;
  }

  const ordered = airports
    .filter(a => a.icao !== userBase)
    .sort((a,b) => {
      const ad = a.demand.Y + a.demand.C + a.demand.F;
      const bd = b.demand.Y + b.demand.C + b.demand.F;
      return bd - ad;
    });

  /* Country filter clean build */
  const selector = document.getElementById("countrySelect");
  if (selector) {
    selector.innerHTML = `<option value="ALL">üåç All Countries</option>`;
    const uniqueCountries = [
      ...new Set(ordered.map(a => a.region).filter(c => c && c.trim() !== ""))
    ].sort();

    uniqueCountries.forEach(country => {
      const opt = document.createElement("option");
      opt.value = country;
      opt.textContent = country;
      selector.appendChild(opt);
    });
  }

  // Build rows
  ordered.forEach(a => {

    let dist = "-";
    if (baseLat !== null && baseLon !== null) {
      dist = distanceNM(baseLat, baseLon, a.latitude, a.longitude);
    }

    const d = adjustPassengerClasses(a.demand);
    const total = d.Y + d.C + d.F || 1;
    const ecoPct = (d.Y / total) * 100;
    const bizPct = ((d.Y + d.C) / total) * 100;

    const slotHTML = ACS_buildSlotCell(a.icao, a.category);

    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="col-airport"><strong>${a.city}</strong> (${a.icao})</td>
      <td class="col-country">${a.region}</td>
      <td class="col-distance">${dist} NM</td>
      <td class="col-demand"
      style="cursor:pointer"
      onclick="ACS_openDemandModal('${a.icao}')">
      ${d.Y}/${d.C}/${d.F}
      <div class="demand-bar"
       style="--eco:${ecoPct}%;
              --biz:${bizPct}%"></div>
      </td>
      <td class="col-slots">${slotHTML}</td>
      <td class="col-action" style="display:flex; gap:10px; justify-content:center;">
        <button class="acs-btn-info" onclick="openAirportInfo('${a.icao}')">Info</button>
        <button class="acs-btn" onclick="ACS_openRouteSchedule('${a.icao}')">Create Route</button>
      </td>
    `;
    tableBody.appendChild(row);
  });

  // Safari fix
  const table = document.getElementById("airportTable");
  table.style.visibility = "hidden";
  setTimeout(() => { table.style.visibility = "visible"; }, 50);
}

/* ============================================================
   === FILTER BY COUNTRY =======================================
   ============================================================ */
     
function filterByCountry() {
  const selected  = document.getElementById("countrySelect").value;
  const tableBody = document.getElementById("airportTableBody");
  tableBody.innerHTML = "";

  const airports = getAirportsEuropeSafe();
  if (!airports || airports.length === 0) return;

  const baseObj = getACSBaseResolved();
  const userBase = baseObj ? baseObj.icao : null;

  const base = airports.find(a => a.icao === userBase);

  let baseLat = null, baseLon = null;
  if (base) {
    baseLat = base.latitude;
    baseLon = base.longitude;
  }

  const filtered = airports
    .filter(a => a.icao !== userBase)
    .filter(a => selected === "ALL" || a.region === selected)
    .sort((a, b) => {
      const ad = a.demand.Y + a.demand.C + a.demand.F;
      const bd = b.demand.Y + b.demand.C + b.demand.F;
      return bd - ad;
    });

  if (filtered.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="6">No airports for this country.</td></tr>`;
    return;
  }

  filtered.forEach(a => {
    let dist = "-";
    if (baseLat !== null && baseLon !== null) {
      dist = distanceNM(baseLat, baseLon, a.latitude, a.longitude);
    }

    const d = adjustPassengerClasses(a.demand);
    const total = d.Y + d.C + d.F || 1;
    const ecoPct = (d.Y / total) * 100;
    const bizPct = ((d.Y + d.C) / total) * 100;
    const slotHTML = ACS_buildSlotCell(a.icao, a.category);

    const row = document.createElement("tr");
    row.innerHTML = `
      <td><strong>${a.city}</strong> (${a.icao})</td>
      <td>${a.region}</td>
      <td>${dist} NM</td>
      <td class="col-demand"
      style="cursor:pointer"
      onclick="ACS_openDemandModal('${a.icao}')">

      ${d.Y}/${d.C}/${d.F}

      <div class="demand-bar"
       style="--eco:${ecoPct}%;
              --biz:${bizPct}%"></div>

      </td>

      <td>${slotHTML}</td>
      <td style="display:flex; gap:8px; justify-content:center;">
        <button class="acs-btn-info" onclick="openAirportInfo('${a.icao}')">Info</button>
        <button class="acs-btn" onclick="ACS_openRouteSchedule('${a.icao}')">Create Route</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

/* =============================================================
   === SORT TABLE ==============================================
   ============================================================= */
function sortTable(n) {
  const table = document.getElementById("airportTable");
  let switching = true, dir = "asc", switchcount = 0;

  while (switching) {
    switching = false;
    const rows = table.rows;

    for (let i = 1; i < (rows.length - 1); i++) {
      let shouldSwitch = false;
      const x = rows[i].getElementsByTagName("TD")[n];
      const y = rows[i + 1].getElementsByTagName("TD")[n];
      const xVal = isNaN(parseFloat(x.textContent)) ? x.textContent.toLowerCase() : parseFloat(x.textContent);
      const yVal = isNaN(parseFloat(y.textContent)) ? y.textContent.toLowerCase() : parseFloat(y.textContent);

      if ((dir === "asc" && xVal > yVal) || (dir === "desc" && xVal < yVal)) {
        shouldSwitch = true;
        break;
      }
    }

    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      switchcount++;
    } else if (switchcount === 0 && dir === "asc") {
      dir = "desc";
      switching = true;
    }
  }
}

/* =============================================================
   === MODAL ====================================================
   ============================================================= */
function openAirportInfo(icao) {

  const airports = getAirportsEuropeSafe();
  const ap = airports.find(a => a.icao === icao);
  if (!ap) return;

  const modal   = document.getElementById("airportInfoModal");
  const title   = document.getElementById("modalTitle");
  const content = document.getElementById("modalContent");

  title.textContent = `${ap.city.toUpperCase()} ‚Äî ${ap.icao}`;

  // ===============================
  // LIVE TIME
  // ===============================
  let year = 1940;
  try {
    year = ACS_TIME.currentTime.getFullYear();
  } catch(e){}

  // ===============================
  // LIVE ECONOMICS
  // ===============================
  const econ = ACS_adjustAirportFees(ap, year);

  // ===============================
  // LIVE MARKET
  // ===============================
  const market = ACS_getAirportMarketCapacity(ap);

  const usedPct = Math.round(market.saturation * 100);

  let barColor = "#1ec97b";
  let status = "NORMAL";

  if(usedPct >= 90){
    barColor = "#ff3b30";
    status = "CAPACITY CONSTRAINED";
  }
  else if(usedPct >= 75){
    barColor = "#ff9800";
    status = "HIGH UTILIZATION";
  }
  else if(usedPct >= 50){
    barColor = "#FFC107";
    status = "MODERATE UTILIZATION";
  }

  // ===============================
  // ROLE
  // ===============================
  let role = "Regional Node";

  if(ap.category === "Primary Hub")
    role = "International Gateway";

  else if(ap.category === "Major Regional")
    role = "Regional Hub";

  // ===============================
  // BUILD PANEL
  // ===============================

  content.innerHTML = `

<div class="acs-ops-panel">

<div style="
font-size:12px;
color:#7f8da3;
letter-spacing:1px;
">

${ap.category.toUpperCase()} ¬∑ ${role.toUpperCase()}

</div>


<div class="acs-separator"></div>


<div class="acs-section-title">
INFRASTRUCTURE STATUS
</div>

<div>

Runway Length: ${ap.runway_m} m<br>
Aircraft Capability: ${ap.aircraft_limit}<br>
Field Elevation: ${ap.elevation_ft} ft<br>
Operating Window: ${ap.open_hrs}

</div>

<div style="margin-top:8px">

Throughput Capacity

<div style="
color:#00ff80;
font-weight:600;
font-size:16px;
">

${market.total.toLocaleString()} seats/day

</div>

</div>


<div class="acs-separator"></div>


<div class="acs-section-title">
PASSENGER MARKET STATUS
</div>


<div>

Total Market: ${market.total.toLocaleString()}<br>
In Operation: ${market.used.toLocaleString()}<br>
Available: ${market.available.toLocaleString()}

</div>


<div class="acs-capacity-bar">

<div class="acs-capacity-fill"

style="
width:${usedPct}%;
background:${barColor};
color:${barColor};
">

</div>

</div>


<div class="acs-status-chip"

style="
background:${barColor}22;
color:${barColor};
border:1px solid ${barColor};
">

${usedPct}% ¬∑ ${status}

</div>



<div class="acs-separator"></div>


<div class="acs-section-title">
ECONOMIC ENVIRONMENT
</div>


<div>

Slot Fee Index: $${econ.slot_cost.toLocaleString()}<br>
Landing Fee Index: $${econ.landing_fee.toLocaleString()}<br>
Fuel Index: $${econ.fuel_price}/gal<br>
Airport Charge: ${econ.ticket_fee}%

</div>


<div class="acs-separator"></div>


<div class="acs-section-title">
NETWORK STATUS
</div>


<div>

Network Role: ${role}<br>

Congestion Level:

<span style="
color:${barColor};
font-weight:600;
">

${status}

</span>

</div>


</div>
`;

  modal.style.display = "flex";

}

function closeAirportInfo() {
  document.getElementById("airportInfoModal").style.display = "none";
}

/* ============================================================
   üü¶ ACS CABIN DEMAND INSTRUMENT ‚Äî CENTERED QATAR STYLE
   Structural scale + centered layout
   Fully synchronized with table demand
   ============================================================ */

function ACS_openDemandModal(icao){

  const airports = getAirportsEuropeSafe();
  const ap = airports.find(a => a.icao === icao);
  if(!ap) return;

  const modal   = document.getElementById("acsDemandModal");
  const title   = document.getElementById("acsDemandTitle");
  const content = document.getElementById("acsDemandContent");

  // CENTERED TITLE
  title.innerHTML = `
    <div style="text-align:center;">
      PASSENGER DEMAND<br>
      <span style="font-size:14px; color:#ffb300;">
        ${ap.city.toUpperCase()} ‚Äî ${ap.icao}
      </span>
    </div>
  `;

  const demand = adjustPassengerClasses(ap.demand);

  const days = ["MON","TUE","WED","THU","FRI","SAT","SUN"];

  const distribution =
    [0.14,0.13,0.14,0.13,0.16,0.17,0.13];

  // STRUCTURAL LIMIT BY CATEGORY
  let structuralMax = 300;

  if(ap.category === "Primary Hub") structuralMax = 1200;
  else if(ap.category === "Major Regional") structuralMax = 700;
  else if(ap.category === "Regional") structuralMax = 350;
  else structuralMax = 180;

  let html = "";

  days.forEach((day, i)=>{

    const Y = Math.round(demand.Y * distribution[i]);
    const C = Math.round(demand.C * distribution[i]);
    const F = Math.round(demand.F * distribution[i]);

    const total = Y + C + F;
    const pct = Math.min(100, (total / structuralMax) * 100);

    html += `

      <div style="
        text-align:center;
        margin-bottom:26px;
      ">

        <!-- DAY -->
        <div style="
          font-family:Orbitron;
          font-size:14px;
          color:#ffffff;
          letter-spacing:3px;
          margin-bottom:6px;
        ">
          ${day}
        </div>


        <!-- STRUCTURAL SCALE -->
        <div style="
          width:280px;
          height:12px;
          margin:0 auto 6px auto;
          position:relative;
          background:rgba(255,255,255,0.05);
          border-radius:6px;
          border:1px solid rgba(255,179,0,0.25);
        ">

          <!-- SCALE MARKERS -->
          <!-- ECONOMY / BUSINESS DIVISION -->
<div style="
  position:absolute;
  left:33.33%;
  top:0;
  bottom:0;
  width:1px;
  background:rgba(255,179,0,0.45);
"></div>

<!-- BUSINESS / FIRST DIVISION -->
<div style="
  position:absolute;
  left:66.66%;
  top:0;
  bottom:0;
  width:1px;
  background:rgba(255,179,0,0.45);
"></div>

          <!-- DEMAND BAR -->
          <div style="
            width:${pct}%;
            height:100%;
            background:
              linear-gradient(
                90deg,
                #003a7a,
                #0066cc,
                #00AEEF,
                #33d6ff
              );
            border-radius:6px;
            box-shadow:
              0 0 10px rgba(0,174,239,0.6);
          ">
          </div>

        </div>


        <!-- VALUES BELOW BAR -->
        
     <div style="
  width:100%;
  max-width:260px;
  margin:4px auto 0 auto;
  text-align:center;
  font-family:Orbitron;
  font-size:12px;
  color:#ffb300;
  letter-spacing:2px;
">

  Y&nbsp;${Y}
  &nbsp;&nbsp;&nbsp;
  C&nbsp;${C}
  &nbsp;&nbsp;&nbsp;
  F&nbsp;${F}

</div>

      </div>
    `;
  });

  content.innerHTML = html;

  modal.style.display = "flex";
}


function ACS_closeDemandModal(){
  document.getElementById("acsDemandModal").style.display = "none";
}
     
window.addEventListener("click", (e) => {
  const modal = document.getElementById("airportInfoModal");
  if (e.target === modal) modal.style.display = "none";
});

/* =============================================================
   === LOGOUT ===================================================
   ============================================================= */
function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}

/* =============================================================
   === INITIALIZATION ==========================================
   ============================================================= */
document.addEventListener("DOMContentLoaded", () => {

  loadAirports();

  const baseIcao = localStorage.getItem("ACS_baseICAO") || null;
  if (baseIcao) {
    const airports = getAirportsEuropeSafe();
    const base = airports.find(a => a.icao === baseIcao);

    if (base) {
      const flagEmoji = base.country.replace(/./g, c =>
        String.fromCodePoint(c.charCodeAt(0) + 127397)
      );

      document.getElementById("originFlag").textContent = flagEmoji;
      document.getElementById("originIcao").textContent = base.icao;
      document.getElementById("originCity").textContent =
        `‚Äî ${base.city}, ${base.region}`;
    }
  }
});

/* ============================================================
   === SEND ORIGIN & DESTINATION TO SCHEDULE ===================
   ============================================================ */
function ACS_openRouteSchedule(destIcao) {

  let originIcao = null;

  try {
    if (typeof findBaseAirportGlobal === "function") {
      const base = findBaseAirportGlobal();
      if (base && base.icao) {
        originIcao = base.icao.toUpperCase();
      }
    }

    if (!originIcao) {
      const baseIcao = localStorage.getItem("ACS_baseICAO");
      if (baseIcao) originIcao = baseIcao.toUpperCase();
    }
  } catch (e) {
    console.warn("ACS_openRouteSchedule: cannot resolve base", e);
  }

  if (!originIcao) {
    alert("‚ö†Ô∏è No base selected. Please choose a base first.");
    return;
  }

  const dest = (destIcao || "").toUpperCase();
  if (!dest) {
    alert("‚ö†Ô∏è Destination not valid.");
    return;
  }

  localStorage.setItem("ACS_selectedOrigin", originIcao);
  localStorage.setItem("ACS_selectedDestination", dest);

  localStorage.removeItem("editFlightID");

  window.location.href = "route_schedule.html";
}
</script>

<script src="engine/acs_security_core.js?v=1"></script>
     
</body>
</html>
