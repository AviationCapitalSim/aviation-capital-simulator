<!-- ============================================================
     === SCHEDULE TABLE MODULE ‚Äî Qatar Luxury Edition ===========
     ------------------------------------------------------------
     Version: v1.0 | Date: 30 NOV 2025
     ============================================================ -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Schedule Table - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">

  <style>
/* ============================================================
     === ACS Qatar Luxury ‚Äî Shared Header Style ================
   ============================================================ */

body {
  margin: 0;
  background-color: #081530;
  color: white;
  font-family: "Poppins", sans-serif;
}

/* HEADER */
.acs-header {
  position: fixed;
  top: 0;
  width: 100%;
  backdrop-filter: blur(9px);
  background: rgba(12,23,50,0.45);
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffb300;
  z-index: 5000;
}

.acs-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.acs-left img {
  height: 46px;
}

.acs-left h1 {
  font-size: 1.15rem;
  margin: 0;
  color: #ffb300;
  letter-spacing: 0.5px;
}

.acs-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 2rem;
}

/* NAV LINKS */
.acs-nav a {
  position: relative;
  font-size: 1rem;
  letter-spacing: 0.4px;
  color: #dbe4ff;
  text-decoration: none;
  transition: 0.25s ease;
  padding-bottom: 6px;
}

.acs-nav a:hover,
.acs-nav a.active {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.6);
}

.acs-nav a.active::after,
.acs-nav a:hover::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, #ffb300, #ffe7a0);
  border-radius: 2px;
  box-shadow: 0 0 8px rgba(255,200,60,0.45);
}

.acs-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.support-btn {
  padding: 0.45rem 1.1rem;
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  color: #8AB4FF;
  border: 1px solid rgba(138,180,255,0.45);
  background: rgba(138,180,255,0.08);
  backdrop-filter: blur(6px);
  transition: 0.25s ease;
}

.support-btn:hover {
  background: rgba(138,180,255,0.20);
  box-shadow: 0 0 14px rgba(138,180,255,0.55);
  color: #dfe9ff;
}

.logout-btn {
  padding: 0.45rem 1.1rem;
  border: 1px solid #ffb300;
  border-radius: 12px;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
}

.logout-btn:hover {
  background: #ffb300;
  color: #0c1f3c;
}

/* CLOCK */
.acs-clock-header {
  font-family: "Orbitron", monospace;
  padding: 0.4rem 0.8rem;
  background: rgba(0,255,128,0.08);
  border-radius: 8px;
  font-size: 0.95rem;
  color: #00ff80;
}

/* MAIN */
.acs-main {
  padding: 110px 2rem 70px;
  text-align: center;
}

.sub {
  margin-top: -0.4rem;
  color: #cbd6ff;
  font-size: 1rem;
}

/* ============================================================
     === TABLE ‚Äî Qatar Luxury Panel ============================
   ============================================================ */

table {
  width: 90%;
  margin: 0 auto;
  border-collapse: collapse;
  background: linear-gradient(180deg, rgba(20,35,70,0.75), rgba(10,18,40,0.85));
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 0 20px rgba(255,179,0,0.1);
  border: 1px solid rgba(255,179,0,0.15);
}

th {
  background: rgba(255,179,0,0.15);
  color: #ffca3a;
  padding: 1rem;
  font-size: 1rem;
  text-shadow: 0 0 6px rgba(255,200,80,0.4);
}

td {
  background: rgba(10,20,45,0.8);
  border: 1px solid rgba(255,255,255,0.05);
  padding: 0.8rem;
  color: #dbe4ff;
  text-align: center;
  font-size: 0.92rem;
}

/* CHIPS */
.chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: #0c2b52;
  padding: 5px 10px;
  margin: 2px 0;
  border-radius: 8px;
  color: #ffca3a;
  font-weight: 700;
  font-size: 0.85rem;
  box-shadow: 0 0 8px rgba(255,200,60,0.25);
  cursor: pointer;
}

/* Tooltip */
.chip .tooltip {
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  padding: 6px 10px;
  background: #ffca3a;
  color: #0c1f3c;
  border-radius: 6px;
  display: none;
  font-size: 0.75rem;
  white-space: nowrap;
  font-weight: 700;
}

.chip:hover .tooltip {
  display: block;
}

/* BUTTONS */
.btn {
  border-radius: 14px;
  padding: 7px 12px;
  font-weight: 600;
  cursor: pointer;
  border: none;
}

.btn-assign {
  background: #00a86b;
  color: #fff;
}

.btn-assign:hover {
  background: #00945f;
}

.btn-maint {
  background: #ffb300;
  color: #0d1b34;
}

.btn-maint:hover {
  background: #e6a100;
}

.back-btn {
  margin-top: 2rem;
  padding: 0.6rem 1.6rem;
  border-radius: 10px;
  border: 1px solid #ffb300;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  cursor: pointer;
  font-weight: 600;
}

.back-btn:hover {
  background: #ffb300;
  color: #0c1f3c;
}

/* FOOTER */
footer {
  text-align: center;
  color: #7c8bb8;
  padding: 2rem 0;
  margin-top: 2rem;
}

/* === AIRCRAFT HOVER CARD ‚Äî Qatar Luxury === */
       
.aircraft-hover-card {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -115%);
  background: rgba(14, 27, 60, 0.95);
  padding: 1rem 1.2rem;
  border-radius: 14px;
  border: 1px solid #ffb300;
  box-shadow: 0 4px 24px rgba(0,0,0,0.45);
  color: #ffe9b3;
  z-index: 9999;
  width: 260px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.20s ease-in-out;
}

.aircraft-hover-card.visible {
  opacity: 1;
}

.aircraft-hover-card h4 {
  margin: 0 0 0.4rem 0;
  font-size: 1rem;
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.5);
}

.progress-bar {
  width: 100%;
  height: 10px;
  background: rgba(255,255,255,0.15);
  border-radius: 6px;
  margin-top: 0.5rem;
  overflow: hidden;
  border: 1px solid rgba(255,200,60,0.35);
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #ffb300, #ffdd80);
  width: 0%;
  transition: width 0.5s ease;
}

.progress-label {
  display: block;
  text-align: right;
  font-size: 0.8rem;
  margin-top: 4px;
  color: #ffdd80;
}
/* ============================================================
   === MODAL BASE STYLES (REQUIRED) ============================
   ============================================================ */

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(5, 10, 25, 0.65);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 6000;
}

.modal-content {
  background: #0d1b34;
  border: 1px solid rgba(255,179,0,0.35);
  padding: 1.5rem;
  border-radius: 16px;
  box-shadow: 0 0 18px rgba(255,179,0,0.25);
  color: #dbe4ff;
  width: 300px;
  text-align: center;
}

</style>
</head>

<body>

<!-- ============================================================
     === HEADER QATAR LUXURY (ID√âNTICO A DASHBOARD) =============
     ============================================================ -->
<header class="acs-header">

  <div class="acs-left">
    <img src="acs_logo.png" alt="ACS Logo">
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="finance.html">Bank</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html" class="active">Routes</a>
    <a href="hr.html">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
    <div id="acs-clock" class="acs-clock-header">00:00 ‚Äî 01 JAN 1940</div>
  </div>

</header>

<!-- ============================================================
     === MAIN CONTENT ===========================================
     ============================================================ -->
<main class="acs-main">

  <h2 style="
  font-size:1.9rem;
  font-weight:700;
  color:#ffca3a;
  text-shadow:0 0 10px rgba(255,200,60,0.55);
  letter-spacing:0.4px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
">
  üìÖ Weekly Flight Schedule
</h2>

<p class="sub" style="font-size:1rem; color:#cbd6ff;">
  Automatic schedule monitor with real-time route integration.
</p>

  <table id="scheduleTable">
    <thead>
      <tr>
        <th>Aircraft</th>
        <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>
        <th>Plan</th>
      </tr>
    </thead>
    <tbody id="scheduleBody"></tbody>
  </table>

  <div class="summary">
    <p id="updateTime">Last update: --</p>
  </div>

  <button class="back-btn" onclick="window.location.href='routes.html'">‚¨Ö Back to Routes</button>

</main>
<!-- ============================================================
     === MODAL: ACTION MENU =====================================
     ============================================================ -->
<div id="actionModal" class="modal">
  <div class="modal-content">
    <h3>Manage Flight</h3>
    <button onclick="removeItem()">üóë Remove</button>
    <button style="background:#e53935;" onclick="closeActionModal()">‚ùå Cancel</button>
    <button style="background:#ff9800;" onclick="deleteFlight()">üöÆ Delete</button>
    <button style="background:#1E88E5;" onclick="editFlight()">‚úèÔ∏è Edit</button>
  </div>
</div>

<!-- ============================================================
     === MODAL: MAINTENANCE =====================================
     ============================================================ -->
<div id="maintModal" class="modal">
  <div class="modal-content">
    <h3>Plan Maintenance</h3>

    <label>Type</label>
    <select id="maintType" style="width:100%;padding:8px;border-radius:6px;border:none;background:#12224c;color:#fff;">
      <option value="A">A-Check (5 h)</option>
      <option value="B">B-Check (24 h)</option>
    </select>

    <label style="margin-top:10px;">Day</label>
    <select id="maintDay" style="width:100%;padding:8px;border-radius:6px;border:none;background:#12224c;color:#fff;">
      <option value="mon">Mon</option><option value="tue">Tue</option><option value="wed">Wed</option>
      <option value="thu">Thu</option><option value="fri">Fri</option><option value="sat">Sat</option><option value="sun">Sun</option>
    </select>

    <label style="margin-top:10px;">Start Time</label>
    <input type="time" id="maintStart" value="06:00" style="width:100%;padding:8px;border-radius:6px;border:none;background:#12224c;color:#fff;">

    <button onclick="applyMaintenance()">Apply</button>
    <button onclick="closeMaintModal()">‚ùå Cancel</button>
  </div>
</div>

<footer>¬© 2025 Aviation Capital Simulator. All rights reserved.</footer>

<!-- ============================================================
     === üî• AQU√ç VA *TODO* TU JS ORIGINAL (SIN TOCAR NADA) =====
     ============================================================ -->

<script>
     
    const days = ["mon","tue","wed","thu","fri","sat","sun"];
    const STORE_KEY = "scheduleItems";
    const ROUTE_KEY  = "confirmedRoute";
    
    // === AJUSTE 1: Schedule usa SOLO la flota real ===
    function getRealFleet() {
      return JSON.parse(localStorage.getItem("ACS_MyFleet") || "[]");
    }

    const TURNAROUND_MIN = 45;

    const toMin = hhmm => { const [h,m]=hhmm.split(":").map(Number); return h*60+m; };
    const toHHMM = min => { const h=Math.floor(min/60)%24, m=min%60; return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`; };

    const getItems = () => JSON.parse(localStorage.getItem(STORE_KEY) || "[]");
    const setItems = list => localStorage.setItem(STORE_KEY, JSON.stringify(list));
    const getRoute = () => { const r=localStorage.getItem(ROUTE_KEY); return r?JSON.parse(r):null; };

    // === El sistema viejo de fleet queda neutralizado pero sin romper nada ===
    const getFleet = () => getRealFleet();
    const setFleet = f => localStorage.setItem("ACS_MyFleet", JSON.stringify(f));

    (function initFleet(){
      if(!getRealFleet().length) {
        setFleet([]); 
      }
    })();

    /* ============================================================
       === AJUSTE 2: HOVER MODAL (C / D / Pending / B) ============
       ============================================================ */

function showAircraftHover(ac, cell) {
  const old = document.querySelector(".aircraft-hover-card");
  if (old) old.remove();

  const st = ac.status || "";
  if (
    st !== "In C-Check" &&
    st !== "In D-Check" &&
    st !== "Pending Delivery" &&
    st !== "B-Check"
  ) {
    return;
  }

  const card = document.createElement("div");
  card.className = "aircraft-hover-card";

  const start = ac.lastC || ac.lastD || ac.deliveryStart || null;
  const end   = ac.deliveryDate || null;

  const label =
    st === "In C-Check"        ? "C-Check üõ†" :
    st === "In D-Check"        ? "D-Check ‚öôÔ∏è" :
    st === "Pending Delivery"  ? "Pending Delivery ‚è≥" :
    st === "B-Check"           ? "B-Check üîß" :
                                 st;

  let pct = 0;
  if (start && end) {
    const now    = getSimTime();
    const s      = new Date(start);
    const e      = new Date(end);
    pct = Math.min(100, Math.max(0, (passed = now - s, passed / (e - s)) * 100));
  }

  card.innerHTML = `
    <h4>${ac.registration} ‚Äî ${label}</h4>
    <p>Started: ${start ? new Date(start).toDateString() : "‚Äî"}</p>
    <p>Ends:    ${end ? new Date(end).toDateString() : "‚Äî"}</p>

    <div class="progress-bar">
      <div class="progress-fill" style="width:${pct.toFixed(0)}%"></div>
    </div>
    <span class="progress-label">${pct.toFixed(0)}%</span>
  `;

  cell.style.position = "relative";
  cell.appendChild(card);

  setTimeout(() => card.classList.add("visible"), 10);
}

function hideAircraftHover() {
  const card = document.querySelector(".aircraft-hover-card");
  if (card) card.remove();
}

    /* ============================================================
       === RENDER PRINCIPAL DEL SCHEDULE =========================
       ============================================================ */

    function renderSchedule(){
      const tbody = document.getElementById("scheduleBody");
      tbody.innerHTML = "";

      const items = getItems();
      const fleet = getRealFleet();  // === AJUSTE 3: usar flota real ===
      const byTail = {};

      items.forEach(it => {
        if(!byTail[it.tail]) byTail[it.tail] = [];
        byTail[it.tail].push(it);
      });

      fleet.forEach(ac=>{
        const tr = document.createElement("tr");

        /* ============================================================
           === AJUSTE 4: Columna Aircraft con matr√≠cula + status ======
           ============================================================ */

        const tdTail = document.createElement("td");

        tdTail.innerHTML = `
          ${ac.registration || ac.tail}
          <br>
          ${ac.status === "In C-Check" ? `${ac.registration} ‚Ä¢ üõ† C-Check` : ""}
          ${ac.status === "In D-Check" ? `${ac.registration} ‚Ä¢ ‚öôÔ∏è D-Check` : ""}
          ${ac.status === "Pending Delivery" ? `${ac.registration} ‚Ä¢ ‚è≥ Delivery` : ""}
          ${ac.status === "B-Check" ? `${ac.registration} ‚Ä¢ üîß B-Check` : ""}
        `;

        tdTail.onmouseenter = () => showAircraftHover(ac, tdTail);
        tdTail.onmouseleave = hideAircraftHover;

        tr.appendChild(tdTail);

        /* ============================================================
           === D√çAS DEL SCHEDULE (NO SE EDIT√ì NADA AQU√ç) ===============
           ============================================================ */

        days.forEach(d=>{
          const td = document.createElement("td");
          const dayItems = (byTail[ac.tail]||[]).filter(x=>x.day===d);
          let lastEnd = null;
          let hadFlight = false;

          dayItems.forEach(it=>{
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.dataset.id = it.id;
            chip.dataset.blockId = it.blockId || "";
            chip.dataset.type = it.type;

            if(it.type==="flight"){
              hadFlight = true;
              const iata = localStorage.getItem("userIATA") || "XX";

              let numOut = it.flightNumberOut ?? it.flightOut ?? 100;
              let numIn  = it.flightNumberIn  ?? it.flightIn  ?? (Number(numOut) + 1);

              if (String(numOut).startsWith(iata)) numOut = String(numOut).replace(iata, "");
              if (String(numIn).startsWith(iata)) numIn = String(numIn).replace(iata, "");

              const flightOut = `${iata}${String(numOut)}`;
              const flightIn  = `${iata}${String(numIn)}`;

              chip.textContent = `‚úàÔ∏è ${flightOut} / ${flightIn}`;

              const tooltip = document.createElement("span");
              tooltip.className = "tooltip";
              tooltip.innerHTML = `${it.departure}‚Äì${it.arrival}<br>${it.origin}-${it.destination}`;
              chip.appendChild(tooltip);

              const arrMin = toMin(it.arrival);
              lastEnd = lastEnd===null ? arrMin : Math.max(lastEnd, arrMin);
            } 
            else if(it.type==="service") {

              const label = it.serviceType==="A" ? "üü° A-Check" : "‚öôÔ∏è B-Check";
              chip.textContent = label;

              const tooltip = document.createElement("span");
              tooltip.className = "tooltip";
              tooltip.innerHTML = `${it.start || "?"} ‚Äì ${it.end || "?"}`;
              chip.appendChild(tooltip);
            }

            chip.onclick = ()=>openActionModal(chip);
            td.appendChild(chip);
          });

          const maintToday = dayItems.find(x => x.type === "service");

          if (maintToday) {
            if (maintToday.serviceType === "A") {
              const maintEnd = toMin(maintToday.end);
              lastEnd = (lastEnd ?? maintEnd) < maintEnd ? maintEnd : lastEnd;
            }

            if (maintToday.serviceType === "B") {
              const nextInfo = document.createElement("div");
              nextInfo.className = "next-slot";
              nextInfo.textContent = "Next Flight: N/A (B-Check Day)";
              td.appendChild(nextInfo);
              tr.appendChild(td);
              return;
            }
          }

          if(hadFlight){
            const nextInfo = document.createElement("div");
            nextInfo.className = "next-slot";
            const next = toHHMM((lastEnd ?? 0) + TURNAROUND_MIN);
            nextInfo.textContent = `Next Flight: ${next}`;
            td.appendChild(nextInfo);
          }

          tr.appendChild(td);
        });

        /* ============================================================
           === BOTONES PLAN ROUTE / MAINTENANCE ======================
           ============================================================ */

        const planTd = document.createElement("td");
        const wrap = document.createElement("div"); 
        wrap.className="plan-actions";

        const assignBtn = document.createElement("button");
        assignBtn.className = "btn btn-assign";
        assignBtn.textContent = "Assign Route";

        assignBtn.onclick = ()=>assignRouteToTail(ac);

        const maintBtn = document.createElement("button");
        maintBtn.className = "btn btn-maint";
        maintBtn.textContent = "Plan Maintenance";
        maintBtn.onclick = ()=>openMaintModal(ac.tail);

        wrap.appendChild(assignBtn); 
        wrap.appendChild(maintBtn);
        planTd.appendChild(wrap);
        tr.appendChild(planTd);
        tbody.appendChild(tr);
      });

      document.getElementById("updateTime").textContent = 
        "Last update: " + new Date().toLocaleTimeString();
    }

    /* ============================================================
       === RESTO DEL SCRIPT (NO ALTERADO) =========================
       ============================================================ */

    function assignRouteToTail(ac){
      const route = getRoute();
      if(!route){ alert("No confirmed route available."); return; }
      if(route.aircraft !== ac.type){ alert(`‚ö† Route is for ${route.aircraft}, but tail ${ac.tail} is ${ac.type}.`); return; }

      const items = getItems();
      const daysSel = Array.isArray(route.days) && route.days.length ? route.days : ["mon"];
      const separate = !!route.separateDays;
      const dep = route.departure || "06:00";
      const dur = Number(route.blockTimeMin || 210);
      const arr = toHHMM(toMin(dep) + dur);

      const flightOut = route.flightNumberOut || Math.floor(100 + Math.random() * 800);
      const flightIn  = route.flightNumberIn  || flightOut + 1;

      const allFlights = getItems().filter(f => f.type === "flight");
      const isDuplicate = allFlights.some(f =>
        f.flightNumberOut === flightOut || f.flightNumberIn === flightIn
      );

      const deletedFlights = JSON.parse(localStorage.getItem("deletedFlights") || "[]");

      if (deletedFlights.includes(flightOut) || deletedFlights.includes(flightIn)) {
        alert(`‚õî Flight ${flightOut}/${flightIn} was previously deleted and cannot be reused.`);
        return;
      }

      if (isDuplicate) {
        alert(`‚ö†Ô∏è Flight number ${flightOut}/${flightIn} already assigned to another aircraft.`);
        return;
      }

      const hasConflict = (day)=>{
        const dayItems = items.filter(x=>x.tail===ac.tail && x.day===day && x.type==="flight");
        const newStart = toMin(dep);
        const newEnd = newStart + dur;
        for(const f of dayItems){
          const s = toMin(f.departure);
          const e = toMin(f.arrival);
          if(s === newStart) return true;
          if(!(newEnd + TURNAROUND_MIN <= s || e + TURNAROUND_MIN <= newStart)) return true;
        }
        return false;
      };

      const blockId = separate ? null : ("block-"+Math.random().toString(36).slice(2,8));
      let assignedAny = false;

      daysSel.forEach(day=>{
        if(hasConflict(day)) return;
        const flight = {
          id: separate ? ("flt-"+Math.random().toString(36).slice(2,8)) : blockId,
          blockId: separate ? "" : blockId,
          type:"flight",
          tail: ac.tail,
          acType: ac.type,
          day,
          origin: route.origin,
          destination: route.destination,
          departure: dep,
          arrival: arr,
          flightNumberOut: flightOut,
          flightNumberIn: flightIn
        };
        items.push(flight);
        assignedAny = true;
      });

      if(!assignedAny){
        alert("‚ö† Cannot assign: schedule conflicts on selected days.");
        return;
      }

      setItems(items);
      renderSchedule();
    }

    let maintTail=null;
    function openMaintModal(tail){
      maintTail=tail; 
      document.getElementById("maintModal").style.display="flex";
    }
    function closeMaintModal(){
      maintTail=null; 
      document.getElementById("maintModal").style.display="none";
    }

    function applyMaintenance(){
      if(!maintTail){ closeMaintModal(); return; }

      const t = document.getElementById("maintType").value;
      const d = document.getElementById("maintDay").value;
      const start = document.getElementById("maintStart").value || "06:00";
      const dur = t === "A" ? 300 : 1440;
      const end = toHHMM(toMin(start) + dur);

      const items = getItems();
      const fleet = getRealFleet();

      const ac = fleet.find(x => x.registration === maintTail || x.tail === maintTail);

      items.push({
        id:"svc-"+Math.random().toString(36).slice(2,8),
        type:"service",
        serviceType:t,
        tail:maintTail,
        acType:ac?.type || "",
        day:d,
        start:start,
        end:end
      });

      setItems(items);
      closeMaintModal();
      renderSchedule();
    }

    let selectedChip=null;
    function openActionModal(chip){
      selectedChip = chip;
      const modal = document.getElementById("actionModal");
      const buttons = modal.querySelectorAll("button");

      const type = chip.dataset.type;
      buttons.forEach(btn => btn.style.display = "inline-block");

      if (type === "service") {
        buttons.forEach(btn => {
          if (btn.textContent.includes("Delete") || btn.textContent.includes("Edit")) {
            btn.style.display = "none";
          }
        });
      }

      modal.style.display = "flex";
    }

    function closeActionModal(){
      selectedChip=null;
      document.getElementById("actionModal").style.display="none";
    }

    function removeItem(){
      if(!selectedChip){ closeActionModal(); return; }
      const id = selectedChip.dataset.id;
      const block = selectedChip.dataset.blockId || "";
      const type = selectedChip.dataset.type;

      const items=getItems();
      let filtered;

      if(type==="flight" && block){
        filtered = items.filter(x=>x.blockId!==block);
      } else {
        filtered = items.filter(x=>x.id!==id);
      }

      setItems(filtered);
      closeActionModal();
      renderSchedule();
    }

    function deleteFlight(){
      if(!selectedChip){ closeActionModal(); return; }

      const id = selectedChip.dataset.id;
      const block = selectedChip.dataset.blockId || "";
      let items = getItems();
      let usedFlights = JSON.parse(localStorage.getItem("flightNumbers") || "[]");
      let deletedFlights = JSON.parse(localStorage.getItem("deletedFlights") || "[]");

      const flight = items.find(f => f.id === id || f.blockId === block);
      if (!flight) { 
        alert("‚ö†Ô∏è Flight not found or already deleted."); 
        closeActionModal(); 
        return; 
      }

      if (flight.flightNumberOut) {
        deletedFlights.push(flight.flightNumberOut, flight.flightNumberIn);
        localStorage.setItem("deletedFlights", JSON.stringify(deletedFlights));
      }

      const isBlock = !!block && block.startsWith("block-");
      const updatedItems = isBlock ? 
        items.filter(f => f.blockId !== block) : 
        items.filter(f => f.id !== id);

      setItems(updatedItems);

      if (flight.flightNumberOut && flight.flightNumberIn) {
        usedFlights = usedFlights.filter(n => 
          n !== flight.flightNumberOut && n !== flight.flightNumberIn
        );
        localStorage.setItem("flightNumbers", JSON.stringify(usedFlights));
      }

      closeActionModal();
      renderSchedule();
      alert(`‚ùå Flight ${flight.flightNumberOut || ""} deleted permanently (block cleared).`);
    }

    function editFlight(){
      if(!selectedChip){ closeActionModal(); return; }
      localStorage.setItem("editFlightID", selectedChip.dataset.id);
      closeActionModal();
      window.location.href = "route_schedule.html";
    }

    function handleLogout(){
      alert("üëã Session closed. See you soon, Captain!");
      window.location.href="login.html";
    }

    window.addEventListener("load", renderSchedule);

</script>

</body>
</html>
