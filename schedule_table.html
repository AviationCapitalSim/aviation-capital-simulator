<!-- ============================================================
     === SCHEDULE TABLE MODULE ‚Äî Qatar Luxury Edition ===========
     ------------------------------------------------------------
     Version: FINAL v1.5 | Date: 27 NOV 2025
     ============================================================ -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Schedule Table - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">

  <style>
/* ============================================================
   === GLOBAL PAGE STYLE =======================================
   ============================================================ */
body {
  margin: 0;
  background-color: #081530;
  color: white;
  font-family: "Poppins", sans-serif;
}

/* ============================================================
   === QATAR LUXURY HEADER =====================================
   ============================================================ */
.acs-header {
  position: fixed;
  top: 0;
  width: 100%;
  backdrop-filter: blur(9px);
  background: rgba(12,23,50,0.45);
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffb300;
  z-index: 5000;
}

.acs-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.acs-left img {
  height: 46px;
}

.acs-left h1 {
  font-size: 1.15rem;
  margin: 0;
  color: #ffb300;
  letter-spacing: 0.5px;
}

.acs-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 2rem;
}

.acs-nav a {
  position: relative;
  font-size: 1rem;
  letter-spacing: 0.4px;
  color: #dbe4ff;
  text-decoration: none;
  transition: 0.25s ease;
  padding-bottom: 6px;
}

.acs-nav a:hover,
.acs-nav a.active {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.6);
}

.acs-nav a.active::after,
.acs-nav a:hover::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, #ffb300, #ffe7a0);
  border-radius: 2px;
  box-shadow: 0 0 8px rgba(255,200,60,0.45);
}

.acs-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.support-btn {
  padding: 0.45rem 1.1rem;
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  color: #8AB4FF;
  border: 1px solid rgba(138,180,255,0.45);
  background: rgba(138,180,255,0.08);
}

.logout-btn {
  padding: 0.45rem 1.1rem;
  border: 1px solid #ffb300;
  border-radius: 12px;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  font-weight: 600;
  cursor: pointer;
}

.acs-clock-header {
  font-family: "Orbitron", monospace;
  padding: 0.4rem 0.8rem;
  background: rgba(0,255,128,0.08);
  border-radius: 8px;
  font-size: 0.95rem;
  color: #00ff80;
}

/* ============================================================
   === MAIN ====================================================
   ============================================================ */
.acs-main {
  padding: 110px 2rem 70px;
  text-align: center;
}

.sub {
  margin-top: -0.4rem;
  color: #cbd6ff;
  font-size: 1rem;
}
/* ============================================================
   === SCHEDULE TABLE (Qatar Luxury) ===========================
   ============================================================ */

table {
  width: 90%;
  margin: 0 auto;
  border-collapse: collapse;
  background: linear-gradient(180deg, rgba(20,35,70,0.75), rgba(10,18,40,0.85));
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 0 20px rgba(255,179,0,0.1);
  border: 1px solid rgba(255,179,0,0.15);
}

th {
  background: rgba(255,179,0,0.15);
  color: #ffca3a;
  padding: 1rem;
  font-size: 1rem;
  text-shadow: 0 0 6px rgba(255,200,80,0.4);
}

td {
  background: rgba(10,20,45,0.8);
  border: 1px solid rgba(255,255,255,0.05);
  padding: 0.8rem;
  color: #dbe4ff;
  text-align: center;
  font-size: 0.92rem;
}

/* ============================================================
   === FLIGHT CHIPS ============================================
   ============================================================ */

.chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: #0c2b52;
  padding: 5px 10px;
  margin: 2px 0;
  border-radius: 8px;
  color: #ffca3a;
  font-weight: 700;
  font-size: 0.85rem;
  box-shadow: 0 0 8px rgba(255,200,60,0.25);
  cursor: pointer;
  position: relative;
}

/* Tooltip */
.chip .tooltip {
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  padding: 6px 10px;
  background: #ffca3a;
  color: #0c1f3c;
  border-radius: 6px;
  display: none;
  font-size: 0.75rem;
  white-space: nowrap;
  font-weight: 700;
  z-index: 99999;
}

.chip:hover .tooltip {
  display: block;
}

/* ============================================================
   === BUTTONS =================================================
   ============================================================ */

.btn {
  border-radius: 14px;
  padding: 7px 12px;
  font-weight: 600;
  cursor: pointer;
  border: none;
}

.btn-assign {
  background: #00a86b;
  color: #fff;
}

.btn-assign:hover {
  background: #00945f;
}

.btn-maint {
  background: #ffb300;
  color: #0d1b34;
}

.btn-maint:hover {
  background: #e6a100;
}

.back-btn {
  margin-top: 2rem;
  padding: 0.6rem 1.6rem;
  border-radius: 10px;
  border: 1px solid #ffb300;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  cursor: pointer;
  font-weight: 600;
}

.back-btn:hover {
  background: #ffb300;
  color: #0c1f3c;
}

/* ============================================================
   === FOOTER ================================================
   ============================================================ */

footer {
  text-align: center;
  color: #7c8bb8;
  padding: 2rem 0;
  margin-top: 2rem;
}

/* ============================================================
   === AIRCRAFT HOVER CARD ‚Äî Qatar Luxury ======================
   ============================================================ */

.aircraft-hover-card {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -115%);
  background: rgba(14, 27, 60, 0.95);
  padding: 1rem 1.2rem;
  border-radius: 14px;
  border: 1px solid #ffb300;
  box-shadow: 0 4px 24px rgba(0,0,0,0.45);
  color: #ffe9b3;
  z-index: 9999;
  width: 260px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.20s ease-in-out;
}

.aircraft-hover-card.visible {
  opacity: 1;
}

.aircraft-hover-card h4 {
  margin: 0 0 0.4rem 0;
  font-size: 1rem;
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.5);
}

.progress-bar {
  width: 100%;
  height: 10px;
  background: rgba(255,255,255,0.15);
  border-radius: 6px;
  margin-top: 0.5rem;
  overflow: hidden;
  border: 1px solid rgba(255,200,60,0.35);
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #ffb300, #ffdd80);
  width: 0%;
  transition: width 0.5s ease;
}

.progress-label {
  display: block;
  text-align: right;
  font-size: 0.8rem;
  margin-top: 4px;
  color: #ffdd80;
}

/* ============================================================
   === BASE MODAL STYLE ========================================
   ============================================================ */

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(5, 10, 25, 0.65);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 6000;
}

.modal-content {
  background: #0d1b34;
  border: 1px solid rgba(255,179,0,0.35);
  padding: 1.5rem;
  border-radius: 16px;
  box-shadow: 0 0 18px rgba(255,179,0,0.25);
  color: #dbe4ff;
  width: 300px;
  text-align: center;
}

/* ============================================================
   === ACTION PLAN COLUMN (SMALLER) ============================
   ============================================================ */

.plan-actions {
  display: flex;
  gap: 6px;
  justify-content: center;
}

.plan-actions .btn {
  padding: 4px 10px;
  font-size: 0.75rem;
  border-radius: 10px;
  white-space: nowrap;
}

#scheduleTable td:last-child,
#scheduleTable th:last-child {
  width: 170px;
}
       
/* ============================================================
   üü¶ PASO 2 ‚Äî TOP ALIGN + CHRONO STACK (FINAL)
   ============================================================ */

#scheduleTable td {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: flex-start;

  padding-top: 6px;
  gap: 4px;
}
       
/* HOTFIX ‚Äî revertir flex global y proteger columna Aircraft */
#scheduleTable td { 
  display: table-cell; 
  vertical-align: middle; 
}

#scheduleTable td:not(:first-child) {
  vertical-align: top;
}
       
/* ============================================================
   üü¶ FIX ‚Äî KEEP ACTION PLAN CENTERED
   ============================================================ */

#scheduleTable td:last-child,
#scheduleTable th:last-child {
  vertical-align: middle !important;
}
.row-maint td {
  opacity: 0.45;
  background-color: rgba(200,80,0,0.15) !important;
}

.row-pending td {
  opacity: 0.35;
  background-color: rgba(150,150,150,0.12) !important;
}

/* ============================================================
   MINI CHIP QATAR ‚Äî ULTRA COMPACTO + CENTRADO
   ============================================================ */
       
.flightChip {
  display: block;                 /* uno debajo del otro */
  margin: 2px auto;               /* centrado */
  padding: 1px 5px;               /* ultra compacto */
  font-size: 10px;                /* tama√±o mini */
  font-weight: 600;
  color: #FFD54F;                 /* oro brillante */
  background: rgba(255, 204, 0, 0.15); 
  border: 1px solid rgba(255, 204, 0, 0.35);
  border-radius: 6px;             /* √≥valo peque√±o */
  width: fit-content;             /* ajustado al texto */
  white-space: nowrap;            /* no dividir */
}

/* ============================================================
   === B-CHECK DAY BACKGROUND ‚Äî Qatar Luxury A2 Premium ========
   ============================================================ */
.bcheck-day {
  background: rgba(135, 145, 165, 0.26) !important;
  border: 1px solid rgba(135, 145, 165, 0.38) !important;
  border-radius: 10px;
}
       
/* === MODAL ERROR ‚Äî Qatar Luxury Style === */

.modal-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.error-modal {
  background: linear-gradient(180deg, #0a1c33 0%, #162b45 100%);
  padding: 25px;
  border-radius: 14px;
  border: 1px solid rgba(255, 255, 255, 0.18);
  box-shadow: 0 0 18px rgba(0,0,0,0.45);
  width: 340px;
  text-align: center;
}

.modal-title {
  color: #ffb300;
  font-size: 20px;
  margin-bottom: 10px;
  font-weight: 600;
}

.modal-text {
  color: #d1d9e6;
  margin-bottom: 20px;
  font-size: 16px;
}

.modal-button {
  background: #ffb300;
  color: #000;
  border: none;
  padding: 12px 26px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
}

.modal-button:hover {
  background: #ffca47;
}

/* ============================================================
   üü° FLIGHT TOOLTIP (FIX CLIPPING)
   ============================================================ */

.flight-tooltip {
  max-width: 280px;
  white-space: normal;
  overflow: visible;
  line-height: 1.35;
}
       
/* ============================================================
   ‚úàÔ∏è FLIGHT CHIP ‚Äî COMPACT (ONE LINE)
   ============================================================ */

.flight-chip {
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 14px;
  white-space: nowrap;
  line-height: 1.2;
}

.flight-chip strong {
  font-weight: 600;
}
       
/* ============================================================
   ‚ú® ACS MODAL ‚Äî QATAR LUXURY
   ============================================================ */

.acs-action-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.acs-action-box {
  background: linear-gradient(180deg, #0b132b, #020617);
  border: 2px solid #ffcc33;
  border-radius: 20px;
  padding: 22px;
  display: flex;
  gap: 14px;
  box-shadow: 0 0 40px rgba(255,204,51,0.25);
}

.acs-action-btn {
  min-width: 90px;
  padding: 10px 0;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

.acs-action-btn.gold { background: #ffcc33; color: #000; }
.acs-action-btn.amber { background: #f59e0b; color: #000; }
.acs-action-btn.red   { background: #dc2626; color: #fff; }

.acs-action-btn.ghost {
  background: transparent;
  color: #fff;
  border: 1px solid #334155;
}

/* ============================================================
   ü¶Ñ ACS MODAL ‚Äî VISIBILITY FIX (SINGLE SOURCE)
   ============================================================ */

.acs-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.66);
  backdrop-filter: blur(6px);
  display: flex;                /* üîë SIEMPRE FLEX */
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

.acs-modal.hidden {
  display: none;                /* üîë √öNICO control de ocultaci√≥n */
}


.acs-modal-card.qatar {
  width: min(520px, 92vw);
  border-radius: 20px;
  overflow: hidden;
  background: linear-gradient(180deg, #0b132b 0%, #020617 100%);
  border: 2px solid rgba(255, 204, 51, 0.70);
  box-shadow: 0 0 42px rgba(255,204,51,0.20);
}

.acs-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  background: rgba(255,179,0,0.10);
  border-bottom: 1px solid rgba(255, 204, 51, 0.35);
}

.acs-modal-header h3 {
  margin: 0;
  font-size: 1.05rem;
  color: #ffcc33;
  letter-spacing: 0.4px;
  text-shadow: 0 0 10px rgba(255,204,51,0.25);
  display: flex;
  align-items: center;
  gap: 10px;
}

.btn-close {
  border: 1px solid rgba(255,204,51,0.45);
  background: rgba(255,204,51,0.06);
  color: #ffcc33;
  width: 40px;
  height: 36px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 800;
}

.btn-close:hover {
  background: rgba(255,204,51,0.14);
}

.acs-modal-body {
  padding: 14px 16px 6px;
  color: #dbe4ff;
  text-align: left;
}

.flight-kicker {
  font-size: 0.85rem;
  color: #cbd6ff;
  opacity: 0.95;
  margin-bottom: 10px;
}

.flight-hero {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,204,51,0.25);
  background: rgba(16,43,77,0.35);
  box-shadow: inset 0 0 18px rgba(0,0,0,0.35);
  margin-bottom: 10px;
}

.flight-hero .route {
  font-weight: 800;
  color: #ffe7a0;
  letter-spacing: 0.2px;
}

.flight-hero .times {
  font-family: "Orbitron", monospace;
  color: #00ff80;
  font-size: 0.92rem;
  white-space: nowrap;
}

.flight-meta {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 10px;
}

.meta-card {
  border-radius: 14px;
  padding: 10px 12px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
}

.meta-card .label {
  display: block;
  font-size: 0.78rem;
  color: #cbd6ff;
  opacity: 0.9;
  margin-bottom: 4px;
}

.meta-card .value {
  font-weight: 700;
  color: #ffdd80;
}

.acs-modal-footer {
  padding: 12px 16px 16px;
  border-top: 1px solid rgba(255, 204, 51, 0.20);
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.acs-modal-footer .btn-modal {
  padding: 10px 12px;
  border-radius: 14px;
  border: none;
  cursor: pointer;
  font-weight: 800;
  letter-spacing: 0.2px;
  white-space: nowrap;
}

.btn-modal.gold { background: #ffcc33; color: #000; }
.btn-modal.amber { background: #f59e0b; color: #000; }
.btn-modal.red { background: #dc2626; color: #fff; }

.btn-modal.ghost {
  background: rgba(255,255,255,0.05);
  color: #dbe4ff;
  border: 1px solid rgba(255,255,255,0.14);
}

.btn-modal:hover { filter: brightness(1.06); transform: translateY(-1px); }

/* ============================================================
   ü¶Ñ M1 ‚Äî MAINTENANCE MODAL (Qatar Luxury Unicorn) ‚Äî 17DEC25
   ============================================================ */

.acs-maint-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(6px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

.acs-maint-card {
  width: min(420px, 92vw);
  border-radius: 20px;
  overflow: hidden;
  background: linear-gradient(180deg, #0b132b 0%, #020617 100%);
  border: 2px solid rgba(255, 204, 51, 0.65);
  box-shadow: 0 0 42px rgba(255,204,51,0.22);
}

.acs-maint-header {
  padding: 14px 18px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,179,0,0.12);
  border-bottom: 1px solid rgba(255,204,51,0.35);
}

.acs-maint-header h3 {
  margin: 0;
  font-size: 1.1rem;
  color: #ffcc33;
  letter-spacing: 0.4px;
  display: flex;
  gap: 10px;
  align-items: center;
}

.acs-maint-body {
  padding: 18px;
  color: #dbe4ff;
}

.maint-field {
  margin-bottom: 14px;
}

.maint-field label {
  display: block;
  font-size: 0.8rem;
  color: #cbd6ff;
  margin-bottom: 6px;
}

.maint-field select,
.maint-field input[type="time"] {
  width: 100%;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,204,51,0.25);
  background: rgba(16,43,77,0.45);
  color: #fff;
  font-size: 0.95rem;
}

.maint-field input[type="time"] {
  font-family: "Orbitron", monospace;
}

.acs-maint-footer {
  padding: 14px 18px 18px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  border-top: 1px solid rgba(255,204,51,0.25);
}

.maint-btn {
  padding: 10px;
  border-radius: 14px;
  border: none;
  font-weight: 800;
  cursor: pointer;
}

.maint-btn.apply {
  background: #ffcc33;
  color: #000;
}

.maint-btn.cancel {
  background: rgba(255,255,255,0.05);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.18);
}

.maint-btn:hover {
  transform: translateY(-1px);
  filter: brightness(1.05);
}
       
/* ============================================================
   üõ† SERVICE CHIP ‚Äî TECH GRAY (QATAR LUXURY)
   ------------------------------------------------------------
   ‚Ä¢ Diferenciado de vuelos
   ‚Ä¢ Estilo t√©cnico / mantenimiento
   ‚Ä¢ Mantiene identidad ACS (borde √°mbar)
   ============================================================ */

.service-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;

  padding: 3px 12px;
  font-size: 11px;
  font-weight: 700;
  border-radius: 999px;
  white-space: nowrap;

  background: rgba(160, 170, 185, 0.22);       /* gris t√©cnico */
  border: 1px solid rgba(255, 179, 0, 0.55);   /* √°mbar ACS */
  color: #E5E7EB;                              /* texto gris claro */

  box-shadow:
    0 0 6px rgba(0,0,0,0.25),
    inset 0 0 6px rgba(255,255,255,0.08);
}
       
/* ============================================================
   üü´ PASO 2 ‚Äî B-CHECK DAY STYLE (GRAY CELL) ‚Äî 17DEC25
   ============================================================ */

.bcheck-day {
  background: rgba(120, 120, 120, 0.35) !important;
  box-shadow: inset 0 0 0 1px rgba(160, 160, 160, 0.45);
}

.bcheck-day .chip,
.bcheck-day .service-chip {
  opacity: 0.85;
}
       
/* ============================================================
   üü¶ PASO 3 ‚Äî FLIGHT ACTIVE VISUAL (SAFE)
   ============================================================ */

.flying-now {
  border: 2px solid #00ffcc;
  box-shadow: 0 0 6px rgba(0, 255, 204, 0.8);
  animation: flyingPulse 1.4s ease-in-out infinite;
}

@keyframes flyingPulse {
  0%   { box-shadow: 0 0 4px rgba(0, 255, 204, 0.6); }
  50%  { box-shadow: 0 0 10px rgba(0, 255, 204, 1); }
  100% { box-shadow: 0 0 4px rgba(0, 255, 204, 0.6); }
}

/* === A17.3 ‚Äî Maintenance Due Badge === */
       
.maintenance-dot{
  color:#d32f2f;
  font-size:12px;
  margin-top:2px;
  display:inline-block;
  cursor:default;
}

@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  50% { transform: translateX(6px); }
  75% { transform: translateX(-4px); }
  100% { transform: translateX(0); }
}

/* ============================================================
   üü¶ ACS STATUS BADGES ‚Äî QATAR LUXURY
   ============================================================ */

.acs-status-badge{
  margin-top:4px;
  display:inline-block;
  padding:2px 10px;
  font-size:10px;
  font-weight:800;
  border-radius:999px;
  letter-spacing:0.4px;
}

/* üü¢ ACTIVE */
.badge-active{
  background:rgba(0,255,128,0.18);
  border:1px solid rgba(0,255,128,0.45);
  color:#00ff80;
}

/* üü° A / B */
.badge-acheck,
.badge-bcheck{
  background:rgba(255,204,0,0.18);
  border:1px solid rgba(255,204,0,0.45);
  color:#ffd54f;
}

/* üü† C */
.badge-ccheck{
  background:rgba(255,152,0,0.22);
  border:1px solid rgba(255,152,0,0.55);
  color:#ffb74d;
}

/* üî¥ D */
.badge-dcheck{
  background:rgba(211,47,47,0.25);
  border:1px solid rgba(211,47,47,0.6);
  color:#ff5252;
}

/* üî¥ OVERDUE */
.badge-overdue{
  background:rgba(183,28,28,0.35);
  border:1px solid rgba(255,0,0,0.75);
  color:#ff1744;
}

/* ‚ö™ UNKNOWN */
.badge-unknown{
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:#ccc;
}
       
</style>

</head>
<body>

<!-- ============================================================
     === HEADER QATAR LUXURY (ID√âNTICO A DASHBOARD) =============
     ============================================================ -->
<header class="acs-header">

  <div class="acs-left">
    <img src="acs_logo.png" alt="ACS Logo">
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="finance.html">Bank</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html" class="active">Routes</a>
    <a href="hr.html">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
    <div id="acs-clock" class="acs-clock-header">00:00 ‚Äî 01 JAN 1940</div>
  </div>

</header>

<!-- ============================================================
     === MAIN CONTENT ===========================================
     ============================================================ -->
     
<main class="acs-main">

  <h2
    style="
      font-size:1.9rem;
      font-weight:700;
      color:#ffca3a;
      text-shadow:0 0 10px rgba(255,200,60,0.55);
      letter-spacing:0.4px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    "
  >
      üìÖ Weekly Flight Schedule
  </h2>

  <p class="sub" style="font-size:1rem; color:#cbd6ff;">
    Automatic schedule monitor with real-time route integration.
  </p>

  <table id="scheduleTable">
    <thead>
      <tr>
        <th>Aircraft</th>
        <th>Mon</th>
        <th>Tue</th>
        <th>Wed</th>
        <th>Thu</th>
        <th>Fri</th>
        <th>Sat</th>
        <th>Sun</th>
        <th>Action Plan</th>
      </tr>
    </thead>
    <tbody id="scheduleBody"></tbody>
  </table>
</div>

  <div class="summary">
    <p id="updateTime">Last update: --</p>
  </div>

  <button class="back-btn" onclick="window.location.href='routes.html'">
    ‚¨Ö Back to Routes
  </button>

</main>

<!-- ============================================================
     ü¶Ñ B2 ‚Äî FLIGHT MODAL (Qatar Luxury Unicorn) ‚Äî 17DEC25
     REEMPLAZA COMPLETO el bloque #flightModal anterior
     ============================================================ -->

<div id="flightModal" class="acs-modal hidden">
  <div class="acs-modal-card qatar">

    <div class="acs-modal-header">
      <h3 id="flightModalTitle">‚úàÔ∏è Flight</h3>
      <button class="btn-close" onclick="closeFlightModal()">‚úï</button>
    </div>

    <div id="flightModalContent" class="acs-modal-body">
      <!-- contenido din√°mico por JS -->
    </div>

    <div class="acs-modal-footer">
     <button class="btn-modal gold" onclick="editSelectedFlight()">‚úèÔ∏è EDIT</button>
     <button class="btn-modal amber" onclick="ACS_removeSelectedFlights()">üßπ REMOVE FLIGHTS</button>
     <button class="btn-modal red"   onclick="deleteSelectedFlights()">üóë DELETE FLIGHTS</button>
     <button class="btn-modal ghost" onclick="closeFlightModal()">Close</button>
   </div>

  </div>
</div>

<!-- ============================================================
     ü¶Ñ M2 ‚Äî MAINTENANCE MODAL (Qatar Luxury Unicorn) ‚Äî 17DEC25
     REEMPLAZA COMPLETO #maintModal
     ============================================================ -->

<div id="maintModal" class="acs-maint-modal">
  <div class="acs-maint-card">

    <div class="acs-maint-header">
      <h3>üõ† Plan Maintenance</h3>
      <button class="btn-close" onclick="closeMaintModal()">‚úï</button>
    </div>

    <div class="acs-maint-body">

      <div class="maint-field">
        <label>Maintenance Type</label>
        <select id="maintType">
          <option value="A">üîß A-Check (5 hours)</option>
          <option value="B">‚öôÔ∏è B-Check (24 hours)</option>
        </select>
      </div>

      <div class="maint-field">
        <label>Day</label>
        <select id="maintDay">
          <option value="mon">Monday</option>
          <option value="tue">Tuesday</option>
          <option value="wed">Wednesday</option>
          <option value="thu">Thursday</option>
          <option value="fri">Friday</option>
          <option value="sat">Saturday</option>
          <option value="sun">Sunday</option>
        </select>
      </div>

      <div class="maint-field">
  <label>Start Time</label>
  <select id="maintStart">
    <!-- opciones generadas por JS -->
  </select>
</div>

    </div>

    <div class="acs-maint-footer">
      <button class="maint-btn apply" onclick="applyMaintenance()">Apply</button>
      <button class="maint-btn cancel" onclick="closeMaintModal()">Cancel</button>
    </div>

  </div>
</div>

<!-- ============================================================
     === FLIGHT INFO MODAL ‚Äî Qatar Luxury Edition ================
     ============================================================ -->
     
<!-- === MODAL ERROR ‚Äî MAINTENANCE A (Qatar Luxury) === -->
<div id="maintenanceErrorModal" class="modal-overlay">
  <div class="modal-content error-modal">
    <h2 class="modal-title">‚ùå Invalid Maintenance Time</h2>
    <p id="maintenanceErrorText" class="modal-text"></p>
    <button class="modal-button" onclick="closeMaintenanceErrorModal()">OK</button>
  </div>
</div>

<!-- ============================================================
     üü¶ PASO 4.2 ‚Äî ASSIGN FLIGHTS MODAL (Qatar Luxury Premium)
     ------------------------------------------------------------
     ‚úÖ Modal NUEVO (NO reutiliza #flightModal)
     ============================================================ -->

<div id="assignFlightsModal" class="acs-modal hidden">
  <div class="acs-modal-card qatar">

    <div class="acs-modal-header">
      <h3 id="assignFlightsTitle">‚úàÔ∏è Assign Flights</h3>
      <button class="btn-close" onclick="ACS_closeAssignFlightsModal()">‚úï</button>
    </div>

    <div id="assignFlightsBody" class="acs-modal-body">
      <!-- contenido din√°mico -->
    </div>

    <div class="acs-modal-footer">
      <button class="btn-modal gold" onclick="ACS_confirmAssignFlights()">‚úÖ Assign Selected</button>
      <button class="btn-modal ghost" onclick="ACS_closeAssignFlightsModal()">Cancel</button>
    </div>

  </div>
</div>
     
<footer>
  ¬© 2026 Aviation Capital Simulator. All rights reserved.
</footer>

<!-- ============================================================
     ‚è± ACS TIME ENGINE ‚Äî REQUIRED FOR SCHEDULE TABLE
     ============================================================ -->

<!-- ============================================================
     ‚è≥ ACS TIME ENGINE V12 ‚Äî 24/7 RECOVERY LAYER
     ============================================================ -->
<script src="acs_time_recovery.js"></script>
<script src="time_engine.js"></script>

<!-- üåç WORLD / AIRPORT ENGINE -->
<script src="engine/acs_world_engine.js"></script>
     
<script>

/* ============================================================
   ‚è± PASO 1 ‚Äî SCHEDULE TABLE TIME LISTENER (FINAL)
   Conecta Schedule Table al Time Engine ACS
   ============================================================ */

// ‚è± Tiempo local del m√≥dulo (NO global)
let ACS_TABLE_TIME = {
  minute: 0,
  day: null,
  date: null
};

// üîå Conexi√≥n oficial al Time Engine
if (typeof registerTimeListener === "function") {
  registerTimeListener((currentTime) => {

    // currentTime es Date del simulador
    ACS_TABLE_TIME.minute =
      currentTime.getHours() * 60 + currentTime.getMinutes();

    ACS_TABLE_TIME.day = currentTime.getDay(); // 0‚Äì6
    ACS_TABLE_TIME.date = currentTime;

    // üîÑ Re-render seguro (solo si la tabla ya existe)
    if (typeof renderSchedule === "function") {
      renderSchedule();
    }
  });
} else {
  console.warn("‚õî Time Engine not available for Schedule Table");
}
     
// ============================================================
// üîß B3 ‚Äî normalizeModel EXTENDIDO
// Unifica nombres: may√∫sculas, sin espacios, sin guiones,
// sin diagonales, sin puntos, sin par√©ntesis.
// ============================================================
     
function normalizeModel(m){
  if(!m) return "";

  return String(m)
    .toUpperCase()
    .replace(/[\s\-\/\.\(\)\_]/g, "")  // quitar espacios, guiones, barras, puntos, par√©ntesis, guion bajo
    .replace(/AIRBUS/g, "")           // limpiar prefijos redundantes si vienen
    .replace(/BOEING/g, "")           // igual
    .trim();
}

/* ============================================================
   üü¶ A3.1 ‚Äî AIRCRAFT STATUS RESOLVER (SCHEDULE ¬∑ READ ONLY)
   ------------------------------------------------------------
   Source of truth: ACS_MyAircraft
   Schedule Table NO ejecuta l√≥gica, solo refleja estado
   ============================================================ */

function ACS_getAircraftStatusBadge(ac){

  if (!ac) {
    return { label: "UNKNOWN", class: "badge-unknown" };
  }

  // üî¥ OVERDUE ‚Äî m√°xima prioridad
  if (ac.maintenanceOverdue === true) {
    return { label: "OVERDUE", class: "badge-overdue" };
  }

  // üîß SERVICIOS MAYORES
  if (ac.status === "In D-Check") {
    return { label: "D-CHECK", class: "badge-dcheck" };
  }

  if (ac.status === "In C-Check") {
    return { label: "C-CHECK", class: "badge-ccheck" };
  }

  // ‚öôÔ∏è B-CHECK
  if (ac.status === "B-Check") {
    return { label: "B-CHECK", class: "badge-bcheck" };
  }

  // üîß A-CHECK
  if (ac.status === "A-Check") {
    return { label: "A-CHECK", class: "badge-acheck" };
  }

  // üü¢ OPERATIVO
  if (ac.status === "Active") {
    return { label: "ACTIVE", class: "badge-active" };
  }

  // ‚ö™ FALLBACK
  return {
    label: (ac.status || "UNKNOWN").toUpperCase(),
    class: "badge-unknown"
  };
}

/* ============================================================
   üüß A3.1 ‚Äî SCHEDULE VISUAL SERVICE STATE (ACS)
   ------------------------------------------------------------
   Purpose:
   - Schedule decide SOLO servicios A / B
   - NO modifica estado operacional real
   - NO escribe en ACS_MyAircraft
   - Estado 100% visual / temporal
   ============================================================ */

function ACS_EvaluateScheduleServiceState(ac, scheduleItems) {

  // Estado visual local (NO persistente)
  ac.__schedule = {
    hasService: false,
    type: null,        // "A" | "B"
    reason: null,      // "A-check" | "B-check"
    visualOnly: true
  };

  if (!Array.isArray(scheduleItems)) return ac;

  // Buscar servicios A/B activos para esta aeronave
  const svc = scheduleItems.find(it =>
    it.type === "service" &&
    it.aircraftId === ac.id &&
    (it.serviceType === "A" || it.serviceType === "B") &&
    it.active === true
  );

  if (svc) {
    ac.__schedule.hasService = true;
    ac.__schedule.type = svc.serviceType;
    ac.__schedule.reason = svc.serviceType === "A" ? "A-check" : "B-check";
  }

  return ac;
}

     
/* ============================================================
   üü¶ PASO 4.2-A ‚Äî FLIGHT COMPATIBILITY HELPERS (MODEL EXACT)
   ============================================================ */

function ACS_isFlightCompatibleWithAircraft(flight, aircraft) {

  // Normalizador seguro
  const norm = (v) => String(v || "")
    .normalize("NFKC")
    .replace(/\s+/g, " ")
    .replace(/\u00A0/g, " ")
    .trim()
    .toUpperCase();

  if (!flight || !aircraft) return false;

  // ‚úÖ Vuelo: usar SIEMPRE modelKey (o aircraft) como fuente real
  const fKey = norm(flight.modelKey || flight.aircraft || flight.model || flight.aircraftModel);

  // ‚úÖ Avi√≥n: usar model real del fleet
  const aKey = norm(aircraft.model || aircraft.modelKey || aircraft.aircraft || aircraft.name);

  if (!fKey || !aKey) return false;

  // Compatibilidad estricta por modelo
  return fKey === aKey;
}

function ACS_isFlightAlreadyAssigned(flight){
  return !!(flight && flight.aircraftId);
}
     
// ============================================================
// === REAL FLEET ‚Äî Unified with My Aircraft ==================
// === Source: ACS_MyAircraft (official fleet key) ============
// ============================================================
     
function getRealFleet() {
  return JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");
}

const TURNAROUND_MIN = 45;


/* ============================================================
   ‚è± SAFE toMin ‚Äî prevents undefined hh:mm crashes
   ============================================================ */
const toMin = hhmm => {
  if (!hhmm || typeof hhmm !== "string" || !hhmm.includes(":")) {
    return null;
  }
  const [h, m] = hhmm.split(":").map(Number);
  return h * 60 + m;
};

const toHHMM = min => {
  const h = Math.floor(min/60)%24;
  const m = min%60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
};
     
/* ============================================================
   üîß B1 ‚Äî D√çAS DEL SCHEDULE (OBLIGATORIO)
   ============================================================ */

const days = ["mon","tue","wed","thu","fri","sat","sun"];

/* ============================================================
   üîß B2 ‚Äî RESTAURAR STORE KEYS (OBLIGATORIO)
   ============================================================ */
     
const STORE_KEY = "scheduleItems";
const ROUTE_KEY = "confirmedRoute";

const getItems = () => JSON.parse(localStorage.getItem(STORE_KEY) || "[]");
const setItems = list => localStorage.setItem(STORE_KEY, JSON.stringify(list));

const getRoute = () => {
  const r = localStorage.getItem(ROUTE_KEY);
  return r ? JSON.parse(r) : null;
};


// ============================================================
// FLEET ‚Äî Helper wrappers (compatibilidad legacy) =============
// ============================================================
     
const getFleet = () => getRealFleet();
const setFleet = f => localStorage.setItem("ACS_MyAircraft", JSON.stringify(f));

(function initFleet(){
  const current = getRealFleet();

  // Si por alguna raz√≥n la clave no es un array, la normalizamos
  if (!Array.isArray(current)) {
    localStorage.setItem("ACS_MyAircraft", "[]");
  }
})();

// ============================================================
// === AIRCRAFT HOVER CARD ‚Äî Qatar Luxury v3 ==================
// ============================================================
function showAircraftHover(ac, cell) {

  // Remover card anterior si existe
  const old = document.querySelector(".aircraft-hover-card");
  if (old) old.remove();

  // Ocultar hover si el avi√≥n no est√° en servicio especial
  const st = ac.status || "";
  const activeStatuses = [
    "In C-Check",
    "In D-Check",
    "Pending Delivery",
    "B-Check"
  ];
  if (!activeStatuses.includes(st)) return;

  // Crear card
  const card = document.createElement("div");
  card.className = "aircraft-hover-card";

  // Fechas para progreso
  const start = ac.lastC || ac.lastD || ac.deliveryStart || null;
  const end   = ac.deliveryDate || ac.nextC || ac.nextD || null;

  let pct = 0;
  if (start && end) {
    const now = new Date();
    const s = new Date(start);
    const e = new Date(end);
    pct = Math.min(100, Math.max(0, ((now - s) / (e - s)) * 100));
  }

  // Icono seg√∫n servicio
  const icon =
    st === "In C-Check"       ? "üõ†" :
    st === "In D-Check"       ? "‚öôÔ∏è" :
    st === "Pending Delivery" ? "‚è≥" :
    st === "B-Check"          ? "üîß" : "";

  // Construcci√≥n del contenido
  card.innerHTML = `
    <h4>${ac.registration}</h4>
    <p style="margin-top:-4px; font-size:0.85rem; color:#ffdd80;">
      ${ac.model || "‚Äî"} ‚Äî ${icon}
    </p>

    <p style="margin:6px 0 10px; color:#cbd6ff;">
      Started: ${start ? new Date(start).toDateString() : "‚Äî"}<br>
      Ends: ${end ? new Date(end).toDateString() : "‚Äî"}
    </p>

    <div class="progress-bar">
      <div class="progress-fill" style="width:${pct.toFixed(0)}%"></div>
    </div>
    <span class="progress-label">${pct.toFixed(0)}%</span>
  `;

  // Mostrar en la celda
  cell.style.position = "relative";
  cell.appendChild(card);
  setTimeout(() => card.classList.add("visible"), 10);
}

function hideAircraftHover(){
  const c = document.querySelector(".aircraft-hover-card");
  if (c) c.remove();
}
     
/* ============================================================
   üüß A6 ‚Äî MIGRATE LEGACY SCHEDULE ITEMS (ONE-TIME)
   ------------------------------------------------------------
   - Detecta vuelos sin aircraftId
   - Resuelve aircraftId desde ACS_MyAircraft
   - Preserva todos los dem√°s campos
   - Ejecuta una sola vez (flag protegido)
   ============================================================ */

(function migrateLegacyScheduleItems(){

  const FLAG_KEY = "ACS_schedule_migrated_v1";
  if (localStorage.getItem(FLAG_KEY)) return;

  let items = [];
  let fleet = [];

  try {
    items = JSON.parse(localStorage.getItem("scheduleItems")) || [];
  } catch {
    items = [];
  }

  try {
    fleet = JSON.parse(localStorage.getItem("ACS_MyAircraft")) || [];
  } catch {
    fleet = [];
  }

  if (!Array.isArray(items) || items.length === 0) {
    localStorage.setItem(FLAG_KEY, "1");
    return;
  }

  if (!Array.isArray(fleet) || fleet.length === 0) {
    console.warn("üüß A6: Fleet empty ‚Äî migration skipped");
    return;
  }

  let migratedCount = 0;

  items.forEach(it => {

    if (!it || it.type !== "flight") return;

    // Ya est√° normalizado
    if (it.aircraftId) return;

     // =====================================
    // ‚è± NORMALIZE LEGACY TIME (CRITICAL)
    // =====================================

    const timeToAbsMin = (hhmm) => {
      if (!hhmm || typeof hhmm !== "string") return null;
      const p = hhmm.split(":");
      if (p.length !== 2) return null;
      const h = parseInt(p[0], 10);
      const m = parseInt(p[1], 10);
      if (isNaN(h) || isNaN(m)) return null;
      return (h * 60) + m;
    };

    // Departure
    if (typeof it.depAbsMin !== "number") {
      const depSrc =
        it.depTime ||
        it.dep ||
        it.blockOut ||
        null;

      const depMin = timeToAbsMin(depSrc);
      if (typeof depMin === "number") {
        it.depAbsMin = depMin;
      }
    }

    // Arrival
    if (typeof it.arrAbsMin !== "number") {
      const arrSrc =
        it.arrTime ||
        it.arr ||
        it.blockIn ||
        null;

      const arrMin = timeToAbsMin(arrSrc);
      if (typeof arrMin === "number") {
        it.arrAbsMin = arrMin;
      }
    }
       
    // Intentar resolver por modelo / tipo
    const modelKey =
      it.acType ||
      it.aircraftModel ||
      it.modelKey ||
      it.aircraft ||
      "";

    if (!modelKey) return;

    const match = fleet.find(ac =>
      ac &&
      ac.model === modelKey &&
      ac.status === "Active"
    );

    if (!match || !match.id) return;

    it.aircraftId = match.id;
    it.acType = match.model || it.acType || "";
    migratedCount++;
  });

  if (migratedCount > 0) {
    localStorage.setItem("scheduleItems", JSON.stringify(items));
    console.log(`üüß A6: Migrated ${migratedCount} legacy flight(s)`);
  }

  localStorage.setItem(FLAG_KEY, "1");

})();


// ============================================================
// === RENDER PRINCIPAL DEL SCHEDULE ==========================
// ============================================================
     
function renderSchedule() {

  const tbody = document.getElementById("scheduleBody");
  tbody.innerHTML = "";

  const items = getItems();
  const fleet = getRealFleet();

// ============================================================
// üü¶ PASO 2.1 ‚Äî APPLY OPERATIONAL AUTHORITY (MANDATORY)
// Schedule es la √∫nica autoridad de vuelo
// ============================================================

fleet.forEach(ac => {
  ACS_EvaluateOperationalStatus(ac);
});

// Persistir estado evaluado para SkyTrack / Alerts
localStorage.setItem("ACS_MyAircraft", JSON.stringify(fleet));
     
// ============================================================
// üü¶ 3A.1 ‚Äî INDEXAR ITEMS POR AIRCRAFT ID (FLIGHTS + SERVICES)
// ============================================================

const byAircraftId = {};

// NOTE:
// - flights y services conviven (como en v1.5)
// - aircraftId es la clave √∫nica
// - day DEBE ser mon..sun

items.forEach(it => {

  if (!it) return;

  // ‚õî ignorar items marcados como editados
  if (it.__edited === true) return;

  // ‚õî requiere aircraftId v√°lido
  const key = String(it.aircraftId || "").trim();
  if (!key) return;

  // ‚õî requiere d√≠a v√°lido
  const day = String(it.day || "").toLowerCase();
  if (!["mon","tue","wed","thu","fri","sat","sun"].includes(day)) return;

  // ‚úÖ aceptar SOLO flight o service
  if (it.type !== "flight" && it.type !== "service") return;

  if (!byAircraftId[key]) byAircraftId[key] = [];
  byAircraftId[key].push(it);
});

 // ============================================================
// SIN FLOTA ‚Äî filas dummy (FIX ac scope)
// ============================================================

if (!fleet.length) {

  for (let i = 0; i < 5; i++) {

    const tr = document.createElement("tr");

    // Aircraft
    const tdTail = document.createElement("td");
    tdTail.textContent = "(empty)";
    tr.appendChild(tdTail);

    // Days
    days.forEach(() => {
      const td = document.createElement("td");
      td.textContent = "‚Äî";
      tr.appendChild(td);
    });

    // Action Plan
    const planTd = document.createElement("td");
    const wrap = document.createElement("div");
    wrap.className = "plan-actions";

    const assignBtn = document.createElement("button");
    assignBtn.className = "btn btn-assign";
    assignBtn.textContent = "Assign Route";
    assignBtn.onclick = () =>
      alert("‚ö† No aircraft available. Buy one first.");

    const maintBtn = document.createElement("button");
    maintBtn.className = "btn btn-maint";
    maintBtn.textContent = "Plan Maintenance";
    maintBtn.onclick = () =>
      alert("‚ö† No aircraft available. Buy one first.");

    wrap.appendChild(assignBtn);
    wrap.appendChild(maintBtn);
    planTd.appendChild(wrap);
    tr.appendChild(planTd);

    tbody.appendChild(tr);
  }

  document.getElementById("updateTime").textContent =
    "Last update: " + new Date().toLocaleTimeString();

  return;
}

  // ============================================================
  // CON FLOTA
  // ============================================================
  fleet.forEach(ac => {

    const tr = document.createElement("tr");
    // üü¶ 3B.1 ‚Äî Aircraft Row Identity (AC_xxx)
    tr.dataset.aircraftId = ac.id || "";
       
    // ============================================================
    // MODELO REAL + MODELO NORMALIZADO
    // ============================================================
    const realModel = ac.model || ac.type || ac.data?.model || "";
    const modelKey  = normalizeModel(realModel);

    tr.dataset.model = modelKey;

    // ============================================================
    // COLUMNA AIRCRAFT
    // ============================================================
    const tdTail = document.createElement("td");
    tdTail.classList.add("col-aircraft");
    tdTail.dataset.model = modelKey;

    /* ============================================================
   üüß SCHED-A1 ‚Äî AIRCRAFT REGISTRATION (SINGLE SOURCE OF TRUTH)
   Source: ACS_MyAircraft.registration
   ============================================================ */
    const reg = ac.registration && ac.registration.trim()
    ? ac.registration
    : "‚Äî";

    const manu = ac.manufacturer || "‚Äî";
       
    /* ============================================================
   üüß A17.3 ‚Äî MAINTENANCE DUE BADGE (UI ONLY)
   ============================================================ */

const stat = ac.status || "";

const hasDue = ac.maintenance?.bDue || ac.maintenance?.aDue;

const dueText = ac.maintenance?.bDue
  ? "B-CHECK DUE"
  : ac.maintenance?.aDue
    ? "A-CHECK DUE"
    : "";

const status = ACS_getAircraftStatusBadge(ac);

const wrapInfo = document.createElement("div");
wrapInfo.style.lineHeight = "1.25";
wrapInfo.style.textAlign = "left";

wrapInfo.innerHTML = `
  <strong>${reg}</strong><br>
  <span>${realModel}</span><br>
  <span style="color:#ffca3a;font-weight:600;">
    ${manu.toUpperCase()}
  </span>
  <div class="acs-status-badge ${status.class}">
    ${status.label}
  </div>
`;

    tdTail.appendChild(wrapInfo);
    tdTail.onmouseenter = () => showAircraftHover(ac, tdTail);
    tdTail.onmouseleave = hideAircraftHover;

    tr.appendChild(tdTail);

    // ============================================================
    // COLUMNAS DE D√çAS
    // ============================================================
    days.forEach(day => {

      const td = document.createElement("td");

     const aircraftId = String(ac.id || "").trim();

     const rawDayItems = (byAircraftId[aircraftId] || []).filter(x => {
  if (!x) return false;
  if (String(x.day || "").toLowerCase() !== day) return false;
  if (x.__edited === true) return false;

  // ‚úÖ SERVICES: siempre visibles si pertenecen al avi√≥n
  if (x.type === "service") {
    return true; // (assigned no obligatorio para services)
  }

  // ‚úÖ FLIGHTS: mantener reglas actuales
  if (x.type === "flight") {
    if (x.assigned !== true) return false;
    return ACS_isFlightCompatibleWithAircraft(x, ac);
  }

  return false;
});
     
    const dayItems = ACS_sortDayEvents(rawDayItems);
         
/* ============================================================
   üü´ PASO 2 ‚Äî DETECT B-CHECK FOR DAY ‚Äî 17DEC25
   ============================================================ */

// ‚è± minuto actual del simulador (YA EXISTE EN ACS)
const nowMin = ACS_TABLE_TIME.minute;

// Buscar B-Check ACTIVO en este d√≠a
const hasActiveBCheck = dayItems.some(it => {
  if (it.type !== "service" || it.serviceType !== "B") return false;

  const start = it.startMinute; // ya existe en el service
  const end   = it.endMinute;

  return nowMin >= start && nowMin < end;
});

// üëâ SOLO si el B-Check est√° ACTIVO ‚Üí gris
if (hasActiveBCheck) {
  td.classList.add("bcheck-day");
}

/* ============================================================
   ‚è± PASO 1 ‚Äî ORDER DAY EVENTS BY START TIME (SAFE)
   ============================================================ */

dayItems.sort((a, b) => {

  // Hora inicio del evento A
  const aStart =
    a.type === "flight"
      ? toMin(a.departure || "00:00")
      : a.type === "service"
        ? (a.startMinute ?? 0)
        : 0;

  // Hora inicio del evento B
  const bStart =
    b.type === "flight"
      ? toMin(b.departure || "00:00")
      : b.type === "service"
        ? (b.startMinute ?? 0)
        : 0;

  return aStart - bStart;
});
         
dayItems.forEach(it => {
     
/* ============================================================
   ‚úàÔ∏è PASO 2 ‚Äî DETECT ACTIVE FLIGHT (SAFE)
   ============================================================ */

// ‚è± Hora actual del simulador
const nowMin = ACS_TABLE_TIME.minute;

// ‚è± Convertir horas del vuelo (SAFE)
const depMin = toMin(it.departure) ?? -1;
const arrMin = toMin(it.arrival) ?? -1;

// ‚úàÔ∏è ¬øEst√° volando ahora?
const isFlying =
  depMin >= 0 &&
  arrMin >= 0 &&
  nowMin >= depMin &&
  nowMin < arrMin;

/* ============================================================
   ‚úàÔ∏è VISUAL MARK ‚Äî FLIGHT IN PROGRESS (SAFE)
   ============================================================ */

if (isFlying && typeof chip !== "undefined" && chip) {
  chip.classList.add("flying-now");
  chip.title = "‚úàÔ∏è Flight in progress";
}
     
/* ============================================================
   üü¢ PASO 5 ‚Äî READ ONLY MODE (SCHEDULE TABLE)
   ------------------------------------------------------------
   - Schedule Table NO ejecuta vuelos
   - NO escribe ACS_FLIGHT_EXEC
   - NO publica en SkyTrack
   - Solo calcula VISUAL STATE
   ============================================================ */

// ‚úàÔ∏è VISUAL ONLY ‚Äî marcar vuelo activo en tabla
if (isFlying && typeof chip !== "undefined" && chip) {
  chip.classList.add("flying-now");
  chip.title = "‚úàÔ∏è Flight in progress";
}

// ‚õî NO DISPATCH
// ‚õî NO SKYTRACK WRITE
// ‚õî NO CLEAR STATE


// ---------------- FLIGHT ----------------
if (it.type === "flight") {

  const chip = document.createElement("span");
  chip.className = "chip flight-chip";
  chip.dataset.id = it.id;
  chip.dataset.blockId = it.blockId || "";
  chip.dataset.type = "flight";

 /* ============================================================
   üüß A4 ‚Äî Flight Chip Label (UI ONLY ¬∑ SAFE)
   ============================================================ */

const labelOut = it.labelOut || it.flightLabelOut || it.flightNumberOut || "‚Äî";
const labelIn  = it.labelIn  || it.flightLabelIn  || it.flightNumberIn  || "‚Äî";

chip.textContent = `${labelOut} / ${labelIn}`;

chip.onclick = () => {
  // üîë selecci√≥n real para EDIT / REMOVE
  window.selectedFlight = {
    data: it,
    element: chip
  };
  openFlightModal(it, chip);
};

td.appendChild(chip);
}

// ---------------- SERVICE ----------------
if (it.type === "service") {

  const chip = document.createElement("span");
  chip.className = "service-chip";
  chip.dataset.id = it.id;
  chip.dataset.type = "service";

  chip.textContent =
    it.serviceType === "A"
      ? "üîß A-Check"
      : "‚öôÔ∏è B-Check";

  chip.onclick = () => {
    // üîë guardar contexto del service seleccionado
    window.selectedService = it;

    // abrir Maintenance Modal en modo EDIT
    openMaintModal(
  (ac.model || ac.type || realModel),
  it,
  ac.id
);

  };

  td.appendChild(chip);
}

});

tr.appendChild(td);

    });

    // ============================================================
    // ACTION PLAN
    // ============================================================
    const planTd = document.createElement("td");
    const wrap = document.createElement("div");
    wrap.className = "plan-actions";

    const assignBtn = document.createElement("button");
    assignBtn.className = "btn btn-assign";
    assignBtn.textContent = "Assign Route";
    assignBtn.onclick = () => assignRouteToTail(ac);

    const maintBtn = document.createElement("button");
    maintBtn.className = "btn btn-maint";
    maintBtn.textContent = "Plan Maintenance";
    maintBtn.onclick = () => openMaintModal(realModel, null, ac.id);

    wrap.appendChild(assignBtn);
    wrap.appendChild(maintBtn);
    planTd.appendChild(wrap);
    tr.appendChild(planTd);

    tbody.appendChild(tr);
  });
     
/* ============================================================
   üü¢ B4 ‚Äî EMPTY BUFFER ROWS (3 ALWAYS)
   Se renderizan siempre, con o sin flota
   ============================================================ */

const EMPTY_ROWS = 3;

for (let i = 0; i < EMPTY_ROWS; i++) {

  const tr = document.createElement("tr");
  tr.classList.add("row-pending");

  // Aircraft
  const tdTail = document.createElement("td");
  tdTail.textContent = "(empty)";
  tdTail.style.opacity = "0.6";
  tr.appendChild(tdTail);

  // Days
  days.forEach(() => {
    const td = document.createElement("td");
    td.textContent = "‚Äî";
    tr.appendChild(td);
  });

  // Action Plan
  const planTd = document.createElement("td");
  const wrap = document.createElement("div");
  wrap.className = "plan-actions";

  const assignBtn = document.createElement("button");
  assignBtn.className = "btn btn-assign";
  assignBtn.textContent = "Assign Route";
  assignBtn.onclick = () =>
    alert("‚ö† This slot is reserved for a future aircraft.");

  const maintBtn = document.createElement("button");
  maintBtn.className = "btn btn-maint";
  maintBtn.textContent = "Plan Maintenance";
  maintBtn.onclick = () =>
    alert("‚ö† No aircraft assigned to this slot.");

  wrap.appendChild(assignBtn);
  wrap.appendChild(maintBtn);
  planTd.appendChild(wrap);
  tr.appendChild(planTd);

  tbody.appendChild(tr);
}
     
  // ============================================================
  // UPDATE TIME (NO TOCAR)
  // ============================================================
     
  document.getElementById("updateTime").textContent =
    "Last update: " + new Date().toLocaleTimeString();
}

/* ============================================================
   üü¶ PASO 4.1 ‚Äî ASSIGN FLIGHTS TO AIRCRAFT (QATAR LUXURY) ‚Äî FIX
   ------------------------------------------------------------
   ‚úÖ Usa MODAL NUEVO (#assignFlightsModal)
   ‚úÖ NO toca #flightModal (Edit/Delete/Remove)
   ‚úÖ SOLO asigna aircraftId en ACS_FLIGHTS
   ============================================================ */

/* ============================================================
   üü¶ PASO 2.2-A ‚Äî ASSIGN ROUTE (SOURCE = scheduleItems)
   ------------------------------------------------------------
   ‚Ä¢ SOLO abre el modal
   ‚Ä¢ NO asigna nada aqu√≠
   ‚Ä¢ NO valida compatibilidad aqu√≠
   ============================================================ */

function assignRouteToTail(ac){

  if (!ac || !ac.id) {
    alert("‚ö† Invalid aircraft.");
    return;
  }

  // üîë FUENTE √öNICA: scheduleItems
  let items = [];
  try {
    items = JSON.parse(localStorage.getItem("scheduleItems")) || [];
  } catch {
    items = [];
  }

  if (!Array.isArray(items) || !items.length) {
    alert("‚ö† No scheduled flights found.");
    return;
  }

    // üëâ Vuelos disponibles para asignar:
  // - NO asignados (sin aircraftId)
  // - O editados (__edited === true) aunque tengan aircraftId (para que pasen por Assign Route)
  const unassignedFlights = items
    .filter(it => it && it.type === "flight" && (!it.aircraftId || it.__edited === true))
    .filter(it => {
      if (typeof ACS_isFlightCompatibleWithAircraft !== "function") return true;
      return ACS_isFlightCompatibleWithAircraft(it, ac);
    });

  if (!unassignedFlights.length) {
    alert("‚ö† All scheduled flights are already assigned.");
    return;
  }

  // ‚úÖ CONTEXTO DEL MODAL (can√≥nico)
  ACS_ASSIGN_CTX.aircraft = ac;
  ACS_ASSIGN_CTX.flightIds = [];

  // ‚úÖ Abrir modal con DATOS REALES DEL SCHEDULE
  ACS_openAssignFlightsModal(ac, unassignedFlights);
}

/* ============================================================
   üü¶ ASSIGN FLIGHTS MODAL CONTEXT (CAN√ìNICO)
   ------------------------------------------------------------
   ‚Ä¢ Estado temporal del modal
   ‚Ä¢ NO persiste
   ============================================================ */

let ACS_ASSIGN_CTX = {
  aircraft: null,
  flightIds: []
};

/* ============================================================
   üü¶ ACS ASSIGN FLIGHTS MODAL ‚Äî MODEL AWARE + UX CLEAN
   ------------------------------------------------------------
   ‚Ä¢ T√≠tulo por MODELO (no matr√≠cula)
   ‚Ä¢ Chip informativo de compatibilidad
   ‚Ä¢ Select all GLOBAL
   ‚Ä¢ Sin Select all por d√≠a
   ============================================================ */

function ACS_openAssignFlightsModal(ac, unassignedFlights){

  ACS_ASSIGN_CTX.aircraft = ac;
  ACS_ASSIGN_CTX.flightIds = [];

  const modal = document.getElementById("assignFlightsModal");
  const title = document.getElementById("assignFlightsTitle");
  const body  = document.getElementById("assignFlightsBody");

  if (!modal || !title || !body) {
    alert("‚õî Assign modal missing in HTML.");
    return;
  }

  // ===== MODELO DE LA RUTA (fuente real)
  const firstFlight = Array.isArray(unassignedFlights) && unassignedFlights.length
    ? unassignedFlights[0]
    : null;

  const routeModelLabel =
    firstFlight?.acType ||
    firstFlight?.model ||
    firstFlight?.aircraft ||
    "Aircraft Model";

  title.textContent = `‚úàÔ∏è Assign Flights ‚Äî ${routeModelLabel}`;

  /* ============================================================
   üüß PASO 4.1 ‚Äî MODEL COMPATIBILITY WARNING (CONTEXTUAL)
   ------------------------------------------------------------
   ‚Ä¢ SOLO aparece si el avi√≥n NO coincide con el modelo de ruta
   ‚Ä¢ NO aparece en casos correctos
   ============================================================ */

const acModelRaw =
  ac?.model ||
  ac?.type ||
  ac?.aircraft ||
  "";

const routeModelRaw =
  firstFlight?.acType ||
  firstFlight?.model ||
  firstFlight?.aircraft ||
  "";

const acModelKey    = normalizeModel(acModelRaw);
const routeModelKey = normalizeModel(routeModelRaw);

let warningHTML = "";

if (acModelKey && routeModelKey && acModelKey !== routeModelKey) {
  warningHTML = `
    <div class="meta-card" style="
      margin-bottom:12px;
      border:1px solid rgba(255,179,0,0.55);
      background:rgba(255,179,0,0.10);
    ">
      ‚ö†Ô∏è This route is restricted to <strong>${routeModelRaw}</strong> aircraft
    </div>
  `;
}
     
  // ===== Agrupar vuelos por d√≠a
     
  const byDay = {};
  unassignedFlights.forEach(f => {
    const d = (f.day || "").toString().trim().toLowerCase();
    if (!d) return;
    if (!byDay[d]) byDay[d] = [];
    byDay[d].push(f);
  });

  const dayOrder = ["mon","tue","wed","thu","fri","sat","sun"];
  const dayLabel = { mon:"MON", tue:"TUE", wed:"WED", thu:"THU", fri:"FRI", sat:"SAT", sun:"SUN" };
  const daysSorted = Object.keys(byDay).sort(
    (a,b)=> dayOrder.indexOf(a)-dayOrder.indexOf(b)
  );

  // ===== CHIP INFORMATIVO + SELECT ALL GLOBAL
     
  body.innerHTML = `
  
  ${warningHTML}

    <div class="flight-kicker" style="
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
">
  <span>Select the flights you want to assign to this aircraft.</span>

  <button
    class="btn-modal ghost"
    style="padding:6px 14px;border-radius:12px;font-weight:800;"
    onclick="ACS_toggleSelectAllGlobal()"
  >
    Select all
  </button>
</div>

    ${daysSorted.map(d => `
      <div class="meta-card" style="margin-bottom:10px;">
        <strong style="color:#ffdd80;">${dayLabel[d] || d.toUpperCase()}</strong>

        <div style="margin-top:8px;display:grid;gap:8px;">
          ${byDay[d].map(f => `
            <label style="display:flex;gap:10px;align-items:center;">
              <input class="acs-assign-check" type="checkbox" data-flight-id="${f.id}">
              <span style="font-weight:800;color:#ffe7a0;">
                ${f.origin || "‚Äî"} ‚Üí ${f.destination || "‚Äî"}
              </span>
              <span style="margin-left:auto;font-family:Orbitron,monospace;color:#00ff80;">
                ${(f.departure || "‚Äî")}‚Äì${(f.arrival || "‚Äî")}
              </span>
            </label>
          `).join("")}
        </div>
      </div>
    `).join("")}

    ${!daysSorted.length
      ? `<div class="meta-card"><strong>No unassigned flights found.</strong></div>`
      : ``}
  `;

  modal.classList.remove("hidden");
}

function ACS_toggleDayAssign(day, on){
  const modal = document.getElementById("assignFlightsModal");
  if (!modal) return;

  const checks = modal.querySelectorAll(`input.acs-assign-check`);
  checks.forEach(ch => {
    // solo los del d√≠a buscado: subimos al meta-card y leemos el t√≠tulo
    const card = ch.closest(".meta-card");
    if (!card) return;

    const head = card.querySelector("strong");
    const label = (head?.textContent || "").toLowerCase();

    const map = { mon:"mon", tue:"tue", wed:"wed", thu:"thu", fri:"fri", sat:"sat", sun:"sun" };
    const want = (map[day] || day).toLowerCase();

    // label viene "MON" etc; convertimos
    const labelDay =
      label.includes("mon") ? "mon" :
      label.includes("tue") ? "tue" :
      label.includes("wed") ? "wed" :
      label.includes("thu") ? "thu" :
      label.includes("fri") ? "fri" :
      label.includes("sat") ? "sat" :
      label.includes("sun") ? "sun" : "";

    if (labelDay === want) ch.checked = !!on;
  });
}

/* ============================================================
   üü¶ PASO 4.2 ‚Äî SELECT ALL GLOBAL (TOGGLE)
   ============================================================ */

function ACS_toggleSelectAllGlobal(){

  const modal = document.getElementById("assignFlightsModal");
  if (!modal) return;

  const checks = [...modal.querySelectorAll("input.acs-assign-check")];
  if (!checks.length) return;

  const allChecked = checks.every(ch => ch.checked === true);

  checks.forEach(ch => {
    ch.checked = !allChecked;
  });

}
     
/* ============================================================
   üüß PASO 4.3 ‚Äî GLOBAL SELECT ALL (VISIBLE CHECKS)
   ============================================================ */

function ACS_toggleAllVisibleAssign(on){
  const modal = document.getElementById("assignFlightsModal");
  if (!modal) return;

  const checks = modal.querySelectorAll("input.acs-assign-check");
  checks.forEach(ch => {
    if (!ch.disabled) ch.checked = !!on;
  });
}
     
/* ============================================================
   üü¶ PASO 6 ‚Äî CONFIRM ASSIGN (UX SAFE + MODEL ENFORCED)
   ============================================================ */

function ACS_confirmAssignFlights(){

  const ac = ACS_ASSIGN_CTX.aircraft;
  if (!ac || !ac.id) return;

  const modal = document.getElementById("assignFlightsModal");
  if (!modal) return;

  const selectedIds = Array.from(
    modal.querySelectorAll("input.acs-assign-check:checked")
  ).map(x => x.getAttribute("data-flight-id")).filter(Boolean);

  if (!selectedIds.length) {
    alert("‚ö† Select at least one flight.");
    return;
  }

  let items = [];
  try {
    items = JSON.parse(localStorage.getItem("scheduleItems")) || [];
  } catch {
    items = [];
  }

  const acModelKey = normalizeModel(ac?.model || ac?.type || "");
  let changed = 0;
  let blocked = false;

  items.forEach(it => {

    // ‚úÖ Permitir asignar:
    // - vuelos sin aircraftId
    // - vuelos editados (__edited === true) aunque tengan aircraftId (porque deben volver a Assign Route)
    if (
      it.type !== "flight" ||
      !selectedIds.includes(it.id) ||
      (it.aircraftId && it.__edited !== true)
    ) return;

    // üîí BLOQUEO DE SOLAPAMIENTO (MISMO AVI√ìN ¬∑ MISMO D√çA)
    const conflict = items.some(other =>
      other.type === "flight" &&
      other.aircraftId === ac.id &&
      other.day === it.day &&
      other.id !== it.id &&
      (
        toMin(it.departure) < toMin(other.arrival) &&
        toMin(it.arrival)   > toMin(other.departure)
      )
    );

    if (conflict) {
      alert(
        `‚õî Schedule conflict\n\n` +
        `Aircraft: ${ac.registration}\n` +
        `Day: ${it.day.toUpperCase()}\n` +
        `Time: ${it.departure}‚Äì${it.arrival}\n\n` +
        `Another flight already occupies this slot.`
      );
      blocked = true;
      return;
    }

    // ‚úÖ ASIGNACI√ìN MANUAL (aqu√≠ S√ç se permite tocar aircraftId porque es Assign Route)
    it.aircraftId = ac.id;
    it.assigned = true;

    // ‚úÖ Limpiar bandera de editado SOLO al asignar manualmente
    if (it.__edited === true) {
      delete it.__edited;
    }

    changed++;
  });


  // ‚õî BLOQUEO UX ‚Äî NO CERRAR MODAL
  if (blocked && changed === 0) {

    const warn = modal.querySelector(".meta-card");
    if (warn) {
      warn.style.animation = "shake 0.4s ease";
      warn.style.borderColor = "#ff3b3b";
      warn.style.background = "rgba(255,59,59,0.15)";
      setTimeout(() => warn.style.animation = "", 450);
    }

    return; // üî¥ CLAVE: NO cerrar modal
  }

  // ‚úÖ √âXITO REAL
  if (changed > 0) {
    localStorage.setItem("scheduleItems", JSON.stringify(items));
    ACS_closeAssignFlightsModal();
    renderSchedule();
    console.log(`üü¢ Assigned ${changed} flight(s) to ${ac.id}`);
  }
}

function ACS_closeAssignFlightsModal(){
  const modal = document.getElementById("assignFlightsModal");
  if (modal) {
    
    modal.classList.add("hidden");
  }
  ACS_ASSIGN_CTX.aircraft = null;
  ACS_ASSIGN_CTX.flightIds = [];
}
     
/* ============================================================
   === B3-A ‚Äî COSTOS INICIALES AL ASIGNAR RUTA (OPERACI√ìN) ====
   ============================================================ */
     
function ACS_applyInitialFlightCosts(route, ac){
  try {
    if (!route || !ac) return;

    // 1) Obtener aeropuerto de origen desde el JS correcto (EU/AF/ASIA seg√∫n corresponda)
    const origin = route.origin;
    let airport = null;

    if (origin?.startsWith("E")) airport = getAirportsEuropeSafe()?.find(a => a.icao === origin);
    if (origin?.startsWith("D") || origin?.startsWith("G")) airport = getAirportsAfricaSafe()?.find(a => a.icao === origin);
    if (origin?.startsWith("V") || origin?.startsWith("R")) airport = getAirportsAsiaSafe()?.find(a => a.icao === origin);

    if (!airport) return;

    const slot = airport.slot_cost_usd || 0;
    const fee  = airport.landing_fee_usd || 0;
    const fuel = airport.fuel_usd_gal || 0;

    // 2) Sumar al Finance Engine (si existe)
    let F = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");
    if (!F || typeof F.capital !== "number") return;

    const totalCost = slot + fee + (fuel * 120); // TEMPORAL
    F.capital -= totalCost;

    F.expenses = (F.expenses || 0) + totalCost;

    F.log = F.log || [];
    F.log.push({
      type: "ROUTE_ASSIGN_COST",
      route: `${route.origin}-${route.destination}`,
      aircraft: ac.registration || ac.tail || ac.model,
      amount: totalCost,
      date: new Date().toISOString()
    });

    localStorage.setItem("ACS_Finance", JSON.stringify(F));
    console.log("üí∞ B3-A aplicado:", totalCost);

  } catch(err){
    console.warn("‚ùó Error B3-A:", err);
  }
}

// ============================================================
// MAINTENANCE
// ============================================================

function openMaintModal(realModel, service = null) {

  // ============================================================
  // üîë PASO 1 ‚Äî SETEAR CONTEXTO DEL AVI√ìN (CR√çTICO)
  // ============================================================
  maintTail = realModel;   // ‚¨ÖÔ∏è SIN ESTO, applyMaintenance() NO FUNCIONA

  // ============================================================
  // üïí MAINT START TIME OPTIONS (RESTORE)
  // ============================================================
  const startSel = document.getElementById("maintStart");
  if (startSel) {
    startSel.innerHTML = "";

    for (let h = 0; h < 24; h++) {
      for (let m = 0; m < 60; m += 30) {
        const hh = String(h).padStart(2, "0");
        const mm = String(m).padStart(2, "0");
        const opt = document.createElement("option");
        opt.value = `${hh}:${mm}`;
        opt.textContent = `${hh}:${mm}`;
        startSel.appendChild(opt);
      }
    }
  }

  // Guardar service activo si existe (modo EDIT)
  window.__EDITING_SERVICE__ = service || null;

  const modal = document.getElementById("maintModal");
  if (!modal) return;

  modal.style.display = "flex";

  // ============================================================
  // üü° MODO EDICI√ìN ‚Äî PRECARGAR DATOS
  // ============================================================
  if (service && service.type === "service") {

    document.getElementById("maintType").value =
      service.serviceType || "A";

    document.getElementById("maintDay").value =
      service.day || "mon";

    document.getElementById("maintStart").value =
      service.start || "00:00";
  }
}
     
/* ============================================================
   üïí M5 ‚Äî MAINTENANCE TIME SELECTOR (5 MIN STEPS) ‚Äî 17DEC25
   ============================================================ */

function ACS_populateMaintenanceTimes() {

  const select = document.getElementById("maintStart");
  if (!select) return;

  select.innerHTML = "";

  for (let h = 0; h < 24; h++) {
    for (let m = 0; m < 60; m += 5) {

      const hh = String(h).padStart(2, "0");
      const mm = String(m).padStart(2, "0");
      const val = `${hh}:${mm}`;

      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;

      // Default = 06:00
      if (val === "06:00") opt.selected = true;

      select.appendChild(opt);
    }
  }
}
     
function closeMaintModal(){
  maintTail = null;
  document.getElementById("maintModal").style.display = "none";
}

/* ============================================================
   === A-CHECK VALIDATION ‚Äî Qatar Luxury =======================
   ============================================================ */
     
function validateACheck(ac, day, startHHMM, endHHMM) {
  if (!ac) return false;

  const items = getItems();

  const startMin = toMin(startHHMM);
  const endMin   = toMin(endHHMM);

  const acKey = normalizeModel(ac.model || ac.type || "");

  // üîé USAMOS SOLO EL VUELO ACTUAL
     
  const flight = it;
  if (!flight || flight.type !== "flight") {
  alert("‚ö† Invalid flight.");
  return;
  }

  for (const f of flights) {
    const fStart = toMin(f.departure);
    const fEnd   = toMin(f.arrival);

    const overlap =
      (startMin >= fStart && startMin < fEnd) ||
      (endMin > fStart && endMin <= fEnd) ||
      (startMin <= fStart && endMin >= fEnd);

    if (overlap) {
      const msg =
        `The selected A-Check conflicts with flight ${f.flightNumberOut} ‚Äì ${f.flightNumberIn}<br>` +
        `Flight time: ${f.departure} ‚Üí ${f.arrival}<br>` +
        `A-Check: ${startHHMM} ‚Üí ${endHHMM}`;

      showMaintenanceErrorModal(msg);
      return false;
    }
  }

  return true;
}
     
// ============================================================
// üõ† MAINTENANCE (FIX EDIT vs APPLY) ‚Äî 07 FEB 2026
// REEMPLAZA COMPLETO el bloque actual "MAINTENANCE"
// (desde: // ============================================================
//         // MAINTENANCE
//  hasta el final de applyMaintenance())
// ============================================================

let maintTail = null;          // legacy (model string)
let maintAircraftId = null;    // ‚úÖ ID real del avi√≥n (source of truth)

function openMaintModal(realModel, service = null, aircraftId = null) {

  // ============================================================
  // üîë PASO 1 ‚Äî SETEAR CONTEXTO (CR√çTICO)
  // ============================================================
  maintTail = realModel || null;
  maintAircraftId = aircraftId || null;

  // Guardar service activo si existe (modo EDIT)
  window.__EDITING_SERVICE__ = (service && service.type === "service") ? service : null;

  // ============================================================
  // üïí START TIME OPTIONS (30 MIN STEPS)
  // ============================================================
  const startSel = document.getElementById("maintStart");
  if (startSel) {
    startSel.innerHTML = "";
    for (let h = 0; h < 24; h++) {
      for (let m = 0; m < 60; m += 30) {
        const hh = String(h).padStart(2, "0");
        const mm = String(m).padStart(2, "0");
        const opt = document.createElement("option");
        opt.value = `${hh}:${mm}`;
        opt.textContent = `${hh}:${mm}`;
        startSel.appendChild(opt);
      }
    }
  }

  // ============================================================
  // üü£ UI MODE: PLAN vs EDIT (MISMO MODAL, distinto modo)
  // ============================================================
  const modal = document.getElementById("maintModal");
  if (!modal) return;

  // Cambiar t√≠tulo y bot√≥n seg√∫n modo
  const headerTitle = modal.querySelector(".acs-maint-header h3");
  const btnApply = modal.querySelector(".maint-btn.apply");

  if (window.__EDITING_SERVICE__) {
    if (headerTitle) headerTitle.textContent = "üõ† Edit Maintenance";
    if (btnApply) btnApply.textContent = "Save";
  } else {
    if (headerTitle) headerTitle.textContent = "üõ† Plan Maintenance";
    if (btnApply) btnApply.textContent = "Apply";
  }

  modal.style.display = "flex";

  // ============================================================
  // üü° MODO EDICI√ìN ‚Äî PRECARGAR DATOS
  // ============================================================
  if (window.__EDITING_SERVICE__) {
    const svc = window.__EDITING_SERVICE__;
    const typeEl = document.getElementById("maintType");
    const dayEl  = document.getElementById("maintDay");
    const stEl   = document.getElementById("maintStart");

    if (typeEl) typeEl.value = svc.serviceType || "A";
    if (dayEl)  dayEl.value  = svc.day || "mon";
    if (stEl)   stEl.value   = svc.start || "00:00";
  }
}

function closeMaintModal(){
  maintTail = null;
  maintAircraftId = null;
  window.__EDITING_SERVICE__ = null;

  const modal = document.getElementById("maintModal");
  if (modal) modal.style.display = "none";
}

/* ============================================================
   ‚úÖ VALIDATE A-CHECK ‚Äî overlap vs flights SAME aircraft/day
   ============================================================ */
function validateACheck(ac, day, startHHMM, endHHMM) {

  if (!ac || !ac.id) return false;

  const items = getItems();

  const startMin = toMin(startHHMM);
  const endMin   = toMin(endHHMM);

  if (startMin === null || endMin === null) return false;

  // Solo vuelos asignados a ESTE avi√≥n y MISMO d√≠a
  const flights = items.filter(x =>
    x &&
    x.type === "flight" &&
    x.assigned === true &&
    String(x.aircraftId || "").trim() === String(ac.id || "").trim() &&
    String(x.day || "").toLowerCase() === String(day || "").toLowerCase()
  );

  for (const f of flights) {
    const fStart = toMin(f.departure);
    const fEnd   = toMin(f.arrival);
    if (fStart === null || fEnd === null) continue;

    const overlap =
      (startMin >= fStart && startMin < fEnd) ||
      (endMin > fStart && endMin <= fEnd) ||
      (startMin <= fStart && endMin >= fEnd);

    if (overlap) {
      const msg =
        `The selected A-Check conflicts with a scheduled flight.<br>` +
        `Flight: ${f.departure} ‚Üí ${f.arrival}<br>` +
        `A-Check: ${startHHMM} ‚Üí ${endHHMM}`;

      showMaintenanceErrorModal(msg);
      return false;
    }
  }

  return true;
}

function applyMaintenance(){

  // ============================================================
  // 0) GUARDIA
  // ============================================================
  if (!maintTail && !maintAircraftId) {
    closeMaintModal();
    return;
  }

  const t = document.getElementById("maintType")?.value || "A";
  const d = document.getElementById("maintDay")?.value || "mon";
  const start = document.getElementById("maintStart")?.value || "06:00";
  const dur = (t === "A") ? 300 : 1440;

  const startMin = toMin(start);
  if (startMin === null) {
    alert("‚ö† Invalid start time.");
    return;
  }

  const end = toHHMM(startMin + dur);

  const items = getItems();
  const fleet = getRealFleet();

  // ============================================================
  // 1) IDENTIFICAR AVI√ìN (PRIORIDAD: aircraftId)
  // ============================================================
  let ac = null;

  if (maintAircraftId) {
    ac = fleet.find(x => String(x.id || "").trim() === String(maintAircraftId).trim()) || null;
  }

  // fallback legacy por modelo
  if (!ac && maintTail) {
    ac = fleet.find(x =>
      normalizeModel(x.model || x.type || "") === normalizeModel(maintTail)
    ) || null;
  }

  if (!ac) {
    alert("‚ö† Aircraft not found for maintenance.");
    closeMaintModal();
    return;
  }

  const editingService = window.__EDITING_SERVICE__;
  const isEditing = !!(editingService && editingService.id);

  // ============================================================
  // 2) VALIDACI√ìN A-CHECK (en ambos modos)
  // ============================================================
  if (t === "A") {
    const ok = validateACheck(ac, d, start, end);
    if (!ok) return; // NO cerrar: dejar corregir
  }

  // ============================================================
  // 3) CREATE: bloquear duplicados (EDIT: NO bloquearse a s√≠ mismo)
  // ============================================================
  if (!isEditing) {

    const serviceSameDay = items.some(it =>
      it &&
      it.type === "service" &&
      it.aircraftId === ac.id &&
      String(it.day || "").toLowerCase() === String(d || "").toLowerCase()
    );

    if (serviceSameDay) {
      alert("‚ö† A maintenance service is already scheduled for this aircraft on this day.");
      closeMaintModal();
      return;
    }

    const sameTypeAlready = items.some(it =>
      it &&
      it.type === "service" &&
      it.aircraftId === ac.id &&
      it.serviceType === t
    );

    if (sameTypeAlready) {
      alert(t === "A"
        ? "This aircraft already has an A-Check scheduled."
        : "This aircraft already has a B-Check scheduled."
      );
      closeMaintModal();
      return;
    }
  }

  // ============================================================
  // 4) COSTO B-CHECK (solo si se crea o si cambias a B en EDIT)
  // ============================================================
  const shouldChargeB =
    (t === "B") && (
      !isEditing || (editingService.serviceType !== "B")
    );

  if (shouldChargeB) {
    try {
      let F = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");
      if (typeof F.capital === "number") {
        const costB = 18000;
        F.capital -= costB;
        F.expenses = (F.expenses || 0) + costB;
        F.log = F.log || [];
        F.log.push({
          type: "B_CHECK",
          aircraft: ac.registration || ac.tail || ac.model,
          day: String(d || "").toUpperCase(),
          amount: costB,
          date: new Date().toISOString()
        });
        localStorage.setItem("ACS_Finance", JSON.stringify(F));
      }
    } catch (e) {
      console.warn("Finance B error:", e);
    }
  }

  // ============================================================
  // 5) ESCRITURA: EDIT ‚Üí UPDATE / CREATE ‚Üí PUSH
  // ============================================================
  if (isEditing) {

    const targetId = String(editingService.id).trim();
    const idx = items.findIndex(x =>
      x && x.type === "service" && String(x.id || "").trim() === targetId
    );

    if (idx === -1) {
      alert("‚õî Service not found to edit.");
      closeMaintModal();
      return;
    }

    const old = items[idx];

    items[idx] = {
      ...old,
      serviceType: t,
      aircraftId: ac.id,

      day: String(d || "").toLowerCase(),
      assigned: true,

      start,
      end,

      startMinute: toMin(start) ?? 0,
      endMinute:   (toMin(end) ?? (t === "B" ? 1440 : 300)),

      tail: normalizeModel(ac.model || ac.type),
      acType: ac.type || "",

      durationMin: (t === "B" ? 1440 : 300)
    };

  } else {

    items.push({
      id: "svc-" + Math.random().toString(36).slice(2, 8),
      type: "service",
      serviceType: t,

      aircraftId: ac.id,

      day: String(d || "").toLowerCase(),
      assigned: true,

      start,
      end,

      startMinute: toMin(start) ?? 0,
      endMinute:   (toMin(end) ?? (t === "B" ? 1440 : 300)),

      tail: normalizeModel(ac.model || ac.type),
      acType: ac.type || "",

      durationMin: (t === "B" ? 1440 : 300)
    });

  }

  // ============================================================
  // 6) FINAL
  // ============================================================
  setItems(items);
  closeMaintModal();
  renderSchedule();
}

function removeItem(){
  if(!selectedChip){ closeActionModal(); return; }

  const id = selectedChip.dataset.id;
  const block = selectedChip.dataset.blockId || "";
  const type = selectedChip.dataset.type;
  const items = getItems();

  let filtered;

  if (type==="flight" && block){
    filtered = items.filter(x => x.blockId !== block);
  } else {
    filtered = items.filter(x => x.id !== id);
  }

  setItems(filtered);
  closeActionModal();
  renderSchedule();
}


/* ============================================================
   üü¶ ROUTE ROTATION SOURCE (SINGLE SOURCE OF TRUTH)
   ============================================================ */

function ACS_getRouteRotationMin(){
  try {
    const r = JSON.parse(localStorage.getItem("confirmedRoute"));
    if (r && Number.isFinite(r.totalRotationMin)) {
      return r.totalRotationMin;
    }
  } catch(e){}
  return null;
}
     
/* ============================================================
   üü¶ ROTATION / NEXT FLIGHT ‚Äî MODAL (ROUTE BASED)
   ============================================================ */

function ACS_calcRotationEnd(departure){
  const rotMin = ACS_getRouteRotationMin();
  if (!departure || !Number.isFinite(rotMin)) return "‚Äî";

  const [h,m] = departure.split(":").map(Number);
  let min = h*60 + m + rotMin;
  min = min % 1440;

  return `${String(Math.floor(min/60)).padStart(2,"0")}:${String(min%60).padStart(2,"0")}`;
}
     
function ACS_calcNextFlight(it) {
  if (!it || !it.departure || !Number.isFinite(it.totalRotationMin)) return "‚Äî";

  const [h, m] = it.departure.split(":").map(Number);
  let min = h * 60 + m + it.totalRotationMin;

  if (it.maintenance === "A") min += 300;
  if (it.maintenance === "B") min += 1440;

  min = min % 1440;

  return (
    String(Math.floor(min / 60)).padStart(2, "0") +
    ":" +
    String(min % 60).padStart(2, "0")
  );
}
     
/* ============================================================
   ü¶Ñ B3 ‚Äî FLIGHT MODAL ENGINE (Unicorn) ‚Äî 17DEC25
   REEMPLAZA COMPLETO: openFlightModal(it) + closeFlightModal()
   ============================================================ */

let ACS_selectedFlightItem = null;   // el item (it)
let ACS_selectedChipEl = null;       // el chip HTML real (para ids/blockId/type)

function openFlightModal(it, chipEl){

// üîë CONTEXTO GLOBAL DEL VUELO ACTIVO (FIX)
window.ACS_selectedFlightItem = it || null;

ACS_selectedFlightItem = it || null;
ACS_selectedChipEl = chipEl || null;


/* ============================================================
   üõ† PASO 4 ‚Äî SERVICE CONTEXT (MODAL) ‚Äî 17DEC25
   ============================================================ */

if (it && it.type === "service") {

  const modal = document.getElementById("flightModal");
  const box   = document.getElementById("flightModalContent");
  const title = document.getElementById("flightModalTitle");

  const dayName = it.day ? it.day.toUpperCase() : "‚Äî";
  const start   = it.start || "‚Äî";
  const end     = it.end || "‚Äî";

  const isB = it.serviceType === "B";
  const serviceLabel = isB ? "‚öôÔ∏è B-Check" : "üîß A-Check";
  const durationText = isB
  ? "24 hours (full day)"
  : "5 hours";

  title.textContent = serviceLabel;

/* ============================================================
   üüß PASO 4.1 ‚Äî ROUTE MODEL INFO CHIP (UX)
   ------------------------------------------------------------
   ‚Ä¢ Informa la restricci√≥n por modelo (antes de asignar)
   ============================================================ */

// Modelo de la ruta (fuente real: vuelos mostrados)
const routeModelKey = normalizeModel(
  firstFlight?.acType || firstFlight?.model || firstFlight?.aircraft || ""
);
const routeModelLabelChip =
  (firstFlight?.acType || firstFlight?.model || firstFlight?.aircraft || "Unknown Model");

// Prepara chip informativo
const routeInfoChipHTML = `
  <div class="meta-card" style="
    margin-bottom:10px;
    display:flex;
    align-items:center;
    gap:8px;
    background:rgba(245,158,11,0.12);
    border:1px solid rgba(245,158,11,0.35);
  ">
    <span style="font-weight:900;color:#f59e0b;">‚ö†</span>
    <span style="font-weight:700;color:#ffe7a0;">
      Route restricted to model:
    </span>
    <span class="service-chip" style="margin-left:auto;">
      ${routeModelLabelChip}
    </span>
  </div>
`;
     
 /* ============================================================
   üüß PASO 4.2 ‚Äî ASSIGN MODAL BODY (GLOBAL SELECT ALL)
   ============================================================ */

body.innerHTML = `
  ${routeInfoChipHTML}

  <div class="flight-kicker" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <span>Select the flights you want to assign to this aircraft.</span>
    <button
      class="btn-modal ghost"
      style="padding:6px 10px;border-radius:12px;font-weight:800;"
      onclick="ACS_toggleAllVisibleAssign(true)"
    >
      Select all
    </button>
  </div>

  ${daysSorted.map(d => `
    <div class="meta-card" style="margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <strong style="color:#ffdd80;">${dayLabel[d] || d.toUpperCase()}</strong>
      </div>

      <div style="margin-top:8px;display:grid;gap:8px;">
        ${byDay[d].map(f => `
          <label style="display:flex;gap:10px;align-items:center;">
            <input class="acs-assign-check" type="checkbox" data-flight-id="${f.id}">
            <span style="font-weight:800;color:#ffe7a0;">${f.origin || "‚Äî"} ‚Üí ${f.destination || "‚Äî"}</span>
            <span style="margin-left:auto;font-family:Orbitron,monospace;color:#00ff80;">
              ${(f.departure || "‚Äî")}‚Äì${(f.arrival || "‚Äî")}
            </span>
          </label>
        `).join("")}
      </div>
    </div>
  `).join("")}

  ${!daysSorted.length ? `<div class="meta-card"><strong>No unassigned flights found.</strong></div>` : ``}
`;

  const footer = modal.querySelector(".acs-modal-footer");
  if (footer) {
    footer.innerHTML = `
      <button class="btn-modal red" onclick="cancelSelectedService()">‚ùå Cancel Service</button>
      <button class="btn-modal ghost" onclick="closeFlightModal()">Close</button>
    `;
  }

  modal.classList.remove("hidden");

  return;
}

  if (chipEl) {
    selectedChip = chipEl;
  }

  const modal = document.getElementById("flightModal");
  const box   = document.getElementById("flightModalContent");
  const title = document.getElementById("flightModalTitle");

  if (!modal || !box || !title) {
    console.warn("‚ö† flightModal elements missing.");
    return;
  }

  const items = getItems();

  const modelKey = it?.tail || it?.acType || "";
  const day      = it?.day || "";

  const flights = items.filter(x =>
    x.type === "flight" &&
    (x.tail === modelKey || x.acType === modelKey) &&
    x.day === day
  ).sort((a,b)=> toMin(a.departure)-toMin(b.departure));

  const services = items.filter(x =>
    x.type === "service" &&
    (x.tail === modelKey || x.acType === modelKey) &&
    x.day === day
  );

  const iataCode = localStorage.getItem("userIATA") || "IT";
  const fnOutRaw = it?.flightNumberOut || "";
  const fnInRaw  = it?.flightNumberIn  || "";

  const normFlight = (v) => {
    const s = String(v || "").trim().toUpperCase();
    if (!s) return "";
    const code = String(iataCode || "").trim().toUpperCase();
    if (code && s.startsWith(code)) return s.slice(code.length);
    return s;
  };

  const fnOut = normFlight(fnOutRaw);
  const fnIn  = normFlight(fnInRaw);

  const flightLabel = (fnOut && fnIn)
    ? `${iataCode}${fnOut} / ${iataCode}${fnIn}`
    : `${iataCode}‚Äî / ${iataCode}‚Äî`;

  const origin = it?.origin || "‚Äî";
  const dest   = it?.destination || "‚Äî";
  const dep    = it?.departure || "‚Äî";
  const arr    = it?.arrival || "‚Äî";

  // ============================================================
  // üîß FLIGHT PANEL ‚Äî √öNICA CORRECCI√ìN
  // ============================================================

  let route = null;
  try { route = JSON.parse(localStorage.getItem("confirmedRoute")); } catch(e){}

  const oneWayMin = route && Number.isFinite(route.blockTimeMin)
    ? route.blockTimeMin
    : (dep !== "‚Äî" && arr !== "‚Äî" ? Math.max(0, toMin(arr) - toMin(dep)) : 0);

  const blockTotalMin = oneWayMin * 2;

  const turnBase = route && Number.isFinite(route.turnaroundMin)
    ? route.turnaroundMin
    : TURNAROUND_MIN;

  let rotEnd = dep !== "‚Äî"
    ? toHHMM(toMin(dep) + oneWayMin + turnBase + oneWayMin)
    : arr;

  let nextFlightText = dep !== "‚Äî"
    ? toHHMM(toMin(dep) + oneWayMin + turnBase + oneWayMin + turnBase)
    : "‚Äî";

  const blockText =
    `${Math.floor(blockTotalMin / 60)}h${String(blockTotalMin % 60).padStart(2,"0")}`;

  const turnText = `${turnBase} min`;

  title.textContent = `‚úàÔ∏è ${flightLabel}`;

  box.innerHTML = `
    <div class="flight-kicker">
      <strong>${origin}</strong> ‚áÑ <strong>${dest}</strong>
      ${day ? `<span style="opacity:.85;"> ¬∑ ${day.toUpperCase()}</span>` : ""}
    </div>

    <div class="flight-hero">
      <div class="route">Route Panel</div>
      <div class="times">DEP ${dep} ¬∑ END ${rotEnd}</div>
    </div>

    <div class="flight-meta">
      <div class="meta-card">
        <span class="label">Block Total Time</span>
        <span class="value">${blockText}</span>
      </div>
      <div class="meta-card">
        <span class="label">Turnaround</span>
        <span class="value">${turnText}</span>
      </div>
      <div class="meta-card">
        <span class="label">Maintenance</span>
        <span class="value">None</span>
      </div>
      <div class="meta-card">
        <span class="label">Next Flight</span>
        <span class="value">${nextFlightText}</span>
      </div>
    </div>
  `;

  modal.classList.remove("hidden");
 
}

/* ============================================================
   ‚ùå PASO 4 ‚Äî CANCEL SERVICE ‚Äî 17DEC25
   ============================================================ */

function cancelSelectedService(){

  if (!ACS_selectedChipEl) {
    closeFlightModal();
    return;
  }

  const id = ACS_selectedChipEl.dataset.id || "";
  if (!id) {
    closeFlightModal();
    return;
  }

  const items = getItems();
  const filtered = items.filter(it => it.id !== id);

  setItems(filtered);
  closeFlightModal();
  renderSchedule();
}
     
/* ============================================================
   üü• HOTFIX ‚Äî RESTORE flightModal FOOTER (Edit/Remove/Delete)
   ------------------------------------------------------------
   ‚úÖ Si antes se machac√≥ el footer (por Assign), lo repara al cerrar
   ============================================================ */

function ACS_restoreFlightModalFooterDefault(){

  const modal = document.getElementById("flightModal");
  if (!modal) return;

  const footer = modal.querySelector(".acs-modal-footer");
  if (!footer) return;

  // üß† Usar selecci√≥n real (source of truth)
  const selected = Array.isArray(window.selectedFlights)
    ? window.selectedFlights
    : [];

  const canEdit = selected.length === 1;

  footer.innerHTML = `
  ${canEdit
    ? `<button class="btn-modal gold" onclick="editSelectedFlight()">‚úèÔ∏è EDIT</button>`
    : `<button class="btn-modal gold disabled" disabled>‚úèÔ∏è EDIT</button>`
  }
  <button class="btn-modal amber" onclick="ACS_removeSelectedFlights()">üßπ REMOVE FLIGHTS</button>
  <button class="btn-modal red"   onclick="deleteSelectedFlights()">üóë DELETE FLIGHTS</button>
  <button class="btn-modal ghost" onclick="closeFlightModal()">Close</button>
`;

}

function closeFlightModal(){
  const modal = document.getElementById("flightModal");
  if (modal) {
  
    modal.classList.add("hidden");
  }

  // ‚úÖ restaurar botones originales siempre
  ACS_restoreFlightModalFooterDefault();

  ACS_selectedFlightItem = null;
  ACS_selectedChipEl = null;
}

/* ============================================================
   üü¶ PASO 7 ‚Äî REMOVE FLIGHTS (UNASSIGN SINGLE FLIGHT ONLY)
   ------------------------------------------------------------
   ‚Ä¢ SOLO remueve el vuelo seleccionado
   ‚Ä¢ NO usa blockId
   ‚Ä¢ NO afecta otros vuelos
   ============================================================ */

function ACS_removeSelectedFlights(){

  if (!window.ACS_selectedFlightItem) {
    alert("‚ö† No flight selected.");
    return;
  }

  const sel = window.ACS_selectedFlightItem;

  let items = [];
  try {
    items = JSON.parse(localStorage.getItem("scheduleItems")) || [];
  } catch {
    items = [];
  }

  if (!Array.isArray(items) || !items.length) {
    alert("‚ö† No scheduled flights found.");
    return;
  }

  let removed = 0;

  items.forEach(it => {
    if (
      it.type === "flight" &&
      it.id === sel.id &&
      it.aircraftId
    ) {
      it.aircraftId = null;
      removed++;
    }
  });

  if (removed === 0) {
    alert("‚ö† This flight was not assigned.");
    return;
  }

  localStorage.setItem("scheduleItems", JSON.stringify(items));

  closeFlightModal();
  renderSchedule();

  console.log(`üü¢ Removed (unassigned) flight ${sel.id}`);
}

/* ============================================================
   üü• B3-D.3 ‚Äî DELETE SINGLE FLIGHT (SAFE ‚Äî FINAL)
   ------------------------------------------------------------
   ‚úî Elimina SOLO el vuelo seleccionado
   ‚úî Fuente √∫nica: localStorage.scheduleItems
   ‚úî NO usa blockId
   ‚úî NO usa aircraftId kill-switch
   ‚úî Limpia flightNumbers asociados
   ‚úî NO toca SkyTrack (READ ONLY)
   ============================================================ */

function deleteSelectedFlights() {

  // 0) Guardias
  if (!ACS_selectedFlightItem || !ACS_selectedChipEl) {
    console.warn("üü• DELETE: no selection (item/chip missing)");
    closeFlightModal();
    return;
  }

  const selItem = ACS_selectedFlightItem;
  const selChip = ACS_selectedChipEl;

  // 1) ID can√≥nico del vuelo
  const selId = (selChip.dataset.id || selItem.id || "").trim();
  if (!selId) {
    console.warn("üü• DELETE: missing flight id");
    closeFlightModal();
    return;
  }

  // 2) Confirmaci√≥n (destructiva)
  const ok = window.confirm(
    "‚õî This will permanently delete this flight.\n\nThis action cannot be undone."
  );
  if (!ok) return;

  // 3) Source of truth
  let items = [];
  try {
    items = JSON.parse(localStorage.getItem("scheduleItems") || "[]");
  } catch {
    items = [];
  }

  if (!Array.isArray(items) || !items.length) {
    localStorage.removeItem("scheduleItems");
    closeFlightModal();
    renderSchedule();
    return;
  }

  // 4) Localizar vuelo objetivo
  const target = items.find(it =>
    it &&
    it.type === "flight" &&
    String(it.id || "").trim() === selId
  );

  if (!target) {
    console.warn("üü• DELETE: target not found", selId);
    closeFlightModal();
    return;
  }

  // 5) Liberar flightNumbers (si aplica)
  try {
    let used = JSON.parse(localStorage.getItem("flightNumbers") || "[]");
    if (Array.isArray(used)) {
      if (target.flightNumberOut) {
        used = used.filter(n => n !== target.flightNumberOut);
      }
      if (target.flightNumberIn) {
        used = used.filter(n => n !== target.flightNumberIn);
      }
      localStorage.setItem("flightNumbers", JSON.stringify(used));
    }
  } catch (e) {}

  // 6) HARD DELETE ‚Äî SOLO este vuelo
  const remaining = items.filter(it =>
    !(it &&
      it.type === "flight" &&
      String(it.id || "").trim() === selId)
  );

// ============================================================
// 7Ô∏è‚É£ PERSISTENCIA
// ============================================================
if (!remaining.length) {
  localStorage.removeItem("scheduleItems");
} else {
  localStorage.setItem("scheduleItems", JSON.stringify(remaining));
}

// ============================================================
// üü¢ FASE A1 ‚Äî OPS LIVE NOTIFY (ROUTE CHANGE ‚Üí OPS)
// ------------------------------------------------------------
// Purpose:
// ‚Ä¢ Notify OPS that scheduleItems changed
// ‚Ä¢ Trigger HR recalculation if OPS engine is available
// ------------------------------------------------------------
// Safety:
// ‚Ä¢ Does NOT modify scheduleItems
// ‚Ä¢ Does NOT affect delete logic
// ‚Ä¢ Safe if OPS engine not loaded
// ============================================================
if (typeof window.ACS_OPS_recalculateAllRequired === "function") {
  console.log("üü¢ OPS NOTIFY: scheduleItems changed (from Schedule Table)");
  window.ACS_OPS_recalculateAllRequired();
} else {
  console.warn("‚ö†Ô∏è OPS engine not loaded ‚Äî live recalculation skipped");
}
     
// ============================================================
// 8Ô∏è‚É£ LOG DELETE (DEBUG)
// ============================================================
console.log("üü• DELETE SINGLE OK", {
  deletedId: selId,
  remaining: remaining.length
});

// ============================================================
// üü¢ FASE 2.1 ‚Äî OPS LIVE RECALC TRIGGER (DELETE ROUTE ‚Üí HR)
// ============================================================
try {
  if (typeof ACS_OPS_recalculateAllRequired === "function") {
    ACS_OPS_recalculateAllRequired();
    console.log(
      "%cüü¢ OPS LIVE RECALC TRIGGERED AFTER ROUTE DELETE",
      "color:#00ffcc;font-weight:700"
    );
  } else {
    console.warn("‚ö†Ô∏è OPS engine not loaded");
  }
} catch (e) {
  console.warn("‚ö†Ô∏è OPS LIVE RECALC FAILED:", e);
}

// ============================================================
// 9Ô∏è‚É£ UI
// ============================================================
closeFlightModal();
renderSchedule();
}
     
/* ============================================================
   üü© B2 ‚Äî EDIT SELECTED FLIGHT (EACH DAY FIX)
   ------------------------------------------------------------
   RULES:
   - Every Day  ‚Üí preserve full days block
   - Each Day  ‚Üí send ONLY the single day being edited
   ============================================================ */

function editSelectedFlight() {

  if (!window.selectedFlight || !window.selectedFlight.data) {
    alert("‚ö† No flight selected for edit.");
    return;
  }

  const it = window.selectedFlight.data;

  const isEachDay = !it.blockId || it.blockId === "";

  const editCtx = {
    mode: "EDIT",

    // ‚úÖ FIX CR√çTICO ‚Äî ESTE ERA EL PROBLEMA
    flightId: it.id,

    origin: it.origin,
    destination: it.destination,

    aircraftId: it.aircraftId || "",
    aircraft: it.acType || "",

    departure: it.departure,
    arrival: it.arrival,

    flightNumberOut: it.flightNumberOut || "",
    flightNumberIn:  it.flightNumberIn  || "",

    blockTimeMin: it.blockTimeMin || null,

    separateDays: isEachDay
  };

  if (isEachDay) {
    editCtx.day  = it.day;
    editCtx.days = [it.day];
  } else {
    editCtx.days = Array.isArray(it.days) && it.days.length
      ? it.days
      : ["mon","tue","wed","thu","fri","sat","sun"];
  }

  localStorage.setItem("ACS_ROUTE_EDIT", JSON.stringify(editCtx));
  window.location.href = "route_schedule.html";
}

// ============================================================
// LOGOUT
// ============================================================
function handleLogout(){
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href="login.html";
}
     
</script>
<!-- ============================================================
     === SCHEDULE ENGINE ‚Äî FINAL SETUP (PART 5 / 5) ============
     ============================================================ -->
<script>

/* ============================================================
   1) VALIDACI√ìN FINAL DE MODALES EXISTENTES
   ============================================================ */

(function validateModals(){
  const required = [
  "maintModal",
  "flightModal",
  "scheduleTable",
  "scheduleBody"
];

  required.forEach(id=>{
    if(!document.getElementById(id)){
      console.warn(`‚ö† Missing element: #${id}`);
    }
  });
})();

/* ============================================================
   2) CLASES FINALES PARA OVALOS (CHIPS) ‚Äî CRUZAR D√çAS
   ============================================================ */

(function addChipStyles(){

  const style = document.createElement("style");
  style.innerHTML = `
    .chip {
      position: relative;
      display: inline-flex;
      flex-wrap: nowrap;
      align-items: center;
      justify-content: center;
      border-radius: 18px;
      padding: 3px 12px;
      font-weight: 700;
      background: #102b4d;
      border: 1px solid rgba(255,200,60,0.30);
      box-shadow: 0 0 10px rgba(255,200,60,0.30);
      backdrop-filter: blur(4px);
      transition: 0.15s ease;
      margin-bottom: 4px;
    }

    .chip:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 14px rgba(255,200,60,0.55);
    }
  `;
  document.head.appendChild(style);

})();

/* === DISABLED MULTI-DAY CHIP SUPPORT PER NEW RULES === */
     
(function multiDayChipSupport(){})();


function applyLongChipBehavior(){
  /* disabled per new Qatar rules */
}

/* === DISABLED CHIP-LONG MONITOR === */
     
(function monitorSchedule(){

  if (typeof window.renderSchedule !== "function") {
    console.warn("‚ö† renderSchedule not found, monitor skipped");
    return;
  }

  const orig = window.renderSchedule;

  window.renderSchedule = function(){
    orig();
    // chip-long disabled
  };

})();


/* ============================================================
   üü¶ B3-C ‚Äî OPERATING COST ENGINE (por vuelo) ‚Äî Qatar Luxury v1.0
   ------------------------------------------------------------
   - Cobra combustible, handling y mantenimiento
   - Solo cuando el vuelo "arranca"
   - Se ejecuta seg√∫n ACS_TIME (motor global)
   ============================================================ */

(function(){

    // Registro para no cobrar dos veces el mismo vuelo en el mismo d√≠a sim
    function hasFlightBeenChargedToday(flightID, simDate){
        const key = `ACS_FlightCharge_${flightID}_${simDate}`;
        return localStorage.getItem(key) === "YES";
    }

    function markFlightCharged(flightID, simDate){
        const key = `ACS_FlightCharge_${flightID}_${simDate}`;
        localStorage.setItem(key, "YES");
    }

    // üî• EVENTO: cada vez que ACS_TIME avanza
    if (typeof registerTimeListener === "function") {

        registerTimeListener(function(){

            const items  = JSON.parse(localStorage.getItem("scheduleItems") || "[]");
            const fleet  = JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");

/* ============================================================
   üü¶ A10.17.2 ‚Äî APPLY MAINTENANCE DUE FLAGS
   ============================================================ */
const nowTs = Date.now();

fleet.forEach(ac => {
  ACS_calculateMaintenanceDue(ac, nowTs);
});
             
/* ============================================================
   üü¶ A10.17.2 ‚Äî MAINTENANCE DUE CALCULATOR
   ------------------------------------------------------------
   ‚Ä¢ NO inserta servicios
   ‚Ä¢ NO bloquea vuelos
   ‚Ä¢ SOLO marca aDue / bDue
   ============================================================ */

function ACS_calculateMaintenanceDue(aircraft, nowTs) {

  if (!aircraft) return aircraft;

  const WEEK_MS  = 7  * 24 * 60 * 60 * 1000;
  const MONTH_MS = 30 * 24 * 60 * 60 * 1000;

  const refA = aircraft.lastACheckAt || aircraft.enteredFleetAt;
  const refB = aircraft.lastBCheckAt || aircraft.enteredFleetAt;

  if (!aircraft.maintenance) {
    aircraft.maintenance = {};
  }

  aircraft.maintenance.aDue = false;
  aircraft.maintenance.bDue = false;

  if (refA && (nowTs - refA) >= WEEK_MS) {
    aircraft.maintenance.aDue = true;
  }

  if (refB && (nowTs - refB) >= MONTH_MS) {
    aircraft.maintenance.bDue = true;
  }

  return aircraft;
}
             
            // Fecha simulada YYYY-MM-DD
            const simDate = (typeof ACS_TIME !== "undefined" && ACS_TIME.simDate)
                           ? ACS_TIME.simDate
                           : new Date().toISOString().slice(0,10);

            // Hora simulada HH:MM
            const simTime = (typeof ACS_TIME !== "undefined" && ACS_TIME.simClock)
                           ? ACS_TIME.simClock
                           : "00:00";

            const toMin = t => {
                const [h,m] = t.split(":").map(Number);
                return h*60 + m;
            };

            const simMin = toMin(simTime);

            items.forEach(f => {

                if (f.type !== "flight") return;

                // ¬øFANTASMA?
                const ac = fleet.find(a => a.tail === f.tail || a.registration === f.tail);
                if (!ac) return;  // sin avi√≥n ‚Üí no se opera

                // ¬øMantenimiento?
                if (ac.status === "In C-Check" || ac.status === "In D-Check" || ac.status === "B-Check"){
                    return;
                }

                // ¬øCoincide hora de salida?
                const depMin = toMin(f.departure);
                if (depMin !== simMin) return;

                // ¬øYa cobrado hoy?
                if (hasFlightBeenChargedToday(f.id, simDate)) return;

                // =============== COSTOS DE OPERACI√ìN ===============
                const dist   = Number(f.distanceNM || 0);
                const block  = Number(f.blockTime || 0);
                const acType = f.acType || "";

                // Buscar categor√≠a/modelo para fuel burn
                const acOpt = fleet.find(a => a.tail === f.tail || a.registration === f.tail);
                const category = acOpt?.category || "JET";

                // Fuel burn ~ optimizado (kg por hora)
                const fuelBurnPerHour =
                      category.includes("ATR")     ? 900 :
                      category.includes("REGIONAL")? 1800 :
                      2500;

                const flightHours = block / 60;
                const fuelKG = fuelBurnPerHour * flightHours;
                const fuelUSD = fuelKG * 0.85;

                const handlingUSD     = 350;
                const maintenanceUSD  = 180;

                const totalUSD = Math.round(fuelUSD + handlingUSD + maintenanceUSD);

                // Registrar en Finance Engine
                if (typeof ACS_Finance === "object" &&
                    typeof ACS_Finance.registerExpense === "function") {

                    ACS_Finance.registerExpense({
                        amount: totalUSD,
                        category: "Operational Cost",
                        description: `Flight ${f.flightNumberOut} ‚Äî Fuel/Handling/Maint @ ${f.origin}`,
                        timestamp: new Date().toISOString()
                    });
                }

/* ============================================================
   üüß A18.1 ‚Äî PASSENGERS & REVENUE (REALISTIC GROWTH)
   ------------------------------------------------------------
   ‚Ä¢ Growth in 14-day steps
   ‚Ä¢ No classes yet
   ‚Ä¢ Revenue registered per flight
   ============================================================ */

// --- Aircraft capacity ---
const seats = acOpt?.seats || 0;
if (seats <= 0) return;

// --- Route age (days since first flight on this route) ---
const routeKey = `${f.origin}-${f.destination}`;
const routeStartKey = `ACS_ROUTE_START_${routeKey}`;

let routeStartTs = localStorage.getItem(routeStartKey);
if (!routeStartTs) {
  routeStartTs = Date.now();
  localStorage.setItem(routeStartKey, routeStartTs);
}

const daysActive = Math.floor(
  (Date.now() - Number(routeStartTs)) / (24 * 60 * 60 * 1000)
);

// --- Growth factor (14-day steps) ---
let growthFactor = 0.20;
if (daysActive >= 56) growthFactor = 0.90;
else if (daysActive >= 42) growthFactor = 0.75;
else if (daysActive >= 28) growthFactor = 0.55;
else if (daysActive >= 14) growthFactor = 0.35;

// --- Daily demand (already realistic engine) ---
let dailyDemand = 0;
if (typeof ACS_PAX === "object" &&
    typeof ACS_PAX.getDailyDemand === "function") {

  dailyDemand = ACS_PAX.getDailyDemand(
    f.originData,
    f.destinationData,
    Number(f.distanceNM || 0),
    Number(ACS_TIME?.year || new Date().getFullYear())
  );
}

// --- Passengers on this flight ---
let pax = Math.floor(Math.min(seats, dailyDemand * growthFactor));
if (pax < 0) pax = 0;

// --- Ticket price (simple & distance-based) ---
let ticketPrice = 120;
if (f.distanceNM > 3000) ticketPrice = 220;
else if (f.distanceNM > 1200) ticketPrice = 140;

// --- Revenue ---
const revenueUSD = pax * ticketPrice;

// --- Register income ---
if (revenueUSD > 0 &&
    typeof ACS_Finance === "object" &&
    typeof ACS_Finance.registerIncome === "function") {

  ACS_Finance.registerIncome({
    amount: revenueUSD,
    category: "Flight Revenue",
    description: `Flight ${f.flightNumberOut} ‚Äî ${pax} pax`,
    timestamp: new Date().toISOString()
  });
}

console.log(
  `üí∞ A18.1 Revenue: $${revenueUSD} | Pax: ${pax}/${seats} | Growth ${(growthFactor*100).toFixed(0)}%`
);
                 
                console.log(`‚úàÔ∏èüí∞ B3-C charged: $${totalUSD} (flight ${f.flightNumberOut})`);

                // Marcar cobrado
                markFlightCharged(f.id, simDate);
            });
        });
    }

})();
     

/* ============================================================
   7) LOG
   ============================================================ */

console.log("üü¶ ACS Schedule Module ‚Äî FINALIZED (PART 5 / 5) ‚Äî Qatar Luxury Edition");

/* ============================================================
   üü¶ STEP A ‚Äî LOAD ROUTES (14 DEC 2025)
   ============================================================ */
     
function ACS_loadRoutesStepA() {

  console.log("üü¶ STEP A ‚Äî Loading routes...");

  const routes = JSON.parse(localStorage.getItem("scheduleItems") || "[]");

  if (!Array.isArray(routes)) {
    console.warn("‚ö† scheduleItems no es un array. Valor:", routes);
    window.ACS_Routes_Stored = [];
    return;
  }

  console.log(`üîç Encontradas ${routes.length} rutas guardadas:`);
  routes.forEach((rt, i) => console.log(`‚Äî Ruta #${i+1}:`, rt));

  window.ACS_Routes_Stored = routes;
}

/* ============================================================
   üü¶ STEP B ‚Äî MAP AICRAFT
   ============================================================ */ 
     
function ACS_mapAircraftRows() {

  console.log("üü¶ STEP B ‚Äî Mapping aircraft rows...");

  const map = {};
  const rows = document.querySelectorAll("#scheduleTable tbody tr");

  rows.forEach(tr => {

    // Preferimos el TD con clase .col-aircraft (tu est√°ndar)
    const col = tr.querySelector(".col-aircraft");

    // üî• Tomar modelo desde TODOS los sitios posibles
    const rawModel =
      (col?.dataset.modelRaw || "") ||
      (col?.dataset.model || "") ||
      (tr.dataset.modelRaw || "") ||
      (tr.dataset.model || "");

    const cleanedRaw = String(rawModel || "").trim();

    // Evitar filas vac√≠as
    if (!cleanedRaw || cleanedRaw === "(empty)") return;

    const key = normalizeModel(cleanedRaw);

    if (key) {
      map[key] = tr;
    }
  });

  window.ACS_RowMap = map;
  console.log("üü¶ Mapped rows (MODEL KEYS):", map);
}

// -----------------------------------------------------------
// üü¶ PAINT FLIGHT OVAL ‚Äî v2.0 (REAL ROUTE NUMBERS)
// -----------------------------------------------------------
function buildFlightOval(route) {

  const fnOut = route.flightNumberOut || "";
  const fnIn  = route.flightNumberIn  || "";

  const fnText = (fnOut && fnIn) ? `${fnOut} - ${fnIn}` : "‚Äî";

  return `
      <div class="flightChip" onclick="openFlightModal('${route.id}')">
         ${fnText}
      </div>
  `;
}
     
/* ============================================================
   üü¢ STEP C ‚Äî PAINT ROUTES (AIRCRAFT ID ARCHITECTURE)
   ============================================================ */
     
function ACS_paintRoutesStepC() {

  console.log("üü¢ STEP C ‚Äî Painting routes by aircraftId...");

  const routes = window.ACS_Routes_Stored || [];
  const rowMap = window.ACS_RowMap || {};

  if (!routes.length) {
    console.log("‚ö† No hay rutas para pintar.");
    return;
  }

  routes.forEach(route => {

    // (opcional) solo vuelos
    // if (route.type && route.type !== "flight") return;

    const aircraftId = route.aircraftId || "";

    if (!aircraftId) return; // a√∫n no asignado ‚Üí no pintar

    const tr = rowMap[aircraftId];

    if (!tr) {
      console.warn(`‚ö† No row found for aircraftId: ${aircraftId}`);
      return;
    }

    // MAPA DE CELDAS POR D√çA (MISMO ORDEN QUE YA TIENES)
    const cells = tr.querySelectorAll("td");
    const map = {
      mon: cells[1],
      tue: cells[2],
      wed: cells[3],
      thu: cells[4],
      fri: cells[5],
      sat: cells[6],
      sun: cells[7]
    };

    // OVALO (CHIP) DEL VUELO
    const flightOval = buildFlightOval(route);

    // Pintar en d√≠as
    (route.days || []).forEach(dayID => {
      const td = map[dayID];
      if (td) td.insertAdjacentHTML("beforeend", flightOval);
    });

  });

}

// ============================================================
// üü¶ 3D.2 ‚Äî DOM READY (Schedule Table ‚Äî aircraftId ONLY)
// ============================================================
     
document.addEventListener("DOMContentLoaded", () => {

  // Render principal de la tabla
  if (typeof renderSchedule === "function") {
    renderSchedule();
  } else {
    console.warn("‚ö† renderSchedule no est√° disponible.");
  }

  // ‚ùå LEGACY DISABLED (modelKey architecture)
  // ACS_loadRoutesStepA();
  // ACS_mapAircraftRows();
  // ACS_paintRoutesStepC();

});

/* === MODAL ERROR FUNCTIONS ‚Äî Qatar Luxury === */

function showMaintenanceErrorModal(message) {
  document.getElementById("maintenanceErrorText").textContent = message;
  document.getElementById("maintenanceErrorModal").style.display = "flex";
}

function closeMaintenanceErrorModal() {
  document.getElementById("maintenanceErrorModal").style.display = "none";
}
     
let selectedChip = null;

function openActionModal(chip){
  selectedChip = chip;
  document.getElementById("actionModal").style.display = "flex";
}

function closeActionModal(){
  selectedChip = null;
  document.getElementById("actionModal").style.display = "none";
}
     
/* ============================================================
   ‚è± PASO 3 ‚Äî SORT DAY EVENTS BY START TIME ‚Äî 17DEC25
   ============================================================ */

function ACS_sortDayEvents(events) {
  return events.slice().sort((a, b) => {
    const aMin = a.start ? toMin(a.start) : 0;
    const bMin = b.start ? toMin(b.start) : 0;
    return aMin - bMin;
  });
}
          
</script>

<script>
/* ============================================================
   üü¶ ACS SLOT ENGINE ‚Äî SIMPLE v1.0 (PASO 3)
   ------------------------------------------------------------
   ‚Ä¢ Reserva slots por VUELO
   ‚Ä¢ Sin optimizaci√≥n
   ‚Ä¢ Sin edici√≥n
   ‚Ä¢ Sin EveryDay
   ============================================================ */

function ACS_reserveSlotSimple(flight) {

  if (!flight || !flight.origin || !flight.destination || !flight.day) {
    console.error("‚õî Invalid flight for slot reservation", flight);
    return false;
  }

  let slots = [];
  try {
    slots = JSON.parse(localStorage.getItem("ACS_SLOTS_SIMPLE")) || [];
  } catch {
    slots = [];
  }

  const depSlot = {
    airport: flight.origin,
    day: flight.day,
    time: flight.departure,
    flightId: flight.id,
    type: "DEP"
  };

  const arrSlot = {
    airport: flight.destination,
    day: flight.day,
    time: flight.arrival,
    flightId: flight.id,
    type: "ARR"
  };

  const conflict = slots.find(s =>
    s.airport === depSlot.airport &&
    s.day === depSlot.day &&
    s.time === depSlot.time
  );

  if (conflict) {
    console.warn("‚õî Slot conflict detected:", conflict);
    return false;
  }

  slots.push(depSlot, arrSlot);
  localStorage.setItem("ACS_SLOTS_SIMPLE", JSON.stringify(slots));

  console.log("üü¢ Slots reserved:", depSlot, arrSlot);
  return true;
}
</script>

<script>
/* ============================================================
   ‚úàÔ∏è ACS ‚Äî CREATE FLIGHTS FROM ROUTE (PASO 3)
   ------------------------------------------------------------
   ‚Ä¢ 1 flight = 1 day
   ‚Ä¢ Slot simple incluido
   ‚Ä¢ NO EveryDay
   ============================================================ */

function ACS_createFlightsFromRoute(route) {

  if (!route || !Array.isArray(route.days)) {
    console.error("‚õî Invalid route", route);
    return;
  }

  let flights = [];
  try {
    flights = JSON.parse(localStorage.getItem("ACS_FLIGHTS")) || [];
  } catch {
    flights = [];
  }

  route.days.forEach(day => {

    const flightId = "FL_" + Math.floor(100000 + Math.random() * 900000);

    const flight = {
      id: flightId,
      routeId: route.id,
      model: route.model,
      origin: route.origin,
      destination: route.destination,
      day: day,
      departure: route.departure,
      arrival: route.arrival,
      status: "PLANNED"
    };

    const slotOK = ACS_reserveSlotSimple(flight);
    if (!slotOK) {
      alert(`‚ùå Slot conflict on ${day} ${flight.origin}`);
      return;
    }

    flights.push(flight);
  });

  localStorage.setItem("ACS_FLIGHTS", JSON.stringify(flights));
  console.log("üü¢ Flights created from route:", flights);
}
</script>
     
</body>
</html>
