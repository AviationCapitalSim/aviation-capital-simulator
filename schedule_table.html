<!-- ============================================================
     === SCHEDULE TABLE ‚Äî Qatar Luxury Stable Core v1.0 =========
     ============================================================ -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Schedule Table - Aviation Capital Simulator</title>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png" />
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png" />
  <link rel="apple-touch-icon" href="acs_logo_180.png" />

<style>
/* ============================================================
   GLOBAL
   ============================================================ */
body {
  margin: 0;
  background-color: #081530;
  color: white;
  font-family: "Poppins", sans-serif;
}

/* ============================================================
   HEADER Qatar Luxury
   ============================================================ */
.acs-header {
  position: fixed;
  top: 0;
  width: 100%;
  backdrop-filter: blur(9px);
  background: rgba(12,23,50,0.45);
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffb300;
  z-index: 5000;
}

.acs-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.acs-left img {
  height: 46px;
}

.acs-left h1 {
  font-size: 1.15rem;
  margin: 0;
  color: #ffb300;
  letter-spacing: 0.5px;
}

.acs-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 2rem;
}

.acs-nav a {
  position: relative;
  font-size: 1rem;
  color: #dbe4ff;
  text-decoration: none;
  transition: 0.25s ease;
  padding-bottom: 6px;
}

.acs-nav a:hover,
.acs-nav a.active {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.6);
}

.acs-nav a.active::after,
.acs-nav a:hover::after {
  content: "";
  position: absolute;
  bottom: -8px;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, #ffb300, #ffe7a0);
  border-radius: 2px;
}

/* RIGHT */
.acs-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.support-btn {
  padding: 0.45rem 1.1rem;
  border-radius: 12px;
  font-size: 0.9rem;
  color: #8AB4FF;
  border: 1px solid rgba(138,180,255,0.45);
  background: rgba(138,180,255,0.08);
}

.logout-btn {
  padding: 0.45rem 1.1rem;
  border: 1px solid #ffb300;
  border-radius: 12px;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  font-weight: 600;
  cursor: pointer;
}

.acs-clock-header {
  font-family: "Orbitron", monospace;
  padding: 0.4rem 0.8rem;
  background: rgba(0,255,128,0.08);
  border-radius: 8px;
  font-size: 0.95rem;
  color: #00ff80;
}

/* ============================================================
   MAIN
   ============================================================ */
.acs-main {
  padding: 110px 2rem 70px;
  text-align: center;
}

.sub {
  margin-top: -0.4rem;
  color: #cbd6ff;
  font-size: 1rem;
}

/* ============================================================
   TABLE ‚Äî Qatar Luxury
   ============================================================ */
table {
  width: 90%;
  margin: 0 auto;
  border-collapse: collapse;
  background: linear-gradient(180deg, rgba(20,35,70,0.75), rgba(10,18,40,0.85));
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 0 20px rgba(255,179,0,0.1);
  border: 1px solid rgba(255,179,0,0.15);
}

th {
  background: rgba(255,179,0,0.15);
  color: #ffca3a;
  padding: 1rem;
  font-size: 1rem;
  text-shadow: 0 0 6px rgba(255,200,80,0.4);
}

td {
  background: rgba(10,20,45,0.8);
  border: 1px solid rgba(255,255,255,0.05);
  padding: 0.8rem;
  color: #dbe4ff;
  text-align: center;
  font-size: 0.92rem;
}

/* ============================================================
   CHIPS
   ============================================================ */
.chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: #0c2b52;
  padding: 5px 10px;
  margin: 2px 0;
  border-radius: 8px;
  color: #ffca3a;
  font-weight: 700;
  font-size: 0.85rem;
  box-shadow: 0 0 8px rgba(255,200,60,0.25);
  cursor: pointer;
  position: relative;
}

.chip .tooltip {
  position: absolute;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  padding: 6px 10px;
  background: #ffca3a;
  color: #0c1f3c;
  border-radius: 6px;
  display: none;
  font-size: 0.75rem;
  white-space: nowrap;
  z-index: 99999;
}

.chip:hover .tooltip {
  display: block;
}

/* ============================================================
   BUTTONS
   ============================================================ */
.btn {
  border-radius: 14px;
  padding: 7px 12px;
  font-weight: 600;
  cursor: pointer;
  border: none;
}

.btn-assign {
  background: #00a86b;
  color: #fff;
}

.btn-maint {
  background: #ffb300;
  color: #0d1b34;
}

/* ============================================================
   FOOTER
   ============================================================ */
footer {
  text-align: center;
  color: #7c8bb8;
  padding: 2rem 0;
  margin-top: 2rem;
}
</style>
</head>

<body>
<header class="acs-header">
  <div class="acs-left">
    <img src="acs_logo.png" />
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="finance.html">Bank</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html" class="active">Routes</a>
    <a href="hr.html">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
    <div id="acs-clock" class="acs-clock-header">00:00 ‚Äî 01 JAN 1940</div>
  </div>
</header>

<main class="acs-main">
  <h2 style="font-size:1.9rem;font-weight:700;color:#ffca3a;text-shadow:0 0 10px rgba(255,200,60,0.55);">
    üìÖ Weekly Flight Schedule
  </h2>

  <p class="sub">Automatic schedule monitor with real-time route integration.</p>

  <table id="scheduleTable">
    <thead>
      <tr>
        <th>Aircraft</th>
        <th>Mon</th>
        <th>Tue</th>
        <th>Wed</th>
        <th>Thu</th>
        <th>Fri</th>
        <th>Sat</th>
        <th>Sun</th>
        <th>Action Plan</th>
      </tr>
    </thead>
    <tbody id="scheduleBody"></tbody>
  </table>

  <p id="updateTime" style="margin-top:1rem;">Last update: --</p>

  <button class="back-btn" onclick="window.location.href='routes.html'">
    ‚¨Ö Back to Routes
  </button>
</main>

<!-- ============================================================
     MODALES
     ============================================================ -->
<div id="actionModal" class="modal"><div class="modal-content"></div></div>
<div id="maintModal" class="modal"><div class="modal-content"></div></div>
<div id="flightModal" class="modal"><div class="modal-content"></div></div>

<footer>¬© 2025 Aviation Capital Simulator</footer>
<!-- ============================================================
     === SCHEDULE ENGINE ‚Äî Qatar Luxury Stable Core v1.0 ========
     ============================================================ -->
<script>
/* ============================================================
   CONSTANTES
   ============================================================ */
const days = ["mon","tue","wed","thu","fri","sat","sun"];
const STORE_KEY = "scheduleItems";         // vuelos + maintenance
const ROUTE_KEY = "confirmedRoute";        // ruta seleccionada
const TURNAROUND_MIN = 45;                 // 45 min base turnaround

/* ============================================================
   UTILIDADES
   ============================================================ */
const toMin = t => {
  const [h,m] = t.split(":").map(Number);
  return h*60+m;
};

const toHHMM = min => {
  const h = Math.floor(min/60)%24;
  const m = min%60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
};

const getItems = () =>
  JSON.parse(localStorage.getItem(STORE_KEY) || "[]");

const setItems = (list) =>
  localStorage.setItem(STORE_KEY, JSON.stringify(list));

const getRoute = () => {
  const r = localStorage.getItem(ROUTE_KEY);
  return r ? JSON.parse(r) : null;
};

/* ============================================================
   FLEET (VERSI√ìN FUNCIONAL DE NOVIEMBRE)
   ============================================================ */
function getRealFleet(){
  return JSON.parse(localStorage.getItem("ACS_MyFleet") || "[]");
}

function setFleet(f){
  localStorage.setItem("ACS_MyFleet", JSON.stringify(f));
}

(function initFleet(){
  const f = getRealFleet();
  if (!Array.isArray(f)) setFleet([]);
})();

/* ============================================================
   HOVER CARD ‚Äî Qatar Luxury (estable)
   ============================================================ */
function showAircraftHover(ac, cell){

  const old = document.querySelector(".aircraft-hover-card");
  if (old) old.remove();

  const st = ac.status || "";
  if(!["In C-Check","In D-Check","Pending Delivery","B-Check"].includes(st)){
    return;
  }

  const card = document.createElement("div");
  card.className = "aircraft-hover-card";

  const start = ac.lastC || ac.lastD || ac.deliveryStart || null;
  const end   = ac.deliveryDate || ac.nextC || ac.nextD || null;

  const label =
    st === "In C-Check" ? "C-Check üõ†" :
    st === "In D-Check" ? "D-Check ‚öôÔ∏è" :
    st === "Pending Delivery" ? "Delivery ‚è≥" :
    st === "B-Check" ? "B-Check üîß" : "";

  let pct = 0;
  if(start && end){
    const now = new Date();
    pct = ((now - new Date(start)) / (new Date(end) - new Date(start))) * 100;
    pct = Math.max(0, Math.min(100, pct));
  }

  card.innerHTML = `
    <h4>${ac.registration} ‚Äî ${label}</h4>
    <p style="font-size:0.85rem;">
      Start: ${start ? new Date(start).toDateString() : "‚Äî"}<br>
      End: ${end ? new Date(end).toDateString() : "‚Äî"}
    </p>
    <div class="progress-bar">
      <div class="progress-fill" style="width:${pct.toFixed(0)}%"></div>
    </div>
    <span class="progress-label">${pct.toFixed(0)}%</span>
  `;

  cell.style.position="relative";
  cell.appendChild(card);
  setTimeout(()=>card.classList.add("visible"),10);
}

function hideAircraftHover(){
  const c = document.querySelector(".aircraft-hover-card");
  if(c) c.remove();
}

/* ============================================================
   RENDER PRINCIPAL DEL SCHEDULE (VERSI√ìN ESTABLE)
   ============================================================ */
function renderSchedule(){

  const tbody = document.getElementById("scheduleBody");
  tbody.innerHTML = "";

  const items = getItems();
  const fleet = getRealFleet();

  const byTail={};
  items.forEach(it=>{
    if(!byTail[it.tail]) byTail[it.tail]=[];
    byTail[it.tail].push(it);
  });

  /* ============================================================
     SIN FLOTA ‚Äî 5 filas dummy
     ============================================================ */
  if(fleet.length === 0){
    for(let i=0;i<5;i++){
      const tr=document.createElement("tr");
      const tdTail=document.createElement("td");
      tdTail.textContent="(empty)";
      tr.appendChild(tdTail);

      days.forEach(()=>{
        const td=document.createElement("td");
        td.textContent="‚Äî";
        tr.appendChild(td);
      });

      const plan=document.createElement("td");
      const wrap=document.createElement("div");
      wrap.className="plan-actions";

      const a=document.createElement("button");
      a.className="btn btn-assign";
      a.textContent="Assign Route";
      a.onclick=()=>alert("‚ö† No aircraft available.");

      const b=document.createElement("button");
      b.className="btn btn-maint";
      b.textContent="Plan Maint";
      b.onclick=()=>alert("‚ö† No aircraft available.");

      wrap.appendChild(a);
      wrap.appendChild(b);
      plan.appendChild(wrap);
      tr.appendChild(plan);

      tbody.appendChild(tr);
    }

    document.getElementById("updateTime").textContent =
      "Last update: "+new Date().toLocaleTimeString();
    return;
  }

  /* ============================================================
     CON FLOTA ‚Äî FILAS REALES
     ============================================================ */
  fleet.forEach(ac=>{

    const tr=document.createElement("tr");

    /* AIRCRAFT COLUMN */
    const tdTail=document.createElement("td");
    tdTail.innerHTML=`
      <strong>${ac.registration}</strong><br>
      <span style="font-size:0.85rem;color:#ffca3a;">
        ${ac.type}
      </span><br>
      ${ac.status ? ("<span>"+ac.status+"</span>") : ""}
    `;
    tdTail.onmouseenter=()=>showAircraftHover(ac,tdTail);
    tdTail.onmouseleave=hideAircraftHover;
    tr.appendChild(tdTail);

    /* D√çAS */
    days.forEach(day=>{

      const td=document.createElement("td");
      const dayItems=(byTail[ac.tail]||[]).filter(x=>x.day===day);

      let lastEnd=null;
      let hadFlight=false;

      dayItems.forEach(it=>{

        const chip=document.createElement("span");
        chip.className="chip";
        chip.dataset.id=it.id;
        chip.dataset.blockId=it.blockId||"";
        chip.dataset.type=it.type;

        /* ================== FLIGHT ================== */
        if(it.type==="flight"){

          hadFlight=true;

          const iata=localStorage.getItem("userIATA")||"XX";
          let out=it.flightNumberOut;
          let inn=it.flightNumberIn;

          if(String(out).startsWith(iata)) out=out.replace(iata,"");
          if(String(inn).startsWith(iata)) inn=inn.replace(iata,"");

          chip.textContent=`‚úàÔ∏è ${iata}${out} / ${iata}${inn}`;

          const tooltip=document.createElement("span");
          tooltip.className="tooltip";
          tooltip.innerHTML=`
            ${it.departure}‚Äì${it.arrival}<br>
            ${it.origin} ‚Üí ${it.destination}
          `;
          chip.appendChild(tooltip);

          const arrMin=toMin(it.arrival);
          lastEnd = lastEnd===null ? arrMin : Math.max(arrMin, lastEnd);

          chip.onclick=()=>openFlightModal(it);
        }

        /* ================== MAINTENANCE ================== */
        else if(it.type==="service"){

          chip.textContent=
            it.serviceType==="A" ? "üü° A-Check" : "‚öôÔ∏è B-Check";

          const tooltip=document.createElement("span");
          tooltip.className="tooltip";
          tooltip.innerHTML=`${it.start} ‚Äì ${it.end}`;
          chip.appendChild(tooltip);

          chip.onclick=()=>openActionModal(chip);
        }

        td.appendChild(chip);
      });

      /* NEXT FLIGHT */
      const maintDay=dayItems.find(x=>x.type==="service" && x.serviceType==="B");
      if(maintDay){
        const next=document.createElement("div");
        next.textContent="Next: N/A (B-Check)";
        next.style.fontSize="0.75rem";
        next.style.color="#ffca3a";
        td.appendChild(next);
        tr.appendChild(td);
        return;
      }

      if(hadFlight){
        const next=document.createElement("div");
        next.textContent="Next: "+toHHMM((lastEnd||0)+TURNAROUND_MIN);
        next.style.fontSize="0.75rem";
        next.style.marginTop="4px";
        td.appendChild(next);
      }

      tr.appendChild(td);
    });

    /* ACTION PLAN */
    const plan=document.createElement("td");
    const wrap=document.createElement("div");
    wrap.className="plan-actions";

    const a=document.createElement("button");
    a.className="btn btn-assign";
    a.textContent="Assign Route";
    a.onclick=()=>assignRouteToTail(ac);

    const b=document.createElement("button");
    b.className="btn btn-maint";
    b.textContent="Plan Maint";
    b.onclick=()=>openMaintModal(ac.tail);

    wrap.appendChild(a);
    wrap.appendChild(b);
    plan.appendChild(wrap);
    tr.appendChild(plan);

    tbody.appendChild(tr);
  });

  document.getElementById("updateTime").textContent =
    "Last update: "+new Date().toLocaleTimeString();
}

/* ============================================================
   ASSIGN ROUTE ‚Äî Versi√≥n estable (NOVIEMBRE)
   ============================================================ */
function assignRouteToTail(ac){

  const route=getRoute();
  if(!route){
    alert("‚ö† No confirmed route available.");
    return;
  }

  /* VALIDACI√ìN REAL DE MODELO */
  if(route.aircraft !== ac.type){
    alert(`‚ö† Route is for ${route.aircraft}, but ${ac.registration} is ${ac.type}.`);
    return;
  }

  const items=getItems();
  const daysSel=route.days?.length ? route.days : ["mon"];

  const dep=route.departure || "06:00";
  const dur=Number(route.blockTimeMin || 210);
  const arr=toHHMM(toMin(dep)+dur);

  const out=route.flightNumberOut || Math.floor(100+Math.random()*800);
  const inn=route.flightNumberIn  || out+1;

  /* DUPLICADOS */
  const dup=items.some(f =>
    f.type==="flight" &&
    (f.flightNumberOut===out || f.flightNumberIn===inn)
  );
  if(dup){
    alert(`‚ö† Flight ${out}/${inn} already exists.`);
    return;
  }

  const blockId = route.separateDays ? null : ("block-"+Math.random().toString(36).slice(2,8));
  let assigned=false;

  /* CHECK DE CONFLICTOS */
  const conflict = (day)=>{
    const list=items.filter(x=>x.tail===ac.tail && x.day===day && x.type==="flight");
    const newS=toMin(dep);
    const newE=newS+dur;
    for(const f of list){
      const s=toMin(f.departure);
      const e=toMin(f.arrival);
      if(!(newE+TURNAROUND_MIN <= s || e+TURNAROUND_MIN <= newS)) return true;
    }
    return false;
  };

  daysSel.forEach(day=>{
    if(conflict(day)) return;

    items.push({
      id: blockId || ("flt-"+Math.random().toString(36).slice(2,8)),
      blockId: blockId || "",
      type:"flight",
      tail: ac.tail,
      acType: ac.type,
      day,
      origin: route.origin,
      destination: route.destination,
      departure: dep,
      arrival: arr,
      flightNumberOut: out,
      flightNumberIn: inn
    });

    assigned=true;
  });

  if(!assigned){
    alert("‚ö† Cannot assign: schedule conflicts.");
    return;
  }

  setItems(items);
  renderSchedule();
}

/* ============================================================
   MAINTENANCE
   ============================================================ */
let maintTail=null;

function openMaintModal(tail){
  maintTail=tail;
  document.getElementById("maintModal").style.display="flex";
}

function closeMaintModal(){
  maintTail=null;
  document.getElementById("maintModal").style.display="none";
}

function applyMaintenance(){
  if(!maintTail){
    closeMaintModal();
    return;
  }

  const t=document.getElementById("maintType").value;
  const d=document.getElementById("maintDay").value;
  const start=document.getElementById("maintStart").value || "06:00";
  const dur=t==="A" ? 300 : 1440;
  const end=toHHMM(toMin(start)+dur);

  const items=getItems();
  const fleet=getRealFleet();

  const ac=fleet.find(x=>x.tail===maintTail || x.registration===maintTail);

  items.push({
    id:"svc-"+Math.random().toString(36).slice(2,8),
    type:"service",
    serviceType:t,
    tail:maintTail,
    acType:ac?.type || "",
    day:d,
    start,
    end
  });

  setItems(items);
  closeMaintModal();
  renderSchedule();
}

/* ============================================================
   ACTION MODAL
   ============================================================ */
let selectedChip=null;

function openActionModal(chip){
  selectedChip=chip;
  const modal=document.getElementById("actionModal");

  modal.querySelector(".modal-content").innerHTML=`
    <h3>Manage Flight</h3>
    <button onclick="removeItem()">üóë Remove</button>
    <button style="background:#ff9800" onclick="deleteFlight()">üöÆ Delete</button>
    <button style="background:#1E88E5" onclick="editFlight()">‚úèÔ∏è Edit</button>
    <button style="background:#e53935" onclick="closeActionModal()">Cancel</button>
  `;

  modal.style.display="flex";
}

function closeActionModal(){
  selectedChip=null;
  document.getElementById("actionModal").style.display="none";
}

function removeItem(){
  if(!selectedChip){ closeActionModal(); return; }

  const id=selectedChip.dataset.id;
  const block=selectedChip.dataset.blockId || "";
  const type=selectedChip.dataset.type;
  let items=getItems();

  let filtered;

  if(type==="flight" && block){
    filtered=items.filter(x=>x.blockId!==block);
  } else {
    filtered=items.filter(x=>x.id!==id);
  }

  setItems(filtered);
  closeActionModal();
  renderSchedule();
}

function deleteFlight(){
  if(!selectedChip){ closeActionModal(); return; }

  const id=selectedChip.dataset.id;
  const block=selectedChip.dataset.blockId || "";

  let items=getItems();

  const flight=items.find(f =>
    f.id===id || f.blockId===block
  );

  if(!flight){
    alert("Flight not found.");
    closeActionModal();
    return;
  }

  const out=flight.flightNumberOut;
  const inn=flight.flightNumberIn;

  let deleted=JSON.parse(localStorage.getItem("deletedFlights")||"[]");
  if(out) deleted.push(out,inn);
  localStorage.setItem("deletedFlights",JSON.stringify(deleted));

  if(block){
    items=items.filter(f=>f.blockId!==block);
  } else {
    items=items.filter(f=>f.id!==id);
  }

  setItems(items);
  closeActionModal();
  renderSchedule();

  alert(`‚ùå Flight ${out} deleted permanently.`);
}

/* ============================================================
   FLIGHT MODAL
   ============================================================ */
function openFlightModal(it){

  const modal=document.getElementById("flightModal");
  const box=modal.querySelector(".modal-content");

  const iata=localStorage.getItem("userIATA") || "XX";

  let out=it.flightNumberOut;
  let inn=it.flightNumberIn;

  if(String(out).startsWith(iata)) out=out.replace(iata,"");
  if(String(inn).startsWith(iata)) inn=inn.replace(iata,"");

  box.innerHTML=`
    <h3 style="color:#ffca3a">‚úàÔ∏è ${iata}${out} / ${iata}${inn}</h3>
    <p>${it.origin} ‚Üí ${it.destination}<br>
       Dep: <strong>${it.departure}</strong><br>
       Arr: <strong>${it.arrival}</strong></p>

    <hr style="border-color:rgba(255,179,0,0.3)">

    <button onclick="closeFlightModal()">Close</button>
  `;

  modal.style.display="flex";
}

function closeFlightModal(){
  document.getElementById("flightModal").style.display="none";
}

/* ============================================================
   LOGOUT
   ============================================================ */
function handleLogout(){
  alert("üëã Session closed.");
  window.location.href="login.html";
}

/* ============================================================
   LOAD
   ============================================================ */
window.onload=renderSchedule;
     
</script>

</body>
</html>

