<!-- ============================================================
     === ACS CREATE AIRLINE MODULE ‚Äî Beta v1 | Date: 18 NOV 2025 
     ------------------------------------------------------------
     ‚Ä¢ Qatar Luxury Header (igual que index.html)
     ============================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Airline - Aviation Capital Simulator</title>
  <link rel="stylesheet" href="styles.css?v=3.1" />

   <style>

    body {
      background-color: #0C1F3C;
      color: white;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding-top: 120px;
      text-align: center;
    }

    /* ================= Qatar Luxury Header ================= */
    .acs-header {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 0.8rem 2rem;

      background: rgba(12, 23, 50, 0.45);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);

      border-bottom: 1px solid rgba(255, 179, 0, 0.35);

      display: flex;
      align-items: center;
      justify-content: space-between;

      z-index: 1000;
      box-sizing: border-box;

      animation: acsHeaderFade 0.8s ease forwards;
    }

    @keyframes acsHeaderFade {
      from { opacity: 0; transform: translateY(-10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .acs-logo {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .acs-logo img {
      height: 46px;
      filter: drop-shadow(0 0 6px rgba(255,179,0,0.35));
    }

    .acs-logo h1 {
      color: #FFB300;
      font-size: 1.15rem;
      margin: 0;
      letter-spacing: 0.6px;
      text-shadow: 0 0 8px rgba(255,179,0,0.4);
    }

    .acs-nav-buttons {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-left: auto;
    }

    .nav-btn {
      padding: 0.45rem 1.2rem;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: 0.25s;
      min-width: 100px;

      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.08);
      text-align: center;
      text-decoration: none;
      color: #8AB4FF;
      border-color: rgba(138,180,255,0.45);
    }

    a[href="index.html"].nav-btn {
      color: #FFB300 !important;
      border-color: rgba(255,179,0,0.45) !important;
    }

    .nav-btn:hover {
      background: rgba(138,180,255,0.20);
      box-shadow: 0 0 12px rgba(138,180,255,0.55);
    }

    /* ============================================================
       === QATAR LUXURY A + B + C ‚Äî PREMIUM UI UPGRADE ===========
       ============================================================ */

    .form-container {
      background: linear-gradient(145deg, #102040 0%, #0b1a33 100%);
      max-width: 600px;
      margin: 0 auto;
      padding: 2.4rem;
      border-radius: 22px;
      border: 1px solid rgba(255, 179, 0, 0.22);
      box-shadow:
        0 0 30px rgba(0,0,0,0.55),
        inset 0 0 25px rgba(255,255,255,0.04);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      animation: floatCard 1.2s ease forwards;
    }

    @keyframes floatCard {
      from { opacity:0; transform: translateY(20px) scale(0.97); }
      to   { opacity:1; transform: translateY(0) scale(1); }
    }

    h2 {
      color: #FFB300;
      font-size: 1.7rem;
      letter-spacing: 0.5px;
      margin-bottom: 0.8rem;
      position: relative;
    }

    h2::after {
      content: "";
      display: block;
      width: 90px;
      height: 2px;
      margin: 0.6rem auto 1.3rem;
      background: linear-gradient(90deg, transparent, #ffb300, transparent);
    }

    input, select {
      width: 100%;
      padding: 0.9rem;
      margin-bottom: 1.1rem;

      border-radius: 14px;
      border: 1px solid rgba(255, 179, 0, 0.18);

      background: rgba(10, 30, 60, 0.7);
      color: white;
      font-size: 1rem;

      box-shadow:
        inset 0 0 10px rgba(0,0,0,0.25),
        0 0 6px rgba(255,179,0,0.15);
    }

    input:focus, select:focus {
      outline: none;
      border-color: #FFB300;
      box-shadow:
        0 0 10px rgba(255,179,0,0.45),
        inset 0 0 5px rgba(255,179,0,0.2);
    }

    button {
      background: linear-gradient(135deg, #ffb300 0%, #ffcf53 100%);
      color: #0C1F3C;
      font-weight: 900;
      letter-spacing: 0.5px;

      font-size: 1.1rem;
      border: none;
      border-radius: 16px;

      padding: 1.1rem 2.6rem;
      cursor: pointer;
      transition: 0.25s ease;

      box-shadow:
        0 0 20px rgba(255,179,0,0.45),
        0 6px 18px rgba(0,0,0,0.35);
    }

    button:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow:
        0 0 30px rgba(255,179,0,0.65),
        0 12px 18px rgba(0,0,0,0.4);
    }

    footer {
      margin-top: 3rem;
      color: #bbb;
      font-size: 0.85rem;
    }

    .acs-clock-header {
      font-family: 'Orbitron', 'Consolas', monospace; 
      color: #00ff80;
      font-weight: bold;
      background: rgba(0, 255, 128, 0.08);
      padding: 0.3rem 0.8rem; 
      border-radius: 6px; 
      font-size: 0.9rem;
      margin-left: 1rem;
    }
  </style>
</head>

<body>
  <!-- ================= Qatar Luxury Header ================= -->
  <header class="acs-header">
    <div class="acs-logo">
      <img src="acs_logo.png" alt="ACS Logo" />
      <h1>Aviation Capital Simulator</h1>
    </div>

    <div class="acs-nav-buttons">
      <a href="index.html" class="nav-btn">Home</a>
      <a href="support.html" class="nav-btn">Support</a>
    </div>

    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 2025</div>
  </header>
  <!-- ======================================================= -->

  <section class="form-container">
    <h2>Create Your Airline</h2>
    <p>Enter your airline details below to begin your aviation journey.</p>

    <form id="createAirlineForm" onsubmit="return handleAirlineCreation(event)">
      <input type="text" id="airlineName" placeholder="Airline Name" required />
      <input type="text" id="icao" placeholder="ICAO Code (auto)" maxlength="3" readonly />
      <input type="text" id="iata" placeholder="IATA Code (auto)" maxlength="2" readonly />
      <input type="text" id="slogan" placeholder="Airline Slogan (optional)" />

      <select id="region" required>
        <option value="">Select World Area</option>
        <option value="Europe">Europe</option>
        <option value="Asia">Asia</option>
        <option value="North America">North America</option>
        <option value="South America">South America</option>
        <option value="Africa">Africa</option>
        <option value="Oceania">Oceania</option>
      </select>

      <select id="country" required>
        <option value="">Select Country</option>
      </select>

      <select id="businessModel" required>
        <option value="">Select Business Model</option>
        <option value="Regional">Regional</option>
        <option value="Domestic">Domestic</option>
        <option value="International">International</option>
      </select>

      <select id="operationMode" required>
        <option value="">Select Operation Mode</option>
        <option value="Passenger">Passenger</option>
      </select>

      <button type="submit">CREATE AIRLINE</button>
    </form>
  </section>

  <footer>
    <p>¬© 2025 Aviation Capital Simulator. All rights reserved.</p>
  </footer>


<!-- ‚ùóAQUIE EMPIEZA SCRIPT -->
     
<script>
const realAirlines = [
  "American Airlines","Delta Air Lines","Lufthansa","Emirates","Qatar Airways",
  "Turkish Airlines","Singapore Airlines","British Airways","United Airlines",
  "Air France","Iberia","LATAM","Avianca","Air Europa","Air Canada",
  "Aeroflot","Alaska Airlines","JetBlue","Southwest Airlines","EasyJet","Ryanair"
];
     
/* ============================================================
   UPDATE COUNTRIES (HISTORICAL REAL-WORLD)
   ============================================================ */
function updateCountries() {

  const simYear = parseInt(localStorage.getItem("ACS_year") || "1940");
  const countrySelect = document.getElementById("country");
  const selectedRegion = document.getElementById("region").value;

  countrySelect.innerHTML = '<option value="">Select Country</option>';

  if (!selectedRegion) return;

  const available = ACS_CountryHistory
    .filter(c => 
        c.region === selectedRegion &&
        c.start <= simYear &&
        (c.end === null || c.end >= simYear)
    )
    .sort((a, b) => a.name.localeCompare(b.name));

  available.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.name;
    opt.textContent = c.name;
    countrySelect.appendChild(opt);
  });
}



function generateUniqueCodes() {
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const random = n => Array.from({length:n},()=>letters[Math.floor(Math.random()*letters.length)]).join("");

  let iata, icao;
  let existing = JSON.parse(localStorage.getItem("ACS_users") || "[]")
    .map(u => u.airline?.icao || "")
    .concat(JSON.parse(localStorage.getItem("ACS_users") || "[]")
    .map(u => u.airline?.iata || ""));

  do { iata = random(2); } while (existing.includes(iata));
  do { icao = random(3); } while (existing.includes(icao));

  document.getElementById("iata").value = iata;
  document.getElementById("icao").value = icao;
}

document.getElementById("airlineName").addEventListener("input", generateUniqueCodes);




/* ============================================================
   HANDLE AIRLINE CREATION
   ============================================================ */
function handleAirlineCreation(event) {
  event.preventDefault();

  const airlineName = document.getElementById("airlineName").value.trim();
  const region = document.getElementById("region").value;
  const country = document.getElementById("country").value;
  const businessModel = document.getElementById("businessModel").value;
  const operationMode = document.getElementById("operationMode").value;
  const slogan = document.getElementById("slogan").value.trim();
  const icao = document.getElementById("icao").value.trim().toUpperCase();
  const iata = document.getElementById("iata").value.trim().toUpperCase();

  const normalizedName = airlineName.toLowerCase().replace(/[^a-z\s]/gi, '').trim();

  if (realAirlines.some(real => {
    const realNorm = real.toLowerCase().replace(/[^a-z\s]/gi, '');
    return normalizedName.includes(realNorm) || realNorm.includes(normalizedName);
  })) {
    alert("‚ö†Ô∏è That airline name is too similar to a real-world airline. Please choose a fictional one.");
    return false;
  }

  const allUsers = JSON.parse(localStorage.getItem("ACS_users") || "[]");
  const nameExists = allUsers.some(u => u.airline && u.airline.name.toLowerCase() === airlineName.toLowerCase());
  if (nameExists) {
    alert("‚ö†Ô∏è Airline name already taken by another user in ACS. Please choose a different one.");
    return false;
  }

  const airline = { name: airlineName, icao, iata, slogan, region, country, businessModel, operationMode };

  let user = JSON.parse(localStorage.getItem("ACS_activeUser") || "{}");

  if (!user.userId) {
    alert("‚ö†Ô∏è Session not found. Please log in again.");
    window.location.href = "login.html";
    return false;
  }

  // üî• Force airline to always be an OBJECT
     
  user.airline = {
    id: user.airline_id || null,
    name: airline.name,
    iata: airline.iata,
    icao: airline.icao,
    slogan: airline.slogan,
    region: airline.region,
    country: airline.country,
    businessModel: airline.businessModel,
    operationMode: airline.operationMode
  };
     
/* ============================================================
   üü¶ PASO 2 ‚Äî ENSURE AIRLINE IATA (MANDATORY / SAFE)
   ------------------------------------------------------------
   ‚Ä¢ Garantiza que TODA airline tenga IATA
   ‚Ä¢ Fuente √∫nica de verdad para el sistema de vuelos
   ‚Ä¢ No rompe sesiones existentes
   ============================================================ */

(function ensureAirlineIATA(){

  try {
    if (!user.airline) {
      console.error("‚ùå Airline object missing ‚Äî cannot ensure IATA.");
      return;
    }

    // Normalizar IATA existente
    if (user.airline.iata && typeof user.airline.iata === "string") {
      user.airline.iata = user.airline.iata.toUpperCase().trim();
      console.log("üü¢ Airline IATA already defined:", user.airline.iata);
      return;
    }

    // Generaci√≥n controlada de IATA (fallback oficial)
    const name = (user.airline.name || "AIR").toUpperCase().replace(/[^A-Z]/g, "");
    let iata = name.slice(0, 2);

    // Garant√≠a m√≠nima
    if (iata.length < 2) {
      iata = "XX";
    }

    user.airline.iata = iata;

    console.warn("‚ö†Ô∏è Airline IATA was missing ‚Äî generated automatically:", iata);

  } catch (err) {
    console.error("‚ùå ensureAirlineIATA failed:", err);
  }

})();
     
  // üî• aseguramos que la base existe
  if (typeof user.base === "undefined") {
    user.base = null;
  }

  localStorage.setItem("ACS_activeUser", JSON.stringify(user));

  const index = allUsers.findIndex(u => u.email === user.email);
  if (index !== -1) allUsers[index] = user;
  localStorage.setItem("ACS_users", JSON.stringify(allUsers));
  localStorage.setItem("ACS_Airline", JSON.stringify(airline));

 /* ============================================================
   üü¶ PASO 3 ‚Äî CREATE AIRLINE ¬∑ ESTADO ACTIVO + VUELOS (FINAL)
   ------------------------------------------------------------
   ‚Ä¢ Google Sheet = registro / backend
   ‚Ä¢ localStorage = estado activo del simulador
   ‚Ä¢ airline.iata garantizado
   ============================================================ */

try {

  // ------------------------------------------------------------
  // 1Ô∏è‚É£ GARANTIZAR IATA DE AIRLINE (OBLIGATORIO)
  // ------------------------------------------------------------
  if (!airline.iata || typeof airline.iata !== "string") {
    const cleanName = (airlineName || "ACS").toUpperCase().replace(/[^A-Z]/g, "");
    airline.iata = cleanName.slice(0, 2) || "XX";
    console.warn("‚ö†Ô∏è Airline IATA missing ‚Äî generated:", airline.iata);
  } else {
    airline.iata = airline.iata.toUpperCase().trim();
  }

  // ------------------------------------------------------------
  // 2Ô∏è‚É£ GUARDAR USUARIO ACTIVO (FUENTE DE VERDAD DEL JUEGO)
  // ------------------------------------------------------------
  const activeUser = {
    userId: user.userId,
    airline: {
      name: airlineName,
      iata: airline.iata,
      country: country
    },
    createdAt: new Date().toISOString()
  };

  localStorage.setItem("ACS_activeUser", JSON.stringify(activeUser));
  console.log("üü¢ ACS_activeUser stored:", activeUser);

  // ------------------------------------------------------------
  // 3Ô∏è‚É£ INICIALIZAR SISTEMA DE VUELOS (USANDO IATA CORRECTO)
  // ------------------------------------------------------------
  localStorage.setItem("userIATA", airline.iata);
  localStorage.setItem("lastFlightNumber", "100");
  localStorage.setItem("flightNumbers", JSON.stringify([]));

  console.log("üü© Flight Number System initialized:", airline.iata);

} catch (e) {
  console.error("‚ùå CREATE AIRLINE INIT FAILED:", e);
}


/* ============================================================
   SEND AIRLINE TO GOOGLE SHEET (REGISTRO / BACKEND)
   ============================================================ */

const ACS_API_URL =
  "https://script.google.com/macros/s/AKfycbzzhyG15J2nf-pGyXN0aF1jW4h7ip4xO-eyRxXOYmsNirl6UO4XaZTq8SM7ayzzEib1Zw/exec";

fetch(ACS_API_URL, {
  method: "POST",
  body: JSON.stringify({
    action: "createAirline",
    user_id: user.userId,
    airline_name: airlineName,
    airline_iata: airline.iata,
    country: country
  })
})
.then(res => res.text())
.then(raw => {
  const result = JSON.parse(raw);

  if (result.ok) {
    alert("‚úî Airline synced with server!");
    window.location.href = "choose_base.html";
  } else {
    alert("‚ùå Server error: " + (result.error || "unknown"));
  }
})
.catch(err => {
  alert("‚ùå Error connecting to ACS server: " + err);
});

return false;

}

document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("ACS_activeUser"));
  if (!user) {
    alert("‚ö†Ô∏è Please log in to access this page.");
    window.location.href = "login.html";
  }
});

function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}
</script>

<!-- TIME ENGINE -->
<script src="time_engine.js"></script>
<script src="engine/acs_country_history.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  updateCountries();  

  if (typeof registerTimeListener === "function") {
    registerTimeListener(updateClockDisplay);
    updateClockDisplay();
  }
});

// üî• ESTA ES LA L√çNEA QUE FALTABA
document.getElementById("region").addEventListener("change", updateCountries);

</script>

</body>
</html>
