<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loan Request ‚Äî Aviation Capital Simulator</title>
  
  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.2" />

  <!-- ======== ACS Favicons (16 / 32 / 64) ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">

  <!-- ======== Apple iPhone/iPad Home Screen Icon ======== -->
  <link rel="apple-touch-icon" href="acs_logo_180.png">

  <!-- ======== PWA Manifest ======== -->
  <link rel="manifest" href="manifest.json">
  
  <style>

    /* === LOAN REQUEST PAGE (ACS Unified Style) === */
    body {
      margin: 0;
      background-color: #081530;
      color: white;
      font-family: "Segoe UI", sans-serif;
    }

  /* ============================================================
   HEADER ‚Äî SHARED ACS STANDARD
   ============================================================ */
.acs-header{
  position:fixed;
  top:0;
  width:100%;
  box-sizing:border-box; /* ‚Üê FIX CR√çTICO */
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:.8rem 2rem;
  background:rgba(12,23,50,.45);
  backdrop-filter:blur(9px);
  border-bottom:2px solid #ffb300;
  z-index:5000;
}

.acs-logo{
  display:flex;
  align-items:center;
  gap:1rem;
}

.acs-logo img{
  height:46px;
}

.acs-logo h1{
  margin:0;
  font-size:1.1rem;
  color:#ffb300;
}

.acs-nav{
  display:flex;
  gap:2rem;
}

.acs-nav a{
  text-decoration:none;
  color:#dbe4ff;
}

.acs-nav a.active{
  color:#ffb300;
}

/* ============================================================
   üü¶ RIGHT HEADER AREA ‚Äî PERFECT SPACING & CLOCK ALIGNMENT
   ============================================================ */

.acs-right{
  display:flex;
  align-items:center;
  gap:14px;              /* espacio real entre botones y reloj */
  padding-right:12px;    /* aire contra borde derecho */
  flex-shrink:0;
}

.support-btn{
  padding:.45rem 1.1rem;
  border-radius:12px;
  font-size:.9rem;
  font-weight:600;
  text-decoration:none;
  color:#8AB4FF;
  border:1px solid rgba(138,180,255,.45);
  background:rgba(138,180,255,.08);
}

.logout-btn{
  padding:.45rem 1.1rem;
  border:1px solid #ffb300;
  border-radius:12px;
  background:rgba(255,179,0,.05);
  color:#ffb300;
  font-weight:600;
  cursor:pointer;
}

/* ============================================================
   üü¶ ACS GLOBAL CLOCK ‚Äî STABLE HEADER FIX (NO LAYOUT SHIFT)
   Use in ALL ACS modules
   ============================================================ */

.acs-clock-header{

  font-family:"Orbitron",monospace;
  font-size:.95rem;
  color:#00ff80;

  background:rgba(0,255,128,.08);
  border-radius:10px;

  padding:.45rem .8rem;

  width:260px;                 /* ancho fijo absoluto */
  flex:0 0 260px;             /* evita expansi√≥n o compresi√≥n */

  display:flex;
  justify-content:center;
  align-items:center;

  white-space:nowrap;

  font-variant-numeric:tabular-nums;

  border:1px solid rgba(0,255,128,.18);

  overflow:hidden;            /* protecci√≥n extra */
}
    
    h2 {
      text-align: center;
      color: #FFB300;
      margin-top: 6rem; /* ‚úÖ espacio por header fijo */
      margin-bottom: 0.4rem;
    }

    .top-info p {
      text-align: center;
      color: #ccc;
      margin-bottom: 2rem;
    }

    /* ============================================================
   ACS TERMINAL PANELS ‚Äî REAL FINANCIAL TERMINAL STRUCTURE
   ============================================================ */

.main-grid{

  display:grid;

  grid-template-columns:
  repeat(auto-fit, minmax(340px, 1fr));

  gap:32px;

  margin-top:40px;

  padding:20px;

}

/* terminal container */

.panel{

  background:
  linear-gradient(
    180deg,
    rgba(5,18,48,0.95),
    rgba(2,10,30,0.98)
  );

  border-radius:16px;

  border:
  1px solid rgba(255,179,0,0.18);

  padding:28px;

  min-height:240px;

  display:flex;

  flex-direction:column;

  justify-content:flex-start;

  gap:14px;

  position:relative;

}

/* header */

.panel h3{

  font-size:1rem;

  font-weight:600;

  color:#ffb300;

  letter-spacing:1px;

  margin-bottom:6px;

}

/* spacing inside */

.panel > *{

  margin-top:6px;

}

/* authority panel special */

.acs-authority-panel{

  border-color:
  rgba(0,255,180,0.35);

}

/* submit panel special */

.panel:last-child{

  border-color:
  rgba(0,255,140,0.35);

}

    select, input {
      border-radius: 8px;
      border: none;
      background: #0C1F3C;
      color: white;
      padding: 0.6rem;
      width: 100%;
      font-size: 1rem;
    }

    label {
      display: block;
      margin-top: 0.8rem;
      color: #ccc;
      font-weight: 500;
    }

    .buy-btn {
      background-color: #00a86b;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      width: 100%;
      margin-top: 1rem;
    }

    .buy-btn:hover { background-color: #007d4e; }

    /* ‚úÖ Reloj cockpit Airbus */
    .acs-clock-header {
      font-family: 'Orbitron', 'Consolas', monospace;
      color: #00ff80;
      font-weight: bold;
      background: rgba(0, 255, 128, 0.08);
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-left: 1rem;
    }

/* ============================================================
   üè¶ ACS FINANCIAL AUTHORITY PANEL ‚Äî QATAR LUXURY
   ============================================================ */

.acs-authority-panel{

  background:
  linear-gradient(180deg,
    rgba(10,25,60,0.95),
    rgba(5,15,40,0.98));

  border-radius:18px;

  border:1px solid rgba(255,179,0,0.25);

  box-shadow:
  0 0 25px rgba(0,0,0,0.6),
  inset 0 0 20px rgba(0,40,120,0.15);

}

.acs-authority-block{

  margin-top:14px;

}

.acs-label{

  font-size:0.75rem;

  color:#8ca8ff;

  letter-spacing:1px;

}

.acs-authority-text{

  font-size:1.1rem;

  font-weight:700;

  margin-top:4px;

}

.acs-authority-sub{

  font-size:0.95rem;

  margin-top:3px;

}

.acs-authority-value{

  font-size:1.2rem;

  font-weight:700;

  color:#00ffd0;

}

/* Authority bar */

.acs-authority-bar{

  height:8px;

  background:
  rgba(0,0,0,0.4);

  border-radius:4px;

  margin-top:6px;

  overflow:hidden;

}

.acs-authority-fill{

  height:100%;

  width:0%;

  background:
  linear-gradient(90deg,
    #ff8844,
    #ffb300,
    #00ff88,
    #00ffd0);

  transition:width 0.8s ease;

}

/* ============================================================
   üü¶ ACS FINANCIAL TERMINAL PANELS ‚Äî QATAR LUXURY CORE
   ============================================================ */

.panel{

  background:
  linear-gradient(180deg,
    rgba(14,32,70,0.96),
    rgba(8,22,55,0.98));

  border-radius:18px;

  border:
  1px solid rgba(255,179,0,0.25);

  box-shadow:

  0 0 30px rgba(0,0,0,0.7),

  inset 0 0 25px rgba(0,60,140,0.15),

  inset 0 0 2px rgba(255,200,60,0.15);

  padding:22px;

  position:relative;

  transition:all 0.25s ease;

}

/* Hover institutional feel */

.panel:hover{

  border-color:rgba(255,179,0,0.55);

  box-shadow:

  0 0 40px rgba(255,179,0,0.12),

  inset 0 0 30px rgba(0,60,140,0.2);

}

/* Panel titles */

.panel h3{

  font-size:1.05rem;

  font-weight:600;

  color:#ffb300;

  letter-spacing:0.6px;

  margin-bottom:14px;

}

/* Internal labels */

.panel label{

  font-size:0.8rem;

  color:#8ca8ff;

  letter-spacing:1px;

}

/* Internal values */

.panel p{

  color:#00ffd0;

  font-weight:600;

}

/* Input styling */

.panel input,
.panel select{

  background:

  linear-gradient(180deg,
    rgba(10,25,60,0.9),
    rgba(5,15,40,0.95));

  border:
  1px solid rgba(0,140,255,0.25);

  color:#ffffff;

}

/* Submit panel special styling */

.panel:last-child{

  border-color:rgba(0,255,140,0.35);

  box-shadow:

  0 0 25px rgba(0,255,140,0.15),

  inset 0 0 20px rgba(0,255,140,0.08);

}

/* ============================================================
   üéØ LOAN DETAILS ‚Äî CENTER + SMALL SLIDER FIX (SAFE)
   Only affects Loan Details panel
   ============================================================ */

/* Target ONLY the Loan Details panel (2nd panel in grid) */
.main-grid .panel:nth-child(2){

  align-items:center;

}

/* Center input and select */

.main-grid .panel:nth-child(2) input[type="text"],
.main-grid .panel:nth-child(2) select{

  width:260px;
  text-align:center;

}

/* Smaller, centered slider */

.main-grid .panel:nth-child(2) input[type="range"]{

  width:220px;          /* ‚Üê tama√±o m√°s corto */
  margin-left:auto;
  margin-right:auto;
  display:block;

}

/* Center labels */

.main-grid .panel:nth-child(2) label{

  text-align:center;

}

/* Center max allowed text */

.main-grid .panel:nth-child(2) p{

  text-align:center;

}

/* smaller centered slider */

#loanAmountRange{

  width:220px;
  display:block;
  margin:12px auto 6px auto;

}
    
</style>
  
</head>

<body>
<header class="acs-header">
  <div class="acs-logo">
    <img src="acs_logo.png" alt="ACS Logo" />
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="bank.html" class="active">Bank</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html">Routes</a>
    <a href="hr.html">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
   <div id="acs-clock" class="acs-clock-header">
  <span class="clock-text">20:10 ‚Äî MON 09 JUN 1941</span>
</div>
  
</div>
  
</header>
  
  <!-- ===== MAIN ===== -->
  <main class="acs-main">
    <section class="top-info">
      <h2>üí∞ Loan Request Center</h2>
      <p>Secure financing for your airline expansion. Select your aircraft, loan amount and repayment term.</p>
    </section>

    <div class="main-grid">
      <!-- === AIRCRAFT COLLATERAL === -->
      <div class="panel">
        <h3>‚úàÔ∏è Secured Assets</h3>
        <select id="collateralSelect" style="margin-bottom:0.8rem;">
          <option value="">Select Aircraft</option>
        </select>
        <p id="aircraftValue" style="margin-top:10px; color:#bbb;">No aircraft selected</p>
      </div>

      <!-- === LOAN DETAILS === -->
      <div class="panel">
        <h3>üíµ Loan Details</h3>
        <label>Loan Amount (USD)</label>

<!-- Qatar Luxury Amount (No spinner) -->
<input
  type="text"
  id="loanAmount"
  placeholder="Enter amount"
  inputmode="numeric"
  autocomplete="off"
/>

<!-- Smooth slider (always limited to max per loan) -->
        
<input
  type="range"
  id="loanAmountRange"
  min="0"
  max="0"
  step="1000"
  value="0"
  style="margin-top:10px;width:100%;"
/>

<p style="margin:10px 0 0;color:#9fb3ff;font-size:0.95rem;">
  Max allowed: <span id="maxAllowedText" style="color:#00ff88;font-weight:700;">$0</span>
</p>

        <label>Term (Years)</label>
        <select id="loanTerm">

  <option value="36">Operational Loan (1‚Äì3 years)</option>

  <option value="72">Aircraft Support (4‚Äì6 years)</option>

  <option value="120">Aircraft Financing (7‚Äì10 years)</option>

  <option value="180">Fleet Expansion (11‚Äì15 years)</option>

  <option value="240">Strategic Financing (16‚Äì20 years)</option>

</select>

      </div>

     <!-- === ACS FINANCIAL AUTHORITY PANEL === -->
<div class="panel acs-authority-panel">

  <h3>üè¶ Financial Authority</h3>

  <!-- Authority Level -->
  <div class="acs-authority-block">

    <div class="acs-label">
      AUTHORITY LEVEL
    </div>

    <div class="acs-authority-bar">
      <div id="authorityFill"
           class="acs-authority-fill">
      </div>
    </div>

    <div id="creditRating"
         class="acs-authority-text">
      LOADING
    </div>

  </div>

  <!-- Stability -->
  <div class="acs-authority-block">

    <div class="acs-label">
      FINANCIAL STABILITY
    </div>

    <div id="riskLevel"
         class="acs-authority-sub">
      LOADING
    </div>

  </div>

  <!-- Interest -->
  <div class="acs-authority-block">

    <div class="acs-label">
      BASE INTEREST RATE
    </div>

    <div id="interestRate"
         class="acs-authority-value">
      0%
    </div>

  </div>

  <!-- Capacity -->
  <div class="acs-authority-block">

    <div class="acs-label">
      MAXIMUM LOAN CAPACITY
    </div>

    <div id="maxLoan"
         class="acs-authority-value">
      $0
    </div>

  </div>

</div>

       <!-- === SUBMIT SECTION === -->
      <div class="panel">
        <h3>üìù Submit Request</h3>
        <p>Once approved, funds will be transferred instantly to your airline balance.</p>
        <button id="requestLoanBtn" class="buy-btn">Submit Loan Request</button>
        <p id="loanMessage" style="margin-top:15px; color:#ccc;"></p>
      </div>

      <!-- ============================================================
           üè¶ ACTIVE LOANS TERMINAL ‚Äî SAME GRID STRUCTURE
           ============================================================ -->

      <div class="panel" id="activeLoansPanel">

        <h3>üè¶ Active Loan Portfolio</h3>

        <div id="loanPortfolioContainer"
             style="
             display:flex;
             flex-direction:column;
             gap:10px;
             margin-top:6px;
             ">
        </div>

      </div>

    </div>
   
</main>

  <!-- ===== FOOTER ===== -->
  <footer class="acs-footer">
    <p>¬© 2026 Aviation Capital Simulator. All rights reserved.</p>
  </footer>

<!-- ============================================================
     ‚è≥ TIME ENGINE
     ============================================================ -->
<script src="acs_time_recovery.js"></script>
<script src="time_engine.js"></script>

<!-- ============================================================
     üîê SECURITY CORE
     ============================================================ -->
<script src="engine/acs_security_core.js?v=1"></script>

<!-- ============================================================
     üíº FINANCE + BANK ENGINE
     (IMPORTANTE: estos dos deben existir en /engine/)
     ============================================================ -->
<script src="engine/acs_finance.js"></script>
<script src="engine/acs_bank.js"></script>
<script src="engine/acs_aircraft_db.js"></script>
  
<!-- ===== SCRIPT ===== -->
  
<script>
/* ============================================================
   üè¶ ACS LOAN REQUEST ‚Äî REAL AVIATION ENGINE INTEGRATION
   Rule: Max 70% per loan
   ============================================================ */

const collateralSelect = document.getElementById("collateralSelect");
const aircraftValue    = document.getElementById("aircraftValue");
const loanAmountInput  = document.getElementById("loanAmount");
const loanTermSelect   = document.getElementById("loanTerm");

const creditRatingEl   = document.getElementById("creditRating");
const riskLevelEl      = document.getElementById("riskLevel");
const interestRateEl   = document.getElementById("interestRate");
const maxLoanEl        = document.getElementById("maxLoan");

const loanMessageEl    = document.getElementById("loanMessage");

let BANK_SUMMARY = null;
let MAX_PER_LOAN = 0;

function money(x){
  return "$" + Math.round(Number(x || 0)).toLocaleString();
}

function loadBankData(){
  if (typeof ACS_BANK_getSummary !== "function"){
    console.error("‚ùå ACS_BANK_getSummary missing ‚Äî engine/acs_bank.js not loaded");
    loanMessageEl.textContent = "BANK ENGINE NOT LOADED (acs_bank.js)";
    return;
  }

  BANK_SUMMARY = ACS_BANK_getSummary();

  const capacity = Number(BANK_SUMMARY.loanCapacity || 0);
  MAX_PER_LOAN = capacity * 0.7;

  loanAmountInput.max = Math.floor(MAX_PER_LOAN);
  loanAmountInput.placeholder =
  "Max allowed: $" + Math.floor(MAX_PER_LOAN).toLocaleString();
  
  interestRateEl.textContent = Number(BANK_SUMMARY.interestRate || 0).toFixed(2) + "%";
  maxLoanEl.textContent = money(MAX_PER_LOAN);

  updateCreditProfile();
}

/* ============================================================
   üè¶ ACS FINANCIAL AUTHORITY ENGINE
   Replaces legacy AAA / CCC model
   ============================================================ */

function updateCreditProfile(){

  if(!BANK_SUMMARY){
    creditRatingEl.textContent = "NO DATA";
    riskLevelEl.textContent    = "UNKNOWN";
    return;
  }

  const fleetValue =
    Number(BANK_SUMMARY.fleetValue || 0);

  const loans =
    Array.isArray(BANK_SUMMARY.loans)
    ? BANK_SUMMARY.loans
    : [];

  const totalDebt =
    loans.reduce((sum,l)=>
      sum + Number(l.remaining || 0), 0);

  const debtRatio =
    fleetValue > 0
      ? totalDebt / fleetValue
      : 1;

  let authority = "";
  let stability = "";
  let color     = "";
  let level     = 15;

  /* AUTHORITY MODEL */

  if(fleetValue >= 100000000){

    authority = "GLOBAL AUTHORITY";
    stability = "SECURE";
    color     = "#00ffd0";
    level     = 100;

  }
  else if(fleetValue >= 25000000){

    authority = "EXTENDED AUTHORITY";
    stability = "STRONG";
    color     = "#00ff88";
    level     = 75;

  }
  else if(fleetValue >= 5000000){

    authority = "STANDARD AUTHORITY";
    stability = "STABLE";
    color     = "#4da3ff";
    level     = 55;

  }
  else if(fleetValue >= 1000000){

    authority = "LIMITED AUTHORITY";
    stability = "ELEVATED RISK";
    color     = "#ffb300";
    level     = 35;

  }
  else{

    authority = "RESTRICTED AUTHORITY";
    stability = "UNSTABLE";
    color     = "#ff8844";
    level     = 15;

  }

  /* APPLY TEXT */

  creditRatingEl.textContent = authority;
  creditRatingEl.style.color = color;

  riskLevelEl.textContent = stability;
  riskLevelEl.style.color = color;

  /* APPLY AUTHORITY BAR */

  const bar =
  document.getElementById("authorityFill");

  if(bar)
    bar.style.width = level + "%";

}
  
function getAircraftDatabase(){

  // check common global locations safely

  if(typeof ACS_AIRCRAFT_DB !== "undefined")
    return ACS_AIRCRAFT_DB;

  if(typeof window.ACS_AIRCRAFT_DB !== "undefined")
    return window.ACS_AIRCRAFT_DB;

  if(typeof window.ACS !== "undefined" &&
     typeof window.ACS.AIRCRAFT_DB !== "undefined")
    return window.ACS.AIRCRAFT_DB;

  // fallback: search dynamically
  for(const k in window){

    if(Array.isArray(window[k]) &&
       window[k].length > 0 &&
       window[k][0]?.price_acs_usd){

      return window[k];

    }

  }

  return null;

}
  
/* ============================================================
   üü¶ ACS BANK ‚Äî MULTI COLLATERAL CHECKBOX ENGINE
   ------------------------------------------------------------
   Professional real aviation financing model
   Allows multiple aircraft selection as collateral
   Calculates dynamic loan limit based on real fleet value
   ============================================================ */

function loadAircraft(){

  const fleet =
    JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");

  const DB = getAircraftDatabase();

  if(!DB){
    console.error("Aircraft database not found");
    return;
  }

  /* ============================================================
     BUILD CHECKBOX LIST UI
     ============================================================ */

  collateralSelect.style.display = "none";

  let container =
    document.getElementById("collateralCheckboxContainer");

  if(!container){

    container = document.createElement("div");

    container.id = "collateralCheckboxContainer";

    container.style.marginTop = "10px";
    container.style.display = "flex";
    container.style.flexDirection = "column";
    container.style.gap = "6px";

    collateralSelect.parentNode.appendChild(container);

  }

  container.innerHTML = "";

  let totalCollateral = 0;

  fleet.forEach((ac, index) => {

    const dbAircraft =
      DB.find(db =>
        db.manufacturer === ac.manufacturer &&
        db.model === ac.model
      );

    let value = 0;

    if(dbAircraft && dbAircraft.price_acs_usd)
      value = Number(dbAircraft.price_acs_usd);

const isLocked =
  ac.collateralActive === true;

const row =
  document.createElement("label");

row.style.display = "flex";
row.style.alignItems = "center";
row.style.gap = "8px";
row.style.fontSize = "0.95rem";

if(isLocked){

  row.style.opacity = "0.4";
  row.style.cursor = "not-allowed";

}
else{

  row.style.cursor = "pointer";

}

const cb =
  document.createElement("input");

cb.type = "checkbox";
cb.value = value;
cb.dataset.index = index;

if(isLocked){

  cb.disabled = true;

}
else{

  cb.onchange = updateCollateralTotals;

}

const text =
  document.createElement("span");

text.textContent =
  `${ac.manufacturer} ${ac.model} ‚Äî ${money(value)}`;

if(isLocked){

  const badge =
    document.createElement("span");

  badge.textContent =
    "  (Secured Asset Value)";

  badge.style.color = "#ff8844";
  badge.style.marginLeft = "6px";

  text.appendChild(badge);

}

row.appendChild(cb);
row.appendChild(text);

container.appendChild(row);


  });

  updateCollateralTotals();

}

/* ============================================================
   üü¶ COLLATERAL TOTAL CALCULATOR
   ============================================================ */

function updateCollateralTotals(){

  const checkboxes =
    document.querySelectorAll("#collateralCheckboxContainer input");

  let total = 0;

  checkboxes.forEach(cb => {

    if(cb.checked)
      total += Number(cb.value);

  });

  aircraftValue.textContent =
    total > 0
    ? "Total Collateral: " + money(total)
    : "No aircraft selected";

  /* ============================================================
     REAL BANK LIMIT CALCULATION
     ============================================================ */

  const collateralLimit =
    total * 0.70;

  const bankLimit =
    Number(BANK_SUMMARY?.loanCapacity || 0);

  const fleetLimit =
    Number(BANK_SUMMARY?.fleetValue || 0) * 0.50;

  const finalLimit =
    Math.min(collateralLimit, bankLimit, fleetLimit);

  MAX_PER_LOAN = Math.floor(finalLimit);

  /* ============================================================
     UPDATE UI
     ============================================================ */

  loanAmountInput.placeholder =
    "Max allowed: " + money(MAX_PER_LOAN);

  document.getElementById("maxAllowedText").textContent =
    money(MAX_PER_LOAN);

  maxLoanEl.textContent =
    money(MAX_PER_LOAN);

  /* ============================================================
     UPDATE SLIDER
     ============================================================ */

  const slider =
    document.getElementById("loanAmountRange");

  if(slider){

  slider.min = 0;

slider.max = Math.max(0, Number(MAX_PER_LOAN || 0));

/* FIX CR√çTICO ‚Äî step nunca mayor que max */
slider.step =
  slider.max <= 1000
  ? 1
  : Math.floor(slider.max / 100);

/* reset seguro */
slider.value = 0;

}

}

/* ============================================================
   üü¶ ACS BANK ‚Äî AMOUNT SYNC ENGINE (FINAL STABLE VERSION)
   ------------------------------------------------------------
   Professional aviation financing amount control
   Fully synchronized slider ‚áÑ input
   No readonly conflicts
   Safe initialization
   ============================================================ */

let loanSlider = null;

/* ============================================================
   FORMAT MONEY INPUT
   ============================================================ */

function formatMoneyInput(value){

  const num =
    Number(String(value).replace(/[^0-9]/g,""));

  if(!num) return "";

  return num.toLocaleString();

}

/* ============================================================
   INITIALIZE AMOUNT CONTROLS
   ============================================================ */

function initializeAmountControls(){

  loanSlider =
    document.getElementById("loanAmountRange");

  if(!loanSlider || !loanAmountInput){

    console.warn("ACS BANK: loan controls not found");
    return;

  }

  /* ============================================================
     INPUT ‚Üí SLIDER SYNC
     ============================================================ */

  loanAmountInput.addEventListener("input", () => {

    let raw =
      Number(
        loanAmountInput.value.replace(/[^0-9]/g,"")
      );

    if(!raw) raw = 0;

    if(raw > MAX_PER_LOAN)
      raw = MAX_PER_LOAN;

    loanSlider.value = raw;

    loanAmountInput.value =
      formatMoneyInput(raw);

  });

  /* ============================================================
     SLIDER ‚Üí INPUT SYNC
     ============================================================ */

  loanSlider.addEventListener("input", () => {

    const value =
      Number(loanSlider.value);

    loanAmountInput.value =
      formatMoneyInput(value);

  });

  /* ============================================================
     INITIAL RESET
     ============================================================ */

  loanSlider.min = 0;
  loanSlider.max = MAX_PER_LOAN || 0;
  loanSlider.value = 0;

  loanAmountInput.value = "";

  console.log("ACS BANK: Amount controls initialized");

}

/* ============================================================
   üè¶ ACS BANK ‚Äî REAL LOAN PAYMENT ENGINE
   ------------------------------------------------------------
   Professional aviation financing amortization system
   Calculates real monthly payment, total repayment, interest
   Fully integrated with ACS bank + finance engine
   ============================================================ */

let PAYMENT_ENGINE = {

  monthlyPayment: 0,
  totalRepayment: 0,
  totalInterest: 0

};

/* ============================================================
   üè¶ ACS BANK ‚Äî ACTIVE LOANS TERMINAL ENGINE
   Displays all active loans from bank engine
   ============================================================ */

function loadLoanPortfolio(){

  const container =
    document.getElementById("loanPortfolioContainer");

  if(!container) return;

  if(typeof ACS_BANK_getSummary !== "function"){
    container.innerHTML =
      "<p style='color:#ff8844'>Bank engine not available</p>";
    return;
  }

  const summary =
    ACS_BANK_getSummary();

  const loans =
    Array.isArray(summary.loans)
    ? summary.loans
    : [];

  if(loans.length === 0){

    container.innerHTML =
      "<p style='color:#8ca8ff'>No active loans.</p>";

    return;
  }

  container.innerHTML = "";

  loans.forEach((loan, index) => {

    const block =
      document.createElement("div");

    block.style.marginTop = "12px";
    block.style.padding = "12px";
    block.style.border =
      "1px solid rgba(0,255,140,0.25)";
    block.style.borderRadius = "10px";

    const remaining =
      Number(loan.remaining || 0);

    const payment =
      Number(loan.payment || 0);

    const rate =
      Number(loan.rate || 0);

    block.innerHTML = `
      <div style="font-weight:600;color:#00ffd0;">
        Loan #${index + 1}
      </div>

      <div style="font-size:0.9rem;color:#8ca8ff;">
        Remaining Balance: ${money(remaining)}
      </div>

      <div style="font-size:0.9rem;color:#8ca8ff;">
        Monthly Payment: ${money(payment)}
      </div>

      <div style="font-size:0.9rem;color:#8ca8ff;">
        Interest Rate: ${rate.toFixed(2)}%
      </div>
    `;

    container.appendChild(block);

  });

}
  
/* ============================================================
   CALCULATE REAL LOAN PAYMENTS
   ============================================================ */

function ACS_calculateLoanPayment(){

  if(!BANK_SUMMARY) return;

  const principal =
    Number(
      loanAmountInput.value.replace(/[^0-9]/g,"")
    );

  if(!principal || principal <= 0){

    updatePaymentUI(0,0,0);
    return;

  }

  const annualRate =
    Number(BANK_SUMMARY.interestRate || 0) / 100;

  const monthlyRate =
    annualRate / 12;

  const months =
    Number(loanTermSelect.value || 0);

  if(months <= 0){

    updatePaymentUI(0,0,0);
    return;

  }

  /* ============================================================
     AMORTIZATION FORMULA
     ============================================================ */

  let monthlyPayment = 0;

  if(monthlyRate === 0){

    monthlyPayment =
      principal / months;

  }
  else{

    monthlyPayment =
      principal *
      (
        monthlyRate *
        Math.pow(1 + monthlyRate, months)
      )
      /
      (
        Math.pow(1 + monthlyRate, months) - 1
      );

  }

  const totalRepayment =
    monthlyPayment * months;

  const totalInterest =
    totalRepayment - principal;

  PAYMENT_ENGINE.monthlyPayment =
    monthlyPayment;

  PAYMENT_ENGINE.totalRepayment =
    totalRepayment;

  PAYMENT_ENGINE.totalInterest =
    totalInterest;

  updatePaymentUI(
    monthlyPayment,
    totalRepayment,
    totalInterest
  );

}

/* ============================================================
   UPDATE UI DISPLAY
   ============================================================ */

function updatePaymentUI(monthly, total, interest){

  let box =
    document.getElementById("loanPaymentBox");

  if(!box){

    box =
      document.createElement("div");

    box.id = "loanPaymentBox";

    box.style.marginTop = "18px";
    box.style.padding = "14px";
    box.style.borderRadius = "10px";
    box.style.background =
      "linear-gradient(180deg, rgba(0,25,60,0.6), rgba(0,10,30,0.8))";
    box.style.border =
      "1px solid rgba(0,255,180,0.25)";
    box.style.fontSize = "0.95rem";

    loanTermSelect.parentNode.appendChild(box);

  }

  if(monthly <= 0){

    box.innerHTML =
      "<span style='color:#8ca8ff'>Enter amount to calculate payment</span>";

    return;

  }

  box.innerHTML =

  "<div style='color:#00ffd0;font-weight:700;margin-bottom:4px'>MONTHLY PAYMENT: " +
  money(monthly) +
  "</div>" +

  "<div style='color:#8ca8ff'>TOTAL REPAYMENT: " +
  money(total) +
  "</div>" +

  "<div style='color:#ffb300'>INTEREST COST: " +
  money(interest) +
  "</div>";

}

/* ============================================================
   AUTO UPDATE EVENTS
   ============================================================ */

loanAmountInput.addEventListener(
  "input",
  ACS_calculateLoanPayment
);

loanTermSelect.addEventListener(
  "change",
  ACS_calculateLoanPayment
);

if(typeof loanSlider !== "undefined" && loanSlider){

  loanSlider.addEventListener(
    "input",
    ACS_calculateLoanPayment
  );

}
  
function submitLoan(){

  /* ============================================================
     CLEAN FORMATTED INPUT (remove commas)
     ============================================================ */

  const cleanAmount =
    Number(
      loanAmountInput.value
      .replace(/,/g,"")
      .replace(/[^0-9]/g,"")
    );

  const amount = cleanAmount;

  const years =
    Number(loanTermSelect.value || 0);

  const months =
    years * 12;

  /* ============================================================
     VALIDATION
     ============================================================ */

  if (!amount || amount <= 0){

    loanMessageEl.textContent =
      "Enter a valid loan amount.";

    return;

  }

  if (amount > MAX_PER_LOAN){

    loanMessageEl.textContent =
      "Amount exceeds the maximum allowed.";

    return;

  }

  /* ============================================================
     CREATE LOAN
     ============================================================ */

  try{

  /* ============================================================
     üü© B8.1 ‚Äî COLLATERAL LOCK ENGINE
     Marks aircraft as collateral
     ============================================================ */

  const fleet =
    JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");

  const checkboxes =
    document.querySelectorAll("#collateralCheckboxContainer input");

  checkboxes.forEach(cb => {

    if(cb.checked){

      const index =
        Number(cb.dataset.index);

      if(fleet[index]){

        fleet[index].collateralActive = true;
        fleet[index].collateralLoanId = Date.now();

      }

    }

  });

  localStorage.setItem(
    "ACS_MyAircraft",
    JSON.stringify(fleet)
  );

  /* ============================================================
     CREATE LOAN
     ============================================================ */

  ACS_BANK_createLoan(amount, months);

  loanMessageEl.textContent =
    "Loan approved. Funds transferred.";

    setTimeout(() =>
      location.reload(),
      1000
    );

  }
  catch(err){

    loanMessageEl.textContent =
      err?.message || "Loan error.";

  }

}

document.getElementById("requestLoanBtn").addEventListener("click", submitLoan);

document.addEventListener("DOMContentLoaded", () => {

  loadBankData();

  loadAircraft();

  initializeAmountControls();

  renderLoanPortfolio();

});

function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}  

/* ============================================================
   üü© B-22 ‚Äî ACTIVE LOAN PORTFOLIO ENGINE (FILTER + PAID STATE)
   ------------------------------------------------------------
   Fix:
   ‚Ä¢ Oculta loans pagados del panel activo
   ‚Ä¢ Muestra estado PAID correctamente
   ‚Ä¢ Bloquea amortizaci√≥n si remaining = 0
   ============================================================ */

function renderLoanPortfolio(){

  const container =
    document.getElementById("loanPortfolioContainer");

  if(!container) return;

  container.innerHTML = "";

  if(!BANK_SUMMARY ||
     !BANK_SUMMARY.loans ||
     BANK_SUMMARY.loans.length === 0){

    container.innerHTML =
      `<div style="
        color:#8ca8ff;
        font-size:0.95rem;
        opacity:0.8;
      ">
        No active loans.
      </div>`;

    return;
  }

  /* ============================================================
     FILTER ONLY ACTIVE LOANS
     ============================================================ */

  const activeLoans =
    BANK_SUMMARY.loans.filter(
      loan => Number(loan.remaining || 0) > 0
    );

  if(activeLoans.length === 0){

    container.innerHTML =
      `<div style="
        color:#00ff88;
        font-size:0.95rem;
        font-weight:600;
      ">
        All loans fully paid.
      </div>`;

    return;
  }

  /* ============================================================
     RENDER ACTIVE LOANS ONLY
     ============================================================ */

  activeLoans.forEach((loan) => {

    const card =
      document.createElement("div");

    card.style.background =
      "linear-gradient(180deg, rgba(10,25,60,0.95), rgba(5,15,40,0.98))";

    card.style.border =
      "1px solid rgba(0,255,180,0.25)";

    card.style.borderRadius =
      "10px";

    card.style.padding =
      "12px";

    card.style.display =
      "flex";

    card.style.justifyContent =
      "space-between";

    card.style.alignItems =
      "center";

    const left =
      document.createElement("div");

    left.innerHTML =
      `
      <div style="color:#00ffd0;font-weight:600">
      Loan: ${money(
      loan.originalAmount ||
      loan.amount ||
      loan.remaining ||
      0
      )}
      </div>

      <div style="color:#8ca8ff;font-size:0.85rem">
        Remaining: ${money(loan.remaining)}
      </div>

      <div style="color:#8ca8ff;font-size:0.85rem">
        Monthly: ${money(loan.monthlyPayment)}
      </div>
      `;

    const right =
      document.createElement("button");

    right.textContent =
      "Amortize";

    right.style.background =
      "rgba(0,255,180,0.15)";

    right.style.border =
      "1px solid rgba(0,255,180,0.35)";

    right.style.color =
      "#00ffd0";

    right.style.padding =
      "6px 12px";

    right.style.borderRadius =
      "8px";

    right.style.cursor =
      "pointer";

    right.onclick =
      () => amortizeLoan(loan.id);

    card.appendChild(left);
    card.appendChild(right);

    container.appendChild(card);

  });

}

/* ============================================================
   üü© B-35 FINAL ‚Äî AMORTIZATION ENGINE WITH SAFE COLLATERAL RELEASE
   Fully closed ‚Äî NO syntax errors
   ============================================================ */

function amortizeLoan(loanId){

  const amount =
    prompt("Enter amortization amount:");

  if(!amount) return;

  const value =
    Number(amount.replace(/[^0-9]/g,""));

  if(!value) return;

  try{

    const remaining =
      ACS_BANK_amortizeLoan(loanId, value);

    console.log(
      "Loan amortized. Remaining:",
      remaining
    );

    /* ============================================================
       COLLATERAL RELEASE ENGINE
       ============================================================ */

    if(remaining <= 0){

      const fleet =
        JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");

      let changed = false;

      fleet.forEach(ac => {

        if(ac.collateralActive === true){

          ac.collateralActive = false;
          ac.collateralLoanId = null;

          changed = true;

        }

      });

      if(changed){

        localStorage.setItem(
          "ACS_MyAircraft",
          JSON.stringify(fleet)
        );

        console.log("Collateral released");

      }

    }

    /* ============================================================
       FULL UI REFRESH
       ============================================================ */

    BANK_SUMMARY =
      ACS_BANK_getSummary();

    loadBankData();

    renderLoanPortfolio();

    loadAircraft();

  }
  catch(err){

    console.error(err);

    alert(
      err?.message ||
      "Amortization failed"
    );

  }

}


</script>
  
</body>
</html>
