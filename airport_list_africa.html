<!-- ===========================================================
     === AIRPORT LIST (AFRICA) ‚Äî AVIATION CAPITAL SIMULATOR ===
     Qatar Luxury Edition v3.1 ‚Äî FIX v2.0 (Historical Passenger Logic)
     =========================================================== -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Africa Airports - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">
  <link rel="manifest" href="manifest.json">

  <style>
/* ============================================================
   === GLOBAL ACS QATAR LUXURY STYLE ===========================
   ============================================================ */

body {
  margin: 0;
  color: #fff;
  font-family: "Poppins", sans-serif;
  background-color: #081530;
}

/* ============================================================
   HEADER ‚Äî SHARED ACS STANDARD
   ============================================================ */
.acs-header{
  position:fixed;
  top:0;
  width:100%;
  box-sizing:border-box; /* ‚Üê FIX CR√çTICO */
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:.8rem 2rem;
  background:rgba(12,23,50,.45);
  backdrop-filter:blur(9px);
  border-bottom:2px solid #ffb300;
  z-index:5000;
}

.acs-logo{
  display:flex;
  align-items:center;
  gap:1rem;
}

.acs-logo img{
  height:46px;
}

.acs-logo h1{
  margin:0;
  font-size:1.1rem;
  color:#ffb300;
}

.acs-nav{
  display:flex;
  gap:2rem;
}

.acs-nav a{
  text-decoration:none;
  color:#dbe4ff;
}

.acs-nav a.active{
  color:#ffb300;
}

/* ============================================================
   üü¶ RIGHT HEADER AREA ‚Äî PERFECT SPACING & CLOCK ALIGNMENT
   ============================================================ */

.acs-right{
  display:flex;
  align-items:center;
  gap:14px;              /* espacio real entre botones y reloj */
  padding-right:12px;    /* aire contra borde derecho */
  flex-shrink:0;
}

.support-btn{
  padding:.45rem 1.1rem;
  border-radius:12px;
  font-size:.9rem;
  font-weight:600;
  text-decoration:none;
  color:#8AB4FF;
  border:1px solid rgba(138,180,255,.45);
  background:rgba(138,180,255,.08);
}

.logout-btn{
  padding:.45rem 1.1rem;
  border:1px solid #ffb300;
  border-radius:12px;
  background:rgba(255,179,0,.05);
  color:#ffb300;
  font-weight:600;
  cursor:pointer;
}

/* ============================================================
   üü¶ ACS GLOBAL CLOCK ‚Äî STABLE HEADER FIX (NO LAYOUT SHIFT)
   Use in ALL ACS modules
   ============================================================ */

.acs-clock-header{

  font-family:"Orbitron",monospace;
  font-size:.95rem;
  color:#00ff80;

  background:rgba(0,255,128,.08);
  border-radius:10px;

  padding:.45rem .8rem;

  width:260px;                 /* ancho fijo absoluto */
  flex:0 0 260px;             /* evita expansi√≥n o compresi√≥n */

  display:flex;
  justify-content:center;
  align-items:center;

  white-space:nowrap;

  font-variant-numeric:tabular-nums;

  border:1px solid rgba(0,255,128,.18);

  overflow:hidden;            /* protecci√≥n extra */
}

/* ================= MAIN CONTENT ================= */
.acs-main {
  padding: 110px 2rem 70px;
  text-align: center;
}

.acs-main h2 {
  font-size: 2.1rem;
  font-weight: 600;
  color: #ffca3a;
  margin-top: 18px;     /* Sube el t√≠tulo */
  margin-bottom: 6px;   /* Espacio con el subt√≠tulo */
  text-shadow:
    0 0 6px rgba(255,190,60,0.55),
    0 0 12px rgba(255,190,60,0.35);
}


.sub {
  text-align: center;
  color: #cbd6ff;
  opacity: 0.9;
  font-size: 1.05rem;
  margin-top: 10px;       /* despega del t√≠tulo */
  margin-bottom: 32px;    /* aire antes del Origin */
}


/* ===== Origin Banner ===== */
.origin-banner {
  margin-top: 12px;
  margin-bottom: 18px;
  font-size: 1.15rem;
  color: #ffca3a;
  font-weight: 600;
  letter-spacing: 0.3px;
  text-shadow: 0 0 8px rgba(255,190,60,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.45rem;
}

.origin-banner .label {
  color: #ffe7a0;
  font-weight: 700;
}

.origin-banner strong {
  color: #ffca3a;
  font-size: 1.2rem;
}

.origin-banner #originCity {
  color: #dbe4ff;
  opacity: 0.95;
  font-weight: 400;
  margin-left: 0.3rem;
}

.origin-banner .icon {
  font-size: 1.25rem;
  margin-right: 0.3rem;
}

/* ============================================================
   === QATAR LUXURY TABLE =====================================
   ============================================================ */

table {
  width: 95%;
  margin: 2rem auto 0 auto;
  border-collapse: collapse;
  background: rgba(14,27,70,0.65);
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 0 25px rgba(0,0,0,0.45);
  backdrop-filter: blur(6px);
}

thead {
  background: rgba(20,40,85,0.85);
  backdrop-filter: blur(6px);
}

th, td {
  padding: 14px 10px;
  text-align: center;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

th {
  color: #ffb300;
  cursor: pointer;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.83rem;
}

tr:nth-child(even) {
  background: rgba(255,255,255,0.035);
}

tr:hover {
  background: rgba(255,179,0,0.12);
  transition: 0.15s ease;
  box-shadow: 0 0 14px rgba(255,179,0,0.35) inset;
}

/* Demand bar */
.demand-bar {
  width: 100%;
  height: 8px;
  border-radius: 6px;
  background: linear-gradient(
    to right,
    #1DB954 var(--eco),
    #FFB300 var(--eco) var(--biz),
    #FF6F00 var(--biz) 100%
  );
  box-shadow: 0 0 6px rgba(255,179,0,0.3);
  margin-top: 6px;
}
       
/* Buttons */
       
.acs-btn {
  background-color: #00a86b;
  color: #fff;
  border: none;
  padding: 7px 16px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: .25s;
}

.acs-btn:hover {
  background-color: #00794f;
  transform: scale(1.05);
}

.acs-btn-info {
  background: rgba(20,40,85,0.85);
  color: #ffb300;
  border: 1px solid #ffb300;
  padding: 7px 14px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: .25s;
}

.acs-btn-info:hover {
  background: #ffb300;
  color: #081530;
  transform: scale(1.05);
}

/* Back Button */
.back-btn {
  margin: 2.5rem auto;
  background: none;
  border: 1px solid #ffb300;
  color: #ffb300;
  padding: 10px 22px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
}

.back-btn:hover {
  background: #ffb300;
  color: #081530;
}

/* Pie chart */
.demand-pie {
  width: 58px;
  height: 58px;
  margin: 8px auto 0 auto;
  border-radius: 50%;
  position: relative;
  background: conic-gradient(
    #1DB954 0deg var(--eco),
    #FFB300 var(--eco) var(--biz),
    #FF6F00 var(--biz) 360deg
  );
  box-shadow: 0 0 10px rgba(255,179,0,0.45);
}

.demand-pie .slice {
  position: absolute;
  inset: 9px;
  background: #081530;
  border-radius: 50%;
}

/* Modal */
.acs-modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(4px);
  justify-content: center;
  align-items: center;
  z-index: 9000;
}

.acs-modal-box {
  background: rgba(12,23,50,0.92);
  border: 2px solid #ffb300;
  border-radius: 18px;
  padding: 20px 26px;
  width: 420px;
  max-height: 80vh;
  overflow-y: auto;
  color: #fff;
  box-shadow: 0 0 25px rgba(255,179,0,0.35);
  animation: fadeIn .25s ease;
}

.acs-modal-close {
  margin-top: 18px;
  width: 100%;
  background: none;
  border: 1px solid #ffb300;
  border-radius: 10px;
  color: #ffb300;
  padding: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: .25s;
}

.acs-modal-close:hover {
  background: #ffb300;
  color: #081530;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.92); }
  to   { opacity: 1; transform: scale(1); }
}

/* Country selector */
       
.country-select {
  background: linear-gradient(180deg, #2e3f6e, #1e2d55);
  color: #ffffff;
  border: 2px solid #ffb300;
  padding: 5px 28px 5px 12px;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  box-shadow: 0 0 12px rgba(255,179,0,0.25);
  background-image: url("data:image/svg+xml;utf8,<svg fill='%23ffffff' height='16' width='16' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 13px;
}

.country-filter {
  margin: 4px auto 26px auto;
  display: flex;
  justify-content: center;
}

.country-select {
  width: 160px;
}

/* ===== CONTINENT QUICK ACCESS ===== */
.continent-access {
  margin-top: 32px;
  margin-bottom: 38px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 18px;
}

.continent-btn {
  display: inline-block;
  text-decoration: none;
  padding: 8px 18px;
  font-size: 0.9rem;
  font-weight: 600;
  border-radius: 12px;
  border: 2px solid #ffb300;
  background: rgba(20,40,80,0.45);
  color: #ffe7a0;
  cursor: pointer;
  transition: 0.25s ease;
  box-shadow: 0 0 10px rgba(255,179,0,0.25);
}

.continent-btn:hover {
  background: #ffb300;
  color: #081530;
  transform: scale(1.07);
  box-shadow: 0 0 18px rgba(255,179,0,0.55);
}
       
/* ============================================================
   === SLOT BAR (AGREGADO, COLUMNA 5) ‚Äî v1.0 ===================
   ============================================================ */

.slot-bar {
  width: 100%;
  height: 8px;
  border-radius: 6px;
  background: rgba(255,255,255,0.10);
  margin-top: 6px;
  overflow: hidden;
}

.slot-bar-fill {
  height: 100%;
  border-radius: 6px;
  transition: width .25s ease;
  box-shadow: 0 0 6px rgba(255,255,255,0.28);
}

/* ============================================================
   üü© ACS DEMAND WEEKLY BAR ‚Äî AIRBUS STYLE
   ============================================================ */

.acs-demand-row{
  margin-bottom:14px;
}

.acs-demand-day{
  font-size:13px;
  color:#7f8da3;
  margin-bottom:4px;
  letter-spacing:1px;
}

.acs-demand-bar{
  width:100%;
  height:14px;
  border-radius:6px;
  overflow:hidden;
  background:#0a162f;
  display:flex;
  box-shadow:0 0 10px rgba(0,0,0,0.6);
}

.acs-demand-segY{
  background:#00AEEF;
  box-shadow:0 0 6px rgba(0,174,239,0.7);
}

.acs-demand-segC{
  background:#FF8C00;
  box-shadow:0 0 6px rgba(255,140,0,0.7);
}

.acs-demand-segF{
  background:#FFD700;
  box-shadow:0 0 8px rgba(255,215,0,0.9);
}

.acs-demand-values{
  font-size:12px;
  margin-top:4px;
  color:#cbd6ff;
}

th.sortable::after{

  content:" ‚áÖ";

  font-size:11px;

  color:#00AEEF;

  opacity:0.7;

  margin-left:6px;

}

th.sort-asc::after{

  content:" ‚ñ≤";

  color:#00ff80;

}

th.sort-desc::after{

  content:" ‚ñº";

  color:#ffb300;

}

/* ============================================================
   ‚úàÔ∏è ACS TABLE HEADER ‚Äî AIRBUS OCC / QATAR LUXURY STYLE
   ============================================================ */

#airportTable th{
  position:relative;
  cursor:pointer;
  user-select:none;
  font-weight:600;
  letter-spacing:0.4px;
  transition:all 0.25s ease;
}

/* hover effect Airbus style */
#airportTable th:hover{
  color:#00ffa6;
  text-shadow:0 0 6px rgba(0,255,166,0.35);
}

/* default arrows */
#airportTable th::after{
  content:"‚áÖ";
  font-size:13px;
  margin-left:8px;
  opacity:0.35;
  color:#6faeff;
  transition:all 0.2s ease;
}

/* ascending */
#airportTable th.sort-asc{
  color:#00ffa6;
}

#airportTable th.sort-asc::after{
  content:"‚ñ≤";
  opacity:1;
  color:#00ffa6;
  text-shadow:0 0 6px rgba(0,255,166,0.6);
}

/* descending */
#airportTable th.sort-desc{
  color:#00ffa6;
}

#airportTable th.sort-desc::after{
  content:"‚ñº";
  opacity:1;
  color:#00ffa6;
  text-shadow:0 0 6px rgba(0,255,166,0.6);
}

/* ============================================================
   ‚úàÔ∏è ACS TABLE HEADER ‚Äî AIRBUS OCC / QATAR EXECUTIVE STYLE
   ============================================================ */

#airportTable thead tr{
  background:linear-gradient(
    180deg,
    rgba(25,40,75,0.95),
    rgba(15,28,55,0.95)
  );

  border-bottom:1px solid rgba(0,255,166,0.15);

  box-shadow:
    inset 0 -1px 0 rgba(0,255,166,0.12),
    0 4px 12px rgba(0,0,0,0.35);
} 

@media(max-width:600px){

  #acsSlotContent > div{

    grid-template-columns:1fr !important;

  }

}
       
</style>
</head>

<body>

  <!-- HEADER -->
  <header class="acs-header">
    <div class="acs-logo">
      <img src="acs_logo.png" alt="ACS Logo" />
      <h1>Aviation Capital Simulator</h1>
    </div>

    <nav class="acs-nav">
      <a href="dashboard.html">Main</a>
      <a href="finance.html">Finance</a>
      <a href="aircraft.html">Aircraft</a>
      <a href="routes.html" class="active">Routes</a>
      <a href="hr.html">HR</a>
    </nav>

    <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn">Logout</a>
    <div class="acs-clock-header"><span id="acs-clock">00:00 ‚Äî 01 JAN 1940</span></div>
  </div>
</header>
     
  <!-- MAIN -->
     
  <main class="acs-main">
    <h2>üåç African Airports</h2>
    <p class="sub">Sort by demand, cost, or runway length. Click ‚ÄúCreate Route‚Äù to plan flights.</p>

    <div class="origin-banner">
      <span class="icon">üõ´</span>
      <span class="label">Base:</span>
      <span id="originFlag">üè≥Ô∏è</span>
      <strong id="originIcao">---</strong>
      <span id="originCity">‚Äî Loading...</span>
    </div>

     <!-- Country selector -->
       
    <div class="country-filter">
      <select id="countrySelect" class="country-select" onchange="filterByCountry()">
        <option value="ALL">üåç All Countries</option>
      </select>
    </div>

     <!-- ===== CONTINENT QUICK ACCESS (QATAR LUXURY) ===== -->
       
    <div class="continent-access">

     <a href="airport_list_europe.html" class="continent-btn">Europe</a>

     <a href="airport_list_asia.html" class="continent-btn">Asia</a>

     <a href="airport_list_northamerica.html" class="continent-btn">North America</a>

     <a href="airport_list_southamerica.html" class="continent-btn">South America</a>

     <a href="airport_list_oceania.html" class="continent-btn">Oceania</a>

     <a href="airport_list_middleeast.html" class="continent-btn">Middle East</a>

   </div>
       
    <!-- TABLE -->
       
    <table id="airportTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Airport (ICAO)</th>
          <th onclick="sortTable(1)">Country</th>
          <th onclick="sortTable(2)">Distance (NM)</th>
          <th onclick="sortTable(3)">Demand (Y/C/F)</th>
          <th onclick="sortTable(4)">Slots</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="airportTableBody"></tbody>
    </table>

    <button class="back-btn" onclick="window.location.href='routes.html'">‚¨Ö Back</button>
  </main>

  <footer>¬© 2026 Aviation Capital Simulator. All rights reserved.</footer>

  <!-- Tooltip -->
  <div id="demandTooltip"></div>

  <!-- MODAL -->
     
  <div id="airportInfoModal" class="acs-modal">
    <div class="acs-modal-box">
      <div id="modalContent">Loading...</div>
      <button class="acs-modal-close" onclick="closeAirportInfo()">Close</button>
    </div>
  </div>

<!-- ============================================================
     üü© ACS PASSENGER DEMAND MODAL ‚Äî WEEKLY DISTRIBUTION
     Airbus OCC + Qatar Executive Style
     ============================================================ -->
     
<div id="acsDemandModal" class="acs-modal">
  <div class="acs-modal-box" style="max-width:600px">

    <h3 id="acsDemandTitle">Passenger Demand</h3>

    <div id="acsDemandContent"></div>

    <button class="acs-modal-close"
            onclick="ACS_closeDemandModal()">Close</button>

  </div>
</div>

<!-- ============================================================
     üü© ACS AIRPORT SLOT DEMAND MODAL ‚Äî GLOBAL REUSABLE
     Airbus OCC + Qatar Executive Luxury
     Used in ALL continents
     ============================================================ -->
     
<div id="acsSlotModal" class="acs-modal">
  <div class="acs-modal-box" style="max-width:600px">

    <h3 id="acsSlotTitle"></h3>

    <div id="acsSlotContent"></div>

    <button class="acs-modal-close"
            onclick="ACS_closeSlotDemandModal()">
      Close
    </button>

  </div>
</div>
     
  <!-- SCRIPTS -->
     
  <script>
    window.WorldAirportsACS = window.WorldAirportsACS || {};
  </script>

  <!-- Dataset AFRICA -->
  <script src="engine/airports/world_airports_af.js"></script>

  <!-- ============================================================
     ‚è≥ ACS TIME ENGINE V12 ‚Äî 24/7 RECOVERY LAYER
     ============================================================ -->
<script src="acs_time_recovery.js"></script>
<script src="time_engine.js"></script>
  
  <!-- üîµ B1 ‚Äî Historical Airport Cost Engine -->
  <script src="engine/acs_airport_costs_engine.js?v=1.0"></script>
  
  <!--  üîµ A4 ‚Äî Slot Engine (DEBE IR ANTES DE airports_loader.js) -->
  <script src="engine/acs_slots_engine.js?v=2.0"></script>
     
  <!-- World + Loader + ACS Engines -->
  <script src="engine/airports_loader.js"></script>
  <script src="engine/acs_world_engine.js"></script>

   <script>
/* ============================================================
   === DISTANCE ENGINE =============================
   ============================================================ */
function distanceNM(lat1, lon1, lat2, lon2) {
  const R = 3440.065;
  const toRad = deg => deg * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);  // ‚úî CORRECTO

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) ** 2;

  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}


/* =============================================================
   === HISTORICAL AIRPORT ENGINE ‚Äî WITH SAFE FALLBACK ==========
   ============================================================= */
function getAirportsEuropeSafe() {
  try {
    if (window.ACS_World &&
        ACS_World.ready &&
        ACS_World.BY_CONTINENT &&
        Array.isArray(ACS_World.BY_CONTINENT["Europe"]) &&
        ACS_World.BY_CONTINENT["Europe"].length > 0) {

      console.log("üü¶ Using ACS_World (historical mode)");
      return ACS_World.BY_CONTINENT["Europe"];
    }
  } catch (err) {
    console.warn("ACS_World failed:", err);
  }

  console.log("üüß Fallback ‚Üí Using WorldAirportsACS (standard mode)");
  return WorldAirportsACS["Europe"] || [];
}

// ============================================================
// === BLOQUE 3 ‚Äî HISTORICAL DEMAND CURVE (A√ëADIDO) ============
// ============================================================

function getHistoricalFactor(year) {

  if (year < 1940) return 0.05;     // Aviaci√≥n temprana
  if (year < 1950) return 0.10;     // WWII / posguerra
  if (year < 1958) return 0.25;     // Era turboprop
  if (year < 1965) return 0.45;     // Jet Age inicial
  if (year < 1975) return 0.60;     // Boom internacional
  if (year < 1990) return 0.80;     // Aviaci√≥n moderna temprana

  return 1.00; // 1990‚Äì2025 demanda moderna
}

// ============================================================
// === BLOQUE 4 ‚Äî HISTORICAL CLASS ENGINE (A√ëADIDO) ============
// ============================================================

function adjustPassengerClasses(demand) {

  const year =
    window.ACS_TIME &&
    window.ACS_TIME.currentTime instanceof Date
      ? window.ACS_TIME.currentTime.getFullYear()
      : 1940;

  let Y = demand.Y;
  let C = demand.C;
  let F = demand.F;

  // aplicar factor hist√≥rico general
  const factor = getHistoricalFactor(year);
  Y = Math.round(Y * factor);
  C = Math.round(C * factor);
  F = Math.round(F * factor);

  // activaci√≥n hist√≥rica de clases
  if (year < 1955) {
    C = 0;
    F = 0;
  } else if (year < 1975) {
    F = 0;
  }

  return { Y, C, F };
}

/* ============================================================
   === GET SLOT HTML (bar + values) ‚Äî v1.0 ======================
   ============================================================ */
function ACS_buildSlotCell(icao, category) {

  const max = ACS_getMaxSlotsByCategory(category);  
  if (!max) return "‚Äî"; 

  let usedTotal = 0;
  let count = 0;

  const slots = JSON.parse(localStorage.getItem("ACS_SLOTS") || "{}")[icao];
  if (slots) {
    const days = Object.keys(slots);
    days.forEach(day => {
      const times = Object.keys(slots[day]);
      times.forEach(time => {
        usedTotal += slots[day][time].used || 0;
        count++;
      });
    });
  }

  const usedAvg = count > 0 ? Math.round(usedTotal / count) : 0;
  const free = Math.max(0, max - usedAvg);
  const pct = Math.max(0, Math.min(100, (free / max) * 100));

  let color = "#00FF80";
  if (pct < 50 && pct >= 20) color = "#FFB300";
  if (pct < 20) color = "#FF2E2E";

  return `
  <div onclick="ACS_openSlotDemandModal('${icao}')"
       style="cursor:pointer">

    ${free} / ${max}

    <div class="slot-bar">
      <div class="slot-bar-fill"
           style="width:${pct}%; background:${color};"></div>
    </div>

  </div>
`;
}
        
/* =============================================================
   === HISTORICAL AIRPORT ENGINE ‚Äî AFRICA SAFE MODE ============
   ============================================================= */
        
function getAirportsAfricaSafe() {
  try {
    if (window.ACS_World &&
        ACS_World.ready &&
        ACS_World.BY_CONTINENT &&
        Array.isArray(ACS_World.BY_CONTINENT["Africa"]) &&
        ACS_World.BY_CONTINENT["Africa"].length > 0) {

      console.log("üü¶ Using ACS_World (historical mode) ‚Äî Africa");
      return ACS_World.BY_CONTINENT["Africa"];
    }
  } catch (err) {
    console.warn("ACS_World failed (Africa):", err);
  }

  console.log("üüß Fallback ‚Üí Using WorldAirportsACS (standard mode) ‚Äî Africa");
  return WorldAirportsACS["Africa"] || [];
}
        
/* ============================================================
   === FIND BASE AIRPORT (GLOBAL ‚Äî ANY CONTINENT) ===============
   ============================================================ */
        
function findBaseAirportGlobal() {

  const baseIcao = localStorage.getItem("ACS_baseICAO") || null;
  if (!baseIcao) return null;

  // 1. Usar ACS_World si est√° listo
  if (window.ACS_World &&
      ACS_World.ready &&
      ACS_World.INDEX_ICAO &&
      ACS_World.INDEX_ICAO[baseIcao]) {

    return ACS_World.INDEX_ICAO[baseIcao];
  }

  // 2. Fallback: buscar en WorldAirportsACS
  for (const cont in WorldAirportsACS) {
    const list = WorldAirportsACS[cont];
    if (!Array.isArray(list)) continue;

    const ap = list.find(a => a.icao === baseIcao);
    if (ap) return ap;
  }

  return null;
}
        
/* ============================================================
   === WAIT FOR WORLD ENGINE BEFORE LOADING TABLE ===============
   ============================================================ */
        
function waitForWorldEngine(callback) {
     
  if (window.ACS_World && ACS_World.ready === true) {
    callback();
  } else {
    setTimeout(() => waitForWorldEngine(callback), 120);
  }
}

/* ============================================================
   === LOAD AIRPORTS (√ÅFRICA ‚Äî NM FIX FINAL) ===================
   ============================================================ */
        
 function loadAirports() {

  const tableBody = document.getElementById("airportTableBody");
  tableBody.innerHTML = "";

  const airports = getAirportsAfricaSafe();
  if (!airports || airports.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="5">No airports available.</td></tr>`;
    return;
  }

  // ‚úî BASE REAL DEL JUGADOR (GLOBAL)
  const userBase = localStorage.getItem("ACS_baseICAO") || null;
  const base = findBaseAirportGlobal();

  let baseLat = null, baseLon = null;
  if (base) {
    baseLat = base.latitude;
    baseLon = base.longitude;
  }

  // ORDENAR POR DEMANDA TOTAL (igual que Europa)
      
  const ordered = airports
    .filter(a => a.icao !== userBase)
    .sort((a, b) => {
      const ad = a.demand.Y + a.demand.C + a.demand.F;
      const bd = b.demand.Y + b.demand.C + b.demand.F;
      return bd - ad;
    });

  // CONSTRUIR SELECTOR DE PA√çSES (FIX HUECO VAC√çO)
      
const selector = document.getElementById("countrySelect");
if (selector) {
  selector.innerHTML = `<option value="ALL">üåç All Countries</option>`;

  const uniqueCountries = [...new Set(
    ordered
      .map(a => a.region)
      .filter(r => r && r.trim() !== "")
  )].sort();

  uniqueCountries.forEach(country => {
    const opt = document.createElement("option");
    opt.value = country;
    opt.textContent = country;
    selector.appendChild(opt);
  });
}

  // Build rows
  ordered.forEach(a => {

    let dist = "-";
    if (baseLat !== null && baseLon !== null) {
      dist = distanceNM(baseLat, baseLon, a.latitude, a.longitude);
    }

    const d = adjustPassengerClasses(a.demand);
    const total = d.Y + d.C + d.F || 1;
    const ecoPct = (d.Y / total) * 100;
    const bizPct = ((d.Y + d.C) / total) * 100;

    const slotHTML = ACS_buildSlotCell(a.icao, a.category);

    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="col-airport"><strong>${a.city}</strong> (${a.icao})</td>
      <td class="col-country">${a.region}</td>
      <td class="col-distance">${dist} NM</td>
      <td class="col-demand"
      style="cursor:pointer"
      onclick="ACS_openDemandModal('${a.icao}')">
      ${d.Y}/${d.C}/${d.F}
      <div class="demand-bar"
       style="--eco:${ecoPct}%;
              --biz:${bizPct}%"></div>
      </td>
      <td class="col-slots">${slotHTML}</td>
      <td class="col-action" style="display:flex; gap:10px; justify-content:center;">
        <button class="acs-btn-info" onclick="openAirportInfo('${a.icao}')">Info</button>
        <button class="acs-btn" onclick="ACS_openRouteSchedule('${a.icao}')">Create Route</button>
      </td>
    `;
    tableBody.appendChild(row);
  });

  // Safari fix
  const table = document.getElementById("airportTable");
  table.style.visibility = "hidden";
  setTimeout(() => { table.style.visibility = "visible"; }, 50);
}

/* ============================================================
   === FILTER BY COUNTRY (AFRICA ‚Äî FINAL FIX) ==================
   ============================================================ */
        
function filterByCountry() {

  const selected  = document.getElementById("countrySelect").value;
  const tableBody = document.getElementById("airportTableBody");
  tableBody.innerHTML = "";

  // Obtener aeropuertos del continente
  const airports = getAirportsAfricaSafe();
  if (!airports || airports.length === 0) return;

  // ‚úî BASE REAL DEL JUGADOR (GLOBAL)
  const userBase = localStorage.getItem("ACS_baseICAO") || null;
  const base = findBaseAirportGlobal();

  let baseLat = null;
  let baseLon = null;

  if (base) {
    baseLat = base.latitude;
    baseLon = base.longitude;
  }

  // Filtrar + ordenar por demanda total (igual que Europa)
  const filtered = airports
    .filter(a => a.icao !== userBase)
    .filter(a => selected === "ALL" || a.region === selected)
    .sort((a, b) => {
      const ad = a.demand.Y + a.demand.C + a.demand.F;
      const bd = b.demand.Y + b.demand.C + b.demand.F;
      return bd - ad;
    });

  if (filtered.length === 0) {
    tableBody.innerHTML = `
      <tr><td colspan="5">No airports for this country.</td></tr>
    `;
    return;
  }

  filtered.forEach(a => {
    let dist = "-";
    if (baseLat !== null && baseLon !== null) {
      dist = distanceNM(baseLat, baseLon, a.latitude, a.longitude);
    }

    const d = adjustPassengerClasses(a.demand);
    const total = d.Y + d.C + d.F || 1;
    const ecoPct = (d.Y / total) * 100;
    const bizPct = ((d.Y + d.C) / total) * 100;
    const slotHTML = ACS_buildSlotCell(a.icao, a.category);

    const row = document.createElement("tr");
    row.innerHTML = `
      <td><strong>${a.city}</strong> (${a.icao})</td>
      <td>${a.region}</td>
      <td>${dist} NM</td>
      <td class="col-demand"
      style="cursor:pointer"
      onclick="ACS_openDemandModal('${a.icao}')">

      ${d.Y}/${d.C}/${d.F}

      <div class="demand-bar"
       style="--eco:${ecoPct}%;
              --biz:${bizPct}%"></div>

      </td>

      <td>${slotHTML}</td>
      <td style="display:flex; gap:8px; justify-content:center;">
        <button class="acs-btn-info" onclick="openAirportInfo('${a.icao}')">Info</button>
        <button class="acs-btn" onclick="ACS_openRouteSchedule('${a.icao}')">Create Route</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

/* ============================================================
   üü© ACS GLOBAL TABLE SORT ENGINE v3.0
   Professional aviation-grade sorting engine
   Supports:
   ICAO, Country, Distance, Demand, Slots
   Ignores Action column automatically
   ============================================================ */

const ACS_TABLE_SORT_STATE = {};

function ACS_parseCellValue(cell, columnIndex){

  if(!cell) return "";

  const txt = cell.textContent.trim();

  switch(columnIndex){

    // Airport (ICAO)
    case 0:{
      const match = txt.match(/\((.*?)\)/);
      return match ? match[1].toUpperCase() : txt.toUpperCase();
    }

    // Country
    case 1:
      return txt.toUpperCase();

    // Distance (NM)
    case 2:{
      const num = parseFloat(txt.replace(/[^\d.]/g,""));
      return isNaN(num) ? 0 : num;
    }

    // Demand Y/C/F
    case 3:{
      const parts = txt.split("/");
      if(parts.length === 3){
        return (
          Number(parts[0]) +
          Number(parts[1]) +
          Number(parts[2])
        );
      }
      return 0;
    }

    // Slots free/max
    case 4:{
      const match = txt.match(/(\d+)\s*\/\s*(\d+)/);
      return match ? Number(match[1]) : 0;
    }

    default:
      return txt.toUpperCase();

  }

}
        
/* ============================================================
   === TABLE SORT (CLON EUROPA) ================================
   ============================================================ */
        
function sortTable(columnIndex){

  const table = document.getElementById("airportTable");
  const tbody = document.getElementById("airportTableBody");

  if(!table || !tbody) return;

  if(columnIndex === 5) return;

  const rows = Array.from(tbody.querySelectorAll("tr"));

  if(rows.length <= 1) return;

  const currentDir =
    ACS_TABLE_SORT_STATE[columnIndex] === "asc"
      ? "desc"
      : "asc";

  ACS_TABLE_SORT_STATE[columnIndex] = currentDir;

  rows.sort((a,b)=>{

    const A = ACS_parseCellValue(a.children[columnIndex], columnIndex);
    const B = ACS_parseCellValue(b.children[columnIndex], columnIndex);

    if(typeof A === "number" && typeof B === "number"){
      return currentDir === "asc"
        ? A - B
        : B - A;
    }

    return currentDir === "asc"
      ? String(A).localeCompare(String(B))
      : String(B).localeCompare(String(A));

  });

  tbody.innerHTML = "";
  rows.forEach(r => tbody.appendChild(r));

  // ‚úÖ update arrows (CORRECT LOCATION)
  const headers = table.querySelectorAll("th");

  headers.forEach(h=>{
    h.classList.remove("sort-asc","sort-desc");
  });

  headers[columnIndex].classList.add(
    currentDir === "asc"
      ? "sort-asc"
      : "sort-desc"
  );

}

/* ============================================================
   üü¶ U1 ‚Äî REAL AIRPORT UTILIZATION (LIVE) ‚Äî FIX v2
   Source of Truth: localStorage.scheduleItems
   - NO depende de ACS_PAX (evita 0/IDLE por passenger_engine ausente)
   - Weekly schedule ‚Üí Daily average (√∑7) para % realista
   - No fake pax: si no se resuelven seats ‚Üí 0
   ============================================================ */

function ACS_resolveAircraftSeatsForFlight(f){
  // 1) direct fields on schedule item (if present)
  const direct =
    Number(f.seats) ||
    Number(f.paxCapacity) ||
    Number(f.capacity);

  if (Number.isFinite(direct) && direct > 0) return direct;

  // 2) try common fleet stores (by aircraftId)
  const stores = [
    "ACS_Fleet",
    "ACS_fleet",
    "ACS_MY_FLEET",
    "ACS_myFleet",
    "myAircraft",
    "ACS_AircraftOwned"
  ];

  for (const k of stores){
    try{
      const arr = JSON.parse(localStorage.getItem(k) || "[]");
      if (Array.isArray(arr)){
        const ac = arr.find(x => x && (x.id === f.aircraftId || x.aircraftId === f.aircraftId));
        if (ac){
          const s =
            Number(ac.seats) ||
            Number(ac.paxCapacity) ||
            Number(ac.capacity) ||
            Number(ac.totalSeats);

          if (Number.isFinite(s) && s > 0) return s;
        }
      }
    }catch(e){}
  }

  // 3) last-resort model heuristics (ONLY if known ‚Äî no fake pax)
  const mk = String(f.modelKey || f.aircraft || "").toUpperCase();
  if (mk.includes("307")) return 33; // 307 Stratoliner (known)
  return 0; // unknown -> 0
}

/* ============================================================
   üüß U3 ‚Äî REAL UTILIZATION (HYBRID) + DEMAND CAPTURE (OPTION B)
   ------------------------------------------------------------
   PRIMARY: ACS_TRAFFIC_LOG (real transported pax)
   FALLBACK: scheduleItems + ACS_PAX.calculate (predicted live)
   Adds: demandCapturePct vs marketDemand (totalDemand)
   Global-ready for 6 continents
   Date: 20 FEB 2026
   ============================================================ */

function ACS_getAirportRealUtilization(icao, marketThroughput, marketDemand){

  const out = {
    pax: 0,
    flights: 0,
    utilizationPct: 0,
    demandCapturePct: 0,

    // debug / transparency
    source: "IDLE",
    paxWeekly: 0,
    flightsWeekly: 0
  };

  const I = String(icao || "").toUpperCase();
  if (!I) return out;

  const thr = Number(marketThroughput) || 0;
  const dem = Number(marketDemand) || 0;

  /* ============================================================
     1) PRIMARY ‚Äî Real transported pax from ACS_TRAFFIC_LOG (7d avg)
     ============================================================ */
  let log = [];
  try{
    log = JSON.parse(localStorage.getItem("ACS_TRAFFIC_LOG") || "[]");
  }catch(e){
    log = [];
  }

  if (Array.isArray(log) && log.length){

    const now = Date.now();
    const WEEK_MS = 7 * 24 * 60 * 60 * 1000;

    let paxWeekly = 0;
    let flightsWeekly = 0;

    for(const f of log){

      if(!f) continue;

      const o = String(f.origin || "").toUpperCase();
      const d = String(f.destination || "").toUpperCase();

      if(o !== I && d !== I) continue;

      if(!f.ts) continue;
      if(now - Number(f.ts) > WEEK_MS) continue;

      paxWeekly += Number(f.pax || 0);
      flightsWeekly += 1;

    }

    const paxDailyReal = Math.round(paxWeekly / 7);

    if(paxDailyReal > 0){

      out.pax = paxDailyReal;
      out.flights = flightsWeekly;          // weekly flight touches (debug)
      out.paxWeekly = paxWeekly;
      out.flightsWeekly = flightsWeekly;

      out.source = "TRAFFIC_LOG";

      if (thr > 0){
        out.utilizationPct = Math.max(0, Math.min(100, Math.round((out.pax / thr) * 100)));
      } else {
        out.utilizationPct = 0;
      }

      if (dem > 0){
        out.demandCapturePct = Math.max(0, Math.min(100, Math.round((out.pax / dem) * 100)));
      } else {
        out.demandCapturePct = 0;
      }

      return out;

    }

  }

  /* ============================================================
     2) FALLBACK ‚Äî Predicted live pax from scheduleItems + ACS_PAX
     (keeps airports from going IDLE before first arrivals)
     ============================================================ */

  /* Resolve sim day safely from ACS_TIME */
let dayKey = "mon";
let year = 1944;

try{

  if(window.ACS_TIME?.currentTime){

    const d = window.ACS_TIME.currentTime;

    year = d.getFullYear();

    const days = ["sun","mon","tue","wed","thu","fri","sat"];
    dayKey = days[d.getDay()] || "mon";

  }

}catch(e){}
     

  let items = [];
  try{
    items = JSON.parse(localStorage.getItem("scheduleItems") || "[]");
  }catch(e){
    items = [];
  }

  const normDay = (v) => String(v || "").trim().toLowerCase().slice(0,3);
  const dayKeyN = normDay(dayKey);

  const allFlights = (Array.isArray(items) ? items : []).filter(x => x && x.type === "flight");

  // flights scheduled for TODAY (sim day)
  let flights = allFlights.filter(x => normDay(x.day) === dayKeyN);

  // fallback: if none scheduled today, use all flights
  if (!flights.length) flights = allFlights;

  if (!flights.length) return out;

  const hasPaxEngine = window.ACS_PAX && typeof ACS_PAX.calculate === "function";
  if (!hasPaxEngine) return out;

  flights.forEach(f => {

    const origin = String(f.origin || "").toUpperCase();
    const dest   = String(f.destination || "").toUpperCase();

    if (origin !== I && dest !== I) return;

    const seats = ACS_resolveAircraftSeatsForFlight(f);
    if (!seats) return;

    const distanceNM = Number(f.distanceNM) || 0;

    const paxRes = ACS_PAX.calculate({
      year,
      route: {
        origin,
        destination: dest,
        distanceNM
      },
      aircraft: {
        seats
      },
      time: {
        departureHHMM: String(f.departure || "12:00")
      }
    });

    const pax = Math.max(0, Math.round(Number(paxRes && paxRes.pax) || 0));
    if (!pax) return;

    out.pax += pax;
    out.flights += 1;

  });

  out.source = out.pax > 0 ? "PAX_PREDICT" : "IDLE";

  if (thr > 0){
    out.utilizationPct = Math.max(0, Math.min(100, Math.round((out.pax / thr) * 100)));
  }else{
    out.utilizationPct = 0;
  }

  if (dem > 0){
    out.demandCapturePct = Math.max(0, Math.min(100, Math.round((out.pax / dem) * 100)));
  }else{
    out.demandCapturePct = 0;
  }

  return out;

}
        
/* =============================================================
   === MODAL ====================================================
   ============================================================= */
function openAirportInfo(icao) {

  const airports = getAirportsEuropeSafe();
  const ap = airports.find(a => a.icao === icao);
  if (!ap) return;

  const modal   = document.getElementById("airportInfoModal");
  const title   = document.getElementById("modalTitle");
  const content = document.getElementById("modalContent");

  // ===============================
  // LIVE TIME
  // ===============================
  let year = 1940;
  try {
    year = ACS_TIME.currentTime.getFullYear();
  } catch(e){}

  // ===============================
  // LIVE ECONOMICS
  // ===============================
  const econ = ACS_adjustAirportFees(ap, year);

  // ===============================
  // STRUCTURAL CAPACITY
  // ===============================
  const market = ACS_getAirportMarketCapacity(ap);

  // ===============================
  // STRUCTURAL DEMAND (TABLE SOURCE)
  // ===============================
  const demand = adjustPassengerClasses(ap.demand);

  const totalDemand =
    (demand.Y || 0) +
    (demand.C || 0) +
    (demand.F || 0);

 // ===============================
// REAL UTILIZATION (ONLY REAL DATA)
// ===============================

const real = ACS_getAirportRealUtilization(
  ap.icao,
  market.throughput,
  totalDemand
) || {};
     
const usedPct = Number(real.utilizationPct) || 0;
const realPax = Number(real.pax) || 0;

  // ===============================
  // STATUS COLOR
  // ===============================
  let barColor = "#1ec97b";
  let status   = "IDLE";

  if(usedPct >= 90){
    barColor = "#ff3b30";
    status = "CAPACITY CONSTRAINED";
  }
  else if(usedPct >= 75){
    barColor = "#ff9800";
    status = "HIGH UTILIZATION";
  }
  else if(usedPct >= 40){
    barColor = "#FFC107";
    status = "ACTIVE";
  }
  else if(usedPct > 0){
    barColor = "#34c759";
    status = "LOW UTILIZATION";
  }

  // ===============================
  // ROLE
  // ===============================
  let role = "Regional Node";

  if(ap.category === "Primary Hub")
    role = "International Gateway";

  else if(ap.category === "Major Regional")
    role = "Regional Hub";

// ===============================
// BUILD PANEL ‚Äî AIRBUS OCC GRID
// ===============================

content.innerHTML = `

<div class="acs-ops-panel">

<!-- ============================================================
     ‚úàÔ∏è AIRPORT TITLE ‚Äî AIRBUS OCC REAL CLASSIFICATION
     Clean ‚Äî Real aviation terminology ‚Äî No duplication
     ============================================================ -->

<div style="
text-align:center;
margin-bottom:16px;
">

  <!-- SYSTEM LABEL -->
  <div style="
  font-family:Orbitron;
  font-size:11px;
  color:#ffb300;
  letter-spacing:2px;
  margin-bottom:5px;
  ">
  AIRPORT INFORMATION
  </div>

  <!-- AIRPORT NAME -->
  <div style="
  font-family:Orbitron;
  font-size:24px;
  color:#00ff9c;
  letter-spacing:2px;
  font-weight:600;
  text-shadow:0 0 10px rgba(0,255,156,0.35);
  ">
  ${ap.city.toUpperCase()} ‚Äî ${ap.icao}
  </div>

  <!-- REAL AVIATION CLASSIFICATION -->
  <div style="
  font-family:Orbitron;
  font-size:12px;
  color:#7f8da3;
  letter-spacing:1.5px;
  margin-top:6px;
  ">

  ${
    ap.category === "Primary Hub"
      ? "INTERNATIONAL AIRPORT"

    : ap.category === "Major Regional"
      ? "REGIONAL AIRPORT"

    : ap.category === "Regional"
      ? "REGIONAL AIRPORT"

    : ap.category === "Secondary"
      ? "DOMESTIC AIRPORT"

    : "LOCAL AIRPORT"
  }

  </div>

</div>

<!-- GRID 2√ó2 STRUCTURE -->
<div style="
display:grid;
grid-template-columns:1fr 1fr;
gap:18px 24px;
align-items:start;
">


<!-- ================= LEFT TOP ================= -->
<div>

<div class="acs-section-title">
STRUCTURAL CAPACITY
</div>

<div style="font-size:13px; line-height:1.6">

Runway Length: <b>${ap.runway_m}</b> m<br>
Aircraft Capability: <b>${ap.aircraft_limit}</b><br>
Field Elevation: <b>${ap.elevation_ft}</b> ft<br>
Operating Window: <b>${ap.open_hrs}</b>

</div>

<div style="margin-top:10px">

Throughput Capacity<br>

<div style="
color:#00ff80;
font-weight:600;
font-size:16px;
margin-top:2px;
">

${market.throughput.toLocaleString()} pax/day

</div>

</div>

</div>


<!-- ================= RIGHT TOP ================= -->
<div>

<div class="acs-section-title">
PASSENGER DEMAND
</div>

<div style="
font-family:Orbitron;
font-size:14px;
letter-spacing:2px;
margin-top:6px;
color:#ffb300;
">

Y ${demand.Y.toLocaleString()}
&nbsp;&nbsp;&nbsp;
C ${demand.C.toLocaleString()}
&nbsp;&nbsp;&nbsp;
F ${demand.F.toLocaleString()}

</div>

<div style="
margin-top:6px;
color:#00ff80;
font-weight:600;
font-size:13px;
">

Total: ${totalDemand.toLocaleString()} pax/day

</div>

</div>


<!-- ================= LEFT BOTTOM ================= -->
<div>

<div class="acs-section-title">
REAL TRAFFIC UTILIZATION
</div>

<div style="
margin-top:6px;
font-size:13px;
">

<div style="margin-top:8px;">
Market demand capture:<br>
<b>${real.demandCapturePct}%</b> of <b>${totalDemand.toLocaleString()}</b> pax/day
</div>

<div style="margin-top:6px; opacity:0.75; font-size:12px;">
Source: <b>${real.source}</b>

</div>
</div>


<!-- STRUCTURAL UTILIZATION BAR -->
<div style="
margin-top:10px;
display:flex;
flex-direction:column;
align-items:center;
">

<div style="
width:100%;
max-width:240px;
height:6px;
background:#0a162f;
border-radius:4px;
border:1px solid rgba(255,255,255,0.08);
position:relative;
overflow:hidden;
">

<!-- 50% marker -->
<div style="
position:absolute;
left:50%;
top:0;
bottom:0;
width:1px;
background:rgba(255,179,0,0.35);
"></div>

<!-- REAL UTILIZATION -->
<div style="
width:${usedPct}%;
height:100%;
background:${barColor};
box-shadow:0 0 6px ${barColor};
transition:width 0.6s ease;
">
</div>

</div>

<!-- SCALE -->
<div style="
display:flex;
justify-content:space-between;
width:100%;
max-width:240px;
font-size:10px;
color:#7f8da3;
margin-top:4px;
font-family:Orbitron;
letter-spacing:1px;
">

<span>0%</span>
<span>50%</span>
<span>100%</span>

</div>

</div>


<div class="acs-status-chip"
style="
background:${barColor}22;
color:${barColor};
border:1px solid ${barColor};
margin-top:6px;
">

${usedPct}% ¬∑ ${status}

</div>

</div>


<!-- ================= RIGHT BOTTOM ================= -->
<div>

<div class="acs-section-title">
ECONOMIC ENVIRONMENT
</div>

<div style="font-size:13px; line-height:1.6">

Slot Fee: <b>$${econ.slot_cost.toLocaleString()}</b><br>
Landing Fee: <b>$${econ.landing_fee.toLocaleString()}</b><br>
Fuel Price: <b>$${econ.fuel_price}/gal</b><br>
Airport Charge: <b>${econ.ticket_fee}%</b>

</div>


<div class="acs-section-title" style="margin-top:14px">
NETWORK STATUS
</div>

<div style="font-size:13px">

Role: <b>${role}</b><br>

Congestion:

<span style="
color:${barColor};
font-weight:600;
">

${status}

</span>

</div>

</div>


</div>

</div>
`;

  modal.style.display = "flex";

}

function closeAirportInfo() {
  document.getElementById("airportInfoModal").style.display = "none";
}

/* ============================================================
   üü© ACS PASSENGER DEMAND ‚Äî GRID 2√ó2 AIRBUS OCC LAYOUT
   Compact, centered, Airbus green airport title
   Fully synchronized with table demand
   ============================================================ */

function ACS_openDemandModal(icao){

  const airports = getAirportsEuropeSafe();
  const ap = airports.find(a => a.icao === icao);
  if(!ap) return;

  const modal   = document.getElementById("acsDemandModal");
  const title   = document.getElementById("acsDemandTitle");
  const content = document.getElementById("acsDemandContent");

  /* ---------- TITLE ---------- */

  title.innerHTML = `
    <div style="text-align:center; line-height:1.25;">

      <div style="
        font-family:Orbitron;
        font-size:12px;
        color:#ffb300;
        letter-spacing:2px;
        margin-bottom:4px;
      ">
        PASSENGER DEMAND
      </div>

      <div style="
        font-family:Orbitron;
        font-size:22px;
        color:#00ff9c;
        letter-spacing:2px;
        font-weight:600;
        text-shadow:0 0 8px rgba(0,255,156,0.35);
      ">
        ${ap.city.toUpperCase()} ‚Äî ${ap.icao}
      </div>

    </div>
  `;

  /* ---------- REAL DEMAND SOURCE ---------- */

  const demand = adjustPassengerClasses(ap.demand);

  const days = ["MON","TUE","WED","THU","FRI","SAT","SUN"];

  const distribution =
    [0.14,0.13,0.14,0.13,0.16,0.17,0.13];

   /* ============================================================
   üü¶ ACS WEEKLY MAX CALCULATION ‚Äî REQUIRED FOR HYBRID SCALING
   ============================================================ */

  const dailyTotals = distribution.map(p =>
  Math.round(
    (demand.Y + demand.C + demand.F) * p
    )
 );

  const weeklyMax =
  Math.max(...dailyTotals, 1);
     
  /* ---------- STRUCTURAL LIMIT ---------- */

  let structuralMax = 300;

  if(ap.category === "Primary Hub") structuralMax = 1200;
  else if(ap.category === "Major Regional") structuralMax = 700;
  else if(ap.category === "Regional") structuralMax = 350;
  else structuralMax = 180;

  /* ---------- BUILD GRID ---------- */

  let html = `
    <div style="
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:18px 12px;
      justify-items:center;
      margin-top:10px;
    ">
  `;

  days.forEach((day, i)=>{

    const Y = Math.round(demand.Y * distribution[i]);
    const C = Math.round(demand.C * distribution[i]);
    const F = Math.round(demand.F * distribution[i]);

   /* ============================================================
   üü¶ ACS HYBRID DEMAND SCALING ENGINE v1.0
   Airbus OCC professional scaling
   Prevents stagnation and preserves realism
   ============================================================ */

const total = Y + C + F;

const structuralPct =
  structuralMax > 0
    ? (total / structuralMax) * 100
    : 0;

const relativePct =
  weeklyMax > 0
    ? (total / weeklyMax) * 100
    : 0;

/* hybrid scaling */
let pct =
  (structuralPct * 0.65) +
  (relativePct * 0.35);

/* minimum visibility */
pct = Math.max(12, Math.min(100, pct));

    html += `

      <div style="
        text-align:center;
        width:100%;
        max-width:180px;
      ">

        <!-- DAY -->
        <div style="
          font-family:Orbitron;
          font-size:13px;
          color:#ffffff;
          letter-spacing:2px;
          margin-bottom:4px;
        ">
          ${day}
        </div>

        <!-- BAR -->
        <div style="
          width:100%;
          height:8px;
          background:rgba(255,255,255,0.06);
          border-radius:4px;
          position:relative;
          border:1px solid rgba(255,179,0,0.25);
          overflow:hidden;
        ">

          <!-- DIVISION 1 -->
          <div style="
            position:absolute;
            left:33.33%;
            top:0;
            bottom:0;
            width:1px;
            background:rgba(255,179,0,0.4);
          "></div>

          <!-- DIVISION 2 -->
          <div style="
            position:absolute;
            left:66.66%;
            top:0;
            bottom:0;
            width:1px;
            background:rgba(255,179,0,0.4);
          "></div>

          <!-- DEMAND -->
          <div style="
            width:${pct}%;
            height:100%;
            background:
              linear-gradient(
                90deg,
                #003a7a,
                #0066cc,
                #00AEEF,
                #33d6ff
              );
            box-shadow:
              0 0 6px rgba(0,174,239,0.6);
          ">
          </div>

        </div>

        <!-- Y C F -->
        <div style="
          display:grid;
          grid-template-columns:1fr 1fr 1fr;
          font-family:Orbitron;
          font-size:11px;
          color:#ffb300;
          margin-top:4px;
        ">

          <div>Y ${Y}</div>
          <div>C ${C}</div>
          <div>F ${F}</div>

        </div>

      </div>

    `;
  });

  html += `</div>`;

  content.innerHTML = html;

  modal.style.display = "flex";
}

function ACS_closeDemandModal(){
  document.getElementById("acsDemandModal").style.display = "none";
}
     
window.addEventListener("click", (e) => {
  const modal = document.getElementById("airportInfoModal");
  if (e.target === modal) modal.style.display = "none";
});

/* ============================================================
   üü© ACS SLOT DEMAND MODAL ‚Äî GLOBAL VERSION
   Airbus OCC + Qatar Executive
   Live slot infrastructure visualization
   ============================================================ */

function ACS_openSlotDemandModal(icao){

  const airports = getAirportsEuropeSafe();
  const ap = airports.find(a => a.icao === icao);

  if(!ap) return;

  const modal   = document.getElementById("acsSlotModal");
  const title   = document.getElementById("acsSlotTitle");
  const content = document.getElementById("acsSlotContent");

  const maxSlots =
    ACS_getMaxSlotsByCategory(ap.category) || 0;

  let usedTotal = 0;
  let count = 0;

  const slots =
    JSON.parse(localStorage.getItem("ACS_SLOTS") || "{}")[icao];

  if(slots){

    Object.values(slots).forEach(day=>{
      Object.values(day).forEach(hour=>{
        usedTotal += Number(hour.used || 0);
        count++;
      });
    });

  }

  const usedAvg =
    count > 0 ? Math.round(usedTotal / count) : 0;

  const freeSlots =
    Math.max(0, maxSlots - usedAvg);

  const utilization =
    maxSlots > 0
      ? Math.round((usedAvg / maxSlots) * 100)
      : 0;

  /* COLOR LOGIC Airbus OCC */

  let color = "#00ff80";
  let status = "FULL CAPACITY AVAILABLE";

  if(utilization >= 85){
    color = "#ff3b30";
    status = "CAPACITY CONSTRAINED";
  }
  else if(utilization >= 65){
    color = "#ff9f0a";
    status = "HIGH UTILIZATION";
  }
  else if(utilization >= 40){
    color = "#ffd60a";
    status = "MODERATE UTILIZATION";
  }

  /* TITLE */

  title.innerHTML = `
  <div style="text-align:center">

    <div style="
      font-family:Orbitron;
      font-size:12px;
      color:#ffb300;
      letter-spacing:2px;
      margin-bottom:4px;
    ">
      AIRPORT SLOT DEMAND
    </div>

    <div style="
      font-family:Orbitron;
      font-size:22px;
      color:#00ff9c;
      letter-spacing:2px;
      font-weight:600;
    ">
      ${ap.city.toUpperCase()} ‚Äî ${ap.icao}
    </div>

  </div>
  `;

  /* 2√ó2 GRID */

  content.innerHTML = `

  <div style="
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:18px;
    margin-top:12px;
  ">

  <!-- PANEL 1 -->
  <div>

    <div class="acs-section-title">
      STRUCTURAL CAPACITY
    </div>

    <div style="font-size:14px; color:#00ff80">
      ${maxSlots} slots/hour
    </div>

    <div style="font-size:12px; opacity:0.7">
      Category: ${ap.category}
    </div>

  </div>

  <!-- PANEL 2 -->
  <div>

    <div class="acs-section-title">
      LIVE UTILIZATION
    </div>

    <div class="acs-capacity-bar">
      <div class="acs-capacity-fill"
           style="width:${utilization}%;
                  background:${color};
                  color:${color}">
      </div>
    </div>

    <div style="font-size:14px; margin-top:6px">
      ${utilization}%
    </div>

  </div>

  <!-- PANEL 3 -->
  <div>

    <div class="acs-section-title">
      SLOT AVAILABILITY
    </div>

    <div style="font-size:16px; color:${color}">
      ${freeSlots} free
    </div>

    <div style="font-size:12px">
      ${usedAvg} used
    </div>

  </div>

  <!-- PANEL 4 -->
  <div>

    <div class="acs-section-title">
      STATUS
    </div>

    <div class="acs-status-chip"
         style="
         color:${color};
         border:1px solid ${color};
         background:${color}22">

      ${status}

    </div>

  </div>

  </div>
  `;

  modal.style.display = "flex";

}

/* ============================================================
   CLOSE SLOT MODAL
   ============================================================ */

function ACS_closeSlotDemandModal(){

  document.getElementById("acsSlotModal").style.display = "none";

}
     
/* =============================================================
   === LOGOUT ===================================================
   ============================================================= */
function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}
        

 /* ============================================================
   === INITIALIZATION (AFRICA - SIMPLE, COMO EUROPA) ===========
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {

  // 1) Actualizamos el banner (visual)
  updateGlobalBaseBanner();

  // 2) Nos aseguramos que la BASE REAL exista
  ensureBaseBeforeLoad(() => {
    loadAirports();
  });

});
            
/* ============================================================
   === PHASE 2.1 ‚Äî SEND ORIGIN & DESTINATION TO SCHEDULE ======
   ------------------------------------------------------------
   Source: airport_list_*.html  (SouthAmerica, Europe, etc.)
   Purpose: open route_schedule.html with origin/dest selected
   ============================================================ */

function ACS_openRouteSchedule(destIcao) {
  // 1) Recuperar la base global como ORIGIN
  //    (ajusta esto si tu funci√≥n se llama distinto)
  let originIcao = null;

  try {
    // Si ya usas una funci√≥n global para la base:
    if (typeof findBaseAirportGlobal === "function") {
      const base = findBaseAirportGlobal();
      if (base && base.icao) {
        originIcao = base.icao.toUpperCase();
      }
    }

    // Fallback: si tienes la base guardada en localStorage
    if (!originIcao) {
      const baseIcao = localStorage.getItem("ACS_baseICAO");
      if (baseIcao) originIcao = baseIcao.toUpperCase();
    }
  } catch (e) {
    console.warn("ACS_openRouteSchedule: cannot resolve base", e);
  }

  if (!originIcao) {
    alert("‚ö†Ô∏è No base selected. Please choose a base first.");
    return;
  }

  // 2) Normalizar destino
  const dest = (destIcao || "").toUpperCase();
  if (!dest) {
    alert("‚ö†Ô∏è Destination not valid.");
    return;
  }

  // 3) Guardar selecci√≥n en localStorage (canal de transferencia)
  localStorage.setItem("ACS_selectedOrigin", originIcao);
  localStorage.setItem("ACS_selectedDestination", dest);

  // 4) Borrar cualquier modo edici√≥n previo
  localStorage.removeItem("editFlightID");

  // 5) Ir a route_schedule
  window.location.href = "route_schedule.html";
}
        
</script>

</body>
</html>
