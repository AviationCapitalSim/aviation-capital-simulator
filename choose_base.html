<!-- === CHOOSE BASE MODULE ‚Äî Qatar Luxury Edition === -->
<!-- Version: Beta v4 HISTORICAL DYNAMIC | Date: 26 NOV 2025 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Choose Base - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">

  <!-- ======== Apple Home Screen ======== -->
  <link rel="apple-touch-icon" href="acs_logo_180.png">

  <!-- ======== PWA Manifest ======== -->
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      margin: 0;
      background-color: #0C1F3C;
      color: white;
      font-family: "Poppins", sans-serif;
      padding-top: 120px;
      text-align: center;
    }

    /* ============================================================
         QATAR LUXURY HEADER ‚Äî EXACT COPY
       ============================================================ */
    .acs-header {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 0.8rem 2rem;
      background: rgba(12,23,50,0.45);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(255,179,0,0.35);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 1000;
      animation: acsHeaderFade 0.8s ease forwards;
    }

    @keyframes acsHeaderFade {
      from { opacity:0; transform: translateY(-10px); }
      to   { opacity:1; transform: translateY(0); }
    }

    .acs-logo { display: flex; align-items: center; gap: 0.6rem; }
    .acs-logo img { height: 46px; filter: drop-shadow(0 0 6px rgba(255,179,0,0.35)); }
    .acs-logo h1 {
      color: #FFB300;
      font-size: 1.15rem;
      margin: 0;
      letter-spacing: 0.6px;
      text-shadow: 0 0 8px rgba(255,179,0,0.4);
    }

    .nav-btn {
      padding: 0.45rem 1.2rem;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: 0.25s;
      min-width: 100px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .nav-btn-blue {
      color: #8AB4FF;
      border-color: rgba(138,180,255,0.45);
    }

    .nav-btn-blue:hover {
      background: rgba(138,180,255,0.20);
      box-shadow: 0 0 12px rgba(138,180,255,0.55);
    }

    .acs-clock-header {
      font-family: 'Orbitron', monospace;
      color: #00ff80;
      background: rgba(0,255,128,0.08);
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-left: 1rem;
    }

    /* ============================================================
         QATAR LUXURY MAIN CARD
       ============================================================ */
    .form-container {
      background: linear-gradient(145deg, #102040 0%, #0b1a33 100%);
      max-width: 1000px;
      margin: 0 auto;
      padding: 2.4rem;
      border-radius: 22px;
      border: 1px solid rgba(255,179,0,0.22);
      box-shadow: 0 0 30px rgba(0,0,0,0.55),
                  inset 0 0 25px rgba(255,255,255,0.04);
      backdrop-filter: blur(14px);
    }

    h2 { color: #FFB300; font-size: 1.8rem; }
    p  { color: #c9d4ff; font-size: 1rem; }

    /* ============================================================
         SELECTS
       ============================================================ */
    .lux-select {
      width: 48%;
      padding: 0.85rem 1rem;
      border-radius: 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,179,0,0.25);
      color: #e8ecff;
      font-size: 1rem;
      font-weight: 500;
      backdrop-filter: blur(12px);
      box-shadow: inset 0 0 18px rgba(255,255,255,0.04);
      transition: 0.25s;
    }

    .lux-select:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,179,0,0.45);
      box-shadow: 0 0 12px rgba(255,179,0,0.4),
                  inset 0 0 22px rgba(255,255,255,0.07);
    }

    /* ============================================================
         TABLE
       ============================================================ */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      overflow: hidden;
    }

    th {
      background: rgba(255,179,0,0.15);
      color: #FFB300;
      padding: 0.7rem;
      font-size: 0.95rem;
    }

    td {
      padding: 0.6rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align: center;
    }

    tr:hover { background: rgba(255,255,255,0.07); }

    /* ============================================================
         DEMAND BAR + TOOLTIP
       ============================================================ */
    #demandTooltip {
      position: absolute;
      display: none;
      background: rgba(10,25,60,0.95);
      color: #fff;
      border: 1px solid #FFB300;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.85rem;
      pointer-events: none;
      box-shadow: 0 0 10px rgba(255,179,0,0.3);
      z-index: 1000;
      width: 180px;
    }

    .demand-bar {
      width: 100%;
      height: 8px;
      border-radius: 6px;
      background: linear-gradient(to right, #1DB954 var(--eco), #FFB300 var(--eco) var(--biz), #FF6F00 var(--biz) 100%);
      box-shadow: 0 0 6px rgba(255,179,0,0.3);
      margin-top: 6px;
    }

    /* ============================================================
         GREEN BUTTON
       ============================================================ */
    .acs-btn {
      background-color: #1DB954;
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: 0.25s;
      box-shadow: 0 0 10px rgba(29,185,84,0.4);
    }

    .acs-btn:hover {
      background-color: #21e065;
      transform: scale(1.05);
      box-shadow: 0 0 16px rgba(29,185,84,0.6);
    }
  </style>
</head>

<body>

<header class="acs-header">
  <div class="acs-logo">
    <img src="acs_logo.png" alt="ACS Logo" />
    <h1>Aviation Capital Simulator</h1>
  </div>

  <div style="display:flex; align-items:center; gap:1rem;">
    <a href="support.html" class="nav-btn nav-btn-blue">Support</a>
    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 1940</div>
  </div>
</header>

<section class="form-container">
  <h2>Choose Your Base</h2>
  <p>Select a continent and country to establish your main operations base.</p>

  <div>
    <select id="continentSelect" class="lux-select">
      <option value="">üåç Select Continent</option>
      <option value="NorthAmerica">North America</option>
      <option value="SouthAmerica">South America</option>
      <option value="Europe">Europe</option>
      <option value="Asia">Asia</option>
      <option value="MiddleEast">Middle East</option>
      <option value="Africa">Africa</option>
      <option value="Oceania">Oceania</option>
    </select>

    <select id="countrySelect" class="lux-select">
      <option value="">üè≥Ô∏è Select Country</option>
    </select>
  </div>

  <table id="airportTable">
    <thead>
      <tr>
        <th>ICAO</th>
        <th>IATA</th>
        <th>City</th>
        <th>Airport</th>
        <th>Category</th>
        <th>Demand (Y/C/F)</th>
        <th>Slots</th>
        <th>Cost (USD)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="airportList">
      <tr><td colspan="9">Select a continent and country to view airports.</td></tr>
    </tbody>
  </table>
</section>

<footer>
  <p>¬© 2025 Aviation Capital Simulator. All rights reserved.</p>
</footer>

<div id="demandTooltip"></div>

<!-- ============================================================
     === SCRIPTS ================================================
     ============================================================ -->
  
<script src="time_engine.js"></script>
<script src="engine/airports_loader.js"></script>
<script src="engine/acs_country_history.js"></script> <!-- si lo usas -->
<script src="engine/acs_world_engine.js"></script>    <!-- üëà NUEVO -->

<!-- ============================================================
     === INITIALIZER (√öNICO BLOQUE CORRECTO) ====================
     ============================================================ -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  loadAirportScripts(() => {
  buildAirportIndex();     // loader original
  ACS_World.initialize();  // <-- ESTA L√çNEA ES LA QUE FALTABA
  console.log("üåç Motor mundial listo:", ACS_World.ready);

  document.getElementById("continentSelect")
    .addEventListener("change", loadCountries);

  document.getElementById("countrySelect")
    .addEventListener("change", loadAirports);
});

});
</script>
  
<script>
let selectedContinent = "";
let selectedCountry = "";

/* ============================================================
   === HISTORICAL GROUPS (OPCI√ìN 1) ============================
   ============================================================ */
const ACS_HISTORICAL_GROUPS = [
  {
    label: "Soviet Union",
    start: 1917,
    end: 1991,
    members: [
      "Russia","Belarus","Ukraine","Kazakhstan","Kyrgyzstan","Uzbekistan",
      "Turkmenistan","Tajikistan","Georgia","Armenia","Azerbaijan","Moldova","Lithuania","Latvia","Estonia"
    ]
  },
  {
    label: "Korea",
    start: 1900,
    end: 1948,
    members: ["South Korea","North Korea","Korea"]
  },
  {
    label: "French Indochina",
    start: 1887,
    end: 1954,
    members: ["Vietnam","Laos","Cambodia"]
  },
  {
    label: "British Protectorates",
    start: 1900,
    end: 1971,
    members: [
      "United Arab Emirates","Qatar","Bahrain","Kuwait","Oman",
      "Trucial States"
    ]
  }
];

/* ============================================================
   === AUX: Buscar entrada en ACS_CountryHistory ===============
   ============================================================ */
function findCountryHistory(name) {
  if (!window.ACS_CountryHistory) return null;
  return ACS_CountryHistory.find(c => c.name === name) || null;
}

/* ============================================================
   === RESOLVE COUNTRY LABEL FOR YEAR ==========================
   ============================================================ */
/**
 * Recibe un pa√≠s moderno (ej: "Russia") y un a√±o (ej: 1940)
 * Devuelve:
 *  - Un nombre hist√≥rico agrupado ("Soviet Union", "Korea", etc.)
 *  - O el mismo pa√≠s si existe en ese a√±o
 *  - O null si no deber√≠a mostrarse en ese a√±o
 */
function resolveCountryForYear(countryName, year) {
  if (!countryName) return null;

  // 1) ¬øPertenece a un grupo hist√≥rico?
  for (const group of ACS_HISTORICAL_GROUPS) {
    if (group.members.includes(countryName)) {
      if (year >= group.start && year <= group.end) {
        return group.label;
      }
      // Fuera del rango del grupo ‚Üí seguimos evaluando como pa√≠s moderno
    }
  }

  // 2) ¬øExiste este pa√≠s en la historia?
  const hist = findCountryHistory(countryName);
  if (hist) {
    const start = hist.start ?? -9999;
    const end = (hist.end === null || hist.end === undefined) ? 9999 : hist.end;
    if (year >= start && year <= end) {
      return countryName; // v√°lido en ese a√±o
    } else {
      return null; // pa√≠s moderno fuera de su rango
    }
  }

  // 3) Si no est√° en ACS_CountryHistory ‚Üí lo aceptamos siempre
  return countryName;
}
  
/* ============================================================
   === CONTINENT SELECT ‚Äî ALWAYS OPEN =========================
   ------------------------------------------------------------
   ‚ñ™ Muestra SIEMPRE los 7 continentes
   ‚ñ™ Sin "Unavailable in XXXX"
   ‚ñ™ Sin disabled
   ‚ñ™ Filtro hist√≥rico se hace luego
   ============================================================ */
function buildContinentSelect() {
  const continentSelect = document.getElementById("continentSelect");
  if (!continentSelect) return;

  const allContinents = [
    "NorthAmerica",
    "SouthAmerica",
    "Europe",
    "Asia",
    "MiddleEast",
    "Africa",
    "Oceania"
  ];

  continentSelect.innerHTML = '<option value="">üåç Select Continent</option>';

  allContinents.forEach(cont => {
    const opt = document.createElement("option");
    opt.value = cont;

    const pretty = cont.replace(/([A-Z])/g, " $1").trim();
    opt.textContent = pretty;
    opt.style.color = "#e8ecff";

    continentSelect.appendChild(opt);
  });
}


/* ============================================================
   CHOOSE_BASE ‚Äî loadCountries() (WorldAirportsACS + WorldEngine)
   ------------------------------------------------------------
   ‚ñ™ Usa directamente WorldAirportsACS[continent]
   ‚ñ™ Aplica fechas hist√≥ricas con ACS_World.airportExistsInYear
   ‚ñ™ No depende de √≠ndices internos del motor
   ============================================================ */
function loadCountries() {
  selectedContinent = document.getElementById("continentSelect").value;
  const countrySelect = document.getElementById("countrySelect");
  const list = document.getElementById("airportList");

  // Reset UI
  countrySelect.innerHTML = '<option value="">üè≥Ô∏è Select Country</option>';
  list.innerHTML = '<tr><td colspan="9">Select a continent and country to view airports.</td></tr>';

  if (!selectedContinent) return;

  const year = ACS_World.getSimYear();

  // üîπ Lista bruta del continente desde el LOADER
  const rawList =
    (window.WorldAirportsACS && WorldAirportsACS[selectedContinent])
      ? WorldAirportsACS[selectedContinent]
      : [];

  // üîπ Aplicar solo filtro hist√≥rico (apertura/cierre)
  const airports = rawList.filter(a => ACS_World.airportExistsInYear(a, year));

  if (!airports.length) {
    list.innerHTML = `<tr><td colspan="9">
      No airports available in this continent for the year ${year}.
    </td></tr>`;
    return;
  }

  // üîπ Extraer pa√≠ses reales de la base
  const countrySet = new Set();

  airports.forEach(a => {
    const country =
      (a.region && String(a.region).trim()) ||
      (a.country && String(a.country).trim()) ||
      (a.country_name && String(a.country_name).trim());

    if (country) countrySet.add(country);
  });

  const countries = Array.from(countrySet).sort();

  // Poblar select de pa√≠ses
  countries.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    countrySelect.appendChild(opt);
  });
}

/* Inicializar men√∫ de continentes al cargar */
document.addEventListener("DOMContentLoaded", () => {
  buildContinentSelect();
});

/* ============================================================
   LOAD AIRPORTS ‚Äî WorldAirportsACS + WorldEngine (Stable Beta)
   ------------------------------------------------------------
   ‚ñ™ Usa WorldAirportsACS[continent] como fuente principal
   ‚ñ™ Filtra por pa√≠s seleccionado + a√±o hist√≥rico
   ‚ñ™ Usa ACS_World.getHistoricalDemand para demanda
   ‚ñ™ Sin filtros artificiales (runway, etc.)
   ============================================================ */
function loadAirports() {
  selectedCountry = document.getElementById("countrySelect").value;
  const tbody = document.getElementById("airportList");
  tbody.innerHTML = "";

  if (!selectedContinent || !selectedCountry) {
    tbody.innerHTML = '<tr><td colspan="9">Please select both continent and country.</td></tr>';
    return;
  }

  const year = ACS_World.getSimYear();

  // üîπ Lista bruta del continente desde el LOADER
  const rawList =
    (window.WorldAirportsACS && WorldAirportsACS[selectedContinent])
      ? WorldAirportsACS[selectedContinent]
      : [];

  // üîπ Filtrar por pa√≠s y por a√±o hist√≥rico
  const airports = rawList.filter(a => {
    const country =
      (a.region && String(a.region).trim()) ||
      (a.country && String(a.country).trim()) ||
      (a.country_name && String(a.country_name).trim());

    if (!country) return false;
    if (country !== selectedCountry) return false;

    // Respetar apertura/cierre hist√≥rica del motor mundial
    return ACS_World.airportExistsInYear(a, year);
  });

  if (!airports.length) {
    tbody.innerHTML = `<tr><td colspan="9">
      No airports available in ${selectedCountry} for the year ${year}.
    </td></tr>`;
    return;
  }
/* ============================================================
   === HISTORICAL SORTING SYSTEM (C-2) =========================
   ------------------------------------------------------------
   ‚Ä¢ 1940‚Äì1954 ‚Üí ordenar por Y
   ‚Ä¢ 1955‚Äì1975 ‚Üí ordenar por Y + C
   ‚Ä¢ 1976+     ‚Üí ordenar por Y + C + F
   ============================================================ */
airports.sort((a, b) => {

  const D1 = ACS_World.getHistoricalDemand(a, year);
  const D2 = ACS_World.getHistoricalDemand(b, year);

  let totalA = 0;
  let totalB = 0;

  if (year < 1955) {
    // SOLO Y
    totalA = (D1.Y || 0);
    totalB = (D2.Y || 0);
  }
  else if (year < 1976) {
    // Y + C
    totalA = (D1.Y || 0) + (D1.C || 0);
    totalB = (D2.Y || 0) + (D2.C || 0);
  }
  else {
    // Y + C + F
    totalA = (D1.Y || 0) + (D1.C || 0) + (D1.F || 0);
    totalB = (D2.Y || 0) + (D2.C || 0) + (D2.F || 0);
  }

  // ORDEN DESCENDENTE (Mayor ‚Üí Menor)
  return totalB - totalA;
});

  airports.forEach(a => {
    // Demanda hist√≥rica real del motor mundial
    const D = ACS_World.getHistoricalDemand(a, year);
    const total = D.Y + D.C + D.F;

    const ecoPct = total ? (D.Y / total) * 100 : 0;
    const bizPct = total ? ((D.Y + D.C) / total) * 100 : 0;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${a.icao}</td>
      <td>${a.iata}</td>
      <td>${a.city}</td>
      <td>${a.name || a.city}</td>
      <td>${a.category}</td>
      <td>
        ${D.Y}/${D.C}/${D.F}
        <div class="demand-bar"
             style="--eco:${ecoPct}%; --biz:${bizPct}%"></div>
      </td>
      <td>${a.slot_capacity}</td>
      <td>$${(a.slot_cost_usd || 0).toLocaleString()}</td>
      <td><button class="acs-btn" onclick="setBase('${a.icao}')">
        Set as Base
      </button></td>
    `;
    tbody.appendChild(row);
  });
}

/* ============================================================
   SET BASE ‚Äî SE MANTIENE MODERNO (GUARDA a.region)
   (Luego el Dashboard har√° la magia hist√≥rica con banderas)
============================================================ */
function setBase(icao) {
  const airport = Object.values(WorldAirportsACS).flat().find(a => a.icao === icao);
  if (!airport) return alert("‚ö†Ô∏è Airport not found.");

  const user = JSON.parse(localStorage.getItem("ACS_activeUser"));
  if (!user || !user.airline) {
    alert("‚ö†Ô∏è No active session or airline found.");
    window.location.href = "login.html";
    return;
  }

  // üî• Guardar pa√≠s moderno del aeropuerto
  
   user.airline.country = airport.country || airport.region || "";

  // üî• BASE REAL (estructura moderna ACS)
  
  user.base = {
  icao: airport.icao,
  iata: airport.iata,
  city: airport.city,
  name: airport.name,
  country: airport.country || airport.region || "",
  continent: selectedContinent,
  demand_total: (airport.demand?.Y||0)+(airport.demand?.C||0)+(airport.demand?.F||0),
  slot_capacity: airport.slot_capacity,
  slot_cost_usd: airport.slot_cost_usd
};

// üî• COMPATIBILIDAD CON LOS 7 CONTINENTES (no tocar)
localStorage.setItem("ACS_baseICAO", airport.icao);
localStorage.setItem("ACS_baseIATA", airport.iata);
localStorage.setItem("ACS_baseCity", airport.city);
localStorage.setItem("ACS_baseName", airport.name);
localStorage.setItem("ACS_baseCountry", airport.country || airport.region || "");
localStorage.setItem("ACS_baseContinent", selectedContinent);

// üî• Guardar en ACS_activeUser y ACS_users
localStorage.setItem("ACS_activeUser", JSON.stringify(user));

const users = JSON.parse(localStorage.getItem("ACS_users")||"[]");
const index = users.findIndex(u => u.email === user.email);
if (index !== -1) users[index] = user;
localStorage.setItem("ACS_users", JSON.stringify(users));

alert(`‚úÖ Base set successfully at ${airport.city} (${airport.icao}).`);
window.location.href = "dashboard.html";


/* ============================================================
   DEMAND TOOLTIP
============================================================ */
const tooltip = document.getElementById("demandTooltip");

document.addEventListener("mousemove", e => {
  const cell = e.target.closest("td:nth-child(6)");
  if (cell && cell.textContent.includes("/")) {
    const parts = cell.textContent.trim().split("/");
    if (parts.length === 3) {
      const [Y, C, F] = parts.map(Number);
      const total = Y + C + F;
      const ecoDeg = total ? (Y/total)*360 : 0;
      const bizDeg = total ? ((Y+C)/total)*360 : 0;

      tooltip.innerHTML = `
        <h4>Passenger Demand</h4>
        <div>Economy: ${Y}</div>
        <div>Business: ${C}</div>
        <div>First: ${F}</div>
      `;
      tooltip.style.display = "block";
      tooltip.style.left = e.pageX + 15 + "px";
      tooltip.style.top = e.pageY - 60 + "px";
    }
  } else {
    tooltip.style.display = "none";
  }
});

</script>

</body>
</html>
