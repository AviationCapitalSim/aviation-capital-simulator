<!-- === CHOOSE BASE MODULE ‚Äî Qatar Luxury Edition === -->
<!-- Version: Beta v4 FIXED | Date: 26 NOV 2025 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Choose Base - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">

  <!-- ======== Apple Home Screen ======== -->
  <link rel="apple-touch-icon" href="acs_logo_180.png">

  <!-- ======== PWA Manifest ======== -->
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      margin: 0;
      background-color: #0C1F3C;
      color: white;
      font-family: "Poppins", sans-serif;
      padding-top: 120px;
      text-align: center;
    }

    /* ============================================================
         QATAR LUXURY HEADER ‚Äî EXACT COPY
       ============================================================ */
    .acs-header {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 0.8rem 2rem;
      background: rgba(12,23,50,0.45);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(255,179,0,0.35);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 1000;
      animation: acsHeaderFade 0.8s ease forwards;
    }

    @keyframes acsHeaderFade {
      from { opacity:0; transform: translateY(-10px); }
      to   { opacity:1; transform: translateY(0); }
    }

    .acs-logo { display: flex; align-items: center; gap: 0.6rem; }
    .acs-logo img { height: 46px; filter: drop-shadow(0 0 6px rgba(255,179,0,0.35)); }
    .acs-logo h1 {
      color: #FFB300;
      font-size: 1.15rem;
      margin: 0;
      letter-spacing: 0.6px;
      text-shadow: 0 0 8px rgba(255,179,0,0.4);
    }

    .nav-btn {
      padding: 0.45rem 1.2rem;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: 0.25s;
      min-width: 100px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .nav-btn-blue {
      color: #8AB4FF;
      border-color: rgba(138,180,255,0.45);
    }

    .nav-btn-blue:hover {
      background: rgba(138,180,255,0.20);
      box-shadow: 0 0 12px rgba(138,180,255,0.55);
    }

    .acs-clock-header {
      font-family: 'Orbitron', monospace;
      color: #00ff80;
      background: rgba(0,255,128,0.08);
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-left: 1rem;
    }

    /* ============================================================
         QATAR LUXURY MAIN CARD
       ============================================================ */
    .form-container {
      background: linear-gradient(145deg, #102040 0%, #0b1a33 100%);
      max-width: 1000px;
      margin: 0 auto;
      padding: 2.4rem;
      border-radius: 22px;
      border: 1px solid rgba(255,179,0,0.22);
      box-shadow: 0 0 30px rgba(0,0,0,0.55),
                  inset 0 0 25px rgba(255,255,255,0.04);
      backdrop-filter: blur(14px);
    }

    h2 { color: #FFB300; font-size: 1.8rem; }
    p  { color: #c9d4ff; font-size: 1rem; }

    /* ============================================================
         SELECTS
       ============================================================ */
    .lux-select {
      width: 48%;
      padding: 0.85rem 1rem;
      border-radius: 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,179,0,0.25);
      color: #e8ecff;
      font-size: 1rem;
      font-weight: 500;
      backdrop-filter: blur(12px);
      box-shadow: inset 0 0 18px rgba(255,255,255,0.04);
      transition: 0.25s;
    }

    .lux-select:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,179,0,0.45);
      box-shadow: 0 0 12px rgba(255,179,0,0.4),
                  inset 0 0 22px rgba(255,255,255,0.07);
    }

    /* ============================================================
         TABLE
       ============================================================ */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background: rgba(255,255,255,0.04);
      border-radius: 14px;
      overflow: hidden;
    }

    th {
      background: rgba(255,179,0,0.15);
      color: #FFB300;
      padding: 0.7rem;
      font-size: 0.95rem;
    }

    td {
      padding: 0.6rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align: center;
    }

    tr:hover { background: rgba(255,255,255,0.07); }

    /* ============================================================
         DEMAND BAR + TOOLTIP
       ============================================================ */
    #demandTooltip {
      position: absolute;
      display: none;
      background: rgba(10,25,60,0.95);
      color: #fff;
      border: 1px solid #FFB300;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.85rem;
      pointer-events: none;
      box-shadow: 0 0 10px rgba(255,179,0,0.3);
      z-index: 1000;
      width: 180px;
    }

    .demand-bar {
      width: 100%;
      height: 8px;
      border-radius: 6px;
      background: linear-gradient(to right, #1DB954 var(--eco), #FFB300 var(--eco) var(--biz), #FF6F00 var(--biz) 100%);
      box-shadow: 0 0 6px rgba(255,179,0,0.3);
      margin-top: 6px;
    }

    /* ============================================================
         GREEN BUTTON
       ============================================================ */
    .acs-btn {
      background-color: #1DB954;
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: 0.25s;
      box-shadow: 0 0 10px rgba(29,185,84,0.4);
    }

    .acs-btn:hover {
      background-color: #21e065;
      transform: scale(1.05);
      box-shadow: 0 0 16px rgba(29,185,84,0.6);
    }
  </style>
</head>

<body>

<header class="acs-header">
  <div class="acs-logo">
    <img src="acs_logo.png" alt="ACS Logo" />
    <h1>Aviation Capital Simulator</h1>
  </div>

  <div style="display:flex; align-items:center; gap:1rem;">
    <a href="support.html" class="nav-btn nav-btn-blue">Support</a>
    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 1940</div>
  </div>
</header>

<section class="form-container">
  <h2>Choose Your Base</h2>
  <p>Select a continent and country to establish your main operations base.</p>

  <div>
    <select id="continentSelect" class="lux-select">
      <option value="">üåç Select Continent</option>
      <option value="NorthAmerica">North America</option>
      <option value="SouthAmerica">South America</option>
      <option value="Europe">Europe</option>
      <option value="Asia">Asia</option>
      <option value="MiddleEast">Middle East</option>
      <option value="Africa">Africa</option>
      <option value="Oceania">Oceania</option>
    </select>

    <select id="countrySelect" class="lux-select">
      <option value="">üè≥Ô∏è Select Country</option>
    </select>
  </div>

  <table id="airportTable">
    <thead>
      <tr>
        <th>ICAO</th>
        <th>IATA</th>
        <th>City</th>
        <th>Airport</th>
        <th>Category</th>
        <th>Demand (Y/C/F)</th>
        <th>Slots</th>
        <th>Cost (USD)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="airportList">
      <tr><td colspan="9">Select a continent and country to view airports.</td></tr>
    </tbody>
  </table>
</section>

<footer>
  <p>¬© 2025 Aviation Capital Simulator. All rights reserved.</p>
</footer>

<div id="demandTooltip"></div>

<!-- ENGINE SCRIPTS -->
<script src="time_engine.js"></script>
<script src="engine/airports_loader.js"></script>
<script src="engine/acs_country_history.js"></script>

<script>
let selectedContinent = "";
let selectedCountry = "";

/* ============================================================
   LOAD COUNTRIES (MODO HIST√ìRICO SUAVE)
============================================================ */
function loadCountries() {
  selectedContinent = document.getElementById("continentSelect").value;
  const countrySelect = document.getElementById("countrySelect");
  const list = document.getElementById("airportList");

  countrySelect.innerHTML = '<option value="">üè≥Ô∏è Select Country</option>';
  list.innerHTML = '<tr><td colspan="9">Select a continent and country to view airports.</td></tr>';

  if (!selectedContinent || !WorldAirportsACS[selectedContinent]) return;

  /* Pa√≠ses que aparecen en los aeropuertos */
  const airportCountries = [...new Set(WorldAirportsACS[selectedContinent].map(a => a.region))].sort();

  /* Pa√≠ses v√°lidos seg√∫n historia (solo si existen) */
  const validCountries = ACS_CountryHistory
    .filter(c => c.region === selectedContinent || true)
    .map(c => c.name);

  /* === MODO SUAVE === */
  const finalCountries = airportCountries.filter(c => {
    // Si coincide con historia ‚Üí ok
    if (validCountries.includes(c)) return true;
    // Si NO est√° en historia ‚Üí igual se acepta (suave)
    return true;
  });

  finalCountries.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    countrySelect.appendChild(opt);
  });
}

/* ============================================================
   LOAD AIRPORTS (SIN CAMBIO, SOLO VISUAL)
============================================================ */
function loadAirports() {
  selectedCountry = document.getElementById("countrySelect").value;
  const tbody = document.getElementById("airportList");
  tbody.innerHTML = "";

  if (!selectedContinent || !selectedCountry) {
    tbody.innerHTML = '<tr><td colspan="9">Please select both continent and country.</td></tr>';
    return;
  }

  const airports = WorldAirportsACS[selectedContinent]
    .filter(a => a.region === selectedCountry)
    .sort((a, b) => {
      const demandA = (a.demand?.Y || 0) + (a.demand?.C || 0) + (a.demand?.F || 0);
      const demandB = (b.demand?.Y || 0) + (b.demand?.C || 0) + (b.demand?.F || 0);
      return demandB - demandA;
    });

  if (!airports.length) {
    tbody.innerHTML = '<tr><td colspan="9">No airports available for this country.</td></tr>';
    return;
  }

  airports.forEach(a => {
    const Y = a.demand?.Y || 0;
    const C = a.demand?.C || 0;
    const F = a.demand?.F || 0;
    const total = Y + C + F;

    const ecoPct = total ? (Y / total) * 100 : 0;
    const bizPct = total ? ((Y + C) / total) * 100 : 0;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${a.icao}</td>
      <td>${a.iata}</td>
      <td>${a.city}</td>
      <td>${a.name}</td>
      <td>${a.category}</td>
      <td>
        ${Y}/${C}/${F}
        <div class="demand-bar" style="--eco:${ecoPct}%; --biz:${bizPct}%"></div>
      </td>
      <td>${a.slot_capacity}</td>
      <td>$${a.slot_cost_usd.toLocaleString()}</td>
      <td><button class="acs-btn" onclick="setBase('${a.icao}')">Set as Base</button></td>
    `;
    tbody.appendChild(row);
  });
}

/* ============================================================
   SET BASE (SIN CAMBIO)
============================================================ */
function setBase(icao) {
  const airport = Object.values(WorldAirportsACS).flat().find(a => a.icao === icao);
  if (!airport) return alert("‚ö†Ô∏è Airport not found.");

  const user = JSON.parse(localStorage.getItem("ACS_activeUser"));
  if (!user || !user.airline) {
    alert("‚ö†Ô∏è No active session or airline found.");
    window.location.href = "login.html";
    return;
  }

  user.airline.base = {
    icao: airport.icao,
    iata: airport.iata,
    city: airport.city,
    country: airport.region,
    continent: selectedContinent,
    demand_total: (airport.demand.Y||0)+(airport.demand.C||0)+(airport.demand.F||0),
    slot_capacity: airport.slot_capacity,
    cost_slot_usd: airport.slot_cost_usd
  };

  localStorage.setItem("ACS_activeUser", JSON.stringify(user));

  const users = JSON.parse(localStorage.getItem("ACS_users")||"[]");
  const index = users.findIndex(u => u.email === user.email);
  if (index !== -1) users[index] = user;
  localStorage.setItem("ACS_users", JSON.stringify(users));

  alert(`‚úÖ Base set successfully at ${airport.city} (${airport.icao}).`);
  window.location.href = "dashboard.html";
}

/* ============================================================
   DEMAND TOOLTIP
============================================================ */
const tooltip = document.getElementById("demandTooltip");

document.addEventListener("mousemove", e => {
  const cell = e.target.closest("td:nth-child(6)");
  if (cell && cell.textContent.includes("/")) {
    const parts = cell.textContent.trim().split("/");
    if (parts.length === 3) {
      const [Y, C, F] = parts.map(Number);
      const total = Y + C + F;
      const ecoDeg = total ? (Y/total)*360 : 0;
      const bizDeg = total ? ((Y+C)/total)*360 : 0;

      tooltip.innerHTML = `
        <h4>Passenger Demand</h4>
        <div>Economy: ${Y}</div>
        <div>Business: ${C}</div>
        <div>First: ${F}</div>
      `;
      tooltip.style.display = "block";
      tooltip.style.left = e.pageX + 15 + "px";
      tooltip.style.top = e.pageY - 60 + "px";
    }
  } else {
    tooltip.style.display = "none";
  }
});

/* ============================================================
   INITIALIZER (NO TOCADO)
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  loadAirportScripts(() => {
    buildAirportIndex();

    document.getElementById("continentSelect").addEventListener("change", loadCountries);
    document.getElementById("countrySelect").addEventListener("change", loadAirports);
  });
});
</script>

</body>
</html>
