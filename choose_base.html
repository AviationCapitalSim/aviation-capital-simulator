<!-- === CHOOSE BASE MODULE â€” Qatar Luxury Edition === -->
<!-- Version: Beta v5 | Date: 22 NOV 2025 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Choose Base - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">
  <link rel="manifest" href="manifest.json">

<style>
/* â€¦â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* TODO TU CSS ORIGINAL SIN CAMBIOS */
/* â€¦â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
</style>
</head>

<body>

<header class="acs-header">
  <div class="acs-logo">
    <img src="acs_logo.png" alt="ACS Logo" />
    <h1>Aviation Capital Simulator</h1>
  </div>

  <div style="display:flex; align-items:center; gap:1rem;">
    <a href="support.html" class="nav-btn nav-btn-blue">Support</a>
    <div class="acs-clock-header" id="acs-clock">00:00 â€” 01 JAN 1940</div>
  </div>
</header>

<section class="form-container">
  <h2>Choose Your Base</h2>
  <p>Select a continent and country to establish your main operations base.</p>

  <div>
    <select id="continentSelect" class="lux-select">
      <option value="">ğŸŒ Select Continent</option>
      <option value="NorthAmerica">North America</option>
      <option value="SouthAmerica">South America</option>
      <option value="Europe">Europe</option>
      <option value="Asia">Asia</option>
      <option value="Africa">Africa</option>
      <option value="Oceania">Oceania</option>
      <option value="MiddleEast">Middle East</option> <!-- ğŸ”¥ AGREGADO -->
    </select>

    <select id="countrySelect" class="lux-select">
      <option value="">ğŸ³ï¸ Select Country</option>
    </select>
  </div>

  <table id="airportTable">
    <thead>
      <tr>
        <th>ICAO</th>
        <th>IATA</th>
        <th>City</th>
        <th>Airport</th>
        <th>Category</th>
        <th>Demand (Y/C/F)</th>
        <th>Slots</th>
        <th>Cost (USD)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="airportList">
      <tr><td colspan="9">Select a continent and country to view airports.</td></tr>
    </tbody>
  </table>
</section>

<footer>
  <p>Â© 2025 Aviation Capital Simulator. All rights reserved.</p>
</footer>

<div id="demandTooltip"></div>

<!-- === CORE SCRIPTS === -->
<script src="time_engine.js"></script>
<script src="engine/airports_loader.js"></script>
<script src="engine/acs_country_history.js"></script>

<script>
/* ============================================================
   GLOBAL VARIABLES
============================================================ */
let selectedContinent = "";
let selectedCountry = "";

/* ============================================================
   COUNTRY EXISTENCE (HISTORICAL 1940â€“2026)
============================================================ */
function countryExisted(countryName, year) {
  const entry = ACS_CountryHistory.find(c => c.name === countryName);
  if (!entry) return true; 

  if (year < entry.start) return false;
  if (entry.end && year > entry.end) return false;

  return true;
}

/* ============================================================
   RUNWAY HISTORICAL FILTER (BY ERA)
============================================================ */
function runwayHistoricalFilter(a, year) {

  if (year < 1950) {  
    if (!a.runway_m || a.runway_m === 0) return false;
    if (a.runway_m < 800) return false;
    return true;
  }

  if (year < 1970) {  
    if (a.runway_m < 600) return false;
    return true;
  }

  return true;
}

/* ============================================================
   FULL HISTORICAL FILTER (COUNTRY + RUNWAY)
============================================================ */
function ACS_filterAirport_Historical(a, year) {
  if (!countryExisted(a.region, year)) return false;
  if (!runwayHistoricalFilter(a, year)) return false;
  return true;
}

/* ============================================================
   LOAD COUNTRIES
============================================================ */
function loadCountries() {
  selectedContinent = document.getElementById("continentSelect").value;
  const countrySelect = document.getElementById("countrySelect");

  countrySelect.innerHTML = '<option value="">ğŸ³ï¸ Select Country</option>';
  document.getElementById("airportList").innerHTML =
    '<tr><td colspan="9">Select a continent and country to view airports.</td></tr>';

  if (!selectedContinent || !WorldAirportsACS[selectedContinent]) return;

  const countries = [...new Set(WorldAirportsACS[selectedContinent].map(a => a.region))].sort();

  countries.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    countrySelect.appendChild(opt);
  });
}

/* ============================================================
   LOAD AIRPORTS + HISTORICAL FILTER
============================================================ */
function loadAirports() {

  selectedCountry = document.getElementById("countrySelect").value;
  const tbody = document.getElementById("airportList");
  tbody.innerHTML = "";

  if (!selectedContinent || !selectedCountry) {
    tbody.innerHTML = '<tr><td colspan="9">Please select both continent and country.</td></tr>';
    return;
  }

  const year = ACS_TIME.currentTime.getUTCFullYear();

  const airports = WorldAirportsACS[selectedContinent]
    .filter(a => a.region === selectedCountry)
    .filter(a => ACS_filterAirport_Historical(a, year))  // ğŸ”¥ ACTIVO
    .sort((a, b) => {
      const dA = (a.demand?.Y||0)+(a.demand?.C||0)+(a.demand?.F||0);
      const dB = (b.demand?.Y||0)+(b.demand?.C||0)+(b.demand?.F||0);
      return dB - dA; 
    });

  if (!airports.length) {
    tbody.innerHTML = '<tr><td colspan="9">No airports available for this country in this year.</td></tr>';
    return;
  }

  airports.forEach(a => {
    const Y = a.demand?.Y || 0;
    const C = a.demand?.C || 0;
    const F = a.demand?.F || 0;
    const total = Y + C + F;

    const ecoPct = total ? (Y/total)*100 : 0;
    const bizPct = total ? ((Y+C)/total)*100 : 0;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${a.icao}</td>
      <td>${a.iata}</td>
      <td>${a.city}</td>
      <td>${a.name || a.city}</td>
      <td>${a.category}</td>
      <td>
        ${Y}/${C}/${F}
        <div class="demand-bar" style="--eco:${ecoPct}%; --biz:${bizPct}%"></div>
      </td>
      <td>${a.slot_capacity}</td>
      <td>$${a.slot_cost_usd.toLocaleString()}</td>
      <td><button class="acs-btn" onclick="setBase('${a.icao}')">Set as Base</button></td>
    `;
    tbody.appendChild(row);
  });
}

/* ============================================================
   SET AIRLINE BASE
============================================================ */
function setBase(icao) {

  const airport = Object.values(WorldAirportsACS).flat().find(a => a.icao === icao);
  if (!airport) return alert("âš ï¸ Airport Not Found");

  const user = JSON.parse(localStorage.getItem("ACS_activeUser"));
  if (!user || !user.airline) {
    alert("âš ï¸ Please log in.");
    window.location.href = "login.html";
    return;
  }

  user.airline.base = {
    icao: airport.icao,
    iata: airport.iata,
    city: airport.city,
    country: airport.region,
    continent: selectedContinent,
    demand_total: (airport.demand.Y||0)+(airport.demand.C||0)+(airport.demand.F||0),
    slot_capacity: airport.slot_capacity,
    cost_slot_usd: airport.slot_cost_usd
  };

  localStorage.setItem("ACS_activeUser", JSON.stringify(user));

  const users = JSON.parse(localStorage.getItem("ACS_users")||"[]");
  const i = users.findIndex(u => u.email === user.email);
  if (i !== -1) users[i] = user;
  localStorage.setItem("ACS_users", JSON.stringify(users));

  alert(`âœ… Base set at ${airport.city} (${airport.icao}).`);
  window.location.href = "dashboard.html";
}

/* ============================================================
   TOOLTIP (DEMAND)
============================================================ */
const tooltip = document.getElementById("demandTooltip");

document.addEventListener("mousemove", e => {
  const cell = e.target.closest("td:nth-child(6)");
  if (!cell || !cell.textContent.includes("/")) {
    tooltip.style.display = "none";
    return;
  }

  const [Y,C,F] = cell.textContent.trim().split("/").map(Number);
  const total = Y + C + F;
  const ecoDeg = total ? (Y/total)*360 : 0;
  const bizDeg = total ? ((Y+C)/total)*360 : 0;

  tooltip.innerHTML = `
    <h4>Passenger Demand</h4>
    <div>Economy: ${Y}</div>
    <div>Business: ${C}</div>
    <div>First: ${F}</div>
    <div class="demand-pie" style="--eco:${ecoDeg}deg; --biz:${bizDeg}deg;">
      <div class="slice"></div>
    </div>
  `;

  tooltip.style.display = "block";
  tooltip.style.left = e.pageX + 15 + "px";
  tooltip.style.top = e.pageY - 60 + "px";
});

/* ============================================================
   INITIALIZATION
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  loadAirportScripts(() => {
    buildAirportIndex();
    document.getElementById("continentSelect").addEventListener("change", loadCountries);
    document.getElementById("countrySelect").addEventListener("change", loadAirports);
  });
});
</script>

</body>
</html>
