<!-- ============================================================
     === DEPARTMENT CONTROL CENTER ‚Äî Qatar Luxury Edition ========
     === Version: v2 FIXED | Date: 25 NOV 2025 ===================
     ============================================================ -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Department Control Center - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">

<style>
/* ============================================================
     === GLOBAL VISUALS ‚Äî Qatar Luxury ===========================
   ============================================================ */

body {
  margin: 0;
  background-color: #081530;
  color: white;
  font-family: "Poppins", sans-serif;
}

/* ============================================================
     === HEADER (Exact Copy from Dashboard) =====================
   ============================================================ */

.acs-header {
  position: fixed;
  top: 0;
  width: 100%;
  backdrop-filter: blur(9px);
  background: rgba(12,23,50,0.45);
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffb300;
  z-index: 5000;
}

.acs-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.acs-left img {
  height: 46px;
}

.acs-left h1 {
  font-size: 1.15rem;
  margin: 0;
  color: #ffb300;
  letter-spacing: 0.5px;
}

.acs-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 2rem;
}

.acs-nav a {
  position: relative;
  font-size: 1rem;
  letter-spacing: 0.4px;
  color: #dbe4ff; 
  text-decoration: none;
  transition: 0.25s ease;
  padding-bottom: 6px;
}

.acs-nav a:hover,
.acs-nav a.active {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.6);
}

.acs-nav a.active::after,
.acs-nav a:hover::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, #ffb300, #ffe7a0);
  border-radius: 2px;
}

.acs-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.logout-btn {
  padding: 0.45rem 1.1rem;
  border: 1px solid #ffb300;
  border-radius: 12px;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
}

.logout-btn:hover {
  background: #ffb300;
  color: #0c1f3c;
}

.acs-clock-header {
  font-family: "Orbitron", monospace;
  padding: 0.4rem 0.8rem;
  background: rgba(0,255,128,0.08);
  border-radius: 8px;
  font-size: 0.95rem;
  color: #00ff80;
}

/* ============================================================
     === MAIN LAYOUT ===========================================
   ============================================================ */

.acs-main {
  padding: 110px 2rem 70px;
  text-align: center;
}

/* T√≠tulo estilo Dashboard */
.acs-title {
  font-size: 1.9rem;
  font-weight: 600;
  color: #ffca3a;
  text-shadow: 0 0 12px rgba(255,190,60,0.55);
  letter-spacing: 0.6px;
  margin-bottom: 0.2rem;
}

.acs-sub {
  margin-top: -0.2rem;
  color: #cbd6ff;
  font-size: 1rem;
}

/* ============================================================
     === PREMIUM PANEL (80% width) =============================
   ============================================================ */

.control-panel {
  width: 80%;
  margin: 2rem auto;
  background: linear-gradient(180deg, rgba(20,35,70,0.75), rgba(10,18,40,0.85));
  padding: 2rem;
  border-radius: 22px;
  border: 1px solid rgba(255,179,0,0.15);
  box-shadow: 0 0 25px rgba(0,0,0,0.4);
}

/* ============================================================
     === TABLE ‚Äî Qatar Luxury Dark Premium =====================
   ============================================================ */

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

th {
  background: #102040;
  color: #ffb300;
  padding: 0.9rem;
  border-bottom: 2px solid #ffb300;
  font-size: 1rem;
}

td {
  padding: 0.8rem;
  font-size: 0.95rem;
  color: #dbe4ff;
  border-bottom: 1px solid rgba(255,179,0,0.15);
}

tr:nth-child(even) {
  background: rgba(255,255,255,0.03);
}

/* Staff, Salary, Morale colors */
.staff { color: #00e28a; font-weight: 600; }
.salary { color: #ff6464; font-weight: 600; }
.morale { color: #8ae2ff; font-weight: 600; }

/* Action buttons */
.btn {
  border: none;
  border-radius: 8px;
  padding: 6px 10px;
  font-weight: 600;
  cursor: pointer;
  margin-right: 4px;
  transition: 0.2s;
}

.btn-bonus { background:#00a86b; color:white; opacity:0.45; cursor:not-allowed; }
.btn-hire { background:#007bff; color:white; }
.btn-adjust { background:#ffb300; color:black; }
.btn-dismiss { background:#000; color:white; }

/* Total Payroll */
#totalPayroll {
  padding-top: 1.2rem;
  font-weight: bold;
  text-align: right;
  font-size: 1.1rem;
  color: #ffca3a;
  text-shadow: 0 0 10px rgba(255,200,60,0.4);
}

/* ============================================================
     === MODALS (sin cambios de funcionalidad) =================
   ============================================================ */

.acs-modal {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.7);
  align-items:center; justify-content:center;
  z-index:2000;
}

.acs-modal-content {
  background:#0b1c3f;
  border:1px solid #ffb300;
  border-radius:12px;
  padding:1.5rem 2rem;
  width:400px;
  text-align:center;
  box-shadow: 0 0 15px rgba(255,179,0,0.4);
}

/* Close button */
.close-modal {
  background:none;
  border:none;
  color:#aaa;
  font-size:1.2rem;
  cursor:pointer;
  position:absolute;
  top:10px;
  right:20px;
}

/* ============================================================
   === ACS GALACTIC LOAD LEVELER (Qatar Luxury) ================
   ============================================================ */

.load-bar-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
}

.load-bar {
  width: 140px;
  height: 12px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid rgba(255, 200, 60, 0.25);
  position: relative;
  box-shadow: 0 0 10px rgba(255,179,0,0.15) inset;
}

.load-fill {
  height: 100%;
  width: 0%;
  border-radius: 10px;
  transition: width 0.5s ease-out;
  background: linear-gradient(90deg,
    rgba(0,255,140,1),
    rgba(0,200,100,1)
  );
  position: relative;
}

/* Galactic pulse line */
.load-fill::after {
  content: "";
  position: absolute;
  top: 0;
  left: -40px;
  width: 40px;
  height: 100%;
  background: rgba(255,255,255,0.25);
  filter: blur(4px);
  animation: loadPulse 3.6s infinite ease-in-out;
}

@keyframes loadPulse {
  0%   { left: -40px; opacity: 0; }
  35%  { opacity: 0.35; }
  50%  { left: 140px; opacity: 0.25; }
  100% { left: 140px; opacity: 0; }
}

/* COLORS by percentage */
.load-critical  { background: linear-gradient(90deg,#ff3b3b,#ff7a7a); }
.load-low       { background: linear-gradient(90deg,#ff8c3b,#ffbd7a); }
.load-medium    { background: linear-gradient(90deg,#ffc93b,#ffe37a); }
.load-high      { background: linear-gradient(90deg,#3bff9d,#6effc4); }

.load-number {
  font-size: 0.85rem;
  color: #dbe4ff;
  font-weight: 600;
}

/* ============================================================
   === HR FULL MODAL FIX ‚Äî Position, Scroll, Centering  =========
   ============================================================ */

.hr-full-modal {
  margin-top: 40px !important;      /* Baja el modal */
  max-height: 80vh !important;      /* Altura m√°xima */
  overflow-y: auto !important;      /* Scroll interno */
  padding-bottom: 40px !important;  /* Espacio abajo */
}

.hr-modal-title {
  margin-top: 0;
  padding-top: 10px;
  font-size: 1.6rem;
  text-align: center;
  color: #ffca3a;
  text-shadow: 0 0 10px rgba(255,185,50,0.5);
}

.hr-modal-sub {
  text-align: center;
  color: #a9b8e8;
  margin-top: -8px;
  margin-bottom: 20px;
}

/* Select fix */
.hr-select {
  width: 100%;
  padding: 10px;
  background: rgba(20,35,70,0.75);
  border-radius: 10px;
  color: white;
  border: 1px solid rgba(255,200,60,0.35);
}

/* Remove arrows that stretch layout */
.hr-select::-webkit-inner-spin-button,
.hr-select::-webkit-outer-spin-button {
  -webkit-appearance: none;
}

/* BLOCK (cada secci√≥n) */
.hr-block {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,190,60,0.20);
  padding: 1.2rem 1rem;
  border-radius: 16px;
  margin-bottom: 1.6rem;
  text-align: left;
}

.hr-block-title {
  color: #ffb300;
  font-size: 1.2rem;
  margin-bottom: 0.8rem;
}

/* Labels */
.hr-label {
  display: block;
  font-size: 0.95rem;
  margin-bottom: 0.3rem;
  color: #ffca3a;
}

/* Select */
.hr-select {
  width: 100%;
  padding: 0.6rem;
  border-radius: 12px;
  border: 1px solid rgba(255,200,60,0.35);
  background: rgba(255,255,255,0.07);
  color: white;
  margin-bottom: 1rem;
  font-size: 1rem;
}

/* COST */
.hr-cost {
  color: #cdd9ff;
  font-size: 1rem;
  margin-bottom: 1rem;
}

/* Buttons */
.hr-btn-confirm {
  width: 100%;
  padding: 0.8rem;
  background: #00a86b;
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  font-size: 1rem;
}

.hr-btn-danger {
  width: 100%;
  padding: 0.8rem;
  background: #ff4747;
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  font-size: 1rem;
}

.hr-btn-gold {
  width: 100%;
  padding: 0.8rem;
  background: #ffb300;
  color: #0c1f3c;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  font-size: 1rem;
}

.hr-btn-close {
  width: 100%;
  padding: 0.9rem;
  background: #b13f3f;
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  cursor: pointer;
  font-size: 1rem;
  margin-top: 0.8rem;
}

.hr-btn-disabled {
  width: 100%;
  padding: 0.8rem;
  border-radius: 12px;
  background: rgba(255,255,255,0.15);
  color: #777;
  border: none;
  font-size: 1rem;
}

.hr-disabled {
  opacity: 0.45;
  pointer-events: none;
}

/* Warning */
.hr-warning {
  color: #ff6b6b;
  margin-bottom: 1rem;
  font-weight: bold;
}
     
.btn-control {
  background: #ffb300;
  color: #0c1f3c;
  font-weight: 700;
  padding: 6px 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,200,60,0.35);
  cursor: pointer;
  transition: 0.25s;
}

.btn-control:hover {
  background: #ffd35c;
  box-shadow: 0 0 12px rgba(255,190,60,0.5);
}
     
#deptSelector {
  background: rgba(20,35,70,0.75);
  border: 1px solid rgba(255,200,60,0.35);
  color: #ffca3a;
  font-weight: 600;
}
     
/* ===== HR DEPARTMENT SELECTOR (Qatar Luxury) ===== */

.hr-box {
    background: #0d1c3c;
    border: 1px solid rgba(255,179,0,0.35);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.2rem;
}

.hr-label {
    color: #FFB300;
    font-weight: 600;
    display: block;
    margin-bottom: 6px;
    font-size: 1rem;
}

.hr-select {
    width: 100%;
    padding: 0.45rem;
    font-size: 1rem;
    color: #FFB300;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,179,0,0.35);
    border-radius: 6px;
    outline: none;
    cursor: pointer;
}
.hr-select option {
    background: #0c1a38;
    color: white;
    padding: 6px;
}
     
/* ============================================================
   üü© A2 ‚Äî KPI CARDS (Qatar Luxury Premium)
   ============================================================ */

.kpi-wrapper {
  display: flex;
  justify-content: space-between;
  gap: 1.2rem;
  margin-bottom: 2rem;
}

.kpi-card {
  flex: 1;
  background: rgba(15,25,55,0.70);
  border: 1px solid rgba(255,179,0,0.35);
  border-radius: 16px;
  padding: 1.2rem 1rem;
  text-align: center;
  box-shadow: 0 0 12px rgba(0,0,0,0.35);
}

.kpi-card h3 {
  margin: 0;
  font-size: 1rem;
  color: #ffca3a;
  letter-spacing: 0.5px;
}

.kpi-card p {
  margin-top: 0.5rem;
  font-size: 1.5rem;
  font-weight: 700;
  color: white;
}

/* ============================================================
   üü¶ B3 ‚Äî COLUMNA EXTRA / TAGS
   ============================================================ */

.role-tag {
  background: rgba(255,179,0,0.15);
  color: #ffca3a;
  padding: 6px 12px;      /* antes 4px 10px */
  border-radius: 14px;    /* un poco m√°s redondo */
  font-size: 0.8rem;
  font-weight: 600;
  white-space: nowrap;    /* üî• evita que se divida */
}

.payroll {
  color: #dbe4ff;
  font-weight: 600;
}

.bonus-disabled {
  color: #777;
  font-style: italic;
}

</style>
</head>

<body>

<!-- ============================================================
     === HEADER ==================================================
     ============================================================ -->
<header class="acs-header">
  <div class="acs-left">
    <img src="acs_logo.png" alt="ACS Logo">
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="finance.html">Finance</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html">Routes</a>
    <a href="hr.html" class="active">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
    <div id="acs-clock" class="acs-clock-header">00:00 ‚Äî 01 JAN 2025</div>
  </div>
</header>

<!-- ============================================================
     === MAIN ====================================================
     ============================================================ -->
<main class="acs-main">

  <h2 class="acs-title">üè¢ Department Control Center</h2>
  <p class="acs-sub">Manage all departments, staff, salaries and morale.</p>

  <section class="control-panel">

   <!-- ============================================================
     üü¶ A1 ‚Äî KPI SUPERIOR (Qatar Luxury)
     Ubicaci√≥n: Dentro de .control-panel, ANTES de la tabla
     ============================================================ -->

<div class="kpi-wrapper">

  <div class="kpi-card">
    <h3>Total Staff</h3>
    <p id="kpiTotalStaff">0</p>
  </div>

  <div class="kpi-card">
    <h3>Monthly Payroll</h3>
    <p id="kpiTotalPayroll">$0</p>
  </div>

  <div class="kpi-card">
    <h3>Average Morale</h3>
    <p id="kpiAvgMorale">0%</p>
  </div>

</div>

<!-- ============================================================
   üüß B1 ‚Äî NUEVO THEAD (Qatar Luxury v4)
   ============================================================ -->

<table id="deptTable">
<thead>
  <tr>
    <th>Department</th>
    <th>Role</th>
    <th>Staff</th>
    <th>Required</th>
    <th>Diff</th>
    <th>Efficiency</th>
    <th>Salary</th>
    <th>Payroll</th>
    <th>Morale</th>
    <th>Bonus</th>
    <th>Actions</th>
  </tr>
</thead>

<tbody id="departmentRows"></tbody>
</table>


<!-- ============================================================== -->
<!-- üî∂ HR FULL CONTROL MODAL ‚Äî Qatar Luxury Edition ‚Äî BUY NEW Style -->
<!-- ============================================================== -->
       
<div class="acs-modal" id="hrFullModal">
  <div class="acs-modal-content hr-full-modal">

    <!-- Close -->
    <button class="close-modal" onclick="closeHRFullModal()">‚úñ</button>

    <!-- HEADER -->
    <h2 class="hr-modal-title">
      <span id="hrModalDeptName">Department</span>
    </h2>
    <p class="hr-modal-sub">Department Control Panel</p>

    <!-- ============================
     HR DEPARTMENT SELECTOR
     (Qatar Luxury)
     ============================ -->
       
     <div class="hr-box">
     <label class="hr-label">Department</label>

     <select id="hrDeptSelector" class="hr-select">
      
          <!-- JS insertar√° las opciones -->
    </select>
  </div>

<!-- =============================================== -->
<!-- HR SUMMARY BLOCK (NECESARIO PARA F RELOAD)       -->
<!-- =============================================== -->
       
<div class="hr-block">
  <h3 class="hr-block-title">Summary</h3>

  <p class="hr-label">Current Staff</p>
  <p id="hrCurrentStaff" class="hr-cost">0</p>

  <p class="hr-label">Required Staff</p>
  <p id="hrRequiredStaff" class="hr-cost">0</p>

  <p class="hr-label">Difference</p>
  <p id="hrDifference" class="hr-cost">0</p>

  <p class="hr-label">Salary (per employee)</p>
  <p id="hrSalary" class="hr-cost">$0</p>

  <p class="hr-label">Morale</p>
  <p id="hrMorale" class="hr-cost">0%</p>
</div>

    <!-- ========================================================= -->
    <!-- HIRE STAFF BLOCK -->
    <!-- ========================================================= -->
       
    <div class="hr-block">
      <h3 class="hr-block-title">Hire Staff</h3>

      <label class="hr-label">Select Quantity</label>
      <select id="hireQty" class="hr-select"></select>

      <p class="hr-cost">Cost: <strong id="hireCost">$0</strong></p>

      <button class="hr-btn-confirm" onclick="HR_confirmHireFull()">
        Confirm Hire
      </button>
    </div>

    <!-- ========================================================= -->
    <!-- FIRE STAFF BLOCK -->
    <!-- ========================================================= -->
    <div class="hr-block">
      <h3 class="hr-block-title">Fire Staff</h3>

      <label class="hr-label">Select Quantity</label>
      <select id="fireQty" class="hr-select"></select>

      <p id="fireWarning" class="hr-warning">‚Äî</p>

      <button class="hr-btn-danger" onclick="HR_confirmFireFull()">
        Confirm Dismissal
      </button>
    </div>

    <!-- ========================================================= -->
    <!-- SALARY ADJUST BLOCK -->
    <!-- ========================================================= -->
    <div class="hr-block">
      <h3 class="hr-block-title">Adjust Salary</h3>

      <input type="range" min="50" max="150" value="100" step="5" id="salaryRangeFull">

      <p>Adjustment: <strong id="salaryValFull">100%</strong></p>
      <p>New Salary: <strong id="salaryNewFull">$0</strong></p>
      <p>Monthly Payroll After Change: <strong id="salaryAfterFull">$0</strong></p>

      <button class="hr-btn-gold" onclick="HR_confirmSalaryFull()">
        Apply Adjustment
      </button>
    </div>

    <!-- ========================================================= -->
    <!-- BONUS (DISABLED) -->
    <!-- ========================================================= -->
    <div class="hr-block hr-disabled">
      <h3 class="hr-block-title">Bonus (Coming Soon)</h3>

      <input type="range" min="20" max="100" disabled>

      <p><em>Bonus system will be activated later.</em></p>

      <button class="hr-btn-disabled" disabled>Bonus Disabled</button>
    </div>

       
    <!-- ========================================================= -->
<!-- üîÑ AUTO-ADJUST SALARY (REPLACES AUTO-BALANCE STAFF)       -->
<!-- ========================================================= -->
<div class="hr-block">
  <h3 class="hr-block-title">Auto-Adjust Salary</h3>

  <button class="hr-btn-gold" onclick="HR_applyAutoAdjust()">
    Auto-Adjust Salary
  </button>
</div>


    <!-- ========================================================= -->
    <!-- CLOSE BUTTON -->
    <!-- ========================================================= -->
    <button class="hr-btn-close" onclick="closeHRFullModal()">
      Close
    </button>

  </div>
</div>


<footer class="acs-footer">
  ¬© 2025 Aviation Capital Simulator. All rights reserved.
</footer>

<!-- ============================================================
     === SCRIPTS ‚Äî CORREGIDOS (Orden Obligatorio) ===============
     ============================================================ -->

<script src="engine/acs_alerts.js"></script>   <!-- üü¶ PRIMERO -->
<script src="time_engine.js"></script>
<script src="engine/acs_finance.js"></script>
<script src="engine/acs_hr_engine.js"></script>


<script>
let activeDept = null;

/* ============================================================
   === GALACTIC LOAD BAR BUILDER ==============================
   ============================================================ */
     
function ACS_HR_renderLoadBar(dep) {
  const staff = dep.staff;
  const required = dep.required || dep.min || 0;

  let pct = required > 0 ? (staff / required) * 100 : 100;
  if (pct > 100) pct = 100;

  let cls = "load-high";
  if (pct < 40) cls = "load-critical";
  else if (pct < 60) cls = "load-low";
  else if (pct < 80) cls = "load-medium";

  return `
    <div class="load-bar-wrapper">
      <div class="load-bar">
        <div class="load-fill ${cls}" style="width:${pct}%"></div>
      </div>
      <span class="load-number">${staff} / ${required}</span>
    </div>
  `;
}
     
/* ============================================================
   üü¶ FIX 1 ‚Äî Protecci√≥n total dentro de HR_prepareTableData
   Ubicaci√≥n: Reemplaza el bloque roto previo
   ============================================================ */

function HR_prepareTableData(dep) {

  // Protecci√≥n total para evitar crashes
  if (!dep || typeof dep !== "object") {
      console.warn("‚ö† Departamento inv√°lido:", dep);
      return {
        id: "N/A",
        name: "Invalid",
        staff: 0,
        required: 0,
        diff: 0,
        morale: 0,
        efficiency: 0,
        salary: 0,
        payroll: 0,
        base: "N/A"
      };
  }

  // Campos obligatorios con valores por defecto
  dep.required   = dep.required   || 0;
  dep.morale     = dep.morale     || 0;
  dep.salary     = dep.salary     || 0;
  dep.payroll    = dep.payroll    || 0;
  dep.base       = dep.base       || "N/A";

  // C√°lculo del diff y eficiencia (igual que antes)
  const diff = dep.required - dep.staff;
  const efficiency =
    dep.required > 0 ? (dep.staff / dep.required) * (dep.morale / 100) : 1;

  return {
      ...dep,
      diff,
      efficiency
  };
}

/* ============================================================
   === LOAD DEPARTMENTS ‚Äî FIXED + CLEAN PREMIUM VERSION ========
   ============================================================ */
     
function loadDepartments() {
  const rows = document.getElementById("departmentRows");
  rows.innerHTML = "";

  const depts = ACS_HR_getDepartmentsView();

  depts.forEach(d => {

    const dep = HR_prepareTableData(d);

    // === RENDER DEPARTAMENTO ===
    rows.innerHTML += `
      <tr>
        <td>${dep.name}</td>

      <td>
    <span class="role-tag">${
      dep.id.includes("pilots_small")  ? "Pilots ‚Äî Small"  :
      dep.id.includes("pilots_medium") ? "Pilots ‚Äî Medium" :
      dep.id.includes("pilots_large")  ? "Pilots ‚Äî Large"  :
      dep.id.includes("pilots_vlarge") ? "Pilots ‚Äî Very Large" :
      dep.base
     }</span>
     </td>


        <td class="staff">${dep.staff}</td>

        <td>${dep.required}</td>

        <td class="diff" style="color:${
          dep.diff > 0 ? '#ff4d4d' :
          dep.diff < 0 ? '#00ff99' :
          '#ffe38a'
        }">
          ${dep.diff}
        </td>

        <td class="efficiency" style="color:${
          dep.efficiency >= 0.85 ? '#3bff9d' :
          dep.efficiency >= 0.65 ? '#ffe38a' :
          dep.efficiency >= 0.40 ? '#ff8c3b' :
          '#ff4d4d'
        }">
          ${(dep.efficiency * 100).toFixed(0)}%
        </td>

        <td class="salary">$${dep.salary}</td>

        <td class="payroll">$${dep.payroll.toLocaleString()}</td>

        <td class="morale">${dep.morale}%</td>

        <td class="bonus-disabled">0%</td>

        <td>
          <button class="btn btn-control" onclick="openHRFullModal('${dep.id}')">
            ‚öôÔ∏è Control
          </button>
        </td>
      </tr>
    `;
  });
     
// ========================================================
// ‚≠ê SYNC HR ‚Üí LOCALSTORAGE (Payroll, Staff, Morale)
// ========================================================
     
try {
    const HR = ACS_HR_recalculateAll();   // recalcula payroll real
    ACS_HR_save(HR);                      // guarda en ACS_HR del localStorage
    console.log("üíæ HR actualizado en localStorage:", HR);
} catch (e) {
    console.warn("‚ö†Ô∏è No se pudo actualizar HR:", e);
}
     
  // === KPI UPDATE ===
     
  document.getElementById("kpiTotalStaff").textContent =
    depts.reduce((sum, d) => sum + d.staff, 0);

  document.getElementById("kpiTotalPayroll").textContent =
    "$" + depts.reduce((sum, d) => sum + d.payroll, 0).toLocaleString();

  const avgMorale =
    depts.reduce((sum, d) => sum + d.morale, 0) / depts.length;

  document.getElementById("kpiAvgMorale").textContent =
    avgMorale.toFixed(0) + "%";
}

function openHire(id) {
  activeDept = id;
  const hr = ACS_HR_load()[id];
  document.getElementById("hireDeptName").textContent = hr.name;
  document.getElementById("hireCount").value = 1;
  document.getElementById("hireCost").textContent = hr.salary.toLocaleString();
  document.getElementById("hireModal").style.display = "flex";
}

function openSalary(id) {
  activeDept = id;
  const hr = ACS_HR_load()[id];
  document.getElementById("salaryDeptName").textContent = hr.name;
  document.getElementById("salaryRange").value = 100;
  document.getElementById("salaryValue").textContent = "100%";
  document.getElementById("salaryModal").style.display = "flex";
}

function openDismiss(id) {
  activeDept = id;
  const hr = ACS_HR_load()[id];
  document.getElementById("dismissDeptName").textContent = hr.name;
  document.getElementById("dismissCount").value = 1;
  document.getElementById("dismissModal").style.display = "flex";
}

function closeModal(id) {
  document.getElementById(id).style.display = "none";
}

function confirmHire() {
  const count = parseInt(document.getElementById("hireCount").value);
  ACS_HR_hire(activeDept, count);
  closeModal('hireModal');
  loadDepartments();
}

function confirmDismiss() {
  const count = parseInt(document.getElementById("dismissCount").value);
  ACS_HR_fire(activeDept, count);
  closeModal('dismissModal');
  loadDepartments();
}

function confirmSalary() {
  const percent = parseInt(document.getElementById("salaryRange").value);
  ACS_HR_adjustSalary(activeDept, percent);
  closeModal('salaryModal');
  loadDepartments();
}

function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}

     
window.addEventListener("DOMContentLoaded", () => {
  loadDepartments();
  if (typeof registerTimeListener === "function") {
    registerTimeListener(updateClockDisplay);
    updateClockDisplay();
  }
});

/* ============================================================
   üü¶ E1 ‚Äî Department Selector Fill (HR Modal)
   ============================================================ */
     
function HR_fillDepartmentSelector() {
    const sel = document.getElementById("hrDeptSelector");
    if (!sel) return;

    sel.innerHTML = "";

    // Agregar todos los departamentos visibles
    ACS_HR_DEPARTMENTS.forEach(dep => {
        const opt = document.createElement("option");
        opt.value = dep.id;
        opt.textContent = dep.name;
        sel.appendChild(opt);
    });
}
     
/* ============================================================
   HR FULL MODAL ‚Äî OPEN
   ============================================================ */
     
let HR_active = null;
     
function openHRFullModal(id) {
  HR_active = id;

  const hr = ACS_HR_load()[id];
  
  HR_fillDepartmentSelector();
     
  // Set title
  document.getElementById("hrModalDeptName").textContent = hr.name;

  // Build selects (Hire + Fire) and cost
  HR_buildSelects(hr);

  // Reset salary slider
  document.getElementById("salaryRangeFull").value = 100;
  document.getElementById("salaryValFull").textContent = "100%";
  document.getElementById("salaryNewFull").textContent = "$" + hr.salary;
  document.getElementById("salaryAfterFull").textContent = "$" + hr.payroll;
 

  // Seleccionar departamento actual en el selector
     
  const sel = document.getElementById("hrDeptSelector");
  if (sel) sel.value = id;
     
  // Scroll modal to top
     
  document.querySelector(".hr-full-modal").scrollTop = 0;

  // Show modal
     
  document.getElementById("hrFullModal").style.display = "flex";
}

/* Update hire cost when changing qty */
     
function updateHireCost(hr=null) {
  if (!hr) hr = ACS_HR_load()[HR_active];
  const qty = parseInt(document.getElementById("hireQty").value);
  document.getElementById("hireCost").textContent =
    "$" + (qty * hr.salary);
}

/* Confirm hire */
     
function HR_confirmHireFull() {
  const qty = parseInt(document.getElementById("hireQty").value);
  ACS_HR_hire(HR_active, qty);
  closeHRFullModal();
  loadDepartments();
}

/* Confirm fire */
     
function HR_confirmFireFull() {
  const qty = parseInt(document.getElementById("fireQty").value);
  ACS_HR_fire(HR_active, qty);
  closeHRFullModal();
  loadDepartments();
}

/* Salary change */
     
document.getElementById("salaryRangeFull").addEventListener("input", () => {
  const hr = ACS_HR_load()[HR_active];
  const val = parseInt(salaryRangeFull.value);
  document.getElementById("salaryValFull").textContent = val + "%";

  const newSalary = Math.round(hr.salary * (val / 100));
  document.getElementById("salaryNewFull").textContent = "$" + newSalary;

  const newPayroll = newSalary * hr.staff;
  document.getElementById("salaryAfterFull").textContent = "$" + newPayroll;
});

function HR_confirmSalaryFull() {
  const val = parseInt(document.getElementById("salaryRangeFull").value);
  ACS_HR_adjustSalary(HR_active, val);
  closeHRFullModal();
  loadDepartments();
}
     
/* ============================================================
   === HR FULL MODAL ‚Äî BUILD SELECTS ===========================
   ============================================================ */
     
function HR_buildSelects(hrDept) {

  // Hire 1‚Äì20
  const hireSel = document.getElementById("hireQty");
  hireSel.innerHTML = "";
  for (let i = 1; i <= 20; i++) {
    hireSel.innerHTML += `<option value="${i}">${i}</option>`;
  }

  // Fire 1‚Äìstaff actual
  const fireSel = document.getElementById("fireQty");
  fireSel.innerHTML = "";
  for (let i = 1; i <= hrDept.staff; i++) {
    fireSel.innerHTML += `<option value="${i}">${i}</option>`;
  }

  // Cost update
  document.getElementById("hireCost").textContent =
    "$" + hrDept.salary.toLocaleString();

  document.getElementById("fireWarning").textContent = "‚Äî";
}
     
/* Close */
function closeHRFullModal() {
  document.getElementById("hrFullModal").style.display = "none";
}

/* ============================================================
   üü™ F ‚Äî DYNAMIC MODAL REFRESH ENGINE v1.0
   ------------------------------------------------------------
   ‚Ä¢ Opci√≥n A: NO cierra el modal
   ‚Ä¢ Cambiar de departamento refresca todo:
     - T√≠tulo
     - Staff actual
     - Required
     - Hire options
     - Fire options
     - Costos
     - Auto-Balance
   ‚Ä¢ No afecta nada fuera del modal
   ============================================================ */

// === Evento principal del selector ===
document.getElementById("hrDeptSelector").addEventListener("change", function () {
    const newID = this.value;
    if (!newID) return;

    HR_reloadModalDepartment(newID);
});


// === Funci√≥n que recarga el modal sin cerrarlo ===
     
function HR_reloadModalDepartment(id) {

    HR_active = id;

    const hr = ACS_HR_load()[id];
    if (!hr) return;

    // üîÑ T√≠tulo din√°mico
    document.getElementById("hrModalDeptName").textContent = hr.name;

    // üîÑ Recalcular selects (Hire / Fire)
    HR_buildSelects(hr);

    // üîÑ Recalcular costos de hire
    updateHireCost(hr);

    // üîÑ Fire options (cantidad disponible)
    const fireSel = document.getElementById("fireQty");
    fireSel.innerHTML = "";
    for (let i = 1; i <= hr.staff; i++) {
        fireSel.innerHTML += `<option value="${i}">${i}</option>`;
    }

    // üîÑ Mostrar staff actual
    document.getElementById("hrCurrentStaff").textContent = hr.staff;

    // üîÑ Mostrar required
    document.getElementById("hrRequiredStaff").textContent = hr.required ?? hr.staff;

    // üîÑ Mostrar diferencia
    const diff = (hr.required ?? hr.staff) - hr.staff;
    const diffEl = document.getElementById("hrDifference");
    diffEl.textContent = diff;

    diffEl.style.color = diff > 0 ? "#ff4d4d" : diff < 0 ? "#00ff99" : "#ffe38a";

    // üîÑ Actualizar salario mostrado
    document.getElementById("hrSalary").textContent = `$${hr.salary}`;

    // üîÑ Actualizar moral
    document.getElementById("hrMorale").textContent = `${hr.morale}%`;


    // üîÑ Mantener el modal arriba
    document.querySelector(".hr-full-modal").scrollTop = 0;
}

function HR_applyAutoAdjust() {
    if (typeof ACS_HR_autoAdjust5Y === "function") {
        ACS_HR_autoAdjust5Y();     // usa tu funci√≥n real de ajuste
        loadDepartments();         // refresca tabla
        HR_reloadModalDepartment(HR_active); // refresca modal sin cerrarlo
    }
}

</script>

</body>
</html>
