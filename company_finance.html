<!-- ============================================================
     === ACS COMPANY FINANCE MODULE ‚Äî Qatar Luxury Minimal v2 ===
     ------------------------------------------------------------
     Version: v2.1 | Date: 02 DEC 2025
     ============================================================ -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Company Finance - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">
  <link rel="manifest" href="manifest.json">

<style>
     
/* ============================================================
   === GLOBAL PAGE STYLE ‚Äî Qatar Luxury ========================
   ============================================================ */

body {
  margin: 0;
  background: #081530;
  color: #ffffff;
  font-family: "Poppins", sans-serif;
}

#companyFinanceRoot {
  padding: 55px 2rem 60px;
}

/* ============================================================
     === GLOBAL HEADER ‚Äî EXACT DASHBOARD COPY =================
   ============================================================ */

.acs-header {
  position: fixed;
  top: 0;
  width: 100%;
  backdrop-filter: blur(9px);
  background: rgba(12,23,50,0.45);
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffb300;
  z-index: 5000;
}

.acs-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.acs-left img {
  height: 46px;
}

.acs-left h1 {
  font-size: 1.15rem;
  margin: 0;
  color: #ffb300;
  letter-spacing: 0.5px;
}

.acs-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 2rem;
}

.acs-nav a {
  position: relative;
  font-size: 1rem;
  letter-spacing: 0.4px;
  color: #dbe4ff;
  text-decoration: none;
  transition: 0.25s ease;
  padding-bottom: 6px;
}

.acs-nav a:hover,
.acs-nav a.active {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.6);
}

.acs-nav a.active::after,
.acs-nav a:hover::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, #ffb300, #ffe7a0);
  border-radius: 2px;
  box-shadow: 0 0 8px rgba(255,200,60,0.45);
}

.acs-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.support-btn {
      padding: 0.45rem 1.1rem;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      color: #8AB4FF;
      border: 1px solid rgba(138,180,255,0.45);
      background: rgba(138,180,255,0.08);
      backdrop-filter: blur(6px);
      transition: 0.25s ease;
    }
    .support-btn:hover {
      background: rgba(138,180,255,0.20);
      box-shadow: 0 0 14px rgba(138,180,255,0.55);
      color: #dfe9ff;
    }

.logout-btn {
      padding: 0.45rem 1.1rem;
      border: 1px solid #ffb300;
      border-radius: 12px;
      background: rgba(255,179,0,0.05);
      color: #ffb300;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }

 .logout-btn:hover {
      background: #ffb300;
      color: #0c1f3c;
    }
     
.acs-clock-header {
  font-family: "Orbitron", monospace;
  padding: 0.4rem 0.8rem;
  background: rgba(0,255,128,0.08);
  border-radius: 8px;
  font-size: 0.95rem;
  color: #00ff80;
}

/* ============================================================
   === KPI CARDS (Top Summary) ================================
   ============================================================ */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
  gap: 1rem;
}

.kpi-card {
  background: #0d1a42;
  border: 1px solid #ffb3005e;
  border-radius: 14px;
  padding: 1rem;
  text-align: center;
  box-shadow: 0 0 12px rgba(0,0,0,0.45);
}

.kpi-card small {
  color: #ffb300aa;
}

.kpi-value {
  font-size: 1.4rem;
  font-weight: 700;
  margin-top: 6px;
  color: #dbe4ff;
}

/* ============================================================
   === FINANCE SECTIONS WRAPPER ===============================
   ============================================================ */
.finance-section {
  background: #0b1638;
  border-radius: 16px;
  padding: 1.4rem;
  margin-top: 2rem;
  box-shadow: 0 0 14px rgba(0,0,0,0.45);
}

.finance-section h2 {
  text-align: left;
  color: #ffb300;
  font-size: 1.3rem;
  margin-bottom: 1rem;
}

/* ============================================================
   === BREAKDOWN LIST =========================================
   ============================================================ */
     
.breakdown-list {
  display: flex;
  flex-direction: column;
  gap: 0.7rem;
}

.breakdown-item {
  background: #0d1a42;
  border: 1px solid #ffb3003b;
  border-radius: 10px;
  padding: 0.7rem;
}

.breakdown-label {
  color: #ffca5c;
  font-size: 0.9rem;
}

.breakdown-bar {
  background: #14245c;
  height: 6px;
  border-radius: 4px;
  margin-top: 4px;
  overflow: hidden;
}

.breakdown-fill {
  height: 6px;
  background: linear-gradient(to right,#ffb300,#ffe3a0);
}

/* ============================================================
   === MONTHLY HISTORY TABLE ==================================
   ============================================================ */
.history-table {
  width: 100%;
  border-collapse: collapse;
}

.history-table th {
  text-align: left;
  padding: 0.5rem;
  background: #0a1433;
  color: #ffb300;
}

.history-table td {
  padding: 0.4rem 0.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  color: #ddd;
  font-size: 0.9rem;
}
     
/* ============================================================
   === FINANCE THERMOMETER BAR (Qatar Luxury) ==================
   ============================================================ */

.finance-meter {
  background: #0a1433;
  border: 1px solid #ffb3003b;
  border-radius: 10px;
  padding: 0.9rem 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 0 12px rgba(0,0,0,0.35);
}

.finance-meter-title {
  font-size: 0.9rem;
  color: #ffca5c;
  margin-bottom: 6px;
  text-align: center;
}

.finance-meter-bar {
  width: 100%;
  height: 10px;
  background: #102049;
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid #ffb3004d;
}

.finance-meter-fill {
  height: 100%;
  width: 0%;
  transition: width 0.35s ease-out;
  background: linear-gradient(90deg, #18ff92, #ffe600, #ff4d4d);
  border-radius: 10px;
}
     
/* ============================================================
   === LOG SECTION + FILTERS ==================================
   ============================================================ */
.log-filter {
  margin-bottom: 1rem;
  display: flex;
  gap: 0.7rem;
}

.filter-btn {
  padding: 0.35rem 0.8rem;
  border-radius: 8px;
  background: rgba(138,180,255,0.08);
  border: 1px solid rgba(138,180,255,0.45);
  color: #8ab4ff;
  cursor: pointer;
  transition: 0.25s ease;
  font-size: 0.85rem;
}

.filter-btn.active {
  background: #8ab4ff;
  color: #0c1f3c;
}

/* log table compact */
.log-table {
  width: 100%;
  border-collapse: collapse;
}

.log-table td, .log-table th {
  padding: 0.4rem;
  font-size: 0.85rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.log-table th {
  background: #0a1433;
  color: #ffb300;
}

/* ============================================================
   === LEASING CONTRACTS - CARD STYLE =========================
   ============================================================ */
.leasing-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 1rem;
}

.leasing-card {
  background: #0d1a42;
  border: 1px solid #ffb30055;
  border-radius: 12px;
  padding: 1rem;
}

.leasing-card h4 {
  margin: 0;
  font-size: 1.05rem;
  color: #ffb300;
}

.leasing-card p {
  margin: 4px 0;
  color: #dbe4ff;
  font-size: 0.9rem;
}
     
</style>
</head>

<body>

<!-- ============================================================
     === QATAR LUXURY HEADER ====================================
     ============================================================ -->

<header class="acs-header">
  <div class="acs-logo">
    <img src="acs_logo.png" alt="ACS Logo" />
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html" class="active">Main</a>   
    <a href="bank.html">Bank</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html">Routes</a>
    <a href="hr.html">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
    <div id="acs-clock" class="acs-clock-header">00:00 ‚Äî 01 JAN 1940</div>
  </div>
</header>


<!-- ============================================================
     === MAIN ROOT ==============================================
     ============================================================ -->

<!-- ESTE NO SE TOCA ‚Äî AQUI RENDERIZA TODO EL MOTOR -->

<main id="companyFinanceRoot"></main>

<div style="text-align:center; margin-bottom: 3.5rem;">
  <h2 style="
    font-size: 2rem;
    font-weight: 600;
    color: #ffca3a;
    margin-bottom: 0.4rem;
    text-shadow:
      0 0 6px rgba(255,190,60,0.55),
      0 0 12px rgba(255,190,60,0.35);
  ">
    üìä Company Finance
  </h2>

  <p style="
    font-size: 1.05rem;
    color: #cbd6ff;
    opacity: 0.9;
    text-shadow: 0 0 4px rgba(200,210,255,0.25);
  ">
    Access your company‚Äôs monthly performance overview.
  </p>
</div>

     <!-- TOP KPI SUMMARY -->
     
 <div class="kpi-grid">

  <div class="kpi-card">
    <small>Capital</small>
    <div class="kpi-value" id="cf-capital">$0</div>
  </div>

  <div class="kpi-card">
    <small>Revenue (Month)</small>
    <div class="kpi-value" id="cf-revenue">$0</div>
  </div>

  <div class="kpi-card">
    <small>Expenses (Month)</small>
    <div class="kpi-value" id="cf-expenses">$0</div>
  </div>

  <div class="kpi-card">
    <small>Profit (Month)</small>
    <div class="kpi-value" id="cf-profit">$0</div>
  </div>

  <!-- üü© ESTA ES LA POSICI√ìN CORRECTA -->
  <div class="kpi-card">
    <small>Monthly Debt Service</small>
    <div class="kpi-value" id="cf-debt">$0</div>
  </div>

</div>
     
 <!-- BREAKDOWN ‚Äî Qatar Luxury Thermometers -->
     
<div class="finance-section">
  <h2>Income & Expense Breakdown</h2>
  <div id="breakdownGrid" 
       style="display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1rem;">
  </div>
</div>
     
  <!-- MONTHLY HISTORY -->
     
  <div class="finance-section">
    <h2>Monthly History</h2>

    <table class="history-table">
      <thead>
        <tr>
          <th>Month</th>
          <th>Revenue</th>
          <th>Expenses</th>
          <th>Profit</th>
        </tr>
      </thead>
      <tbody id="cf-history"></tbody>
    </table>
  </div>

  <!-- TRANSACTION LOG -->
  <div class="finance-section">
    <h2>Transaction Log</h2>

    <div class="log-filter">
      <div class="filter-btn active" data-filter="all">All</div>
      <div class="filter-btn" data-filter="INCOME">Income</div>
      <div class="filter-btn" data-filter="EXPENSE">Expenses</div>
      <div class="filter-btn" data-filter="INFO">Info</div>
    </div>

    <table class="log-table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Source</th>
          <th>USD</th>
        </tr>
      </thead>
      <tbody id="cf-log-body"></tbody>
    </table>
  </div>

  <!-- LEASING CONTRACTS -->
  <div class="finance-section">
    <h2>Active Leasing Contracts</h2>
    <div id="leasingContainer" class="leasing-grid"></div>
  </div>

</main>

<!-- SCRIPTS -->
     
<!-- ============================================================
     ‚è≥ ACS TIME ENGINE V12 ‚Äî 24/7 RECOVERY LAYER
     ============================================================ -->
<script src="acs_time_recovery.js"></script>
<script src="time_engine.js"></script>

<!-- CORE FINANCE -->
<script src="engine/acs_finance.js"></script>

<!-- PASSENGER ENGINE (CR√çTICO) -->
<script src="engine/passenger_engine.js"></script>

<!-- FLIGHT ECONOMICS (ROUTE REVENUE) -->
<script src="engine/acs_flight_economics.js"></script>

<!-- ============================================================
     üüß C2 ‚Äî ACS SKYTRACK RUNTIME (HEADLESS MODE ‚Äî 24/7 ENGINE)
     ------------------------------------------------------------
     ‚Ä¢ Arranca el motor FR24 sin abrir SkyTrack
     ‚Ä¢ Permite vuelos, arrivals y revenue en background
     ‚Ä¢ Protegido contra doble motor (__ACS_RUNTIME_ACTIVE__)
     ============================================================ -->

<script>
  // üîí Activar modo headless ANTES de cargar el runtime
  window.ACS_RUNTIME_HEADLESS = true;
</script>

<script src="engine/acs_skytrack_runtime.js"></script>
     
<!-- OTROS SISTEMAS -->
<script src="engine/acs_leasing.js"></script>
<script src="engine/acs_hr_engine.js"></script>

<script>

/* ============================================================
   ‚úÖ FIX ‚Äî SAFE NUMBER FORMAT (never crashes)
   ============================================================ */
function ACS_num(v){ 
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}
function ACS_money(v){
  const n = Math.round(ACS_num(v));
  return "$" + n.toLocaleString();
}

/* ============================================================
   === KPI OVERVIEW (SAFE) =====================================
   ============================================================ */
     
function updateCompanyOverview() {

  const f = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");

  document.getElementById("cf-capital").textContent  = ACS_money(f.capital);
  document.getElementById("cf-revenue").textContent  = ACS_money(f.revenue);
  document.getElementById("cf-expenses").textContent = ACS_money(f.expenses);
  document.getElementById("cf-profit").textContent   = ACS_money(f.profit);

  ACS_updateCapitalColor();
  ACS_updateProfitColor();

  /* üü© CF-B19 ‚Äî MONTHLY DEBT SERVICE */

  let debt = 0;

  if(f.bank && Array.isArray(f.bank.loans)){
    f.bank.loans.forEach(loan=>{
      debt += Number(loan.monthlyPayment || 0);
    });
  }

  const debtEl = document.getElementById("cf-debt");

  if(debtEl)
    debtEl.textContent = ACS_money(debt);

}

/* ============================================================
   === CAPITAL UI COLOR FIX ‚Äî NEGATIVE RED =====================
   === (Colorea capital en rojo si es negativo) ================
   ============================================================ */
     
function ACS_updateCapitalColor() {
  const el = document.getElementById("cf-capital");
  if (!el) return;

  // Obtener valor num√©rico del localStorage
  let f = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");
  let cap = f.capital || 0;

  if (cap < 0) {
    el.style.color = "#ff4d4d";   // üî¥ rojo
  } else {
   el.style.color = "#00ff80";   // üü¢ ACS green
  }
}

/* === Activar cambio autom√°tico cuando el DOM carga === */
document.addEventListener("DOMContentLoaded", () => {
  ACS_updateCapitalColor();
});

/* === Activar cambio en tiempo real si cambia ACS_Finance === */
window.addEventListener("storage", (e) => {
  if (e.key === "ACS_Finance") {
    ACS_updateCapitalColor();
  }
});

/* ============================================================
   === PROFIT UI COLOR ‚Äî NEGATIVE RED / POSITIVE GREEN ========
   ============================================================ */
function ACS_updateProfitColor() {
  const el = document.getElementById("cf-profit");
  if (!el) return;

  const f = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");
  const profit = Number(f.profit || 0);

  if (profit < 0) {
    el.style.color = "#ff4d4d";   // üî¥ rojo p√©rdidas
  } else {
    el.style.color = "#00ff80";   // üü¢ verde ganancias
  }
}
     
/* ============================================================
   === MONTHLY HISTORY (SAFE) ==================================
   ============================================================ */
function loadHistory() {
  const f = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");
  const tbody = document.getElementById("cf-history");
  tbody.innerHTML = "";

  const hist = Array.isArray(f.history) ? f.history : [];
  if (!hist.length) return;

  hist.forEach(h => {
    tbody.innerHTML += `
      <tr>
        <td>${h.month || "‚Äî"}</td>
        <td>${ACS_money(h.revenue)}</td>
        <td>${ACS_money(h.expenses)}</td>
        <td>${ACS_money(h.profit)}</td>
      </tr>`;
  });
}


/* ============================================================
   === TRANSACTION LOG WITH FILTERS ============================
   ============================================================ */
function loadTransactionLog(filter="all") {
  const log = JSON.parse(localStorage.getItem("ACS_Log") || "[]");
  const body = document.getElementById("cf-log-body");
  body.innerHTML = "";

 log.slice().reverse().forEach(entry => {

  if (filter !== "all" && entry.type !== filter) return;

  // ‚ùå OCULTAR INGRESOS DE VUELOS (NO UI)
  if (
    entry.type === "INCOME" &&
    typeof entry.source === "string"
  ) {
    const src = entry.source.toUpperCase();

    if (
      src.includes("FLIGHT") ||
      src.includes("AUTO FLIGHT") ||
      src.includes("BASE FLIGHT") ||
      src.includes("FALLBACK")
    ) {
      return; // ‚õî NO mostrar vuelos en Transaction Log
    }
  }

    body.innerHTML += `
    <tr>
      <td>${entry.type}</td>
      <td>${entry.source}</td>
      <td>$${entry.amount.toLocaleString()}</td>
    </tr>`;
  });

}

document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    loadTransactionLog(btn.dataset.filter);
  };
});
     
/* ============================================================
   üü¶ F-UI-2 ‚Äî LIVE + WEEKLY INCOME (VIEW ONLY) ‚Äî v2.1
   ------------------------------------------------------------
   ‚Ä¢ Live Route Income   ‚Üí ACS_Finance.income.live_revenue
   ‚Ä¢ Weekly Route Income ‚Üí ACS_Finance.income.weekly_revenue
   ‚Ä¢ Fuente REAL: Finance (post F8)
   ‚Ä¢ SOLO LECTURA (UI)
   ============================================================ */

function loadBreakdown() {
  const f = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");
  const grid = document.getElementById("breakdownGrid");
  if (!f || !grid) return;

  grid.innerHTML = "";

  const categories = [];

  // ===============================
  // üí∞ INCOME ‚Äî FINANCE REAL
  // ===============================
  categories.push({
    label: "Live Route Revenue (Income)",
    value: Number(f.income?.live_revenue || 0)
  });

  categories.push({
    label: "Weekly Route Revenue (Income)",
    value: Number(f.income?.weekly_revenue || 0)
  });

  // ===============================
  // üí∏ COSTS ‚Äî FINANCE REAL (MONTH)
  // ===============================
  if (f.cost) {
    Object.keys(f.cost).forEach(k => {
      categories.push({
        label: `${k} (Cost)`,
        value: Number(f.cost[k]) || 0
      });
    });
  }

  /* ============================================================
   üè¶ BANK LOANS ‚Äî FINANCE INTEGRATION (ACS BANK ENGINE)
   Adds Bank Loan income into Finance breakdown UI
   ============================================================ */

/* ============================================================
   üè¶ BANK LOANS ‚Äî FINANCE INTEGRATION (REAL SOURCE)
   Reads canonical bank structure from ACS_Finance.bank.loans
   ============================================================ */

const loans =
  Array.isArray(f.bank?.loans)
  ? f.bank.loans
  : [];

if(loans.length > 0){

  const totalLoans =
    loans.reduce(
      (sum, loan) =>
        sum + Number(
          loan.originalAmount ??
          loan.amount ??
          loan.remaining ??
          0
        ),
      0
    );

  categories.push({

    label: "Bank Loans (Financing)",

    value: totalLoans

  });

}
     
  const max = Math.max(...categories.map(c => c.value), 1);

  categories.forEach(cat => {
    const pct = (cat.value / max) * 100;

    const wrapper = document.createElement("div");
    wrapper.className = "finance-meter";

    wrapper.innerHTML = `
      <div class="finance-meter-title">
        ${cat.label} ‚Äî $${Math.round(cat.value).toLocaleString()}
      </div>
      <div class="finance-meter-bar">
        <div class="finance-meter-fill" style="width:${pct}%;"></div>
      </div>
    `;

    grid.appendChild(wrapper);
  });
}

/* ============================================================
   üü© CF-B12 ‚Äî ADD BANK LOANS FINANCING CARD (SAFE ADDITION)
   Does NOT modify existing categories
   Reads canonical bank structure from ACS_Finance.bank.loans
   ============================================================ */

(function(){

  try{

    const f =
      JSON.parse(localStorage.getItem("ACS_Finance") || "{}");

    const loans =
      f.bank?.loans || [];

    if(loans.length === 0) return;

    const total =
      loans.reduce(
        (sum, loan) =>
          sum + Number(loan.originalAmount || 0),
        0
      );

    const container =
      document.querySelector(".finance-breakdown");

    if(!container) return;

    const card =
      document.createElement("div");

    card.className = "finance-chip";

    card.innerHTML = `
      <div class="finance-chip-label">
        bank_loans (Financing)
      </div>

      <div class="finance-chip-bar">
        <div class="finance-chip-fill"
             style="
               width:100%;
               background:linear-gradient(
                 90deg,
                 #00ffd0,
                 #00ff88
               );
             ">
        </div>
      </div>

      <div class="finance-chip-value">
        $${Math.round(total).toLocaleString()}
      </div>
    `;

    container.appendChild(card);

  }
  catch(e){

    console.warn(
      "CF-B12 failed:",
      e
    );

  }

})();
     
/* ============================================================
   üü¶ F-UI-3 ‚Äî FINANCE UI LIVE REFRESH (same-tab)
   ------------------------------------------------------------
   ‚Ä¢ Trigger: ACS_FINANCE_UPDATED
   ‚Ä¢ NO polling
   ‚Ä¢ NO storage hacks
   ============================================================ */

(function ACS_bindFinanceUILive(){

  function refreshAll(){
    updateCompanyOverview();
    loadBreakdown();
    loadHistory();
    loadTransactionLog(
      document.querySelector(".filter-btn.active")?.dataset?.filter || "all"
    );
    loadLeasing();
  }

  // üî• Evento financiero real (MISMA PESTA√ëA)
  window.addEventListener("ACS_FINANCE_UPDATED", refreshAll);

  // üü° Fallback multi-tab (solo si cambia otra pesta√±a)
  window.addEventListener("storage", (e) => {
    if (e.key === "ACS_Finance" || e.key === "ACS_Log") {
      refreshAll();
    }
  });

})();

/* ============================================================
   === LEASING CARDS ===========================================
   ============================================================ */
     
function loadLeasing() {
  const container = document.getElementById("leasingContainer");
  container.innerHTML = "";

  let leasingContracts = [];
  try {
    const store = JSON.parse(localStorage.getItem("ACS_Leasing") || "{}");
    leasingContracts = store.contracts || [];
  } catch {}

  leasingContracts.filter(c => c.status === "ACTIVE").forEach(c => {
    container.innerHTML += `
      <div class="leasing-card">
        <h4>${c.model}</h4>
        <p>Type: ${c.type}</p>
        <p>Monthly: $${c.monthlyRate.toLocaleString()}</p>
        <p>Months Left: ${c.monthsRemaining}</p>
        <p>Status: ${c.status}</p>
      </div>`;
  });
}

/* ============================================================
   === CLOCK ====================================================
   ============================================================ */
     
function updateClockDisplay(simTime){
  const el = document.getElementById("acs-clock");
  if(!el) return;

  window.ACS_CurrentSimDate = simTime;

  const d = simTime instanceof Date ? simTime : new Date();

  const weekday = d
    .toLocaleString("en-US", { weekday: "short", timeZone: "UTC" })
    .toUpperCase();

  const day = String(d.getUTCDate()).padStart(2,"0");

  const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
  const month = months[d.getUTCMonth()];

  const year  = d.getUTCFullYear();
  const hh = String(d.getUTCHours()).padStart(2,"0");
  const mm = String(d.getUTCMinutes()).padStart(2,"0");

  el.textContent = `${hh}:${mm} ‚Äî ${weekday} ${day} ${month} ${year}`;
}

     
/* ============================================================
   === INIT =====================================================
   ============================================================ */
     
document.addEventListener("DOMContentLoaded", () => {

  if (typeof registerTimeListener === "function") {
    registerTimeListener(updateClockDisplay);
    updateClockDisplay();
  }

  updateCompanyOverview();
  loadHistory();
  loadBreakdown();
  loadTransactionLog();
  loadLeasing();
 
});

/* ============================================================
   === FINANCE UI LIVE REFRESH ‚Äî FIX v1.0 =====================
   ============================================================ */

function ACS_subscribeFinanceUIRefresh() {
  window.addEventListener("storage", (e) => {
    if (e.key === "ACS_Finance" || e.key === "ACS_Log") {
      updateCompanyOverview();
      loadHistory();
      loadBreakdown();
      loadTransactionLog();
  
    }
  });
}

// Activar refresh en vivo
ACS_subscribeFinanceUIRefresh();

function handleLogout(){
  window.location.href="login.html";
}
     
/* ============================================================
   ‚õî DISABLED ‚Äî LIVE REFRESH (same-tab)
   ------------------------------------------------------------
   ‚Ä¢ Reemplazado por eventos reales
   ============================================================ */

/*
(function ACS_liveFinanceUI(){
  let lastFinanceStr = null;
  let lastLogStr = null;

  setInterval(() => {
    const fStr = localStorage.getItem("ACS_Finance") || "";
    const lStr = localStorage.getItem("ACS_Log") || "";

    if (fStr !== lastFinanceStr || lStr !== lastLogStr) {
      lastFinanceStr = fStr;
      lastLogStr = lStr;

      updateCompanyOverview();
      loadHistory();
      loadBreakdown();
      loadTransactionLog(
        document.querySelector(".filter-btn.active")?.dataset?.filter || "all"
      );
      loadLeasing();
    }
  }, 700);
})();
*/

     
</script>

<script src="engine/acs_security_core.js?v=1"></script>
     
</body>
</html>
