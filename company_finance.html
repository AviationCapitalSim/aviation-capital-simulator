<!-- ============================================================
     === ACS COMPANY FINANCE MODULE â€” Qatar Luxury Minimal v2 ===
     ------------------------------------------------------------
     Version: v2.0 | Date: 02 DEC 2025
     ============================================================ -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Company Finance - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">
  <link rel="manifest" href="manifest.json">

<style>
     
/* ============================================================
   === GLOBAL PAGE STYLE â€” Qatar Luxury ========================
   ============================================================ */

body {
  margin: 0;
  background: #081530;
  color: #ffffff;
  font-family: "Poppins", sans-serif;
}

#companyFinanceRoot {
  padding: 120px 2rem 60px;
}

/* ============================================================
     === GLOBAL HEADER â€” EXACT DASHBOARD COPY =================
   ============================================================ */

.acs-header {
  position: fixed;
  top: 0;
  width: 100%;
  backdrop-filter: blur(9px);
  background: rgba(12,23,50,0.45);
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffb300;
  z-index: 5000;
}

.acs-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.acs-left img {
  height: 46px;
}

.acs-left h1 {
  font-size: 1.15rem;
  margin: 0;
  color: #ffb300;
  letter-spacing: 0.5px;
}

.acs-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 2rem;
}

.acs-nav a {
  position: relative;
  font-size: 1rem;
  letter-spacing: 0.4px;
  color: #dbe4ff;
  text-decoration: none;
  transition: 0.25s ease;
  padding-bottom: 6px;
}

.acs-nav a:hover,
.acs-nav a.active {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.6);
}

.acs-nav a.active::after,
.acs-nav a:hover::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, #ffb300, #ffe7a0);
  border-radius: 2px;
  box-shadow: 0 0 8px rgba(255,200,60,0.45);
}

.acs-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.support-btn {
  padding: 0.45rem 1.1rem;
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  color: #8AB4FF;
  border: 1px solid rgba(138,180,255,0.45);
  background: rgba(138,180,255,0.08);
  backdrop-filter: blur(6px);
  transition: 0.25s ease;
}

.support-btn:hover {
  background: rgba(138,180,255,0.20);
  box-shadow: 0 0 14px rgba(138,180,255,0.55);
  color: #dfe9ff;
}

.logout-btn {
  padding: 0.45rem 1.1rem;
  border: 1px solid #ffb300;
  border-radius: 12px;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
}

.logout-btn:hover {
  background: #ffb300;
  color: #0c1f3c;
}

.acs-clock-header {
  font-family: "Orbitron", monospace;
  padding: 0.4rem 0.8rem;
  background: rgba(0,255,128,0.08);
  border-radius: 8px;
  font-size: 0.95rem;
  color: #00ff80;
}

/* ============================================================
   === KPI CARDS (Top Summary) ================================
   ============================================================ */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
  gap: 1rem;
}

.kpi-card {
  background: #0d1a42;
  border: 1px solid #ffb3005e;
  border-radius: 14px;
  padding: 1rem;
  text-align: center;
  box-shadow: 0 0 12px rgba(0,0,0,0.45);
}

.kpi-card small {
  color: #ffb300aa;
}

.kpi-value {
  font-size: 1.4rem;
  font-weight: 700;
  margin-top: 6px;
  color: #dbe4ff;
}

/* ============================================================
   === FINANCE SECTIONS WRAPPER ===============================
   ============================================================ */
.finance-section {
  background: #0b1638;
  border-radius: 16px;
  padding: 1.4rem;
  margin-top: 2rem;
  box-shadow: 0 0 14px rgba(0,0,0,0.45);
}

.finance-section h2 {
  text-align: left;
  color: #ffb300;
  font-size: 1.3rem;
  margin-bottom: 1rem;
}

/* ============================================================
   === TABS: WEEKLY / MONTHLY ================================
   ============================================================ */
.tab-buttons {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.tab-btn {
  padding: 0.4rem 1rem;
  border-radius: 10px;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  cursor: pointer;
  border: 1px solid #ffb30055;
  font-weight: 600;
  transition: 0.2s;
}

.tab-btn.active {
  background: #ffb300;
  color: #0d1a42;
}

.tab-panel {
  display: none;
}

.tab-panel.active {
  display: block;
}

/* ============================================================
   === SPARKLINE CHART ========================================
   ============================================================ */
.sparkline {
  width: 100%;
  height: 90px;
}

/* ============================================================
   === BREAKDOWN LIST =========================================
   ============================================================ */
.breakdown-list {
  display: flex;
  flex-direction: column;
  gap: 0.7rem;
}

.breakdown-item {
  background: #0d1a42;
  border: 1px solid #ffb3003b;
  border-radius: 10px;
  padding: 0.7rem;
}

.breakdown-label {
  color: #ffca5c;
  font-size: 0.9rem;
}

.breakdown-bar {
  background: #14245c;
  height: 6px;
  border-radius: 4px;
  margin-top: 4px;
  overflow: hidden;
}

.breakdown-fill {
  height: 6px;
  background: linear-gradient(to right,#ffb300,#ffe3a0);
}

/* ============================================================
   === MONTHLY HISTORY TABLE ==================================
   ============================================================ */
.history-table {
  width: 100%;
  border-collapse: collapse;
}

.history-table th {
  text-align: left;
  padding: 0.5rem;
  background: #0a1433;
  color: #ffb300;
}

.history-table td {
  padding: 0.4rem 0.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  color: #ddd;
  font-size: 0.9rem;
}

/* ============================================================
   === LOG SECTION + FILTERS ==================================
   ============================================================ */
.log-filter {
  margin-bottom: 1rem;
  display: flex;
  gap: 0.7rem;
}

.filter-btn {
  padding: 0.35rem 0.8rem;
  border-radius: 8px;
  background: rgba(138,180,255,0.08);
  border: 1px solid rgba(138,180,255,0.45);
  color: #8ab4ff;
  cursor: pointer;
  transition: 0.25s ease;
  font-size: 0.85rem;
}

.filter-btn.active {
  background: #8ab4ff;
  color: #0c1f3c;
}

/* log table compact */
.log-table {
  width: 100%;
  border-collapse: collapse;
}

.log-table td, .log-table th {
  padding: 0.4rem;
  font-size: 0.85rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.log-table th {
  background: #0a1433;
  color: #ffb300;
}

/* ============================================================
   === LEASING CONTRACTS - CARD STYLE =========================
   ============================================================ */
.leasing-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 1rem;
}

.leasing-card {
  background: #0d1a42;
  border: 1px solid #ffb30055;
  border-radius: 12px;
  padding: 1rem;
}

.leasing-card h4 {
  margin: 0;
  font-size: 1.05rem;
  color: #ffb300;
}

.leasing-card p {
  margin: 4px 0;
  color: #dbe4ff;
  font-size: 0.9rem;
}
</style>
</head>

<body>

<!-- ============================================================
     === QATAR LUXURY HEADER ====================================
     ============================================================ -->

<header class="acs-header">
  <div class="acs-left">
    <img src="acs_logo.png" alt="ACS Logo">
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="finance.html">Bank</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html">Routes</a>
    <a href="hr.html">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
    <div id="acs-clock" class="acs-clock-header">00:00 â€” 01 JAN 1940</div>
  </div>
</header>

<!-- ============================================================
     === MAIN ROOT ==============================================
     ============================================================ -->
     
<main class="acs-main" id="companyFinanceRoot">

  <h2>ðŸ“Š Company Finance</h2>
  <p class="sub">Access your companyâ€™s monthly and weekly growth overview.</p>

  <!-- TOP KPI SUMMARY -->
  <div class="kpi-grid">
    ...

  <!-- TOP KPI SUMMARY -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <small>Capital</small>
      <div class="kpi-value" id="cf-capital">$0</div>
    </div>

    <div class="kpi-card">
      <small>Revenue (Month)</small>
      <div class="kpi-value" id="cf-revenue">$0</div>
    </div>

    <div class="kpi-card">
      <small>Expenses (Month)</small>
      <div class="kpi-value" id="cf-expenses">$0</div>
    </div>

    <div class="kpi-card">
      <small>Profit (Month)</small>
      <div class="kpi-value" id="cf-profit">$0</div>
    </div>
  </div>

  <!-- WEEKLY & MONTHLY FINANCE -->
  <div class="finance-section">
    <h2>Financial Performance</h2>

    <div class="tab-buttons">
      <div class="tab-btn active" data-tab="weeklyTab">Weekly</div>
      <div class="tab-btn" data-tab="monthlyTab">Monthly</div>
    </div>

    <div id="weeklyTab" class="tab-panel active">
      <canvas class="sparkline" id="weeklySpark"></canvas>
    </div>

    <div id="monthlyTab" class="tab-panel">
      <canvas class="sparkline" id="monthlySpark"></canvas>
    </div>
  </div>

  <!-- BREAKDOWN -->
  <div class="finance-section">
    <h2>Income & Expense Breakdown</h2>
    <div id="breakdownContainer" class="breakdown-list"></div>
  </div>

  <!-- MONTHLY HISTORY -->
  <div class="finance-section">
    <h2>Monthly History</h2>

    <table class="history-table">
      <thead>
        <tr>
          <th>Month</th>
          <th>Revenue</th>
          <th>Expenses</th>
          <th>Profit</th>
        </tr>
      </thead>
      <tbody id="cf-history"></tbody>
    </table>
  </div>

  <!-- TRANSACTION LOG -->
  <div class="finance-section">
    <h2>Transaction Log</h2>

    <div class="log-filter">
      <div class="filter-btn active" data-filter="all">All</div>
      <div class="filter-btn" data-filter="INCOME">Income</div>
      <div class="filter-btn" data-filter="EXPENSE">Expenses</div>
      <div class="filter-btn" data-filter="INFO">Info</div>
    </div>

    <table class="log-table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Source</th>
          <th>USD</th>
        </tr>
      </thead>
      <tbody id="cf-log-body"></tbody>
    </table>
  </div>

  <!-- LEASING CONTRACTS -->
  <div class="finance-section">
    <h2>Active Leasing Contracts</h2>
    <div id="leasingContainer" class="leasing-grid"></div>
  </div>

</main>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="engine/acs_finance.js"></script>
<script src="engine/acs_leasing.js"></script>
<script src="time_engine.js"></script>

<script>
/* ============================================================
   === TAB HANDLER =============================================
   ============================================================ */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));

    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  };
});

/* ============================================================
   === KPI OVERVIEW ============================================
   ============================================================ */
function updateCompanyOverview() {
  const f = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");

  document.getElementById("cf-capital").textContent = "$" + f.capital.toLocaleString();
  document.getElementById("cf-revenue").textContent = "$" + f.revenue.toLocaleString();
  document.getElementById("cf-expenses").textContent = "$" + f.expenses.toLocaleString();
  document.getElementById("cf-profit").textContent = "$" + f.profit.toLocaleString();
}

/* ============================================================
   === MONTHLY HISTORY =========================================
   ============================================================ */
function loadHistory() {
  const f = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");
  const tbody = document.getElementById("cf-history");
  tbody.innerHTML = "";
  
  if (!f.history) return;

  f.history.forEach(h => {
    tbody.innerHTML += `
      <tr>
        <td>${h.month}</td>
        <td>$${h.revenue.toLocaleString()}</td>
        <td>$${h.expenses.toLocaleString()}</td>
        <td>$${h.profit.toLocaleString()}</td>
      </tr>`;
  });
}

/* ============================================================
   === TRANSACTION LOG WITH FILTERS ============================
   ============================================================ */
function loadTransactionLog(filter="all") {
  const log = JSON.parse(localStorage.getItem("ACS_Log") || "[]");
  const body = document.getElementById("cf-log-body");
  body.innerHTML = "";

  log.slice().reverse().forEach(entry => {
    if (filter !== "all" && entry.type !== filter) return;

    body.innerHTML += `
      <tr>
        <td>${entry.time}</td>
        <td>${entry.type}</td>
        <td>${entry.source}</td>
        <td>$${entry.amount.toLocaleString()}</td>
      </tr>`;
  });
}

document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    loadTransactionLog(btn.dataset.filter);
  };
});

/* ============================================================
   === BREAKDOWN (Income & Expenses) ===========================
   ============================================================ */
function loadBreakdown() {
  const f = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");
  const container = document.getElementById("breakdownContainer");
  container.innerHTML = "";

  if (!f.income || !f.cost) return;

  // Merge categories
  const categories = [];

  Object.keys(f.income).forEach(k => {
    categories.push({ label: k + " (Income)", value: f.income[k] });
  });

  Object.keys(f.cost).forEach(k => {
    categories.push({ label: k + " (Cost)", value: f.cost[k] });
  });

  const max = Math.max(...categories.map(c => c.value || 0), 1);

  categories.forEach(c => {
    const pct = (c.value / max) * 100;

    container.innerHTML += `
      <div class="breakdown-item">
        <div class="breakdown-label">${c.label} â€” $${c.value.toLocaleString()}</div>
        <div class="breakdown-bar">
          <div class="breakdown-fill" style="width:${pct}%;"></div>
        </div>
      </div>`;
  });
}

/* ============================================================
   === LEASING CARDS ===========================================
   ============================================================ */
function loadLeasing() {
  const container = document.getElementById("leasingContainer");
  container.innerHTML = "";

  let leasingContracts = [];
  try {
    const store = JSON.parse(localStorage.getItem("ACS_Leasing") || "{}");
    leasingContracts = store.contracts || [];
  } catch {}

  leasingContracts.filter(c => c.status === "ACTIVE").forEach(c => {
    container.innerHTML += `
      <div class="leasing-card">
        <h4>${c.model}</h4>
        <p>Type: ${c.type}</p>
        <p>Monthly: $${c.monthlyRate.toLocaleString()}</p>
        <p>Months Left: ${c.monthsRemaining}</p>
        <p>Status: ${c.status}</p>
      </div>`;
  });
}

/* ============================================================
   === SPARKLINES (WEEK + MONTH) ===============================
   ============================================================ */
function renderSparklines() {
  const f = JSON.parse(localStorage.getItem("ACS_Finance") || "{}");

  const monthly = f.history ? f.history.map(h => h.profit) : [0];
  const weekly = monthly.slice(-5); // simple placeholder trend

  new Chart(document.getElementById("weeklySpark"), {
    type: "line",
    data: {
      labels: weekly.map((_,i)=>"W"+(i+1)),
      datasets: [{
        data: weekly,
        borderColor: "#FFB300",
        borderWidth: 2,
        fill: false,
        tension: 0.3
      }]
    },
    options: { plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} }
  });

  new Chart(document.getElementById("monthlySpark"), {
    type: "line",
    data: {
      labels: f.history ? f.history.map(h=>h.month) : ["Month"],
      datasets: [{
        data: monthly,
        borderColor: "#FFB300",
        borderWidth: 2,
        fill: false,
        tension: 0.3
      }]
    },
    options: { plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} }
  });
}

/* ============================================================
   === CLOCK ====================================================
   ============================================================ */
function updateClockDisplay(simTime){
  const el = document.getElementById("acs-clock");
  if(!el) return;

  let d = simTime instanceof Date ? simTime : new Date();
  const day = String(d.getUTCDate()).padStart(2,"0");
  const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
  const month = months[d.getUTCMonth()];
  const year  = d.getUTCFullYear();
  const hh = String(d.getUTCHours()).padStart(2,"0");
  const mm = String(d.getUTCMinutes()).padStart(2,"0");

  el.textContent = `${hh}:${mm} â€” ${day} ${month} ${year}`;
}

/* ============================================================
   === INIT =====================================================
   ============================================================ */
document.addEventListener("DOMContentLoaded", () => {

  if (typeof registerTimeListener === "function") {
    registerTimeListener(updateClockDisplay);
    updateClockDisplay();
  }

  updateCompanyOverview();
  loadHistory();
  loadBreakdown();
  loadTransactionLog();
  loadLeasing();
  renderSparklines();
});

function handleLogout(){
  window.location.href="login.html";
}
</script>

</body>
</html>
