<!-- ============================================================
     üè¶ ACS BANK CENTER ‚Äî HISTORICAL CREDIT AUTHORITY
     Version: 1.0
     Date: 14 FEB 2026
     Engine: engine/acs_bank.js
     ============================================================ -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank ‚Äî Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">
  <link rel="manifest" href="manifest.json">

  <style>
    body{
      margin:0;
      background:#081530;
      color:white;
      font-family:"Poppins",sans-serif;
    }

   /* ============================================================
   HEADER ‚Äî SHARED ACS STANDARD
   ============================================================ */
.acs-header{
  position:fixed;
  top:0;
  width:100%;
  box-sizing:border-box; /* ‚Üê FIX CR√çTICO */
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:.8rem 2rem;
  background:rgba(12,23,50,.45);
  backdrop-filter:blur(9px);
  border-bottom:2px solid #ffb300;
  z-index:5000;
}

.acs-logo{
  display:flex;
  align-items:center;
  gap:1rem;
}

.acs-logo img{
  height:46px;
}

.acs-logo h1{
  margin:0;
  font-size:1.1rem;
  color:#ffb300;
}

.acs-nav{
  display:flex;
  gap:2rem;
}

.acs-nav a{
  text-decoration:none;
  color:#dbe4ff;
}

.acs-nav a.active{
  color:#ffb300;
}

/* ============================================================
   üü¶ RIGHT HEADER AREA ‚Äî PERFECT SPACING & CLOCK ALIGNMENT
   ============================================================ */

.acs-right{
  display:flex;
  align-items:center;
  gap:14px;              /* espacio real entre botones y reloj */
  padding-right:12px;    /* aire contra borde derecho */
  flex-shrink:0;
}

.support-btn{
  padding:.45rem 1.1rem;
  border-radius:12px;
  font-size:.9rem;
  font-weight:600;
  text-decoration:none;
  color:#8AB4FF;
  border:1px solid rgba(138,180,255,.45);
  background:rgba(138,180,255,.08);
}

.logout-btn{
  padding:.45rem 1.1rem;
  border:1px solid #ffb300;
  border-radius:12px;
  background:rgba(255,179,0,.05);
  color:#ffb300;
  font-weight:600;
  cursor:pointer;
}

/* ============================================================
   üü¶ ACS GLOBAL CLOCK ‚Äî STABLE HEADER FIX (NO LAYOUT SHIFT)
   Use in ALL ACS modules
   ============================================================ */

.acs-clock-header{

  font-family:"Orbitron",monospace;
  font-size:.95rem;
  color:#00ff80;

  background:rgba(0,255,128,.08);
  border-radius:10px;

  padding:.45rem .8rem;

  width:260px;                 /* ancho fijo absoluto */
  flex:0 0 260px;             /* evita expansi√≥n o compresi√≥n */

  display:flex;
  justify-content:center;
  align-items:center;

  white-space:nowrap;

  font-variant-numeric:tabular-nums;

  border:1px solid rgba(0,255,128,.18);

  overflow:hidden;            /* protecci√≥n extra */
}

    /* ================= MAIN ================= */
    .acs-main{
      padding:120px 30px 70px;
      max-width:1200px;
      margin:auto;
    }

    .title{
  font-size:2rem;
  font-weight:600;
  color:#ffca3a;
  margin-bottom:14px;
  margin-top:10px;
}

.subtitle{
  font-size:1.05rem;
  color:#cbd6ff;
  opacity:0.9;
  margin-bottom:52px;
}

    .subtitle{
      font-size:1.05rem;
      color:#cbd6ff;
      opacity:0.9;
      text-shadow:0 0 4px rgba(200,210,255,0.25);
      margin-bottom:28px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:18px;
      margin-bottom:24px;
    }

    .card{
      background:linear-gradient(180deg, rgba(20,35,70,0.75), rgba(10,18,40,0.85));
      padding:18px 18px;
      border-radius:18px;
      box-shadow:0 0 25px rgba(0,0,0,0.4);
      border:1px solid rgba(255,179,0,0.15);
    }

    .card h3{
      margin:0 0 10px;
      color:#ffb300;
      text-shadow:0 0 6px rgba(255,179,0,0.35);
      font-size:1.15rem;
    }

    .kpi-value {

  font-family: "Inter", "Segoe UI", "Roboto", sans-serif;

  font-size: 1.55rem;

  font-weight: 600;

  margin-top: 6px;

  color: #00ff80;

  letter-spacing: 0.5px;

}

.kpi-date {

  font-family: "Segoe UI", "Inter", sans-serif;

  font-size: 1.35rem;

  font-weight: 600;

  color: #00ffcc;

  letter-spacing: 0.8px;

}


    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
    }
       
    th, td{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,0.10);
  font-size:0.95rem;
  text-align:center;
  vertical-align:middle;
}

th{
  color:#ffb300;
  text-align:center;
  font-weight:600;
  letter-spacing:0.4px;
}

    .btn{
      margin-top:16px;
      background:#00a86b;
      border:none;
      padding:0.7rem 1.1rem;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      transition:0.25s;
      color:white;
    }
    .btn:hover{ background:#00794f; }

    .hint{
      font-size:0.9rem;
      color:#9fb3ff;
      opacity:0.9;
      margin-top:10px;
    }
  </style>
</head>

<body>

<header class="acs-header">
  <div class="acs-logo">
    <img src="acs_logo.png" alt="ACS Logo" />
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="bank.html" class="active">Bank</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html">Routes</a>
    <a href="hr.html">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
   <div id="acs-clock" class="acs-clock-header">
  <span class="clock-text">20:10 ‚Äî MON 09 JUN 1941</span>
</div>
  
</div>
  
</header>

<main class="acs-main">

  <div class="title" style="margin-bottom:8px;">
  Bank Authority
  </div>

  <div class="subtitle" style="margin-bottom:38px;">
  Aviation Credit & Financing Authority ‚Äî Loan Origination, Capacity, and Debt Service Control
  </div>

  <section class="grid">
       
    <!-- ============================================================
   üü© B17 ‚Äî LOAN ORIGINATION DATE CARD (REAL BANKING FIX)
   Replaces Current Year with Loan Start Date
   ============================================================ -->

<div class="card">

  <h3>Financial Authority</h3>

  <!-- Authority Level Bar -->
  <div style="
    margin-top:10px;
    margin-bottom:6px;
    height:8px;
    background:rgba(255,255,255,0.08);
    border-radius:6px;
    overflow:hidden;
  ">

    <div id="authorityBar" style="
      height:100%;
      width:35%;
      background:linear-gradient(90deg,#ffb300,#00ff88);
      border-radius:6px;
    "></div>

  </div>

  <!-- Authority Label -->
  <div id="authorityLabel"
       style="
         font-weight:600;
         font-size:0.95rem;
         color:#ffb300;
         margin-bottom:8px;
       ">
    RESTRICTED AUTHORITY
  </div>

  <!-- Financial Stability -->
  <div style="font-size:0.85rem;color:#9fb3ff;">
    Stability:
    <span id="authorityStability"
          style="color:#ff8844;font-weight:600;">
      UNSTABLE
    </span>
  </div>

</div>


<div class="card">
  <h3>Remaining Term</h3>
  <div class="value" id="loanTerm">‚Äî</div>
</div>

    <div class="card">
      <h3>Fleet Collateral Value</h3>
      <div class="value" id="fleet">‚Äî</div>
    </div>

    <div class="card">
      <h3>Loan Capacity Available</h3>
      <div class="value" id="capacity">‚Äî</div>
    </div>

    <div class="card">
      <h3>Interest Rate</h3>
      <div class="value" id="rate">‚Äî</div>
    </div>

<!-- üü© B22 ‚Äî ORIGINAL LOAN AMOUNT -->
<div class="card">
  <h3>Original Loan Amount</h3>
  <div class="value" id="loanOriginal">‚Äî</div>
</div>

<!-- üü© B23 ‚Äî MONTHLY DEBT SERVICE -->
<div class="card">
  <h3>Monthly Debt Service</h3>
  <div class="value" id="loanMonthly">‚Äî</div>
</div>

<!-- üü© B24 ‚Äî TOTAL OUTSTANDING DEBT -->
<div class="card">
  <h3>Total Outstanding Debt</h3>
  <div class="value" id="loanOutstanding">‚Äî</div>
</div>
       
  </section>

  <section class="card">
    <h3>Active Loans</h3>

    <table>
      <thead>
  <tr>
    <th>ID</th>
    <th>Status</th>
    <th>Remaining</th>
    <th>Rate</th>
    <th>Monthly</th>
    <th>Open Date</th>
    <th>Closed Date</th>
  </tr>
</thead>
      <tbody id="loanTable"></tbody>
    </table>

    <button class="btn" onclick="goLoan()">Request New Loan</button>
  </section>

</main>

<!-- ============================================================
     ‚è≥ TIME ENGINE
     ============================================================ -->
<script src="acs_time_recovery.js"></script>
<script src="time_engine.js"></script>

<!-- ============================================================
     üîê SECURITY CORE
     ============================================================ -->
<script src="engine/acs_security_core.js?v=1"></script>

<!-- ============================================================
     üíº FINANCE + BANK ENGINE
     (IMPORTANTE: estos dos deben existir en /engine/)
     ============================================================ -->
<script src="engine/acs_finance.js"></script>
<script src="engine/acs_bank.js"></script>

<script>

/* ============================================================
   üü© B-50 ‚Äî ACS BANK UI MASTER SCRIPT (FULL FIXED VERSION)
   Fixes:
   ‚úî Correct maturity date (normalizes broken termMonths)
   ‚úî Adds formatAviationDate
   ‚úî Restores PAID rows
   ‚úî Fixes Closed Date display
   ‚úî Uses simulation date
   ‚úî Aviation-style colors
   ‚úî Fully safe engine integration
   ============================================================ */

function money(x){
  const v = Number(x || 0);
  return "$" + Math.round(v).toLocaleString();
}

function handleLogout(){
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}

function goLoan(){
  window.location.href = "loan_request.html";
}

/* ============================================================
   üü© AVIATION DATE FORMATTER
   ============================================================ */

function formatAviationDate(input){

  if(!input) return "‚Äî";

  const d =
    (input instanceof Date)
    ? input
    : new Date(input);

  if(isNaN(d.getTime()))
    return "‚Äî";

  const day =
    String(d.getDate()).padStart(2,"0");

  const months =
    ["JAN","FEB","MAR","APR","MAY","JUN",
     "JUL","AUG","SEP","OCT","NOV","DEC"];

  const mon =
    months[d.getMonth()];

  const yr =
    d.getFullYear();

  return `${day} ${mon} ${yr}`;
}

/* ============================================================
   üü© TERM NORMALIZER (FIX 72 ‚Üí 864 BUG)
   ============================================================ */

function normalizeTermMonths(loan){

  let m =
    Number(
      loan?.termMonths ??
      loan?.months ??
      0
    );

  if(!m) return 0;

  /* detect legacy bug */
  if(m > 240 && m % 12 === 0){

    const divided = m / 12;

    if(divided <= 240)
      return divided;

  }

  return m;
}

/* ============================================================
   üü© TERM COLOR ENGINE
   ============================================================ */

function termColor(months){

  if(months > 84) return "#00ff88";
  if(months > 36) return "#4da3ff";
  if(months > 12) return "#ffb300";
  if(months > 0)  return "#ff4444";

  return "#00ffcc";
}

/* ============================================================
   üü© MAIN BANK LOAD
   ============================================================ */

function loadBank(){

  if(typeof ACS_BANK_getSummary !== "function"){
    console.error("ACS_BANK_getSummary missing");
    return;
  }

  const s =
    ACS_BANK_getSummary();

  const loans =
    Array.isArray(s.loans)
    ? s.loans
    : [];

  /* ============================================================
     SUMMARY TOTALS
     ============================================================ */

  let totalOutstanding = 0;
let totalOriginal    = 0;
let totalMonthly     = 0;

loans.forEach(loan=>{

  const remaining =
    Number(loan.remaining || 0);

  totalOutstanding += remaining;

  totalOriginal += Number(
    loan.originalAmount ||
    loan.amount ||
    0
  );

  /* ‚úÖ SOLO loans activos generan deuda mensual */

  if(remaining > 0){

    totalMonthly +=
      Number(loan.monthlyPayment || 0);

  }

});

  document.getElementById("loanOriginal").innerText =
    money(totalOriginal);

  document.getElementById("loanMonthly").innerText =
    money(totalMonthly);

  document.getElementById("loanOutstanding").innerText =
    money(totalOutstanding);

  /* ============================================================
     STANDARD CARDS
     ============================================================ */

  document.getElementById("fleet").innerText =
    money(s.fleetValue);

  document.getElementById("capacity").innerText =
    money(s.loanCapacity);

  /* ============================================================
   üü© B-BANK-FIX-FINAL ‚Äî FORCE RATE = 0 WHEN NO ACTIVE LOANS
   ============================================================ */

const activeLoans =
  loans.filter(l => Number(l.remaining || 0) > 0);

const effectiveRate =
  activeLoans.length > 0
    ? Number(s.interestRate || 0)
    : 0;

document.getElementById("rate").innerText =
  effectiveRate.toFixed(2) + "%";

/* ============================================================
   üüß B-AUTH-03 ‚Äî AUTHORITY MIRROR (LOAN REQUEST MASTER MODEL)
   Bank Authority now mirrors Loan Request authority exactly
   Source: fleetValue thresholds (NOT debt ratio)
   ============================================================ */

function updateFinancialAuthority(summary){

  const fleetValue =
    Number(summary?.fleetValue || 0);

  let authorityText = "";
  let stability     = "";
  let authorityColor= "";
  let authorityBar  = "";

  /* ============================================================
     MASTER AUTHORITY MODEL (IDENTICAL TO LOAN REQUEST)
     ============================================================ */

  if(fleetValue >= 100000000){

    authorityText  = "GLOBAL AUTHORITY";
    stability      = "SECURE";
    authorityColor = "#00ffd0";
    authorityBar   = "100%";

  }
  else if(fleetValue >= 25000000){

    authorityText  = "EXTENDED AUTHORITY";
    stability      = "STRONG";
    authorityColor = "#00ff88";
    authorityBar   = "75%";

  }
  else if(fleetValue >= 5000000){

    authorityText  = "STANDARD AUTHORITY";
    stability      = "STABLE";
    authorityColor = "#4da3ff";
    authorityBar   = "55%";

  }
  else if(fleetValue >= 1000000){

    authorityText  = "LIMITED AUTHORITY";
    stability      = "ELEVATED RISK";
    authorityColor = "#ffb300";
    authorityBar   = "35%";

  }
  else{

    authorityText  = "RESTRICTED AUTHORITY";
    stability      = "UNSTABLE";
    authorityColor = "#ff8844";
    authorityBar   = "15%";

  }

  /* ============================================================
     APPLY TO UI
     ============================================================ */

  const labelEl =
    document.getElementById("authorityLabel");

  const barEl =
    document.getElementById("authorityBar");

  const stabilityEl =
    document.getElementById("authorityStability");

  if(labelEl){
    labelEl.innerText = authorityText;
    labelEl.style.color = authorityColor;
  }

  if(barEl){
    barEl.style.width = authorityBar;
    barEl.style.background =
      `linear-gradient(90deg, ${authorityColor}, #00ff88)`;
  }

  if(stabilityEl){
    stabilityEl.innerText = stability;
    stabilityEl.style.color = authorityColor;
  }

}
     
  /* ============================================================
     LOAN TABLE (ACTIVE + PAID)
     ============================================================ */

  const table =
    document.getElementById("loanTable");

  table.innerHTML = "";

  if(loans.length === 0){

    table.innerHTML =
      `<tr>
       <td colspan="7" style="color:#9fb3ff;">
          No loan history.
        </td>
      </tr>`;

    return;
  }

   /* ============================================================
   üü© B-BANK-FILTER-01 ‚Äî SHOW ONLY ACTIVE LOANS IN ACTIVE TABLE
   ============================================================ */

const activeLoans =
  loans.filter(
    l => Number(l.remaining || 0) > 0
  );

activeLoans.forEach(l=>{

    const tr =
      document.createElement("tr");

    const remaining =
      Number(l.remaining || 0);

    const status =
      remaining <= 0
      ? "PAID"
      : "ACTIVE";

    const statusColor =
      remaining <= 0
      ? "#00ff88"
      : "#4da3ff";

    const closed =
      remaining <= 0
      ? formatAviationDate(
          l.closedDate ||
          l.lastPaymentDate ||
          l.paidAt
        )
      : "‚Äî";

    const openDate =
  formatAviationDate(
    l.startTS ||
    l.startDate ||
    l.createdAt
  );

    tr.innerHTML = `

      <td>${l.id || "‚Äî"}</td>

      <td style="
        font-weight:600;
        color:${statusColor};
      ">
        ${status}
      </td>

      <td>${money(remaining)}</td>

      <td>
        ${Number(l.rate || 0).toFixed(2)}%
      </td>

      <td>${money(l.monthlyPayment)}</td>

      <td style="color:#8ab4ff">
        ${openDate}
      </td>

      <td style="color:#00ffd0">
        ${closed}
      </td>
    `;

    table.appendChild(tr);

  });

  /* ============================================================
     üü© B-AUTH-02 ‚Äî CALL AUTHORITY UPDATE (CORRECT LOCATION)
  ============================================================ */

  updateFinancialAuthority(s);

}
     
/* ============================================================
   INIT
   ============================================================ */

document.addEventListener(
  "DOMContentLoaded",
  loadBank
);

</script>

</body>
</html>
