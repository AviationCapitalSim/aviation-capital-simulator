<!-- ===========================================================
     === AIRPORT LIST (ASIA) ‚Äî AVIATION CAPITAL SIMULATOR ===
     Qatar Luxury Edition v3.1 ‚Äî FIX v2.0 (Historical Passenger Logic)
     =========================================================== -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asia Airports - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">
  <link rel="manifest" href="manifest.json">

  <style>
    /* COPIADO 100% DE AFRICA ‚Äî NO CAMBIAR
       Todo Qatar Luxury y la tabla completa ya est√° aqu√≠ */
  </style>
</head>

<body>

  <!-- HEADER -->
  <header class="acs-header">
    <div class="acs-logo">
      <img src="acs_logo.png" alt="ACS Logo" />
      <h1>Aviation Capital Simulator</h1>
    </div>

    <nav class="acs-nav">
      <a href="dashboard.html">Main</a>
      <a href="finance.html">Finance</a>
      <a href="aircraft.html">Aircraft</a>
      <a href="routes.html" class="active">Routes</a>
      <a href="hr.html">HR</a>
      <a href="forum.html">Forum</a>
      <a href="support.html">Support</a>
    </nav>

    <a href="#" class="logout-btn" onclick="handleLogout()">Logout</a>
    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 2025</div>
  </header>

  <!-- MAIN -->
  <main class="acs-main">
    <h2>üåç Asian Airports</h2>
    <p class="sub">Sort by demand or runway length. Click ‚ÄúCreate Route‚Äù.</p>

    <div class="origin-banner">
      <span class="icon">üõ´</span>
      <span class="label">Origin:</span>
      <span id="originFlag">üè≥Ô∏è</span>
      <strong id="originIcao">---</strong>
      <span id="originCity">‚Äî Loading...</span>
    </div>

    <!-- Country selector -->
    <div class="country-filter">
      <select id="countrySelect" class="country-select" onchange="filterByCountry()">
        <option value="ALL">üåç All Countries</option>
      </select>
    </div>

    <!-- TABLE -->
    <table id="airportTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Airport (ICAO)</th>
          <th onclick="sortTable(1)">Country</th>
          <th onclick="sortTable(2)">Distance (NM)</th>
          <th onclick="sortTable(3)">Demand (Y/C/F)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="airportTableBody"></tbody>
    </table>

    <button class="back-btn" onclick="window.location.href='routes.html'">‚¨Ö Back</button>

  </main>

  <footer>¬© 2025 Aviation Capital Simulator. All rights reserved.</footer>

  <!-- Tooltip -->
  <div id="demandTooltip"></div>

  <!-- MODAL -->
  <div id="airportInfoModal" class="acs-modal">
    <div class="acs-modal-box">
      <h3 id="modalTitle">Airport Info</h3>
      <div id="modalContent">Loading...</div>
      <button class="acs-modal-close" onclick="closeAirportInfo()">Close</button>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
    window.WorldAirportsACS = window.WorldAirportsACS || {};
  </script>

  <!-- Dataset ASIA -->
  <script src="engine/airports/world_airports_as.js"></script>

  <!-- Time Engine -->
  <script src="time_engine.js?v=1.2"></script>

  <!-- World + Loader -->
  <script src="engine/airports_loader.js"></script>
  <script src="engine/acs_world_engine.js"></script>


  <script>
/* ============================================================
   === DISTANCE ENGINE ========================================
   ============================================================ */
function distanceNM(lat1, lon1, lat2, lon2) {
  const R = 3440.065;
  const toRad = d => d * Math.PI/180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon/2)**2;

  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

/* ============================================================
   === ASIA SAFE LOADER =======================================
   ============================================================ */
function getAirportsAsiaSafe() {
  try {
    if (window.ACS_World &&
        ACS_World.ready &&
        ACS_World.BY_CONTINENT["Asia"] &&
        ACS_World.BY_CONTINENT["Asia"].length > 0) {

      console.log("üü¶ Using ACS_World (historical mode) ‚Äî Asia");
      return ACS_World.BY_CONTINENT["Asia"];
    }
  } catch (e) {
    console.warn("ACS_World failed:", e);
  }

  console.log("üüß Fallback ‚Üí Using WorldAirportsACS ‚Äî Asia");
  return WorldAirportsACS["Asia"] || [];
}

/* ============================================================
   === FIND BASE AIRPORT GLOBAL ===============================
   ============================================================ */
function findBaseAirportGlobal() {
  const baseIcao = localStorage.getItem("ACS_baseICAO");
  if (!baseIcao) return null;

  // World engine
  if (window.ACS_World &&
      ACS_World.ready &&
      ACS_World.INDEX_ICAO &&
      ACS_World.INDEX_ICAO[baseIcao]) return ACS_World.INDEX_ICAO[baseIcao];

  // Fallback
  for (const cont in WorldAirportsACS) {
    const ap = WorldAirportsACS[cont].find(a => a.icao === baseIcao);
    if (ap) return ap;
  }

  return null;
}

/* ============================================================
   === HISTORICAL CLASS ENGINE (igual √Åfrica) ==================
   ============================================================ */
function getHistoricalFactor(year) {
  if (year < 1940) return 0.05;
  if (year < 1950) return 0.10;
  if (year < 1958) return 0.25;
  if (year < 1965) return 0.45;
  if (year < 1975) return 0.60;
  if (year < 1990) return 0.80;
  return 1.00;
}

function adjustPassengerClasses(demand) {
  const year =
    window.ACS_TIME &&
    window.ACS_TIME.currentTime instanceof Date
      ? window.ACS_TIME.currentTime.getFullYear()
      : 1940;

  let Y = Math.round(demand.Y * getHistoricalFactor(year));
  let C = Math.round(demand.C * getHistoricalFactor(year));
  let F = Math.round(demand.F * getHistoricalFactor(year));

  if (year < 1955) { C = 0; F = 0; }
  else if (year < 1975) { F = 0; }

  return {Y,C,F};
}

/* ============================================================
   === LOAD AIRPORTS (ASIA) ===================================
   ============================================================ */
function loadAirports() {
  const tableBody = document.getElementById("airportTableBody");
  tableBody.innerHTML = "";

  const airports = getAirportsAsiaSafe();
  if (!airports || airports.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="5">No airports.</td></tr>`;
    return;
  }

  const userBase = localStorage.getItem("ACS_baseICAO");
  const baseAp = findBaseAirportGlobal();

  let baseLat = null, baseLon = null;
  if (baseAp) {
    baseLat = baseAp.latitude;
    baseLon = baseAp.longitude;
  }

  const ordered = airports
    .filter(a => a.icao !== userBase)
    .sort((a,b) => (b.demand.Y+b.demand.C+b.demand.F) - (a.demand.Y+a.demand.C+a.demand.F));

  const selector = document.getElementById("countrySelect");
  selector.innerHTML = `<option value="ALL">üåç All Countries</option>`;

  const uniqueCountries = [...new Set(ordered.map(a => a.region))].sort();
  uniqueCountries.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    selector.appendChild(opt);
  });

  ordered.forEach(a => {
    let dist = "-";
    if (baseLat !== null) dist = distanceNM(baseLat, baseLon, a.latitude, a.longitude);

    const d = adjustPassengerClasses(a.demand);
    const total = d.Y + d.C + d.F || 1;

    const ecoPct = (d.Y / total)*100;
    const bizPct = ((d.Y+d.C)/total)*100;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td><strong>${a.city}</strong>(${a.icao})</td>
      <td>${a.region}</td>
      <td>${dist} NM</td>

      <td onmouseover="showDemandTooltip(event,${d.Y},${d.C},${d.F})"
          onmouseout="hideDemandTooltip()">
        ${d.Y}/${d.C}/${d.F}
        <div class="demand-bar" style="--eco:${ecoPct}%;--biz:${bizPct}%"></div>
      </td>

      <td><button class="acs-btn" onclick="goToSchedule('${a.icao}')">
           Create Route</button></td>
    `;

    tableBody.appendChild(row);
  });
}

/* ============================================================
   === FILTER BY COUNTRY (ASIA) ================================
   ============================================================ */
function filterByCountry() {
  const selected  = document.getElementById("countrySelect").value;
  const tableBody = document.getElementById("airportTableBody");
  tableBody.innerHTML = "";

  const airports = getAirportsAsiaSafe();
  const userBase = localStorage.getItem("ACS_baseICAO");
  const base = findBaseAirportGlobal();

  let baseLat=null, baseLon=null;
  if (base) { baseLat=base.latitude; baseLon=base.longitude; }

  const filtered = airports
    .filter(a => a.icao !== userBase)
    .filter(a => selected==="ALL" || a.region===selected)
    .sort((a,b) => (b.demand.Y+b.demand.C+b.demand.F) -
                   (a.demand.Y+a.demand.C+a.demand.F));

  filtered.forEach(a => {
    let dist = "-";
    if (baseLat !== null)
      dist = distanceNM(baseLat, baseLon, a.latitude, a.longitude);

    const d = adjustPassengerClasses(a.demand);
    const total = d.Y+d.C+d.F||1;
    const ecoPct=(d.Y/total)*100;
    const bizPct=((d.Y+d.C)/total)*100;

    const row=document.createElement("tr");
    row.innerHTML=`
      <td><strong>${a.city}</strong>(${a.icao})</td>
      <td>${a.region}</td>
      <td>${dist} NM</td>

      <td onmouseover="showDemandTooltip(event,${d.Y},${d.C},${d.F})"
          onmouseout="hideDemandTooltip()">
        ${d.Y}/${d.C}/${d.F}
        <div class="demand-bar"
             style="--eco:${ecoPct}%;--biz:${bizPct}%"></div>
      </td>

      <td><button class="acs-btn" onclick="goToSchedule('${a.icao}')">
          Create Route</button></td>
    `;
    tableBody.appendChild(row);
  });
}

/* ============================================================
   === DEMAND TOOLTIP ==========================================
   ============================================================ */
function showDemandTooltip(e,Y,C,F){
  const total=Y+C+F||1;
  const ecoDeg=(Y/total)*360;
  const bizDeg=((Y+C)/total)*360;

  const tt=document.getElementById("demandTooltip");
  tt.innerHTML=`
    <strong style="color:#ffca3a;">Passenger Demand</strong>
    <div>Economy: ${Y}</div>
    <div>Business: ${C}</div>
    <div>First: ${F}</div>
    <div class="demand-pie"
      style="--eco:${ecoDeg}deg;--biz:${bizDeg}deg;">
      <div class="slice"></div>
    </div>
  `;
  tt.style.display="block";
  tt.style.left=e.pageX+15+"px";
  tt.style.top=e.pageY-60+"px";
}

function hideDemandTooltip(){
  document.getElementById("demandTooltip").style.display="none";
}

/* ============================================================
   === MODAL INFO (COPIADO DE AFRICA) ==========================
   ============================================================ */
function openAirportInfo(icao){
  const airports=getAirportsAsiaSafe();
  const ap=airports.find(a=>a.icao===icao);
  if(!ap)return;

  const modal=document.getElementById("airportInfoModal");
  const title=document.getElementById("modalTitle");
  const content=document.getElementById("modalContent");

  title.textContent=`${ap.city} (${ap.icao})`;

  content.innerHTML=`
    <div style="color:#ffca3a;font-weight:700;font-size:1.05rem;">üìç Location</div>
    <div><strong>Country:</strong> ${ap.country}</div>
    <div><strong>Region:</strong> ${ap.region}</div>
    <div><strong>Category:</strong> ${ap.category}</div>

    <hr>

    <div style="color:#ffca3a;font-weight:700;font-size:1.05rem;">üß≠ Coordinates</div>
    <div><strong>Lat:</strong> ${ap.latitude}</div>
    <div><strong>Lon:</strong> ${ap.longitude}</div>
    <div><strong>Elevation:</strong> ${ap.elevation_ft} ft</div>
    <div><strong>Runway:</strong> ${ap.runway_m} m</div>

    <hr>

    <div style="color:#ffca3a;font-weight:700;font-size:1.05rem;">üí∞ Costs</div>
    <div><strong>Slot:</strong> $${ap.slot_cost_usd}</div>
    <div><strong>Landing:</strong> $${ap.landing_fee_usd}</div>
    <div><strong>Fuel:</strong> $${ap.fuel_usd_gal>/gal}</div>
  `;

  modal.style.display="flex";
}

function closeAirportInfo(){
  document.getElementById("airportInfoModal").style.display="none";
}

window.addEventListener("click",(e)=>{
  const modal=document.getElementById("airportInfoModal");
  if(e.target===modal)modal.style.display="none";
});

/* ============================================================
   === INITIALIZATION ==========================================
   ============================================================ */
document.addEventListener("DOMContentLoaded", () => {

  updateGlobalBaseBanner();

  ensureBaseBeforeLoad(() => {
    loadAirports();
  });

});

/* ============================================================
   === ENSURE BASE BEFORE LOAD (NECESARIO) =====================
   ============================================================ */
function ensureBaseBeforeLoad(callback){
  const base=localStorage.getItem("ACS_baseICAO");

  if(!base){
    console.warn("‚ö† No base set");
    return setTimeout(()=>ensureBaseBeforeLoad(callback),60);
  }

  const ap=findBaseAirportGlobal();
  if(ap){
    callback();
  } else {
    setTimeout(()=>ensureBaseBeforeLoad(callback),60);
  }
}

/* ============================================================
   === REDIRECT ROUTE ==========================================
   ============================================================ */
function goToSchedule(destICAO) {
  const base = localStorage.getItem("ACS_baseICAO");
  if (!base) return alert("‚ö† Select a base first!");

  window.location.href = `schedule_table.html?from=${base}&to=${destICAO}`;
}
  </script>

</body>
</html>
