<!-- ============================================================
   ‚úàÔ∏è SKYTRACK ‚Äî QATAR LUXURY (DASHBOARD-ALIGNED)
   Project: Aviation Capital Simulator (ACS)
   Module: SkyTrack
   Version: v3.0 UI UNIFIED WITH DASHBOARD
   Date: 2026-01-02

   PURPOSE:
   - Usar EXACTAMENTE el mismo sistema visual que Dashboard
   - Cero CSS propio innecesario
   - SkyTrack se comporta como un m√≥dulo m√°s (Finance / HR / Alerts)
   ============================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACS SkyTrack - Aviation Capital Simulator</title>

  <!-- ======== ACS GLOBAL STYLE (MISMO QUE DASHBOARD) ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== FAVICONS ======== -->
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">

  <!-- ======== LEAFLET CSS (MAP) ======== -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
/* ============================================================
   ‚úÖ CORE DASHBOARD LAYOUT (COPIA REAL)
   ============================================================ */

body {
  margin: 0;
  background-color: #081530;
  color: white;
  font-family: "Poppins", sans-serif;
}

/* ===== HEADER (Dashboard exact behaviour) ===== */
.acs-header {
  position: fixed;
  top: 0;
  width: 100%;
  backdrop-filter: blur(9px);
  background: rgba(12,23,50,0.45);
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffb300;
  z-index: 5000;
}

.acs-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}
.acs-left img { height: 46px; }
.acs-left h1 {
  font-size: 1.15rem;
  margin: 0;
  color: #ffb300;
  letter-spacing: 0.5px;
}

.acs-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 2rem;
}

.acs-nav a {
  position: relative;
  font-size: 1rem;
  letter-spacing: 0.4px;
  color: #dbe4ff;
  text-decoration: none;
  transition: 0.25s ease;
  padding-bottom: 6px;
}

.acs-nav a:hover,
.acs-nav a.active {
  color: #ffca3a;
  text-shadow: 0 0 6px rgba(255,179,0,0.45);
}

.acs-nav a.active::after,
.acs-nav a:hover::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, #ffb300, #ffe7a0);
  border-radius: 2px;
  box-shadow: 0 0 8px rgba(255,200,60,0.45);
}

.acs-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.support-btn {
  background: rgba(255,179,0,0.12);
  border: 1px solid rgba(255,179,0,0.35);
  padding: 6px 12px;
  border-radius: 10px;
  color: #ffca3a;
  text-decoration: none;
  font-weight: 700;
}

.logout-btn {
  background: rgba(255,80,80,0.12);
  border: 1px solid rgba(255,80,80,0.35);
  padding: 6px 12px;
  border-radius: 10px;
  color: #ffbcbc;
  text-decoration: none;
  font-weight: 700;
  cursor: pointer;
}

.acs-clock-header {
  font-family: "Orbitron", sans-serif;
  color: #7CFFB2;
  text-shadow: 0 0 8px rgba(0,255,160,0.35);
  font-size: 0.95rem;
}

/* ===== MAIN (Fix ‚Äúdescudrado‚Äù) ===== */
.acs-main {
  padding-top: 110px; /* CR√çTICO: separa header fijo */
  width: min(1200px, 92%);
  margin: 0 auto;
}

/* ===== Panels (Dashboard feel) ===== */
.panel {
  background: linear-gradient(180deg, rgba(20,35,70,0.75), rgba(10,18,40,0.85));
  border: 1px solid rgba(255,179,0,0.22);
  border-radius: 18px;
  padding: 1.25rem;
  box-shadow: 0 0 22px rgba(0,0,0,0.35);
  margin-bottom: 1.4rem;
}

.panel h3 {
  margin-top: 0;
  color: #ffca3a;
  text-shadow: 0 0 10px rgba(255,200,60,0.35);
  letter-spacing: 0.4px;
}

.sub {
  color: #cbd6ff;
  text-align: center;
  margin-top: 0.4rem;
  margin-bottom: 1.2rem;
}

/* ===== Footer ===== */
.acs-footer {
  text-align: center;
  padding: 16px 0;
  color: rgba(255,255,255,0.65);
}

/* ============================================================
   ‚úÖ SKYTRACK MINIMAL LAYER (solo lo necesario)
   ============================================================ */

#skytrack-map {
  width: 100%;
  height: 460px;
  background: #020617;
  border-radius: 18px;
  overflow: hidden;
}

.skytrack-grid {
  display: grid;
  grid-template-columns: 360px 1fr;
  gap: 1.6rem;
}

.skytrack-list {
  max-height: 460px;
  overflow-y: auto;
}

.flight-card {
  background: rgba(255,255,255,0.04);
  padding: 0.9rem 1rem;
  border-radius: 16px;
  border: 1px solid rgba(255,179,0,0.18);
  margin-bottom: 0.8rem;
  cursor: pointer;
  transition: 0.25s;
}

.flight-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 22px rgba(255,179,0,0.20);
}

.flight-route { color: #ffb300; font-weight: 800; }
.flight-meta {
  font-size: 0.85rem;
  color: #cbd6ff;
  display: flex;
  justify-content: space-between;
  margin-top: 4px;
}

.badge {
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: 800;
}

.badge-ground { background: rgba(0,135,255,0.25); color:#9cc9ff; }
.badge-air    { background: rgba(0,255,160,0.25); color:#8fffd2; }
.badge-maint  { background: rgba(255,179,0,0.30); color:#ffe7a0; }

</style>

</head>
<body>

<!-- ============================================================
     HEADER ‚Äî EXACT COPY FROM DASHBOARD
     ============================================================ -->
<header class="acs-header">
  <div class="acs-left">
    <img src="acs_logo.png" alt="ACS Logo">
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="finance.html">Bank</a>
    <a href="aircraft.html" class="active">Aircraft</a>
    <a href="routes.html">Routes</a>
    <a href="hr.html">HR</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
    <div id="acs-clock" class="acs-clock-header">00:00 ‚Äî 01 JAN 1940</div>
  </div>
</header>

<!-- ============================================================
     MAIN CONTENT ‚Äî SKYTRACK AS DASHBOARD MODULE
     ============================================================ -->
<main class="acs-main">

  <h2 id="welcomeMessage">
    <span class="w-welcome">SKYTRACK</span>
    &nbsp;
    <span class="w-airline">Live World Traffic</span>
  </h2>

  <p class="sub">Real-time aircraft tracking based on your operational schedule.</p>

  <!-- ========================= MAP PANEL ========================= -->
  <div class="panel">
    <h3>üåç World Map</h3>
    <div id="skytrack-map"></div>
  </div>

  <!-- ========================= GRID ========================= -->
<div class="skytrack-grid">

  <!-- ===== LEFT: LIVE TRAFFIC ===== -->
  <div class="panel">
    <h3>‚úàÔ∏è Live Traffic</h3>

    <div class="skytrack-list" id="skytrackLiveList">
      <!-- Live traffic rendered by JS -->
    </div>
  </div>

  <!-- ===== RIGHT: DETAILS / FUTURE ===== -->
  <div class="panel">
    <h3>üìä Flight Details</h3>
    <p>Select a flight to view detailed information.</p>
  </div>

</div>

</main>

<footer class="acs-footer">
  ¬© 2026 Aviation Capital Simulator ‚Äî SkyTrack Module
</footer>

<!-- ============================================================
     CORE TIME ENGINE
     ============================================================ -->
<script src="time_engine.js"></script>

<!-- ============================================================
     WORLD CORE (DEBE IR ANTES DEL RUNTIME)
     ============================================================ -->
<script src="engine/acs_world_engine.js?v=1.0"></script>

<!-- ============================================================
     AIRPORT DATABASE (CONTINENTS)
     ============================================================ -->
<script src="engine/airports/world_airports_na.js?v=1.0"></script>
<script src="engine/airports/world_airports_sa.js?v=1.0"></script>
<script src="engine/airports/world_airports_eu.js?v=1.0"></script>
<script src="engine/airports/world_airports_me.js?v=1.0"></script>
<script src="engine/airports/world_airports_af.js?v=1.0"></script>
<script src="engine/airports/world_airports_as.js?v=1.0"></script>
<script src="engine/airports/world_airports_oc.js?v=1.0"></script>

<!-- ============================================================
     SKYTRACK RUNTIME (AL FINAL)
     ============================================================ -->
<script src="engine/acs_skytrack_runtime.js"></script>

<script src="engine/acs_flight_observer.js"></script>
   
<!-- ============================================================
     üó∫Ô∏è C1.1 ‚Äî LEAFLET MAP INIT (WORLD MAP)
     ============================================================ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const mapEl = document.getElementById("skytrack-map");
  if (!mapEl || typeof L === "undefined") return;

  if (window.ACS_SkyTrack_Map) return;

  const map = L.map("skytrack-map", {
    center: [20, 0],
    zoom: 2,
    zoomControl: true,
    attributionControl: false
  });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    opacity: 0.95
  }).addTo(map);

  setTimeout(() => map.invalidateSize(), 200);

  window.ACS_SkyTrack_Map = map;
});
</script>
   
<!-- ============================================================
     üü¶ 2.2.B-FIX ‚Äî BUILD ICAO AIRPORT INDEX (WAIT FOR DATA)
     (FIX REAL: WorldAirportsACS usa latitude/longitude, no lat/lng)
     ============================================================ -->
<script>
(function () {

  if (window.__ACS_AIRPORT_INDEX__) return;

  const t = setInterval(() => {

    if (
      window.WorldAirportsACS &&
      Object.keys(WorldAirportsACS).length &&
      Array.isArray(WorldAirportsACS[Object.keys(WorldAirportsACS)[0]])
    ) {
      clearInterval(t);

      const idx = {};

      Object.values(WorldAirportsACS).forEach(region => {
        if (!Array.isArray(region)) return;

        region.forEach(ap => {
          if (!ap || !ap.icao) return;

          // ‚úÖ Fuente real: latitude/longitude
          const lat = Number(ap.latitude);
          const lng = Number(ap.longitude);

          if (Number.isFinite(lat) && Number.isFinite(lng)) {
            // Alias de compatibilidad (para motores que esperan lat/lng)
            ap.lat = lat;
            ap.lng = lng;

            idx[ap.icao] = ap;
          }
        });
      });

      window.__ACS_AIRPORT_INDEX__ = idx;

      console.log(
        "üß≠ ICAO index built:",
        Object.keys(idx).length,
        "airports"
      );
    }

  }, 200);

})();
</script>
   
<!-- ============================================================
     üü¶ A3 ‚Äî SKYTRACK MARKER ENGINE (ATC FIXED)
     Solo visualiza ‚Äî NO calcula
============================================================ -->
<script>
(function () {

  function waitForMap(cb) {
    const t = setInterval(() => {
      if (window.ACS_SkyTrack_Map && window.__ACS_LAST_SKYTRACK_SNAPSHOT__) {
        clearInterval(t);
        cb();
      }
    }, 300);
  }

  waitForMap(() => {

    const map = window.ACS_SkyTrack_Map;
    const markers = {};
    const traces = {}; // aircraftId -> polyline
    let didCenter = false;
     
    // üü¶ A8.1 ‚Äî ACTIVE FLIGHT CONTEXT (FR24)
    window.ACS_ACTIVE_FLIGHT_ID = null;
     
    // üü¶ A7.1 ‚Äî LIVE TRACK PANEL RENDER (FR24)
const liveListEl = document.getElementById("skytrackLiveList");
     
// üü¶ A9.1 ‚Äî Flight Details Panel Element
const detailsEl = document.querySelector(".panel h3 + p")
  ? document.querySelector(".panel h3 + p").parentElement
  : null;
     
function renderLiveTrackPanel(snapshot) {
  if (!liveListEl || !Array.isArray(snapshot)) return;

  liveListEl.innerHTML = "";

  snapshot.forEach(item => {
    if (!item.flightNumber) return;

    const card = document.createElement("div");
card.className = "flight-card";

if (window.ACS_ACTIVE_FLIGHT_ID === item.aircraftId) {
  card.style.borderColor = "#ffca3a";
  card.style.boxShadow = "0 0 18px rgba(255,202,58,0.55)";
}

card.addEventListener("click", () => {
  window.ACS_ACTIVE_FLIGHT_ID = item.aircraftId;

  const pos = resolvePosition(item);
  if (pos) {
    map.flyTo(pos, Math.max(map.getZoom(), 6), { animate: true });
  }
});

    const stateClass =
      item.state === "EN_ROUTE" ? "badge-air" :
      item.state === "GROUND" ? "badge-ground" :
      "badge-maint";

    let extra = "";
    const now = window.ACS_TIME?.absMin;

    if (
  item.state === "EN_ROUTE" &&
  now != null &&
  Number.isFinite(item.depAbsMin) &&
  Number.isFinite(item.arrAbsMin)
) {
  const total = Math.max(1, item.arrAbsMin - item.depAbsMin);
  const remaining = Math.max(0, item.arrAbsMin - now);
  const done = Math.max(0, total - remaining);

  const pctDone = Math.round((done / total) * 100);

  const hh = String(Math.floor(remaining / 60)).padStart(2, "0");
  const mm = String(remaining % 60).padStart(2, "0");

  extra = `
    <div><strong>${pctDone}%</strong> PROGRESS</div>
    <div><strong>TIME REMAINING:</strong> ${hh}:${mm}</div>
  `;
}

    card.innerHTML = `
      <div class="flight-route">
        ${item.originICAO} ‚Üí ${item.destinationICAO}
      </div>
      <div class="flight-meta">
        <span>${item.flightNumber}</span>
        <span class="badge ${stateClass}">${item.state}</span>
      </div>
      ${extra}
    `;

    liveListEl.appendChild(card);
  });
}
     
    // üîµ ATC MARKER ‚Äî SMALL
    const atcIcon = L.divIcon({
      className: "acs-atc-aircraft",
      html: `<div style="
        width:8px;
        height:8px;
        background:#0b3cff;
        border:1px solid #001a66;
        border-radius:2px;
        box-shadow:0 0 4px rgba(0,0,0,.6);
      "></div>`,
      iconSize: [18, 18],
      iconAnchor: [9, 9]
    });

/* ============================================================
   üü¶ A9.4.2 ‚Äî RESOLVE DEP/ARR FROM RUNTIME (NO snapshot times)
   Fuente: window.ACS_SkyTrack.itemsByAircraft (Schedule Table expanded)
   ============================================================ */

function ACS_ST_toHHMM(absMin) {
  if (!Number.isFinite(absMin)) return "‚Äî";
  const m = ((absMin % 1440) + 1440) % 1440;
  const hh = String(Math.floor(m / 60)).padStart(2, "0");
  const mm = String(m % 60).padStart(2, "0");
  return `${hh}:${mm}`;
}

function ACS_ST_nowAbsMin() {
  // runtime normaliza a semana (0..10079). Mantenemos igual.
  if (Number.isFinite(window.ACS_SkyTrack?.nowAbsMin)) return window.ACS_SkyTrack.nowAbsMin;
  if (Number.isFinite(window.ACS_TIME?.absMin)) return (window.ACS_TIME.absMin % 10080);
  if (Number.isFinite(window.ACS_TIME?.minute)) return (window.ACS_TIME.minute % 10080);
  return null;
}

function ACS_ST_resolveTimesFromRuntime(snapshotItem) {
  const acId = snapshotItem?.aircraftId;
  if (!acId) return null;

  const now = ACS_ST_nowAbsMin();
  const items = window.ACS_SkyTrack?.itemsByAircraft?.[acId];
  if (!Array.isArray(items) || now == null) return null;

  const flights = items.filter(it => it && it.type === "flight" && Number.isFinite(it.depAbsMin) && Number.isFinite(it.arrAbsMin));
  if (!flights.length) return null;

  // 1) Si est√° EN_ROUTE, buscamos el vuelo activo por ventana de tiempo
  if (snapshotItem.state === "EN_ROUTE") {
    const active = flights.find(f =>
      now >= f.depAbsMin && now < f.arrAbsMin &&
      (!snapshotItem.flightNumber || f.flightNumber === snapshotItem.flightNumber)
    );
    if (active) return active;
  }

  // 2) Si est√° en GROUND: contexto FR24 (pr√≥ximo si existe; si no, √∫ltimo)
  const future = flights
    .filter(f => f.depAbsMin > now)
    .sort((a, b) => a.depAbsMin - b.depAbsMin)[0];

  if (future) return future;

  const past = flights
    .filter(f => f.arrAbsMin < now)
    .sort((a, b) => b.arrAbsMin - a.arrAbsMin)[0];

  return past || null;
}
        
// üü¶ A9.2 ‚Äî Render Flight Details (FR24)
     
function renderFlightDetails(snapshot) {
  if (!detailsEl) return;

  const id = window.ACS_ACTIVE_FLIGHT_ID;
  if (!id) {
    detailsEl.innerHTML = `
      <h3>üìä Flight Details</h3>
      <p>Select a flight to view detailed information.</p>
    `;
    return;
  }

  const item = (snapshot || []).find(f => f.aircraftId === id);
  if (!item) return;

  // ‚úÖ DEP/ARR desde runtime (NO snapshot)
  const rt = ACS_ST_resolveTimesFromRuntime(item);

  const depAbs = rt?.depAbsMin;
  const arrAbs = rt?.arrAbsMin;

  const depTime = ACS_ST_toHHMM(depAbs);
  const arrTime = ACS_ST_toHHMM(arrAbs);

  // Aircraft + matr√≠cula (registration)
  const aircraftLabel = `${item.model || "‚Äî"} (${item.registration || "‚Äî"})`;

  // Extra EN_ROUTE: % + remaining
  const now = ACS_ST_nowAbsMin();
  let extra = "";

  if (
    item.state === "EN_ROUTE" &&
    Number.isFinite(now) &&
    Number.isFinite(depAbs) &&
    Number.isFinite(arrAbs) &&
    arrAbs > depAbs
  ) {
    const total = (arrAbs - depAbs);
    const remaining = Math.max(0, arrAbs - now);
    const done = Math.max(0, total - remaining);
    const pct = Math.max(0, Math.min(100, Math.round((done / total) * 100)));

    const hh = String(Math.floor(remaining / 60)).padStart(2, "0");
    const mm = String(remaining % 60).padStart(2, "0");

    extra = `
      <div style="margin-top:8px;">
        <strong>Progress:</strong> ${pct}%<br>
        <strong>Time Remaining:</strong> ${hh}:${mm}
      </div>
    `;
  }

  detailsEl.innerHTML = `
    <h3>üìä Flight Details</h3>
    <div style="font-size:0.95rem; line-height:1.5;">
      <strong>Flight:</strong> ${item.flightNumber || "‚Äî"}<br>
      <strong>Route:</strong> ${(item.originICAO || "‚Äî")} ‚Üí ${(item.destinationICAO || "‚Äî")}<br>
      <strong>Aircraft:</strong> ${aircraftLabel}<br>
      <strong>Status:</strong> ${item.state || "‚Äî"}<br>
      <strong>Departure:</strong> ${depTime}<br>
      <strong>Arrival:</strong> ${arrTime}
      ${extra}
    </div>
  `;
}
     
    function apLatLng(icao) {
      const ap = window.ACS_AIRPORT_INDEX?.[icao];
      if (!ap) return null;
      const lat = Number(ap.latitude);
      const lng = Number(ap.longitude);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
      return [lat, lng];
    }

    function centerMapOnce(snapshot) {
      if (didCenter) return;
      const baseICAO = localStorage.getItem("ACS_baseICAO");
      const ll = baseICAO ? apLatLng(baseICAO) : null;
      if (ll) {
        map.setView(ll, 6, { animate:false });
        didCenter = true;
      }
    }

    function resolvePosition(item) {

      if (item.state === "EN_ROUTE" && item.position?.progress != null) {
        const o = window.ACS_AIRPORT_INDEX[item.originICAO];
        const d = window.ACS_AIRPORT_INDEX[item.destinationICAO];
        if (!o || !d) return null;

        const p = Math.max(0, Math.min(1, item.position.progress));
        return [
          o.latitude + (d.latitude - o.latitude) * p,
          o.longitude + (d.longitude - o.longitude) * p
        ];
      }

      if (item.position?.airport) {
        const ap = window.ACS_AIRPORT_INDEX[item.position.airport];
        if (!ap) return null;
        return [ap.latitude, ap.longitude];
      }

      return null;
    }

    function buildATCContent(item) {
      const reg =
        item.registration ||
        item.tail ||
        item.callsign ||
        "";
       
      const model =
        item.aircraft ||
        item.aircraftModel ||
        item.aircraftType ||
        item.model ||
        item.modelKey ||
       "";
       
      let extra = "";
      const now = window.ACS_TIME?.absMin;

      if (
        item.state === "EN_ROUTE" &&
        now != null &&
        item.depAbs != null &&
        item.arrAbs != null
      ) {
        const total = item.arrAbs - item.depAbs;
        const remaining = Math.max(0, item.arrAbs - now);
        const pct = Math.round((remaining / total) * 100);

        const hh = String(Math.floor(remaining / 60)).padStart(2, "0");
        const mm = String(remaining % 60).padStart(2, "0");

        extra = `
          <div><strong>${pct}%</strong> FLIGHT REMAINING</div>
          <div><strong>TIME REMAINING:</strong> ${hh}:${mm}</div>
        `;
      }

      return `
        <div style="font-size:12px; line-height:1.3;">
          <strong>${model} ${reg}</strong><br>
          <strong>${item.flightNumber}</strong><br>
          ${item.originICAO} ‚Üí ${item.destinationICAO}<br>
          <strong>${item.state}</strong>
          ${extra}
        </div>
      `;
    }
     
    // üü¶ A6.5 ‚Äî MONOTONIC SNAPSHOT GUARD (per aircraft)
    const lastSeenSnapshot = {}; // aircraftId -> last logical time
     
    function render(snapshot) {

    // üü¶ A7.2 ‚Äî Update Live Track Panel
    renderLiveTrackPanel(snapshot);
       
   // üü¶ A9.3 ‚Äî Update Flight Details Panel
    renderFlightDetails(snapshot);

      if (!Array.isArray(snapshot)) return;

      centerMapOnce(snapshot);

      snapshot.forEach(item => {

  // üü¶ A6.5.1 ‚Äî IGNORE OUT-OF-ORDER SNAPSHOTS
  const key = item.aircraftId;
  const logicalTime =
    Number.isFinite(item.depAbsMin) ? item.depAbsMin :
    Number.isFinite(item.arrAbsMin) ? item.arrAbsMin : 0;

  if (lastSeenSnapshot[key] != null && logicalTime < lastSeenSnapshot[key]) {
    return; // ‚õî ignore older snapshot
  }

  lastSeenSnapshot[key] = logicalTime;

  // üü¶ A6.4.1 ‚Äî STATE-AWARE POSITION (NO mixed states)
  let pos = null;

  if (item.state === "EN_ROUTE") {
    pos = resolvePosition(item);
  } else if (item.position?.airport) {
    pos = resolvePosition(item);
  }

  if (!pos) return;

  let m = markers[item.aircraftId];

  if (!m) {
    m = L.marker(pos, { icon: atcIcon }).addTo(map);
    markers[item.aircraftId] = m;

// üü¶ A6.4.2 ‚Äî Persistent ATC Popup (bind once)
     m.bindPopup("", {
     autoClose: false,
     closeOnClick: false
   });

     m.on("click", () => {
  window.ACS_ACTIVE_FLIGHT_ID = item.aircraftId;
  m.setPopupContent(buildATCContent(item));
  m.openPopup();
});

        } else {
          // üîÅ Reset trace if flight leg changed
         if (
          item.flightNumber &&
          traces[item.aircraftId] &&
          traces[item.aircraftId].__lastFlight !== item.flightNumber
        ) {
         if (map.hasLayer(traces[item.aircraftId])) {
          map.removeLayer(traces[item.aircraftId]);
        }
          delete traces[item.aircraftId];
        }

           m.setLatLng(pos);

       // üü¶ A8.4 ‚Äî Highlight active aircraft
       if (window.ACS_ACTIVE_FLIGHT_ID === item.aircraftId) {
       m.setZIndexOffset(1000);
       } else {
       m.setZIndexOffset(0);
      }
     
           // üü¶ ATC TRACE ‚Äî only when airborne
          if (item.state === "EN_ROUTE") {

          if (!traces[item.aircraftId]) {
          traces[item.aircraftId] = L.polyline([pos], {
          color: "#0b3cff",
          weight: 2,
          opacity: 0.85
          }).addTo(map);

          traces[item.aircraftId].__lastFlight = item.flightNumber;
        } else {
         traces[item.aircraftId].addLatLng(pos);
        }
      }
          if (m.isPopupOpen()) {
            m.setPopupContent(buildATCContent(item));
          }
        }
      });
    }

    render(window.__ACS_LAST_SKYTRACK_SNAPSHOT__);

    window.addEventListener("ACS_SKYTRACK_SNAPSHOT", e => {
      render(e.detail);
    });

    console.log("üü¶ A3 FIXED ‚Äî ATC marker + live popup");

  });

})();
</script>

<script>
function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}
</script>

</body>
</html>
