<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACS SkyTrack - Aviation Capital Simulator</title>

   <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  

   <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">  
  

  <style>
    /* === SKYTRACK LOCAL STYLES (ACS Clean 2) === */
    body {
      background:#081530;
      color:white;
      font-family:"Segoe UI",sans-serif;
      margin:0;
    }

    h2 {
      color:#FFB300;
      margin-top:6rem; /* ‚úÖ header fijo */
      text-align:center;
    }
    .sub { text-align:center; color:#ccc; margin-bottom:1rem; }

    #map {
      height:85vh;
      width:90%;
      border-radius:12px;
      border:1px solid rgba(255,179,0,0.3);
      box-shadow:0 4px 16px rgba(0,0,0,0.4);
      margin:1.5rem auto;
    }

    .flight-info {
      color:#ddd;
      text-align:center;
      font-size:0.95rem;
      margin-top:0.3rem;
    }

    .leaflet-control-attribution { color:#888 !important; }

    /* === Radar Marker Styles === */
    .acs-diamond {
      background:#0096FF;
      width:10px;
      height:10px;
      transform:rotate(45deg);
      border:1px solid white;
      border-radius:2px;
    }
    .acs-label {
      position:absolute;
      top:-4px;
      left:14px;
      font-size:11px;
      font-family:'Orbitron',monospace;
      color:#000;
      text-shadow:0 0 2px #fff;
      white-space:nowrap;
      font-weight:600;
    }

    footer {
      text-align:center;
      color:#999;
      font-size:0.9rem;
      padding:1rem;
    }

    /* ‚úÖ Reloj cockpit Airbus */
    .acs-clock-header {
      font-family:'Orbitron','Consolas',monospace;
      color:#00ff80;
      font-weight:bold;
      background:rgba(0,255,128,0.08);
      padding:0.3rem 0.8rem;
      border-radius:6px;
      font-size:0.9rem;
      margin-left:1rem;
    }
    
.atc-marker {
  position: relative;
}

/* üü¶ Radar square */
.atc-box {
  width: 9px;
  height: 9px;
  background: #0b2a4a;           /* azul marino */
  border: 1px solid #4da3ff;     /* borde radar */
  box-sizing: border-box;
  box-shadow: 0 0 4px rgba(77,163,255,0.6);
}

/* üî¢ Flight number */
.atc-label {
  position: absolute;
  top: -14px;
  left: 12px;
  font-size: 11px;
  font-weight: 600;
  color: #111;                   /* negro/gris oscuro */
  background: rgba(255,255,255,0.85);
  padding: 1px 4px;
  border-radius: 3px;
  white-space: nowrap;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  box-shadow: 0 1px 3px rgba(0,0,0,0.35);
}

</style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <header class="acs-header">
    <div class="acs-logo">
      <img src="acs_logo.png" alt="ACS Logo" />
      <h1>Aviation Capital Simulator</h1>
    </div>

    <nav class="acs-nav">
      <a href="dashboard.html">Main</a>
      <a href="aircraft.html">Aircraft</a>
      <a href="routes.html">Routes</a>
      <a href="skytrack.html" class="active">SkyTrack</a>
      <a href="hr.html">HR</a>
      <a href="forum.html">Forum</a>
      <a href="support.html">Support</a>
    </nav>

    <div class="acs-auth">
      <a href="#" class="logout-btn" onclick="handleLogout()">Logout</a>
    </div>
    
  
    
    <!-- ‚úÖ Reloj cockpit Airbus -->
    
    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 2025</div>
  </header>

  <!-- ===== MAIN ===== -->
  <main class="acs-main">
    <h2>ACS SkyTrack ‚Äî Live Fleet View</h2>
    <p class="sub">Active flight tracking for your airline.</p>
    
    <!-- ‚úÖ SKYTRACK MAP CONTAINER -->
    <div id="map"></div>
    <div class="flight-info" id="flightStatus">Waiting for active flight‚Ä¶</div>
  </main>

  <!-- ===== FOOTER ===== -->
  <footer>¬© 2025 Aviation Capital Simulator. All rights reserved.</footer>

    
<!-- ============================================================
     ‚è± TIME ENGINE
     ============================================================ -->
<script src="time_engine.js"></script>

<script>
/* ============================================================
   üüß A8 ‚Äî SKYTRACK TIME BRIDGE (SAFE)
   ------------------------------------------------------------
   Garantiza que ACS_TIME.currentTime exista para Runtime
   NO crea motor nuevo
   NO altera el Global Time Engine
   SOLO expone currentTime si falta
   ============================================================ */
  
(function () {

  if (!window.ACS_TIME) return;

  // Si ya existe currentTime v√°lido, no tocar
  if (window.ACS_TIME.currentTime instanceof Date) return;

  // Crear currentTime derivado del reloj visual
  try {
    const clockEl = document.getElementById("acs-clock");
    if (!clockEl) return;

    // Fallback seguro: usar Date actual UTC
    window.ACS_TIME.currentTime = new Date();
    console.warn("‚ö† SkyTrack: ACS_TIME.currentTime bridged from Date()");
  } catch (e) {
    console.warn("SkyTrack time bridge failed", e);
  }

})();
</script>

<!-- ============================================================
     üåç WORLD ENGINE (CONTENEDOR)
     ============================================================ -->
<script src="engine/acs_world_engine.js?v=1.0"></script>

<!-- ============================================================
     üåç WORLD AIRPORT DATA (POR CONTINENTE)
     ============================================================ -->
<script src="engine/airports/world_airports_na.js?v=1.0"></script>
<script src="engine/airports/world_airports_sa.js?v=1.0"></script>
<script src="engine/airports/world_airports_eu.js?v=1.0"></script>
<script src="engine/airports/world_airports_me.js?v=1.0"></script>
<script src="engine/airports/world_airports_af.js?v=1.0"></script>
<script src="engine/airports/world_airports_as.js?v=1.0"></script>
<script src="engine/airports/world_airports_oc.js?v=1.0"></script>

<!-- ============================================================
     üß≠ SKYTRACK AIRPORT ADAPTER (LIGERO, ICAO ‚Üí COORDS)
     ============================================================ -->
<script src="engine/skytrack/skytrack_airport_adapter.js?v=1.0"></script>

<!-- ============================================================
     ‚úàÔ∏è FLIGHT RUNTIME (LIVE FLIGHTS)
     ============================================================ -->
<script src="engine/acs_flight_runtime.js"></script>
  
<script>
  
/* ============================================================
   ‚è± SKYTRACK ‚Äî RESUME GLOBAL TIME ENGINE
   ============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  try {
    const savedClock = localStorage.getItem("ACS_CLOCK_STATE");
    if (savedClock) {
      const clockEl = document.getElementById("acs-clock");
      if (clockEl) {
        clockEl.innerText = savedClock;
      }
    }
  } catch (e) {
    console.warn("SkyTrack clock resume failed", e);
  }
});
</script>
  
 <script>
  
/* ============================================================
   üß≠ SKYTRACK ‚Äî BASE RESOLVER (SAME AS DASHBOARD)
   ============================================================ */
    
function resolveACSBase() {

  let activeUser = JSON.parse(localStorage.getItem("ACS_activeUser") || "{}");
  let base = activeUser.base || {};

  const clean = v => (!v || v === "undefined") ? "" : v;

  base.icao    = clean(base.icao);
  base.city    = clean(base.city);
  base.country = clean(base.country);
  base.name    = clean(base.name);

  // üîÅ Fallback legacy (7 continent HTMLs)
  if (!base.icao) {
    base.icao    = clean(localStorage.getItem("ACS_baseICAO"));
    base.city    = clean(localStorage.getItem("ACS_baseCity"));
    base.country = clean(localStorage.getItem("ACS_baseCountry"));
    base.name    = clean(localStorage.getItem("ACS_baseName"));
  }

  if (!base.icao) return null;

  // üîí Normalizar y persistir (igual que dashboard)
  activeUser.base = {
    icao: base.icao.toUpperCase(),
    city: base.city,
    country: base.country,
    name: base.name
  };

  localStorage.setItem("ACS_activeUser", JSON.stringify(activeUser));

  return activeUser.base;
}
   
/* ============================================================
   üåç GREAT CIRCLE INTERPOLATION (SKYTRACK LOCAL)
   ============================================================ */

function interpolateGC(lat1, lon1, lat2, lon2, t) {
  const toRad = d => d * Math.PI / 180;
  const toDeg = r => r * 180 / Math.PI;

  const œÜ1 = toRad(lat1);
  const Œª1 = toRad(lon1);
  const œÜ2 = toRad(lat2);
  const Œª2 = toRad(lon2);

  const sinœÜ1 = Math.sin(œÜ1), cosœÜ1 = Math.cos(œÜ1);
  const sinœÜ2 = Math.sin(œÜ2), cosœÜ2 = Math.cos(œÜ2);

  const ŒîŒª = Œª2 - Œª1;

  const a = Math.sin((œÜ2 - œÜ1) / 2) ** 2 +
            cosœÜ1 * cosœÜ2 * Math.sin(ŒîŒª / 2) ** 2;

  const Œ¥ = 2 * Math.asin(Math.min(1, Math.sqrt(a)));

  if (Œ¥ === 0) {
    return { lat: lat1, lng: lon1 };
  }

  const A = Math.sin((1 - t) * Œ¥) / Math.sin(Œ¥);
  const B = Math.sin(t * Œ¥) / Math.sin(Œ¥);

  const x = A * cosœÜ1 * Math.cos(Œª1) + B * cosœÜ2 * Math.cos(Œª2);
  const y = A * cosœÜ1 * Math.sin(Œª1) + B * cosœÜ2 * Math.sin(Œª2);
  const z = A * sinœÜ1 + B * sinœÜ2;

  const œÜi = Math.atan2(z, Math.sqrt(x * x + y * y));
  const Œªi = Math.atan2(y, x);

  return {
    lat: toDeg(œÜi),
    lng: toDeg(Œªi)
  };
}
   
/* ============================================================
   üõ∞ SKYTRACK ‚Äî MAP INIT + RENDER ACTIVE FLIGHT (SINGLE SOURCE)
   ============================================================ */

let map = null;
let planeMarker = null;   // (se mantiene aunque ya no se use)
let flightTrace = null;   // (se mantiene aunque ya no se use)

/* ============================================================
   üõ∞ SKYTRACK ‚Äî MAP INIT (CENTERED AT BASE)
   ============================================================ */
    
function initSkyTrackMap() {
  if (map) return; // ‚úÖ prevent double init

  // üîπ fallback seguro
  let centerLat = 33.0;
  let centerLng = 68.0;
  let zoom = 5;

  const base = resolveACSBase();

  // üîí Intento 1: centrar inmediatamente si ya est√° todo cargado
  if (base?.icao && window.WorldAirportsACS) {
    const baseAirport = Object.values(WorldAirportsACS).flat()
      .find(a => a.icao === base.icao);

    if (baseAirport && typeof baseAirport.latitude === "number" && typeof baseAirport.longitude === "number") {
      centerLat = baseAirport.latitude;
      centerLng = baseAirport.longitude;
      zoom = 6;
    }
  }

  // üîπ Init map
  map = L.map("map").setView([centerLat, centerLng], zoom);
  window.ACS_SKYTRACK_MAP = map;
  
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 10,
    attribution: "&copy; OpenStreetMap ‚Äî ACS SkyTrack",
  }).addTo(map);

  flightTrace = L.polyline([], {
    weight: 2.2,
    opacity: 0.85,
  }).addTo(map);

  // ============================================================
  // üß≠ AJUSTE CLAVE ‚Äî RECENTRAR EN BASE CUANDO TODO EST√â LISTO
  // ============================================================

  setTimeout(() => {
    if (!map) return;

    const baseLater = resolveACSBase();
    if (!baseLater?.icao || !window.WorldAirportsACS) return;

    const baseAirportLater = Object.values(WorldAirportsACS).flat()
      .find(a => a.icao === baseLater.icao);

    if (!baseAirportLater ||
        typeof baseAirportLater.latitude !== "number" ||
        typeof baseAirportLater.longitude !== "number") return;

    map.setView(
      [baseAirportLater.latitude, baseAirportLater.longitude],
      6
    );

    console.log("üß≠ SkyTrack centered at base:", baseLater.icao);

  }, 300); // üîπ delay corto, seguro, no bloqueante
}
   
// ============================================================
// ‚úàÔ∏è SKYTRACK VISUAL LAYERS
// ============================================================

const liveFlightMarkers = {};
const liveFlightTraces  = {};
const liveFlightPlans   = {};

/* ============================================================
   üüß FIX FINAL ‚Äî SYNC ACS_LIVE_FLIGHTS
   ============================================================ */
   
function syncLiveFlights() {
  if (!Array.isArray(window.ACS_LIVE_FLIGHTS)) {
    try {
      const raw = localStorage.getItem("ACS_LIVE_FLIGHTS");
      if (raw) {
        window.ACS_LIVE_FLIGHTS = JSON.parse(raw);
      } else {
        window.ACS_LIVE_FLIGHTS = [];
      }
    } catch (e) {
      window.ACS_LIVE_FLIGHTS = [];
    }
  }
}
   
// ============================================================
// üü¶ SKYTRACK ‚Äî MARKER ICON (FR24 STYLE)
// ============================================================
function createATCMarkerIcon(f) {
  const color =
    f.status === "air" ? "#1e88e5" :
    f.status === "ground" ? "#455a64" :
    "#2e7d32";

  return L.divIcon({
    className: "atc-marker",
    html: `
      <div class="atc-box"></div>
      <div class="atc-label">${f.flightOut || f.aircraftId || ""}</div>
    `,
    iconSize: [18, 18],
    iconAnchor: [9, 9]
  });
}

function renderLiveFlights() {

  if (!map) return;

  let flights = [];
  try {
    const raw = localStorage.getItem("ACS_LIVE_FLIGHTS");
    flights = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(flights)) flights = [];
  } catch {
    flights = [];
  }

  let nowMin = 0;
  try {
    const t = JSON.parse(
      localStorage.getItem("ACS_TIME") ||
      localStorage.getItem("ACS_TIME_STATE") ||
      "{}"
    );
    if (typeof t.minute === "number") nowMin = t.minute % 1440;
  } catch {}

  const activeIds = new Set();

  // ============================================================
  // üîÅ RENDER EACH FLIGHT  (TODO VA DENTRO DEL LOOP)
  // ============================================================
  flights.forEach(f => {
    if (!f || typeof f.lat !== "number" || typeof f.lng !== "number") return;

    const id = String(f.aircraftId || "");
    if (!id) return;

    activeIds.add(id);

    // üü¶ MARKER
if (!liveFlightMarkers[id]) {
  liveFlightMarkers[id] = L.marker(
    [f.lat, f.lng],
    { icon: createATCMarkerIcon(f) }
  ).addTo(map);
}

// ‚úàÔ∏è MOVIMIENTO SIEMPRE (CLAVE)
liveFlightMarkers[id].setLatLng([f.lat, f.lng]);

// üß≠ TRACE (solo en vuelo)
if (f.status === "air") {

  if (!liveFlightTraces[id]) {
    liveFlightTraces[id] = L.polyline([], {
      color: "#1e88e5",
      weight: 2,
      opacity: 0.9
    }).addTo(map);
  }
  liveFlightTraces[id].addLatLng([f.lat, f.lng]);
}

    // üßæ POPUP
    const percent = Math.round((f.progress || 0) * 100);
    const remainingMin = Math.max(0, (f.arrMin || 0) - nowMin);

    const popup = `
<strong>${f.flightOut || id}</strong><br>
${f.origin} ‚Üí ${f.destination}<br>
${f.status}<br>
${percent}%
`.trim();

    liveFlightMarkers[id].bindPopup(popup);
  });

  // ============================================================
  // üßπ CLEANUP ‚Äî REMOVE NOT ACTIVE
  // ============================================================
  Object.keys(liveFlightMarkers).forEach(id => {
    if (!activeIds.has(id)) {
      map.removeLayer(liveFlightMarkers[id]);
      delete liveFlightMarkers[id];

      if (liveFlightTraces[id]) {
        map.removeLayer(liveFlightTraces[id]);
        delete liveFlightTraces[id];
      }
    }
  });
}

/* ============================================================
   ‚è± SKYTRACK ‚Äî INIT + TIME SYNC
   ============================================================ */
   
  document.addEventListener("DOMContentLoaded", () => {
  initSkyTrackMap();

  if (typeof registerTimeListener === "function") {
    registerTimeListener(renderLiveFlights);
  }
});

/* ============================================================
   üß≠ SKYTRACK ‚Äî GET BASE (ACS OFFICIAL)
   ============================================================ */
   
function getACSBase(){
  try {
    const user = JSON.parse(localStorage.getItem("ACS_activeUser") || "null");
    return user?.base || null;
  } catch {
    return null;
  }
}

/* ============================================================
   üß≠ SKYTRACK ‚Äî CENTER MAP AT BASE (SAFE)
   ============================================================ */
   
function centerMapAtBase(){
  if (!map) return;

  const base = getACSBase();
  if (!base || !base.icao) return;

  // WorldAirportsACS debe estar cargado
  if (!window.WorldAirportsACS) {
    console.warn("‚ö† WorldAirportsACS not loaded yet ‚Äî cannot center at base");
    return;
  }

  const baseAirport = Object.values(WorldAirportsACS).flat()
    .find(a => a.icao === base.icao);

  if (!baseAirport || typeof baseAirport.latitude !== "number" || typeof baseAirport.longitude !== "number") {
    console.warn("‚ö† Base airport not found in WorldAirportsACS:", base.icao);
    return;
  }

  map.setView([baseAirport.latitude, baseAirport.longitude], 6);
  console.log("üß≠ SkyTrack centered at base:", base.icao);
}

    
function renderActiveFlight() {
  try {
    const execRaw = localStorage.getItem("ACS_FLIGHT_EXEC");
    if (!execRaw) {
      const st = document.getElementById("flightStatus");
      if (st) st.textContent = "üõ∞ No active flight (ACS_FLIGHT_EXEC not found).";
      return;
    }

    const exec = JSON.parse(execRaw);
    if (exec.currentLat == null || exec.currentLng == null) return;

    // ‚úÖ create marker once
    if (!planeMarker) {
      const icon = L.divIcon({
        html: `
          <div class="acs-diamond"></div>
          <div class="acs-label">${exec.aircraftId || "AC"}</div>
        `,
        className: "acs-plane",
        iconSize: [20, 20],
        iconAnchor: [10, 10],
      });

      planeMarker = L.marker([exec.currentLat, exec.currentLng], { icon }).addTo(map);
    }

    planeMarker.setLatLng([exec.currentLat, exec.currentLng]);
    if (flightTrace) flightTrace.addLatLng([exec.currentLat, exec.currentLng]);

    // ‚úÖ status line
    const st = document.getElementById("flightStatus");
    if (st) {
      st.textContent = `‚úÖ Tracking: ${exec.aircraftId || "AC"} ‚Äî ${exec.currentLat.toFixed(3)}, ${exec.currentLng.toFixed(3)}`;
    }
  } catch (e) {
    console.error("SkyTrack renderActiveFlight error:", e);
  }
}

function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}
</script>
    
<script>
/* ============================================================
   ‚è± SKYTRACK TIME LISTENER
   ============================================================ */

if (typeof registerTimeListener === "function") {
  registerTimeListener(() => {
  renderActiveFlight();
});
}

/* ============================================================
   üïê Reloj cockpit Airbus sincronizado con ACS
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {
  if (typeof registerTimeListener === "function") {
    registerTimeListener(updateClockDisplay);
    updateClockDisplay();
  }
});

/* ============================================================
   üõ∞ READ ACTIVE FLIGHT FROM SCHEDULE
   ============================================================ */

const activeFlightRaw = localStorage.getItem("ACS_ACTIVE_FLIGHT");

if (!activeFlightRaw) {
  console.log("üõ∞ SkyTrack: No active flight");
} else {
  const activeFlight = JSON.parse(activeFlightRaw);
}
  
/* ============================================================
   ‚è± SKYTRACK ‚Äî START TIME ENGINE
   ============================================================ */
if (typeof ACS_startTimeEngine === "function") {
  ACS_startTimeEngine();
}
    
</script>

</body>
</html>
