<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACS SkyTrack â€” Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">

  <style>
    body {
      background:#081530;
      color:white;
      font-family:"Segoe UI",sans-serif;
      margin:0;
    }

    h2 {
      color:#FFB300;
      margin-top:6rem;
      text-align:center;
    }

    .sub {
      text-align:center;
      color:#ccc;
      margin-bottom:1rem;
    }

    #map {
      height:85vh;
      width:90%;
      margin:1.5rem auto;
      border-radius:12px;
      border:1px solid rgba(255,179,0,0.3);
      box-shadow:0 4px 16px rgba(0,0,0,0.4);
    }

    footer {
      text-align:center;
      color:#999;
      font-size:0.9rem;
      padding:1rem;
    }

    /* ATC marker */
    .atc-box {
      width:9px;
      height:9px;
      background:#0b2a4a;
      border:1px solid #4da3ff;
      box-shadow:0 0 4px rgba(77,163,255,0.6);
    }

    .atc-label {
      position:absolute;
      top:-14px;
      left:12px;
      font-size:11px;
      font-weight:600;
      color:#111;
      background:rgba(255,255,255,0.85);
      padding:1px 4px;
      border-radius:3px;
      white-space:nowrap;
      font-family:ui-monospace,monospace;
      box-shadow:0 1px 3px rgba(0,0,0,0.35);
    }

    .atc-marker {
      position:relative;
    }
    
.acs-app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background: radial-gradient(circle at top, #0b1f3a, #040b17);
}

.acs-main {
  flex: 1;
  padding: 110px 40px 40px; /* espacio para el header */
}

.acs-panel {
  background: rgba(10,20,40,0.55);
  border-radius: 18px;
  padding: 20px;
  backdrop-filter: blur(12px);
  box-shadow: 0 0 40px rgba(0,0,0,0.4);
}

.acs-map {
  width: 100%;
  height: 70vh;
  border-radius: 16px;
  overflow: hidden;
}
    
</style>
</head>

<body>

<div class="acs-app">

  <!-- ===== HEADER (YA CORREGIDO) ===== -->
  
  <header class="acs-header">
    <div class="acs-left">
      <img src="acs_logo.png" alt="ACS Logo">
      <h1>Aviation Capital Simulator</h1>
    </div>

    <nav class="acs-nav">
      <a href="dashboard.html">Main</a>
      <a href="aircraft.html">Aircraft</a>
      <a href="routes.html">Routes</a>
      <a href="skytrack.html" class="active">SkyTrack</a>
      <a href="hr.html">HR</a>
    </nav>

    <div class="acs-right">
      <a href="support.html" class="support-btn">Support</a>
      <a class="logout-btn" onclick="handleLogout()">Logout</a>
      <div class="acs-clock-header" id="acs-clock">00:00 â€” 01 JAN 1940</div>
    </div>
  </header>

  <!-- ===== MAIN CONTENT (CRÃTICO) ===== -->
  
  <main class="acs-main">

    <section class="acs-panel">
      <h2 class="acs-title">SkyTrack â€” Live Fleet View</h2>
      <p class="acs-subtitle">Real-time fleet tracking (FR24-style)</p>

      <div id="map" class="acs-map"></div>
    </section>

  </main>

</div>

<footer>Â© 2025 Aviation Capital Simulator</footer>

<!-- ============================================================
     â± GLOBAL TIME ENGINE (SINGLE SOURCE)
     ============================================================ -->
<script src="time_engine.js"></script>

<!-- ============================================================
     ðŸŒ WORLD ENGINE + AIRPORT DATA
     ============================================================ -->
<script src="engine/acs_world_engine.js"></script>
<script src="engine/airports/world_airports_na.js"></script>
<script src="engine/airports/world_airports_sa.js"></script>
<script src="engine/airports/world_airports_eu.js"></script>
<script src="engine/airports/world_airports_me.js"></script>
<script src="engine/airports/world_airports_af.js"></script>
<script src="engine/airports/world_airports_as.js"></script>
<script src="engine/airports/world_airports_oc.js"></script>

<!-- ============================================================
     âœˆï¸ FLIGHT RUNTIME (SOURCE OF TRUTH)
     ============================================================ -->
<script src="engine/acs_flight_runtime.js"></script>

<script>
/* ============================================================
   ðŸ›° SKYTRACK â€” PURE RENDER LAYER
   ============================================================ */

let map;
const markers = {};
const traces  = {};

function initMap() {
  if (map) return;

  map = L.map("map").setView([30, 10], 3);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 10,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);
}

function atcIcon(label) {
  return L.divIcon({
    className:"atc-marker",
    html:`<div class="atc-box"></div><div class="atc-label">${label || ""}</div>`,
    iconSize:[22,22],
    iconAnchor:[11,11]
  });
}

function renderSkyTrack() {
  if (!map || !Array.isArray(window.ACS_LIVE_FLIGHTS)) return;

  const active = new Set();

  window.ACS_LIVE_FLIGHTS.forEach(f => {
    if (!Number.isFinite(f.lat) || !Number.isFinite(f.lng)) return;

    const id = f.aircraftId;
    active.add(id);

    if (!markers[id]) {
      markers[id] = L.marker([f.lat, f.lng], {
        icon: atcIcon(f.flightOut || id)
      }).addTo(map);
    } else {
      markers[id].setLatLng([f.lat, f.lng]);
    }

    if (f.status === "enroute") {
      if (!traces[id]) {
        traces[id] = L.polyline([], {
          color:"#1e88e5",
          weight:2,
          opacity:0.9
        }).addTo(map);
      }
      traces[id].addLatLng([f.lat, f.lng]);
    } else if (traces[id]) {
      map.removeLayer(traces[id]);
      delete traces[id];
    }
  });

  Object.keys(markers).forEach(id => {
    if (!active.has(id)) {
      map.removeLayer(markers[id]);
      delete markers[id];
      if (traces[id]) {
        map.removeLayer(traces[id]);
        delete traces[id];
      }
    }
  });
}

/* ============================================================
   â± INIT + TIME HOOK
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {
  initMap();

  if (typeof registerTimeListener === "function") {
    registerTimeListener(renderSkyTrack);
  }

  renderSkyTrack(); // first paint
});
  
/* ============================================================
   ðŸ• ACS CLOCK SYNC (Qatar Luxury)
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {
  if (typeof registerTimeListener === "function") {
    registerTimeListener(updateClockDisplay);
    updateClockDisplay();
  }
});
  
</script>

</body>
</html>
