<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACS SkyTrack - Aviation Capital Simulator</title>

   <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  

   <!-- ======== ACS Favicons ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">  
  

  <style>
    /* === SKYTRACK LOCAL STYLES (ACS Clean 2) === */
    body {
      background:#081530;
      color:white;
      font-family:"Segoe UI",sans-serif;
      margin:0;
    }

    h2 {
      color:#FFB300;
      margin-top:6rem; /* ‚úÖ header fijo */
      text-align:center;
    }
    .sub { text-align:center; color:#ccc; margin-bottom:1rem; }

    #map {
      height:85vh;
      width:90%;
      border-radius:12px;
      border:1px solid rgba(255,179,0,0.3);
      box-shadow:0 4px 16px rgba(0,0,0,0.4);
      margin:1.5rem auto;
    }

    .flight-info {
      color:#ddd;
      text-align:center;
      font-size:0.95rem;
      margin-top:0.3rem;
    }

    .leaflet-control-attribution { color:#888 !important; }

    /* === Radar Marker Styles === */
    .acs-diamond {
      background:#0096FF;
      width:10px;
      height:10px;
      transform:rotate(45deg);
      border:1px solid white;
      border-radius:2px;
    }
    .acs-label {
      position:absolute;
      top:-4px;
      left:14px;
      font-size:11px;
      font-family:'Orbitron',monospace;
      color:#000;
      text-shadow:0 0 2px #fff;
      white-space:nowrap;
      font-weight:600;
    }

    footer {
      text-align:center;
      color:#999;
      font-size:0.9rem;
      padding:1rem;
    }

    /* ‚úÖ Reloj cockpit Airbus */
    .acs-clock-header {
      font-family:'Orbitron','Consolas',monospace;
      color:#00ff80;
      font-weight:bold;
      background:rgba(0,255,128,0.08);
      padding:0.3rem 0.8rem;
      border-radius:6px;
      font-size:0.9rem;
      margin-left:1rem;
    }
  </style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <header class="acs-header">
    <div class="acs-logo">
      <img src="acs_logo.png" alt="ACS Logo" />
      <h1>Aviation Capital Simulator</h1>
    </div>

    <nav class="acs-nav">
      <a href="dashboard.html">Main</a>
      <a href="aircraft.html">Aircraft</a>
      <a href="routes.html">Routes</a>
      <a href="skytrack.html" class="active">SkyTrack</a>
      <a href="hr.html">HR</a>
      <a href="forum.html">Forum</a>
      <a href="support.html">Support</a>
    </nav>

    <div class="acs-auth">
      <a href="#" class="logout-btn" onclick="handleLogout()">Logout</a>
    </div>

    <!-- ‚úÖ Reloj cockpit Airbus -->
    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 2025</div>
  </header>

  <!-- ===== MAIN ===== -->
  <main class="acs-main">
    <h2>ACS SkyTrack ‚Äî Live Fleet View</h2>
    <p class="sub">Active flight tracking for your airline.</p>
    
    <!-- ‚úÖ SKYTRACK MAP CONTAINER -->
    <div id="map"></div>
    <div class="flight-info" id="flightStatus">Waiting for active flight‚Ä¶</div>
  </main>

  <!-- ===== FOOTER ===== -->
  <footer>¬© 2025 Aviation Capital Simulator. All rights reserved.</footer>

  <script>

/* ============================================================
   üß≠ SKYTRACK ‚Äî GET BASE (ACS OFFICIAL + FALLBACK)
   ============================================================ */
    
function getACSBase(){
  try {
    const user = JSON.parse(localStorage.getItem("ACS_activeUser"));
    if (user?.base?.icao) {
      return user.base;
    }
  } catch {}

  // üîÅ Fallback legacy (choose_base.html)
  const icao = localStorage.getItem("ACS_baseICAO");
  if (!icao) return null;

  return {
    icao,
    iata: localStorage.getItem("ACS_baseIATA"),
    city: localStorage.getItem("ACS_baseCity"),
    country: localStorage.getItem("ACS_baseCountry"),
    continent: localStorage.getItem("ACS_baseContinent")
  };
}

/* ============================================================
   üõ∞ SKYTRACK ‚Äî MAP INIT + RENDER ACTIVE FLIGHT (SINGLE SOURCE)
   ============================================================ */

let map = null;
let planeMarker = null;   // (se mantiene aunque ya no se use)
let flightTrace = null;   // (se mantiene aunque ya no se use)

/* ============================================================
   üõ∞ SKYTRACK ‚Äî MAP INIT (CENTERED AT BASE)
   ============================================================ */
function initSkyTrackMap() {
  if (map) return; // ‚úÖ prevent double init

  // üîπ fallback seguro
  let centerLat = 33.0;
  let centerLng = 68.0;
  let zoom = 5;

  const base = getACSBase();

  if (base?.icao && window.WorldAirportsACS) {
    const baseAirport = Object.values(WorldAirportsACS).flat()
      .find(a => a.icao === base.icao);

    if (baseAirport) {
      centerLat = baseAirport.latitude;
      centerLng = baseAirport.longitude;
      zoom = 6;
    }
  }

  map = L.map("map").setView([centerLat, centerLng], zoom);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 10,
    attribution: "&copy; OpenStreetMap ‚Äî ACS SkyTrack",
  }).addTo(map);

  flightTrace = L.polyline([], {
    weight: 2.2,
    opacity: 0.85,
  }).addTo(map);
}
    
/* ============================================================
   ‚úàÔ∏è SKYTRACK ‚Äî LIVE FLIGHTS LAYER
   ============================================================ */
let liveFlightMarkers = {};

function renderLiveFlights(){

  if (!map) return; // ‚õî seguridad

  let flights = [];
  try {
    flights = JSON.parse(localStorage.getItem("ACS_LIVE_FLIGHTS")) || [];
  } catch {}

  const activeIds = new Set();

  flights.forEach(f => {
    if (typeof f.lat !== "number" || typeof f.lng !== "number") return;

    activeIds.add(f.aircraftId);

    // Crear marker si no existe
    if (!liveFlightMarkers[f.aircraftId]) {
      liveFlightMarkers[f.aircraftId] = L.marker(
        [f.lat, f.lng],
        { title: f.flightOut || f.aircraftId }
      ).addTo(map);
    }

    // Actualizar posici√≥n
    liveFlightMarkers[f.aircraftId].setLatLng([f.lat, f.lng]);
  });

  // Eliminar vuelos que ya no est√°n activos
  Object.keys(liveFlightMarkers).forEach(id => {
    if (!activeIds.has(id)) {
      map.removeLayer(liveFlightMarkers[id]);
      delete liveFlightMarkers[id];
    }
  });
}

/* ============================================================
   ‚è± SKYTRACK ‚Äî INIT + TIME SYNC
   ============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  initSkyTrackMap();

  if (typeof registerTimeListener === "function") {
    registerTimeListener(renderLiveFlights);
  }
});

    
function renderActiveFlight() {
  try {
    const execRaw = localStorage.getItem("ACS_FLIGHT_EXEC");
    if (!execRaw) {
      const st = document.getElementById("flightStatus");
      if (st) st.textContent = "üõ∞ No active flight (ACS_FLIGHT_EXEC not found).";
      return;
    }

    const exec = JSON.parse(execRaw);
    if (exec.currentLat == null || exec.currentLng == null) return;

    // ‚úÖ create marker once
    if (!planeMarker) {
      const icon = L.divIcon({
        html: `
          <div class="acs-diamond"></div>
          <div class="acs-label">${exec.aircraftId || "AC"}</div>
        `,
        className: "acs-plane",
        iconSize: [20, 20],
        iconAnchor: [10, 10],
      });

      planeMarker = L.marker([exec.currentLat, exec.currentLng], { icon }).addTo(map);
    }

    planeMarker.setLatLng([exec.currentLat, exec.currentLng]);
    if (flightTrace) flightTrace.addLatLng([exec.currentLat, exec.currentLng]);

    // ‚úÖ status line
    const st = document.getElementById("flightStatus");
    if (st) {
      st.textContent = `‚úÖ Tracking: ${exec.aircraftId || "AC"} ‚Äî ${exec.currentLat.toFixed(3)}, ${exec.currentLng.toFixed(3)}`;
    }
  } catch (e) {
    console.error("SkyTrack renderActiveFlight error:", e);
  }
}

// ‚úÖ init when DOM is ready (map div exists)
document.addEventListener("DOMContentLoaded", () => {
  initSkyTrackMap();
  renderActiveFlight();
});

function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}
</script>
  
<!-- ‚è± TIME ENGINE -->
<script src="time_engine.js"></script>

<!-- üåç WORLD / AIRPORT ENGINE -->
<script src="engine/acs_world_engine.js"></script>

<!-- ‚úàÔ∏è FLIGHT RUNTIME (LIVE FLIGHTS) -->
<script src="engine/acs_flight_runtime.js"></script>

  
<script>
/* ============================================================
   ‚è± SKYTRACK TIME LISTENER
   ============================================================ */

if (typeof registerTimeListener === "function") {
  registerTimeListener(() => {
  renderActiveFlight();
});
}

/* ============================================================
   üïê Reloj cockpit Airbus sincronizado con ACS
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {
  if (typeof registerTimeListener === "function") {
    registerTimeListener(updateClockDisplay);
    updateClockDisplay();
  }
});

/* ============================================================
   üõ∞ READ ACTIVE FLIGHT FROM SCHEDULE
   ============================================================ */

const activeFlightRaw = localStorage.getItem("ACS_ACTIVE_FLIGHT");

if (!activeFlightRaw) {
  console.log("üõ∞ SkyTrack: No active flight");
} else {
  const activeFlight = JSON.parse(activeFlightRaw);
}
  
/* ============================================================
   ‚è± SKYTRACK ‚Äî START TIME ENGINE
   ============================================================ */
if (typeof ACS_startTimeEngine === "function") {
  ACS_startTimeEngine();
}
  
/* ============================================================
   ‚è± SKYTRACK ‚Äî TIME SYNC
   ============================================================ */
if (typeof registerTimeListener === "function") {
  registerTimeListener(renderLiveFlights);
}
  
</script>

</body>
</html>
