<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACS SkyTrack - Aviation Capital Simulator</title>
  <link rel="stylesheet" href="styles.css?v=3.2" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* === SKYTRACK LOCAL STYLES (ACS Clean 2) === */
    body {
      background:#081530;
      color:white;
      font-family:"Segoe UI",sans-serif;
      margin:0;
    }

    h2 {
      color:#FFB300;
      margin-top:6rem; /* ‚úÖ header fijo */
      text-align:center;
    }
    .sub { text-align:center; color:#ccc; margin-bottom:1rem; }

    #map {
      height:85vh;
      width:90%;
      border-radius:12px;
      border:1px solid rgba(255,179,0,0.3);
      box-shadow:0 4px 16px rgba(0,0,0,0.4);
      margin:1.5rem auto;
    }

    .flight-info {
      color:#ddd;
      text-align:center;
      font-size:0.95rem;
      margin-top:0.3rem;
    }

    .leaflet-control-attribution { color:#888 !important; }

    /* === Radar Marker Styles === */
    .acs-diamond {
      background:#0096FF;
      width:10px;
      height:10px;
      transform:rotate(45deg);
      border:1px solid white;
      border-radius:2px;
    }
    .acs-label {
      position:absolute;
      top:-4px;
      left:14px;
      font-size:11px;
      font-family:'Orbitron',monospace;
      color:#000;
      text-shadow:0 0 2px #fff;
      white-space:nowrap;
      font-weight:600;
    }

    footer {
      text-align:center;
      color:#999;
      font-size:0.9rem;
      padding:1rem;
    }

    /* ‚úÖ Reloj cockpit Airbus */
    .acs-clock-header {
      font-family:'Orbitron','Consolas',monospace;
      color:#00ff80;
      font-weight:bold;
      background:rgba(0,255,128,0.08);
      padding:0.3rem 0.8rem;
      border-radius:6px;
      font-size:0.9rem;
      margin-left:1rem;
    }
  </style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <header class="acs-header">
    <div class="acs-logo">
      <img src="acs_logo.png" alt="ACS Logo" />
      <h1>Aviation Capital Simulator</h1>
    </div>

    <nav class="acs-nav">
      <a href="dashboard.html">Main</a>
      <a href="aircraft.html">Aircraft</a>
      <a href="routes.html">Routes</a>
      <a href="skytrack.html" class="active">SkyTrack</a>
      <a href="hr.html">HR</a>
      <a href="forum.html">Forum</a>
      <a href="support.html">Support</a>
    </nav>

    <div class="acs-auth">
      <a href="#" class="logout-btn" onclick="handleLogout()">Logout</a>
    </div>

    <!-- ‚úÖ Reloj cockpit Airbus -->
    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 2025</div>
  </header>

  <!-- ===== MAIN ===== -->
  <main class="acs-main">
    <h2>ACS SkyTrack ‚Äî Live Fleet View</h2>
    <p class="sub">Active flight tracking for your airline.</p>

    <div id="map"></div>
    <p class="flight-info" id="flightStatus">üõ´ Simulating flight: UCFM (Bishkek) ‚Üí OMDB (Dubai)</p>
  </main>

  <!-- ===== FOOTER ===== -->
  <footer>¬© 2025 Aviation Capital Simulator. All rights reserved.</footer>

<!-- ============================================================
     ‚è± ACS TIME ENGINE ‚Äî REQUIRED FOR SCHEDULE TABLE
     ============================================================ -->
<script src="./time_engine.js"></script>
      
  <!-- ===== SCRIPT ===== -->
  
  <script>
    // === Initialize map ===
    const map = L.map('map').setView([33.0, 68.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:10,
      attribution:'&copy; OpenStreetMap ‚Äî ACS SkyTrack'
    }).addTo(map);

    // === Airports ===
    const origin = { name:"Bishkek (UCFM)", lat:42.866, lon:74.529 };
    const destination = { name:"Dubai (OMDB)", lat:25.253, lon:55.365 };

    // === Markers & route ===
    L.marker([origin.lat,origin.lon]).addTo(map).bindPopup(`<b>${origin.name}</b><br>Departure`);
    L.marker([destination.lat,destination.lon]).addTo(map).bindPopup(`<b>${destination.name}</b><br>Arrival`);

    const routeLine = L.polyline([[origin.lat,origin.lon],[destination.lat,destination.lon]],{
      color:'#FFB300',weight:2.5,opacity:0.8,dashArray:'5,6'
    }).addTo(map);

    // === ‚ú≥Ô∏è Radar Diamond Marker ===
    const planeIcon = L.divIcon({
      html:`<div class="acs-diamond"></div><div class="acs-label">A320 | N388PP</div>`,
      className:"acs-plane",iconSize:[20,20],iconAnchor:[10,10]
    });
    const planeMarker = L.marker([origin.lat,origin.lon],{icon:planeIcon}).addTo(map);

    // === Ruta din√°mica (traza del vuelo) ===
    const flightTrace = L.polyline([],{
      color:"#00E0FF",weight:2.2,opacity:0.85
    }).addTo(map);

    let progress=0; const steps=400; const updateInterval=50;

    function interpolatePosition(a,b,t){ return [a.lat+(b.lat-a.lat)*t, a.lon+(b.lon-a.lon)*t]; }
    function getBearing(lat1,lon1,lat2,lon2){
      const r=Math.PI/180;
      const y=Math.sin((lon2-lon1)*r)*Math.cos(lat2*r);
      const x=Math.cos(lat1*r)*Math.sin(lat2*r)-Math.sin(lat1*r)*Math.cos(lat2*r)*Math.cos((lon2-lon1)*r);
      return ((Math.atan2(y,x)*180/Math.PI)+360)%360;
    }

    function updatePlane(){
      progress+=1/steps;
      if(progress>1){
        progress=1;
        document.getElementById("flightStatus").innerHTML="‚úÖ Flight completed: Arrived in Dubai (OMDB)";
      }
      const [lat,lon]=interpolatePosition(origin,destination,progress);
      planeMarker.setLatLng([lat,lon]);
      flightTrace.addLatLng([lat,lon]);

      const bearing=getBearing(origin.lat,origin.lon,lat,lon);
      const diamond=planeMarker.getElement()?.querySelector(".acs-diamond");
      if(diamond) diamond.style.transform=`rotate(${bearing+45}deg)`;

      if(progress<1) setTimeout(updatePlane,updateInterval);
    }
    updatePlane();

    function handleLogout(){
      alert("üëã Session closed. See you soon, Captain!");
      window.location.href="login.html";
    }
  </script>

  <!-- ‚úÖ Reloj cockpit Airbus sincronizado -->
  <script src="time_engine.js"></script>
  <script>
  // üïê Reloj cockpit Airbus sincronizado con el motor global ACS
  document.addEventListener("DOMContentLoaded", () => {
    if (typeof registerTimeListener === "function") {
      registerTimeListener(updateClockDisplay);
      updateClockDisplay();
    }
  });

/* ============================================================
   üõ∞ PASO 4.4 ‚Äî READ ACTIVE FLIGHT FROM SCHEDULE
   ============================================================ */

const activeFlightRaw = localStorage.getItem("ACS_ACTIVE_FLIGHT");

if (!activeFlightRaw) {
  console.log("üõ∞ SkyTrack: No active flight");
  return;
}

const activeFlight = JSON.parse(activeFlightRaw);
    
/* ============================================================
   ‚úàÔ∏è PASO 4.5 ‚Äî REAL FLIGHT PROGRESS (TIME-BASED)
   ============================================================ */

// Tiempo actual del simulador
let nowMin = null;

if (typeof ACS_TABLE_TIME !== "undefined") {
  nowMin = ACS_TABLE_TIME.minute;
} else if (typeof getSimMinute === "function") {
  nowMin = getSimMinute();
}

if (nowMin === null) {
  console.warn("SkyTrack: No sim time available");
  return;
}

// Progreso 0 ‚Üí 1
const progress =
  (nowMin - activeFlight.depMin) /
  (activeFlight.arrMin - activeFlight.depMin);

</script>
</body>
</html>
