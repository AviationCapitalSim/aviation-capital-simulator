<!-- ============================================================
     === HR MODULE ‚Äî Qatar Luxury Edition | ACS ================
     === Version: v1 | Date: 25 NOV 2025 =======================
     ============================================================ -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Human Resources - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons (16 / 32 / 64) ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">

  <!-- ======== Apple iPhone/iPad Home Screen Icon ======== -->
  <link rel="apple-touch-icon" href="acs_logo_180.png">

  <!-- ======== PWA Manifest ======== -->
  <link rel="manifest" href="manifest.json">

  <style>
  /* ============================================================
       === ACS Qatar Luxury Dashboard ‚Äî Base Design ============
     ============================================================ */

  body {
    margin: 0;
    background-color: #081530;
    color: white;
    font-family: "Poppins", sans-serif;
  }

  /* ============================================================
       === GLOBAL HEADER (Exact Copy from index/dashboard) =====
     ============================================================ */

  .acs-header {
    position: fixed;
    top: 0;
    width: 100%;
    backdrop-filter: blur(9px);
    background: rgba(12,23,50,0.45);
    padding: 0.8rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 2px solid #ffb300;
    z-index: 5000;
  }

  .acs-left {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .acs-left img {
    height: 46px;
  }

  .acs-left h1 {
    font-size: 1.15rem;
    margin: 0;
    color: #ffb300;
    letter-spacing: 0.5px;
  }

  .acs-nav {
    flex: 1;
    display: flex;
    justify-content: center;
    gap: 2rem;
  }

  /* ============================================================
       === NAVIGATION ‚Äî QATAR PEARL GLOW STYLE =================
     ============================================================ */

  .acs-nav a {
    position: relative;
    font-size: 1rem;
    letter-spacing: 0.4px;
    color: #dbe4ff;
    text-decoration: none;
    transition: 0.25s ease;
    padding-bottom: 6px;
  }

  .acs-nav a:hover,
  .acs-nav a.active {
    color: #ffca3a;
    text-shadow: 0 0 6px rgba(255,179,0,0.45);
  }

  .acs-nav a.active::after,
  .acs-nav a:hover::after {
    content: "";
    position: absolute;
    bottom: -8px;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(to right, #ffb300, #ffe7a0);
    border-radius: 2px;
    box-shadow: 0 0 8px rgba(255,200,60,0.45);
  }

  .acs-right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  /* LOGOUT BUTTON (Qatar style) */
  .logout-btn {
    padding: 0.45rem 1.1rem;
    border: 1px solid #ffb300;
    border-radius: 12px;
    background: rgba(255,179,0,0.05);
    color: #ffb300;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
  }

  .logout-btn:hover {
    background: #ffb300;
    color: #0c1f3c;
  }

  /* CLOCK (same as dashboard) */
  .acs-clock-header {
    font-family: "Orbitron", monospace;
    padding: 0.4rem 0.8rem;
    background: rgba(0,255,128,0.08);
    border-radius: 8px;
    font-size: 0.95rem;
    color: #00ff80;
  }

  /* ============================================================
       === SUPPORT BUTTON (igual dashboard) =====================
     ============================================================ */

  .support-btn {
    padding: 0.45rem 1.1rem;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    color: #8AB4FF;
    border: 1px solid rgba(138,180,255,0.45);
    background: rgba(138,180,255,0.08);
    backdrop-filter: blur(6px);
    transition: 0.25s ease;
  }

  .support-btn:hover {
    background: rgba(138,180,255,0.20);
    box-shadow: 0 0 14px rgba(138,180,255,0.55);
    color: #dfe9ff;
  }

  /* ============================================================
       === MAIN CONTENT (igual dashboard) ======================
     ============================================================ */

  .acs-main {
    padding: 105px 2rem 70px;
    text-align: center;
  }

  .acs-main h2 {
    font-size: 1.9rem;
    font-weight: 600;
    color: #ffca3a;
    text-shadow: 0 0 12px rgba(255,190,60,0.55);
    letter-spacing: 0.6px;
    margin-top: 0.5rem;
  }

  .acs-main .sub {
    margin-top: 0.4rem;
    color: #cbd6ff;
    font-size: 1rem;
  }

  /* ============================================================
       === PANEL GRID (reuso dashboard-grid) ===================
     ============================================================ */

  .dashboard-grid {
    display: grid;
    gap: 2rem;
    margin-top: 2rem;
  }

  .row-business {
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  }

  /* Panel base (mismo que dashboard) */
  .panel {
  background: linear-gradient(180deg, rgba(20,35,70,0.75), rgba(10,18,40,0.85));
  padding: 1.6rem 1.5rem;
  border-radius: 22px;
  box-shadow: 0 0 25px rgba(0,0,0,0.4);
  transition: 0.25s;
  border: 1px solid rgba(255,179,0,0.15);
  text-align: center;     /* üî• todo centrado */
  align-items: center;     /* üî• asegura centro vertical si se usa flex */
}

  .panel:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 32px rgba(255,179,0,0.25);
    border: 1px solid rgba(255,179,0,0.35);
  }

  .panel h3 {
    font-size: 1.25rem;
    color: #ffb300;
    margin-bottom: 0.9rem;
    text-shadow: 0 0 6px rgba(255,179,0,0.4);
  }

  .panel p {
    color: #d7e2ff;
    font-size: 0.95rem;
    line-height: 1.4;
    margin: 0.15rem 0;
  }

  /* ============================================================
       === HR-SPECIFIC STYLES ==================================
     ============================================================ */

  .inactive-panel {
    opacity: 0.45;
    filter: grayscale(100%);
    pointer-events: none;
    position: relative;
  }

  .inactive-note {
    margin-top: 1rem;
    color: #aaa;
    font-style: italic;
    text-align: center;
  }

  /* Standard ACS button */
  .acs-btn {
    margin-top: 1rem;
    background: #00a86b;
    border: none;
    padding: 0.7rem 1.1rem;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.25s;
    color: white;
  }

  .acs-btn:hover {
    background: #00794f;
  }

  /* Footer igual dashboard */
  .acs-footer {
    text-align: center;
    padding: 20px;
    margin-top: 50px;
    color: #7c8bb8;
    font-size: 0.9rem;
  }
  </style>
</head>

<body>

<header class="acs-header">
  <div class="acs-left">
    <img src="acs_logo.png" alt="ACS Logo">
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="bank.html">Bank</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html">Routes</a>
    <a href="hr.html" class="active">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 1940</div>
  </div>
</header>

<main class="acs-main">
  <h2>üë• Human Resources Department</h2>
  <p class="sub">Manage all staff, morale, payroll and bonuses across the company.</p>

  <div class="dashboard-grid row-business">

    <!-- === HR OVERVIEW === -->
    <div class="panel">
      <h3>üìä HR Overview</h3>
      <p>Total Staff: <strong id="totalStaff">‚Äî</strong></p>
      <p>Total Payroll: <strong id="totalPayroll">‚Äî</strong></p>
      <p>Average Morale: <strong id="avgMorale">‚Äî</strong></p>
      <p>Staff Coverage: <strong id="coverage">100%</strong></p>
    </div>

    <!-- === Department Control === -->
    <div class="panel">
      <h3>üßë‚Äçüíº Department Control</h3>
      <p>Total Departments: <strong>18</strong></p>
      <p>Total Staff: <strong id="totalStaff2">‚Äî</strong></p>
      <p>Average Morale: <strong id="avgMorale2">‚Äî</strong></p>
      <p>Monthly Payroll: <strong id="monthlyPayroll">‚Äî</strong></p>
      <button class="acs-btn" onclick="window.location.href='department_control.html'">
        üè¢ Open Department Control Center
      </button>
    </div>

    <!-- === Payroll & Bonuses (Coming Soon) === -->
    <div class="panel inactive-panel">
      <h3>üí∞ Payroll & Bonuses</h3>
      <p>This Month Payroll: <strong>‚Äî</strong></p>
      <p>Bonuses Applied: <strong>$0</strong></p>
      <p>Expense Share: <strong>‚Äî</strong></p>
      <p class="inactive-note">Coming Soon</p>
    </div>

    <!-- === Operational Impact (Coming Soon) === -->
    <div class="panel inactive-panel">
      <h3>‚úàÔ∏è Operational Impact</h3>
      <p>Flight Efficiency: <strong>‚Äî</strong></p>
      <p>Delay Risk: <strong>None</strong></p>
      <p>Maintenance Reliability: <strong>‚Äî</strong></p>
      <p class="inactive-note">Coming Soon</p>
    </div>

  </div>
</main>

<footer class="acs-footer">
  ¬© 2026 Aviation Capital Simulator. All rights reserved.
</footer>

<!-- ============================================================
     === SCRIPTS ‚Äî ORDEN OFICIAL HR + SALARY ===================
     ============================================================ -->

<script src="engine/acs_alerts.js"></script>   <!-- 1Ô∏è‚É£ ALERTS PRIMERO -->

<!-- ‚è≥ TIME ENGINE -->
<script src="acs_time_recovery.js"></script>
<script src="time_engine.js"></script>

<!-- üí∞ FINANCE -->
<script src="engine/acs_finance.js"></script>

<!-- üë• HR CORE -->
<script src="engine/acs_hr_engine.js"></script>

<!-- üß† DEPARTMENT OPS + SALARY ENGINE (CR√çTICO) -->
<script src="engine/acs_department_ops_engine.js"></script>
     
<script>
     
/* ============================================================
   üü© HR DASHBOARD ‚Äî DATA LOADER (SAFE & OPS-READY)
   ------------------------------------------------------------
   Purpose:
   - Cargar KPIs HR sin producir NaN
   - Ser robusto aunque OPS a√∫n no haya calculado
   ------------------------------------------------------------
   Version: v1.1 | Date: 05 FEB 2026
   ============================================================ */

function loadHRDashboard() {

  const hr = ACS_HR_load() || {};
  const departments = Object.values(hr);

  // =========================
  // TOTAL STAFF
  // =========================
  const totalStaff = departments.reduce(
    (sum, d) => sum + (Number(d.staff) || 0),
    0
  );

  // =========================
  // AVERAGE MORALE
  // =========================
  const morale = departments.length
    ? Math.round(
        departments.reduce(
          (sum, d) => sum + (Number(d.morale) || 100),
          0
        ) / departments.length
      )
    : 100;

    // =========================
  // TOTAL PAYROLL (SAFE)
  // =========================
     
  let payroll = 0;

  // 1) Prefer engine total payroll (if available)
  if (typeof ACS_HR_getTotalPayroll === "function") {
    payroll = Number(ACS_HR_getTotalPayroll()) || 0;
  }

  // 2) Fallback: compute from state (staff * salary)
  if (payroll <= 0 && departments.length) {
    payroll = departments.reduce((sum, d) => {
      const staff = Number(d.staff) || 0;
      const salary = Number(d.salary) || 0;
      return sum + (staff * salary);
    }, 0);
  }

  // =========================
  // PAINT UI
  // =========================
     
  document.getElementById("totalStaff").textContent = totalStaff;
  document.getElementById("totalStaff2").textContent = totalStaff;

  document.getElementById("avgMorale").textContent = morale + "%";
  document.getElementById("avgMorale2").textContent = morale + "%";

  document.getElementById("totalPayroll").textContent =
    "$" + payroll.toLocaleString() + " / month";

  document.getElementById("monthlyPayroll").textContent =
    "$" + payroll.toLocaleString();
}

/* ============================================================
   INIT
   ============================================================ */
window.addEventListener("DOMContentLoaded", () => {

  loadHRDashboard();

  if (typeof registerTimeListener === "function") {
    registerTimeListener(updateClockDisplay);
    updateClockDisplay();
  }
});

/* ============================================================
   üü¶ B4 ‚Äî AUTO-BALANCE STAFF ENGINE (HR_fullModal)
   ============================================================ */

function HR_autoAdjustFull() {
    if (!HR_active) return;

    const HR = ACS_HR_load();
    const d = HR[HR_active];
    if (!d) return;

    const required = d.required || d.staff;
    const current = d.staff;

    const diff = required - current;

    // Mostrar diferencia en el modal
    document.getElementById("autoDiff").textContent = diff;

    // === Caso 1: Falta personal ‚Üí contratar autom√°ticamente ===
    if (diff > 0) {
        ACS_HR_hire(HR_active, diff); 
        alert(`‚úÖ ${d.name}: Se contrataron autom√°ticamente ${diff} empleados.`);
    }

    // === Caso 2: Sobra personal ‚Üí confirmar despido ===
    else if (diff < 0) {

        const fireCount = Math.abs(diff);

        const ok = confirm(
            `‚ö†Ô∏è ${d.name}\n\nSobran ${fireCount} empleados.\n\n¬øDeseas despedirlos autom√°ticamente?`
        );

        if (ok) {
            ACS_HR_fire(HR_active, fireCount);
            alert(`‚ùå ${fireCount} empleados despedidos en ${d.name}.`);
        } else {
            return; // Cancelado
        }
    }

    // === Caso 3: est√° perfecto ===
    else {
        alert(`‚úîÔ∏è ${d.name} ya est√° perfectamente balanceado.`);
    }

    // Guardar y refrescar
    ACS_HR_recalculateAll();
    ACS_HR_save(HR);
    loadDepartments(); // refresca tabla grande
    openHRFullModal(HR_active); // reabre modal actualizado
}

/* ============================================================
   üü¶ SAL-JS-2 ‚Äî PREVIEW ENGINE REAL TIME
   ============================================================ */

document.addEventListener("input", e => {
  if (e.target.id === "sal_slider") {
    updateSalaryPreview();
  }
});

function updateSalaryPreview() {

  const HR = ACS_HR_load();
  const dep = HR[__SAL_currentDep];
  if (!dep) return;

  const percent = Number(document.getElementById("sal_slider").value);
  document.getElementById("sal_percent_label").textContent = percent;

  const newSalary = Math.round(dep.salary * (1 + percent / 100));
  const payrollDelta = (newSalary - dep.salary) * dep.staff;

  const market = ACS_HR_getMarketSalary(__SAL_currentDep);
  const ratio = (newSalary / market).toFixed(2);

  // Ratio color
  const ratioEl = document.getElementById("sal_ratio");
  ratioEl.textContent = ratio;

  ratioEl.className = "";
  if (ratio >= 1.0) ratioEl.classList.add("ok");
  else if (ratio >= 0.85) ratioEl.classList.add("warning");
  else ratioEl.classList.add("danger");

  document.getElementById("sal_new").textContent = newSalary;
  document.getElementById("sal_payroll_delta").textContent =
    (payrollDelta >= 0 ? "+" : "") + "$" + payrollDelta;

  // Morale forecast
  let moraleText = "No change";
  let moraleClass = "neutral";

  if (ratio > 1.10) { moraleText = "+1 / month"; moraleClass = "good"; }
  if (ratio < 0.85) { moraleText = "-1 / month"; moraleClass = "bad"; }
  if (ratio < 0.70) { moraleText = "-3 / month"; moraleClass = "bad"; }

  const moraleEl = document.getElementById("sal_morale_effect");
  moraleEl.textContent = moraleText;
  moraleEl.className = moraleClass;

  // Auto Salary warning
  const auto = localStorage.getItem("ACS_AutoSalary") === "ON";
  if (percent !== 0 && auto) {
    document.getElementById("sal_auto_warning").style.display = "block";
  } else {
    document.getElementById("sal_auto_warning").style.display = "none";
  }
}

/* ============================================================
   üü¶ SAL-LOGIC-1 ‚Äî APPLY SALARY POLICY (FINAL AUTHORITY)
   ============================================================ */

function applySalaryPolicy() {

  const HR = ACS_HR_load();
  const dep = HR[__SAL_currentDep];
  if (!dep) return;

  const percent = Number(document.getElementById("sal_slider").value);

  // Si no hay cambio ‚Üí salir
  if (percent === 0) {
    closeSalaryModal();
    return;
  }

  const oldSalary = dep.salary;
  const newSalary = Math.round(oldSalary * (1 + percent / 100));

  // Aplicar definitivo
  dep.salary = newSalary;
  dep.payroll = dep.salary * dep.staff;

  // Registrar revisi√≥n salarial
  const year = ACS_TIME_getYear ? ACS_TIME_getYear() : new Date().getUTCFullYear();
  dep.lastSalaryReviewYear = year;
  dep.salaryStatus = "ok";

  // üî¥ AUTO SALARY OFF INMEDIATO + SYNC SETTINGS UI
  localStorage.setItem("ACS_AutoSalary", "OFF");

  const cb = document.getElementById("autoSalary");
  if (cb) cb.checked = false;

  console.log("%c‚ö† AUTO SALARY DISABLED BY MANUAL OVERRIDE", "color:#ff4040;font-weight:700");

  console.log(
    "%cüí∞ SALARY POLICY APPLIED",
    "color:#00ffcc;font-weight:700",
    dep.name,
    "Old:", oldSalary,
    "New:", newSalary,
    "AutoSalary OFF"
  );

  ACS_HR_save(HR);

  // Recalcular sistema
  if (typeof ACS_HR_recalculateAll === "function") ACS_HR_recalculateAll();
  if (typeof loadDepartments === "function") loadDepartments();
  if (typeof HR_updateKPI === "function") HR_updateKPI();

  closeSalaryModal();
}

/* ============================================================
   üü¶ SAL-REF-1 ‚Äî MARKET SALARY REFERENCE CORE
   ------------------------------------------------------------
   Modelo mixto:
   ‚Ä¢ Usa salario inicial como baseline
   ‚Ä¢ Ajusta por era hist√≥rica
   ============================================================ */

function ACS_HR_getMarketSalary(depID) {

  const HR = ACS_HR_load();
  const dep = HR[depID];
  if (!dep) return dep.salary;

  const base = dep.salary;

  const year = ACS_TIME_getYear ? ACS_TIME_getYear() : new Date().getUTCFullYear();

  let factor = 1.0;

  if (year < 1960) factor = 1.0;
  else if (year < 1980) factor = 1.3;
  else if (year < 2000) factor = 1.8;
  else if (year < 2010) factor = 2.2;
  else factor = 2.6;

  return Math.round(base * factor);
}

/* ============================================================
   üü¶ A3.5 ‚Äî SALARY ‚Üí MORALE MONTHLY ENGINE (ACS OFFICIAL)
   ------------------------------------------------------------
   ‚Ä¢ Eval√∫a impacto salarial en moral
   ‚Ä¢ Se ejecuta 1 vez por mes de juego
   ‚Ä¢ Modelo humano realista
   ‚Ä¢ Totalmente independiente de Auto Salary
   ============================================================ */

function ACS_HR_applySalaryMorale_Monthly() {

  const HR = ACS_HR_load();
  if (!HR) return;

  const year  = ACS_TIME_getYear ? ACS_TIME_getYear() : new Date().getUTCFullYear();
  const month = ACS_TIME_getMonth ? ACS_TIME_getMonth() : new Date().getUTCMonth();

  Object.keys(HR).forEach(id => {

    const dep = HR[id];
    if (!dep || typeof dep.salary !== "number") return;

    const market = ACS_HR_getMarketSalary(id);
    if (!market || market <= 0) return;

    const ratio = dep.salary / market;

    let delta = 0;

    // ========================================================
    // üß† HUMAN BEHAVIOR MODEL
    // ========================================================

    if (ratio >= 1.10) delta = +1;
    else if (ratio >= 1.00) delta = 0;
    else if (ratio >= 0.90) delta = -1;
    else if (ratio >= 0.75) delta = -2;
    else delta = -3;

    if (delta !== 0) {

      const oldMorale = dep.morale || 100;
      const newMorale = Math.max(30, Math.min(100, oldMorale + delta));

      dep.morale = newMorale;

      console.log(
        "%cüß† SALARY MORALE UPDATE",
        delta > 0 ? "color:#00ff88;font-weight:600" : "color:#ff5555;font-weight:600",
        dep.name,
        "Ratio:", ratio.toFixed(2),
        "Delta:", delta,
        "Morale:", oldMorale, "‚Üí", newMorale
      );
    }

  });

  ACS_HR_save(HR);

  // Refrescar UI
  if (typeof loadDepartments === "function") loadDepartments();
  if (typeof HR_updateKPI === "function") HR_updateKPI();
}

/* ============================================================
   üü¶ A3.5.1 ‚Äî MONTHLY TICK ‚Äî SALARY MORALE ENGINE
   ------------------------------------------------------------
   ‚Ä¢ Ejecuta evaluaci√≥n salarial 1 vez por mes de juego
   ‚Ä¢ Totalmente sincronizado con ACS_TIME
   ============================================================ */

let __HR_lastSalaryMonth = null;

registerTimeListener((time) => {

  const year  = time.getUTCFullYear();
  const month = time.getUTCMonth(); // 0‚Äì11

  const key = `${year}-${month}`;

  if (__HR_lastSalaryMonth === null) __HR_lastSalaryMonth = key;

  if (key !== __HR_lastSalaryMonth) {

    console.log(
      "%cüóì HR MONTH TICK ‚Äî SALARY MORALE",
      "color:#00ffcc;font-weight:600",
      "Year:", year,
      "Month:", month + 1
    );

    ACS_HR_applySalaryMorale_Monthly();

    __HR_lastSalaryMonth = key;
  }

});

/* ============================================================
   üü¶ A3.6.1 ‚Äî SALARY ALERT STATE ENGINE (ANTI-SPAM CORE)
   ------------------------------------------------------------
   ‚Ä¢ Guarda historial salarial por departamento
   ‚Ä¢ Evita spam de alertas
   ‚Ä¢ Seguimiento mensual real
   ============================================================ */

function ACS_HR_loadSalaryAlertTrack() {
  return JSON.parse(localStorage.getItem("ACS_HR_SALARY_TRACK") || "{}");
}

function ACS_HR_saveSalaryAlertTrack(state) {
  localStorage.setItem("ACS_HR_SALARY_TRACK", JSON.stringify(state));
}

if (!localStorage.getItem("ACS_HR_SALARY_TRACK")) {
  ACS_HR_saveSalaryAlertTrack({});
}

/* ============================================================
   üü¶ A3.6.2 ‚Äî SALARY ALERT EVALUATOR (MONTHLY DISCIPLINE CORE)
   ------------------------------------------------------------
   ‚Ä¢ Eval√∫a salarios bajos persistentes
   ‚Ä¢ Emite alertas progresivas
   ‚Ä¢ SOLO si Auto Salary est√° OFF
   ‚Ä¢ 100% compatible con Alerts Center
   ============================================================ */

function ACS_HR_evaluateSalaryAlerts_Monthly() {

  // üîí Si Auto Salary est√° ON ‚Üí NO emitir alertas
  const auto = localStorage.getItem("ACS_AutoSalary") === "ON";
  if (auto) return;

  const HR = ACS_HR_load();
  if (!HR) return;

  const track = ACS_HR_loadSalaryAlertTrack();

  Object.keys(HR).forEach(id => {

    const dep = HR[id];
    if (!dep || typeof dep.salary !== "number") return;

    const market = ACS_HR_getMarketSalary(id);
    if (!market || market <= 0) return;

    const ratio = dep.salary / market;

    // Inicializar tracking si no existe
    if (!track[id]) {
      track[id] = {
        lowMonths: 0,
        lastLevel: null
      };
    }

    const entry = track[id];

    // ================================
    // CONTAR MESES DE SALARIO BAJO
    // ================================

    if (ratio < 0.95) {
      entry.lowMonths++;
    } else {
      entry.lowMonths = 0;
      entry.lastLevel = null;
      return;
    }

    // ================================
    // DETERMINAR NIVEL DE ALERTA
    // ================================

    let level = null;
    let title = "";
    let message = "";

    if (ratio < 0.75 && entry.lowMonths >= 2) {
      level = "danger";
      title = "Critical Salary Risk";
      message = `${dep.name} salaries critically below market (${Math.round(ratio*100)}%). High risk of resignations and strikes.`;
    }
    else if (ratio < 0.85 && entry.lowMonths >= 2) {
      level = "warning";
      title = "Salary Lagging";
      message = `${dep.name} salaries significantly below market (${Math.round(ratio*100)}%). Morale deterioration expected.`;
    }
    else if (ratio < 0.95 && entry.lowMonths >= 2) {
      level = "info";
      title = "Salary Review Required";
      message = `${dep.name} salaries below market reference (${Math.round(ratio*100)}%). Review recommended.`;
    }

    // ================================
    // EMITIR ALERTA (ANTI DUPLICADO)
    // ================================

    if (level && entry.lastLevel !== level) {

      if (window.ACS_Alerts && typeof window.ACS_Alerts.push === "function") {

        window.ACS_Alerts.push({
          title: title,
          message: message,
          level: level,
          type: "hr",
          category: "salary",
          source: "HR Salary Engine"
        });

        console.log(
          "%cüíº SALARY ALERT",
          level === "danger" ? "color:#ff4040;font-weight:700" :
          level === "warning" ? "color:#ffae00;font-weight:700" :
                                "color:#00ccff;font-weight:700",
          dep.name,
          "Ratio:", ratio.toFixed(2),
          "Level:", level
        );

        entry.lastLevel = level;
      }
    }

  });

  ACS_HR_saveSalaryAlertTrack(track);
}

/* ============================================================
   üü¶ A3.6.3 ‚Äî MONTHLY TICK ‚Äî SALARY ALERT ENGINE
   ------------------------------------------------------------
   ‚Ä¢ Ejecuta disciplina salarial 1 vez por mes de juego
   ‚Ä¢ SOLO si Auto Salary est√° OFF
   ‚Ä¢ Compatible con Alerts Center
   ============================================================ */

let __HR_lastSalaryAlertMonth = null;

registerTimeListener((time) => {

  const year  = time.getUTCFullYear();
  const month = time.getUTCMonth();

  const key = `${year}-${month}`;

  if (__HR_lastSalaryAlertMonth === null) __HR_lastSalaryAlertMonth = key;

  if (key !== __HR_lastSalaryAlertMonth) {

    console.log(
      "%cüóì HR MONTH TICK ‚Äî SALARY ALERT CHECK",
      "color:#ffb300;font-weight:600",
      "Year:", year,
      "Month:", month + 1
    );

    ACS_HR_evaluateSalaryAlerts_Monthly();

    __HR_lastSalaryAlertMonth = key;
  }

});

/* ============================================================
   üü¶ A3.7.1 ‚Äî AUTO SALARY SETTINGS CORE (MASTER AUTHORITY)
   ------------------------------------------------------------
   ‚Ä¢ Define estado oficial de Auto Salary
   ‚Ä¢ Default ON al crear jugador
   ‚Ä¢ Punto √∫nico de lectura del sistema
   ============================================================ */

function ACS_HR_isAutoSalaryEnabled() {

  let flag = localStorage.getItem("ACS_AutoSalary");

  // üü¢ DEFAULT: ON si no existe a√∫n (jugador nuevo)
  if (!flag) {
    localStorage.setItem("ACS_AutoSalary", "ON");
    flag = "ON";

    console.log(
      "%c‚öô AUTO SALARY DEFAULT ENABLED",
      "color:#00ffcc;font-weight:700"
    );
  }

  return flag === "ON";
}

/* ============================================================
   üüß R5 ‚Äî ACTIVATE ALL "ADJUST SALARY" BUTTONS (ACS FINAL)
   ------------------------------------------------------------
   ‚Ä¢ Detecta cualquier click en bot√≥n con tooltip "Adjust Salary"
   ‚Ä¢ Obtiene el departamento real desde data-dep de la fila
   ‚Ä¢ Conecta directamente con el motor Salary: openSalaryInline(depId)
   ============================================================ */

document.addEventListener("click", (e) => {

  // Buscar bot√≥n Adjust Salary (por tooltip exacto)
  const btn = e.target.closest('[title="Adjust Salary"]');
  if (!btn) return;

  // Buscar depId en la fila contenedora o en el bot√≥n
  const row =
    btn.closest("[data-dep]") ||
    btn.closest("[data-depid]");

  const depId =
    btn.dataset.dep ||
    btn.dataset.depid ||
    row?.getAttribute("data-dep") ||
    row?.getAttribute("data-depid");

  if (!depId) {
    console.error("‚ùå SALARY CLICK ‚Äî depId NOT FOUND");
    console.log("Button:", btn);
    console.log("Row:", row);
    alert("Salary button clicked but department id not found.\nAdd data-dep='customers' (or correct id) to the row.");
    return;
  }

  // Verificar que el motor Salary existe
  if (typeof window.openSalaryInline !== "function") {
    console.error("‚ùå openSalaryInline() NOT FOUND ‚Äî OPS engine not loaded");
    alert("Salary engine not loaded.\nCheck script order and acs_department_ops_engine-2.js");
    return;
  }

  console.log(
    "%cüí∞ SALARY BUTTON ACTIVATED",
    "color:#00ffcc;font-weight:700",
    "Department:", depId
  );

  // üî• ABRIR SALARY REAL
  window.openSalaryInline(depId);

});
     
</script>

<script src="engine/acs_security_core.js?v=1"></script>
     
</body>
</html>
