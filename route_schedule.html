<!-- ============================================================
     === ROUTE SCHEDULE MODULE ‚Äî Qatar Luxury Edition ===========
     ------------------------------------------------------------
     Version:  v3.0 | Date: 09 DEC 2025
     ============================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Route Schedule - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons (A Confirmado) ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">

<style>
/* ============================================================
     === ROUTE SCHEDULE ‚Äî Qatar Luxury Edition CLEAN v1.1 ======
   ============================================================ */

body {
  margin: 0;
  background-color: #081530;
  color: white;
  font-family: "Poppins", sans-serif;
}

/* ============================================================
     === GLOBAL HEADER ‚Äî EXACT DASHBOARD COPY =================
   ============================================================ */

.acs-header {
  position: fixed;
  top: 0;
  width: 100%;
  backdrop-filter: blur(9px);
  background: rgba(12,23,50,0.45);
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffb300;
  z-index: 5000;
}

.acs-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.acs-left img {
  height: 46px;
}

.acs-left h1 {
  font-size: 1.15rem;
  margin: 0;
  color: #ffb300;
  letter-spacing: 0.5px;
}

.acs-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 2rem;
}

.acs-nav a {
  position: relative;
  font-size: 1rem;
  letter-spacing: 0.4px;
  color: #dbe4ff;
  text-decoration: none;
  transition: 0.25s ease;
  padding-bottom: 6px;
}

.acs-nav a:hover,
.acs-nav a.active {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.6);
}

.acs-nav a.active::after,
.acs-nav a:hover::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, #ffb300, #ffe7a0);
  border-radius: 2px;
  box-shadow: 0 0 8px rgba(255,200,60,0.45);
}

.acs-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.support-btn {
  padding: 0.45rem 1.1rem;
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  color: #8AB4FF;
  border: 1px solid rgba(138,180,255,0.45);
  background: rgba(138,180,255,0.08);
  backdrop-filter: blur(6px);
  transition: 0.25s ease;
}

.support-btn:hover {
  background: rgba(138,180,255,0.20);
  box-shadow: 0 0 14px rgba(138,180,255,0.55);
  color: #dfe9ff;
}

.logout-btn {
  padding: 0.45rem 1.1rem;
  border: 1px solid #ffb300;
  border-radius: 12px;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
}

.logout-btn:hover {
  background: #ffb300;
  color: #0c1f3c;
}

.acs-clock-header {
  font-family: "Orbitron", monospace;
  padding: 0.4rem 0.8rem;
  background: rgba(0,255,128,0.08);
  border-radius: 8px;
  font-size: 0.95rem;
  color: #00ff80;
}

/* ============================================================
     === MAIN CONTENT ==========================================
   ============================================================ */

.acs-main {
  padding: 105px 2rem 70px;
  max-width: 900px;
  margin: 0 auto;
  text-align: center;
}

h2 {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.4);
}

.sub {
  color: #cbd6ff;
  margin-bottom: 2.2rem;
}

/* ============================================================
     === CENTRAL CARD ‚Äî Qatar Luxury ===========================
   ============================================================ */

.schedule-container {
  background: linear-gradient(180deg, rgba(20,35,70,0.75), rgba(10,18,40,0.85));
  border-radius: 22px;
  padding: 1.8rem 2rem;
  box-shadow: 0 8px 32px rgba(0,0,0,0.42);
  border: 1px solid rgba(255,179,0,0.18);
  margin-bottom: 3rem;
  text-align: left;
}

/* ============================================================
     === FORM ELEMENTS ‚Äî CLEANED ===============================
   ============================================================ */

label {
  display: block;
  margin-top: 1rem;
  font-weight: 600;
  color: #ffb300;
}

input, select {
  width: 100%;
  padding: 0.7rem;
  margin-top: 0.3rem;
  border-radius: 12px;
  border: 1px solid rgba(255,179,0,0.18);
  background: #0c1a34;
  color: #fff;
  font-size: 1rem;
  transition: 0.2s;
  outline: none;
}

input:focus, select:focus {
  border-color: #ffca50;
  box-shadow: 0 0 8px rgba(255,200,60,0.45);
}

/* Origen/Destino ‚Äî readonly */
input[readonly] {
  background: #0a1530;
  opacity: 0.85;
  cursor: not-allowed;
}

/* Clean Aircraft select ‚Äî FIXED (all aircraft visible) */
select#aircraft option {
  display: block;
}

/* Checkboxes cockpit ACS */
input[type="checkbox"] {
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 6px;
  border: 2px solid #3a4a7a;
  background-color: #1e2b55;
  cursor: pointer;
  position: relative;
  transition: all 0.2s ease;
}

input[type="checkbox"]:checked {
  background-color: #00a86b;
  border-color: #00a86b;
}

input[type="checkbox"]:checked::after {
  content: "‚úî";
  color: white;
  position: absolute;
  top: -3px;
  left: 3px;
  font-size: 0.85rem;
}

.days-row {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 14px;
  margin-top: 0.8rem;
}

.divider {
  border: none;
  height: 1px;
  background: linear-gradient(to right, rgba(255,200,60,0.7), rgba(255,200,60,0.3));
  margin: 1.4rem 0;
}

/* ============================================================
     === TECH PANEL ============================================
   ============================================================ */

.tech-list {
  margin-top: 1.5rem;
  background: rgba(10,18,40,0.8);
  border-radius: 16px;
  padding: 1rem 1.2rem;
  border: 1px solid rgba(255,179,0,0.22);
  box-shadow: 0 4px 22px rgba(0,0,0,0.35);
}

.tech-item {
  display: flex;
  justify-content: space-between;
  padding: 0.45rem 0;
  border-bottom: 1px solid rgba(255,255,255,0.07);
  color: #d7e2ff;
}

.tech-item span {
  color: #ffb300;
  font-weight: 600;
}
     
/* üÖ∞Ô∏è1 ‚Äî ALIGN RIGHT FOR TECH VALUES ‚Äî v1.0 | 09 DEC 2025 */
.tech-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tech-item span {
    margin-left: auto;
    text-align: right;
    min-width: 120px;   /* asegura columna derecha alineada */
    display: inline-block;
}
     
/* ============================================================
     === BUTTONS ===============================================
   ============================================================ */

.acs-btn {
  display: block;
  background: #00a86b;
  color: #fff;
  padding: 0.8rem 1.5rem;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  margin: 1.5rem auto 0.8rem;
  transition: 0.2s ease;
  border: none;
}

.acs-btn:hover {
  background: #00794f;
}

.back-btn {
  display: block;
  margin: 0 auto 0.5rem;
  color: #00a86b;
  background: none;
  border: 1px solid #00a86b;
  border-radius: 10px;
  padding: 0.45rem 1.2rem;
  cursor: pointer;
  transition: 0.2s;
}

.back-btn:hover {
  background: #00a86b;
  color: #081530;
}

.result {
  margin-top: 1rem;
  background: #0b1838;
  padding: 1rem;
  border-radius: 14px;
  color: #cbd6ff;
}

.status-line {
  margin-top: 0.8rem;
  font-weight: 600;
  text-align: center;
}

.status-ok { color: #00ff80; }
.status-warning { color: #ffd54f; }

footer {
  text-align: center;
  padding: 20px;
  color: #7c8bb8;
  font-size: 0.9rem;
  margin-top: 40px;
}
</style>
</head>

<body>

<header class="acs-header">
  <div class="acs-left">
    <img src="acs_logo.png" alt="ACS Logo">
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="finance.html">Finance</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html" class="active">Routes</a>
    <a href="hr.html">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 2025</div>
  </div>
</header>

<main class="acs-main">

  <h2>üß≠ Route Schedule Setup</h2>
  <p class="sub">Plan and evaluate your route performance based on technical parameters and operational constraints.</p>

  <div class="schedule-container">

    <!-- ORIGEN Y DESTINO ‚Äî Limpios y bloqueados -->
    <label>Origin (ICAO)</label>
    <input type="text" id="origin" readonly />

    <label>Destination (ICAO)</label>
    <input type="text" id="destination" readonly />

    <!-- N√∫mero de vuelo ‚Äî VAC√çO, motor intacto pero no se ejecuta -->
       
    <label>Flight Number (Auto)</label>
    <input type="text" id="flightNumber" readonly />

    <!-- Aircraft limpia -->
       
    <label>Aircraft Type</label>
       
    <!-- A2: se a√±ade autoGenerateFlightNumber al onchange -->
       
    <select id="aircraft" onchange="autoCalculate(); autoGenerateFlightNumber();">
  <option value="">-- Select Aircraft --</option>
</select>

<script>
     
/* ============================================================
   üîµ ROUTE SCHEDULE ‚Äî LOAD AIRCRAFT BY ID (FINAL)
   ============================================================ */

document.addEventListener("DOMContentLoaded", loadAircraftById);

function loadAircraftById() {

  const origin = document.getElementById("origin").value.trim();
  const sel = document.getElementById("aircraft");

  sel.innerHTML = `<option value="">-- Select Aircraft --</option>`;

  const fleet = JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");

  const available = fleet.filter(ac =>
    ac.status === "Active" &&
    ac.base === origin
  );

  available.forEach(ac => {
    const opt = document.createElement("option");

    opt.value = ac.id; // üî• aircraftId
    opt.textContent = `${ac.model} ¬∑ ${ac.registration}`;

    // Guardamos datos t√©cnicos SOLO para c√°lculo visual
    opt.dataset.speed    = ac.speed;
    opt.dataset.range    = ac.range;
    opt.dataset.category = ac.category;

    sel.appendChild(opt);
  });
}
</script>

    <label>Departure Time (Local)</label>
    <!-- A2: se a√±ade autoGenerateFlightNumber al onchange -->
    <select id="departureTime" onchange="autoCalculate(); autoGenerateFlightNumber();"></select>

    <label style="text-align:center;margin-top:1.2rem;">Days of Operation</label>
    <div class="days-row">
      <label><input type="checkbox" id="everyDay" onchange="toggleEveryDay()"> Every Day</label>
      <label><input type="checkbox" id="mon"> Mo</label>
      <label><input type="checkbox" id="tue"> Tu</label>
      <label><input type="checkbox" id="wed"> We</label>
      <label><input type="checkbox" id="thu"> Th</label>
      <label><input type="checkbox" id="fri"> Fr</label>
      <label><input type="checkbox" id="sat"> Sa</label>
      <label><input type="checkbox" id="sun"> Su</label>
    </div>

    <hr class="divider" />

    <div class="options-center" style="text-align:center;">
      <label><input type="checkbox" id="separateDays"> Create each day as a separate route</label>
    </div>

    <hr class="divider" />

    <div class="options-center" style="text-align:center;">
      <label><input type="checkbox" id="optimizeRotation" onchange="toggleOptimization()"> Optimize Rotation (avoid delay & maintenance conflict)</label>
    </div>

    <div id="techData" class="tech-list" style="display:none;">
      <div class="tech-item">Distance (NM): <span id="distance">--</span></div>
      <div class="tech-item">Block Time: <span id="blockTime">--</span></div>
      <div class="tech-item">Turnaround Time: <span id="turnaround">--</span></div>
      <div class="tech-item">Total Rotation: <span id="totalRotation">--</span></div>
      <div class="tech-item">Delay Risk (%): <span id="delayRisk">--</span></div>
      <div class="tech-item">Efficiency Index (%): <span id="effIndex">--</span></div>
    </div>

    <div class="result" id="result"></div>
    <div id="optStatus" class="status-line"></div>

    <button class="acs-btn" onclick="confirmRoute()">CONFIRM ROUTE</button>
    <button class="back-btn" onclick="window.location.href='routes.html'">‚¨Ö Back to Routes</button>
  </div>
</main>

<footer>¬© 2025 Aviation Capital Simulator. All rights reserved.</footer>

<!-- ============================================================
     === JAVASCRIPT ORIGINAL ‚Äî MOTOR INTACTO ===================
   ============================================================ -->


<script>

/* ============================================================
   === BASE: GENERAR HORARIOS DE SALIDA ========================
   ============================================================ */
     
const timeSelect = document.getElementById("departureTime");
for (let h = 6; h < 24; h++) {
  for (let m = 0; m < 60; m += 5) {
    const hh = String(h).padStart(2,"0");
    const mm = String(m).padStart(2,"0");
    const opt = document.createElement("option");
    opt.value = `${hh}:${mm}`;
    opt.textContent = `${hh}:${mm}`;
    timeSelect.appendChild(opt);
  }
}
timeSelect.value = "06:00";

function toggleEveryDay() {
  const all = document.getElementById("everyDay").checked;
  ["mon","tue","wed","thu","fri","sat","sun"].forEach(id => {
    document.getElementById(id).checked = all;
  });
}

function toggleOptimization() {
  window.rotationOptimized = document.getElementById("optimizeRotation").checked;
}

function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}

/* üü¶ A4 ‚Äî ROUTE SCHEDULE: Auto Flight Number AFTER selecting aircraft */
     
function autoGenerateFlightNumber() {

    if (!userIATA || userIATA.length !== 2) return;

    const origin = document.getElementById("origin").value.trim();
    const dest   = document.getElementById("destination").value.trim();
    const ac     = document.getElementById("aircraft").value;

    if (!origin || !dest || !ac) return;

    const pair = generateFlightPair();
    if (flightNumberInput) {
        flightNumberInput.value = `${pair.out} ‚ûú ${pair.inn}`;
    }
}

/* ============================================================
   üü¶ FLIGHT NUMBER ENGINE ‚Äî IATA CONNECTED v1.1 (COMPLETO)
   ============================================================ */

// Input del n√∫mero de vuelo
const flightNumberInput = document.getElementById("flightNumber");

// Traer IATA guardado en create_airline
let userIATA = localStorage.getItem("userIATA") || "AT";
if (!localStorage.getItem("userIATA")) {
  console.warn("‚ö†Ô∏è No userIATA found ‚Äî using default AT");
}

// Contadores globales
let lastFlightNumber = parseInt(
  localStorage.getItem("lastFlightNumber") || "100",
  10
);
let usedFlights = JSON.parse(
  localStorage.getItem("flightNumbers") || "[]"
);

/* ============================================================
   üüß A3 ‚Äî Safe Flight Pair Generator (OUT ‚Üí IN)
   ============================================================ */
function generateFlightPair() {

  let num  = lastFlightNumber;
  let out  = `${userIATA}${num}`;
  let inn  = `${userIATA}${num + 1}`;

  // Evitar n√∫meros ya usados
  while (usedFlights.includes(out) || usedFlights.includes(inn)) {
    num += 2;
    out = `${userIATA}${num}`;
    inn = `${userIATA}${num + 1}`;
  }

  // Actualizar el contador global
  lastFlightNumber = num;

  // Pintar en input
  if (flightNumberInput) {
    flightNumberInput.value = `${out} ‚ûú ${inn}`;
  }

  return { out, inn };
}

/* ============================================================
   üü¶ AUTO-GENERATE FLIGHT NUMBER (LLAMADO DESDE EL SELECT)
   ============================================================ */
function autoGenerateFlightNumber() {

  // Necesitamos IATA v√°lido
  if (!userIATA || userIATA.length !== 2) {
    console.warn("‚ùå IATA code missing or invalid");
    return;
  }

  const origin = document.getElementById("origin").value.trim();
  const dest   = document.getElementById("destination").value.trim();
  const ac     = document.getElementById("aircraft").value;

  // Solo generar si todo est√° seleccionado
  if (!origin || !dest || !ac) return;

  // Generamos nueva pareja OUT/IN
  const pair = generateFlightPair();

  if (flightNumberInput) {
    flightNumberInput.value = `${pair.out} ‚ûú ${pair.inn}`;
  }
}

/* ============================================================
   üü¶ FLIGHT NUMBER UTILITIES (NO TOCAR)
   ============================================================ */

function bumpFlightCounter() {
  lastFlightNumber += 2;
  localStorage.setItem("lastFlightNumber", String(lastFlightNumber));
}

function markNumbersUsed(out, inn) {
  usedFlights.push(out, inn);
  localStorage.setItem("flightNumbers", JSON.stringify(usedFlights));
}

function freeNumbers(out, inn) {
  if (!out || !inn) return;
  usedFlights = usedFlights.filter(n => n !== out && n !== inn);
  localStorage.setItem("flightNumbers", JSON.stringify(usedFlights));
}

/* ============================================================
   === PHASE 2.1 ‚Äî CREATION vs EDIT ============================
   ============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  const originInput = document.getElementById("origin");
  const destInput   = document.getElementById("destination");

  const editID = localStorage.getItem("editFlightID");
  const isEditing = !!editID;

  /* ----------------- MODO CREACI√ìN ----------------- */
     
  if (!isEditing) {

    const selOrigin = (localStorage.getItem("ACS_selectedOrigin") || "").toUpperCase();
    const selDest   = (localStorage.getItem("ACS_selectedDestination") || "").toUpperCase();

    originInput.value = selOrigin || originInput.value;
    destInput.value   = selDest   || destInput.value;

    originInput.readOnly = true;
    destInput.readOnly   = true;

    localStorage.removeItem("ACS_selectedOrigin");
    localStorage.removeItem("ACS_selectedDestination");

    /* üü¶ CARGAR FLOTA ACTIVA */
    loadAvailableAircraft();

    /* üü¶ Recalcular al cambiar avi√≥n */
    document.getElementById("aircraft").addEventListener("change", autoCalculate);

    autoGenerateFlightNumber();
    return;
}


  /* ------------------ MODO EDICI√ìN ------------------ */
     
  const items = JSON.parse(localStorage.getItem("scheduleItems") || "[]");
  const flight = items.find(f => f.id === editID || f.blockId === editID);
  if (!flight) return;

  const $ = id => document.getElementById(id);

  $("origin").value       = flight.origin || "";
  $("destination").value  = flight.destination || "";
  $("aircraft").value     = flight.acType || "";
  $("departureTime").value = flight.departure || "06:00";

  loadAvailableAircraft();
  document.getElementById("aircraft").addEventListener("change", autoCalculate);
     
  (flight.days || []).forEach(d => {
    if (document.getElementById(d)) document.getElementById(d).checked = true;
  });

  $("origin").readOnly      = true;
  $("destination").readOnly = true;

  const notice = document.createElement("div");
  notice.style.color = "#FFB300";
  notice.style.marginBottom = "1rem";
  notice.style.fontWeight = "600";
  notice.innerHTML = `‚úèÔ∏è Editing flight: <strong>${flight.origin} ‚ûú ${flight.destination}</strong>`;
  document.querySelector(".schedule-container").prepend(notice);

  if (flight.flightNumberOut && flight.flightNumberIn) {
    freeNumbers(flight.flightNumberOut, flight.flightNumberIn);
  }

  generateFlightPair();

  const btn = document.querySelector(".acs-btn");
  btn.textContent = "UPDATE FLIGHT";

  btn.onclick = () => {
    const origin = $("origin").value.trim();
    const destination = $("destination").value.trim();
    const aircraft = $("aircraft").value;
    const departure = $("departureTime").value;
    const optimized = document.getElementById("optimizeRotation")?.checked || false;
    const DAY_IDS = ["mon","tue","wed","thu","fri","sat","sun"];
    const selectedDays = DAY_IDS.filter(id => document.getElementById(id)?.checked);

    if (!origin || !destination || !aircraft || !departure || selectedDays.length === 0) {
      alert("‚ö†Ô∏è Please complete all fields before updating.");
      return;
    }

    const updatedList = items.filter(f => f.id !== editID && f.blockId !== editID);
    localStorage.setItem("scheduleItems", JSON.stringify(updatedList));

    const rawFN = (flightNumberInput.value || "");
    const match = rawFN.match(/^([A-Z]{2}\d+).*?([A-Z]{2}\d+)$/) || [];
    const flightOut = match[1] || null;
    const flightIn  = match[2] || null;

    const updatedRoute = {
      origin, destination, aircraft, departure,
      optimized, days: selectedDays,
      flightNumberOut: flightOut,
      flightNumberIn: flightIn
    };

    localStorage.setItem("confirmedRoute", JSON.stringify(updatedRoute));
    markNumbersUsed(flightOut, flightIn);
    bumpFlightCounter();

    localStorage.removeItem("editFlightID");
    alert("‚úÖ Flight updated.");
    window.location.href = "schedule_table.html";
  };
});

/* ============================================================
   üîµ A ‚Äî LOAD AVAILABLE AIRCRAFT (NO REGISTRATIONS)
   ============================================================ */

function loadAvailableAircraft() {

  const origin = (document.getElementById("origin").value || "").trim();
  const select = document.getElementById("aircraft");

  select.innerHTML = `<option value="">-- Select Aircraft --</option>`;

  const fleet = JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");

  // üî• SOLO AVIONES ACTIVOS Y BASADOS EN EL ORIGEN
  const filtered = fleet.filter(ac =>
      ac.status === "Active" && ac.base === origin
  );

  // üî• SOLO MODELOS √öNICOS
  const uniqueModels = [...new Set(filtered.map(ac => ac.model))];

  uniqueModels.forEach(model => {
      const ac = filtered.find(f => f.model === model);

      const opt = document.createElement("option");

      // ‚úî CLAVE √öNICA = MODELO (NO MATR√çCULA)
      opt.value = model;
      opt.textContent = model;

      // ‚úî DATOS T√âCNICOS
      opt.dataset.model    = ac.model;
      opt.dataset.brand    = ac.brand || ac.manufacturer || "";
      opt.dataset.category = ac.category || "";
      opt.dataset.speed    = ac.speed || 440;
      opt.dataset.range    = ac.range || 1500;

      // ‚ùå ELIMINADO: matr√≠cula, reg, registration
      // opt.dataset.registration = ac.registration;

      select.appendChild(opt);
  });
}

/* ============================================================
   === GLOBAL DISTANCE ENGINE ‚Äî FIX v2 (NM)
   ------------------------------------------------------------
   Evita error: "Can't find variable: distanceNM"
   ============================================================ */
     
function distanceNM(lat1, lon1, lat2, lon2) {

    const R = 3440.065; // Earth radius in NM
    const toRad = x => (x * Math.PI) / 180;

    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);

    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) ** 2;

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return Math.round(R * c);
}
     
/* ============================================================
   üü¶ FASE 2 ‚Äî TECH ENGINE (Distance / Time / Cost / Crew)
   ============================================================ */

// 1) Distancia (NM)
function rs_getDistanceNM(origin, dest) {
  if (!origin || !dest) return 0;
  let O = null, D = null;

  for (const cont in WorldAirportsACS) {
    const list = WorldAirportsACS[cont];
    if (!Array.isArray(list)) continue;
    O = O || list.find(a => a.icao === origin);
    D = D || list.find(a => a.icao === dest);
  }

  if (!O || !D) return 0;
  return distanceNM(O.latitude, O.longitude, D.latitude, D.longitude);
}

// 2) Block Time
     
function rs_getBlockTime(distance, speed) {
  if (!distance || !speed) return 0;
  const cruise = distance / speed;
  const climbDesc = 0.25;
  return Math.round((cruise + climbDesc) * 60);
}

// 3) Turnaround
     
/* ============================================================
   üõ´ TURNAROUND REAL (1940‚Äì2026) ‚Äî FINAL v4
   ============================================================ */
     
function rs_getTurnaround(category) {

    if (!category) return 45; // default seguro

    const c = category.toUpperCase();

    // ============================
    // 1) LIGHT / SMALL (DC-3, Cessna, Beech)
    // ============================
    if (c.includes("SMALL") || c.includes("LIGHT") ||
        c.includes("DC-3") || c.includes("PIPER") || c.includes("CESSNA")) {
        return 35;  
    }

    // ============================
    // 2) TURBOPROP / ATR / Regional Early
    // ============================
    if (c.includes("ATR") || c.includes("TURBO") ||
        c.includes("REGIONAL")) {
        return 45;
    }

    // ============================
    // 3) Narrow-body Jets (A320, 737, 727, MD-80, Tu-154)
    // ============================
    if (c.includes("NARROW") || 
        c.includes("A320") || c.includes("A318") || c.includes("A319") ||
        c.includes("A321") ||
        c.includes("737")  || c.includes("727")  ||
        c.includes("MD-80") || c.includes("TU-154") || c.includes("DC-9")) {
        return 50;
    }

    // ============================
    // 4) Wide-body Jets (A300, A310, 767, L-1011, DC-10, 787)
    // ============================
    if (c.includes("WIDE")  ||
        c.includes("A300")  || c.includes("A310") ||
        c.includes("767")   || c.includes("787")  ||
        c.includes("L-1011") || c.includes("DC-10")) {
        return 60;
    }

    // ============================
    // 5) Large Heavy Jets (747, A340, DC-8, 707)
    // ============================
    if (c.includes("HEAVY") ||
        c.includes("747") || c.includes("A340") ||
        c.includes("707") || c.includes("DC-8")) {
        return 75;
    }

    // ============================
    // 6) A380 (Ultra Heavy)
    // ============================
    if (c.includes("A380")) {
        return 90;
    }

    // Default
    return 50;
}
     
/* ============================================================
   üü¶ OPTIMIZATION BUFFER ‚Äî FINAL v2
   ============================================================ */
     
function rs_getOptimizedTurnaround(baseTurn, category) {
    if (!document.getElementById("optimizeRotation").checked) {
        return baseTurn; // sin optimizaci√≥n
    }

    const c = (category || "").toUpperCase();

    // Light / Small
    if (c.includes("SMALL") || c.includes("DC-3") || c.includes("PIPER")) {
        return baseTurn + 10;
    }

    // Turboprop / Regional
    if (c.includes("ATR") || c.includes("TURBO") || c.includes("REGIONAL")) {
        return baseTurn + 10;
    }

    // Narrow-body
    if (c.includes("A320") || c.includes("737") || c.includes("MD-80") || c.includes("TU-154")) {
        return baseTurn + 15;
    }

    // Wide-body
    if (c.includes("A300") || c.includes("767") || c.includes("DC-10") || c.includes("L-1011")) {
        return baseTurn + 20;
    }

    // Heavy / 747 / DC-8 / 707
    if (c.includes("747") || c.includes("A340") || c.includes("707") || c.includes("DC-8")) {
        return baseTurn + 25;
    }

    // A380
    if (c.includes("A380")) {
        return baseTurn + 30;
    }

    return baseTurn + 15;
}

// 4) Fuel
     
function rs_getFuelBurn(category) {
  if (!category) return 2400;
  const c = category.toUpperCase();
  if (c.includes("ATR")) return 900;
  if (c.includes("REGIONAL")) return 1800;
  return 2500;
}

// 5) Crew
function rs_getCrewNeeded(category) {
  const c = (category || "").toUpperCase();
  if (c.includes("ATR")) return { pilots: 2, cabin: 2 };
  if (c.includes("REGIONAL")) return { pilots: 2, cabin: 2 };
  return { pilots: 2, cabin: 3 };
}

// 6) Costos
function rs_getTripCost(distance, blockMin, category) {
  const fuelKG = rs_getFuelBurn(category) * (blockMin / 60);
  const fuelCost = fuelKG * 0.85;
  return {
    fuelCost: Math.round(fuelCost),
    handling: 350,
    maintenance: 180,
    total: Math.round(fuelCost + 350 + 180)
  };
}

/* ============================================================
   üõ´ ACS RANGE CHECK ‚Äî SIMPLE & REALISTIC v2.0
   ============================================================ */
/*
    REGLAS:
    - Hasta (range - 15 NM) ‚Üí sin penalizaci√≥n (normal ops)
    - De (range - 15) a range ‚Üí penalizaci√≥n proporcional (m√°x 35%)
    - > range ‚Üí NO permitido
*/
function ACS_checkRangeSimple(distNM, publishedRange) {

    if (!distNM || !publishedRange) {
        return { ok: true, penalty: 0, msg: "No range data" };
    }

    // Nuevo rango libre sin penalizaci√≥n
    const freeLimit = publishedRange - 15;   // Ej: 510 ‚Üí 495

    // üü© 1) Perfectamente dentro del rango operativo
    if (distNM <= freeLimit) {
        return {
            ok: true,
            penalty: 0,
            msg: "‚úî Within safe operational range"
        };
    }

    // üü® 2) Cerca del l√≠mite ‚Üí penalizaci√≥n suave
    if (distNM <= publishedRange) {

        const ratio = (distNM - freeLimit) / (publishedRange - freeLimit);  // 0 ‚Üí 1 lineal
        const penalty = Math.min(0.35, ratio);  // M√°ximo 35%

        return {
            ok: true,
            penalty,
            msg: `‚ö† Near max range ‚Äî payload reduced by ${(penalty * 100).toFixed(0)}%`
        };
    }

    // üü• 3) Excedido ‚Üí no permitido
    return {
        ok: false,
        penalty: 1,
        msg: "‚ùå Route exceeds aircraft maximum published range"
    };
}

     
/* ============================================================
   üü¶ C) CREW ENGINE ‚Äî Reemplazo para Route Schedule
   ------------------------------------------------------------
   Usa ACS_CrewEngine.getCrewFromDatabase(modelo_exacto)
   ============================================================ */

/**
 * Devuelve crew REAL a partir del REG del avi√≥n seleccionado.
 * Entrada: registration (ej: "N123AA")
 * Salida: { pilots, flight_engineers, navigators, radio_ops, cabin, total }
 */
function rs_getCrewReal(registration) {

  // Fallback universal si algo falla
  const fallback = {
    pilots: 2,
    flight_engineers: 0,
    navigators: 0,
    radio_ops: 0,
    cabin: 2,
    total: 4
  };

  if (!registration) return fallback;

  // Obtener flota
  const fleet = JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");
  const ac = fleet.find(a => a.registration === registration);

  if (!ac || !ac.model) return fallback;

  // Crew REAL seg√∫n el modelo exacto (A300, Tu-154, DC-10, MD-80, Do328‚Ä¶)
  try {
    return ACS_CrewEngine.getCrewFromDatabase(ac.model);
  } catch (e) {
    console.warn("CrewEngine error:", e);
    return fallback;
  }
}

// üõ†Ô∏è A2 ‚Äî MODEL NORMALIZER ‚Äî v1.0
// Normaliza cualquier modelo a formato seguro
     
function normalizeModel(model) {
    if (!model) return "";
    return model
        .normalize("NFKC")        // corrige Unicode raro
        .replace(/\s+/g, " ")     // colapsa espacios m√∫ltiples
        .replace(/\u00A0/g, " ")  // elimina espacios no separables
        .trim();                  // limpia izquierda/derecha
}
     
/* ============================================================
   üîµ B ‚Äî AUTO CALCULATE (NO REGISTRATIONS)
   ============================================================ */

function autoCalculate() {

  const origin = document.getElementById("origin").value.trim();
  const dest   = document.getElementById("destination").value.trim();
  const aircraftId = document.getElementById("aircraft").value;

  if (!origin || !dest || !aircraftId) {
    document.getElementById("techData").style.display = "none";
    return;
  }

  const fleet = JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");
  const ac = fleet.find(a => a.id === aircraftId);

  if (!ac) {
    console.warn("Aircraft not found:", aircraftId);
    return;
  }

  const speed    = ac.speed || 440;
  const category = ac.category || "";
  const range    = ac.range || 1500;


    // üîπ Distancia
    const distNM = rs_getDistanceNM(origin, dest);

    // üîπ Block time
    const block = rs_getBlockTime(distNM, speed);

    // üîπ Turnaround
    const baseTurn = rs_getTurnaround(category);
    const optimizeON = document.getElementById("optimizeRotation")?.checked || false;

    const optTurn = optimizeON
        ? rs_getOptimizedTurnaround(baseTurn, category)
        : baseTurn;

    const totalBase = block + baseTurn + block;
    const totalOpt  = block + optTurn  + block;

    // üî• Mostrar bloque t√©cnico
    document.getElementById("techData").style.display = "block";

    document.getElementById("distance").textContent = distNM;
    document.getElementById("blockTime").textContent =
        `${Math.floor(block/60)}h ${block%60}m`;

    if (!optimizeON) {
        document.getElementById("turnaround").innerHTML = `${baseTurn} min`;
    } else {
        document.getElementById("turnaround").innerHTML =
            `${baseTurn} min<br><span style="color:#ffd54f">Optimized: ${optTurn} min</span>`;
    }

    if (!optimizeON) {
        document.getElementById("totalRotation").innerHTML =
            `${Math.floor(totalBase/60)}h ${totalBase%60}m`;
    } else {
        document.getElementById("totalRotation").innerHTML =
            `${Math.floor(totalBase/60)}h ${totalBase%60}m<br>
             <span style="color:#ffd54f">Optimized: ${Math.floor(totalOpt/60)}h ${totalOpt%60}m</span>`;
    }

    document.getElementById("delayRisk").textContent = "3%";
    document.getElementById("effIndex").textContent  = "90%";

    // Guardar para confirmRoute
    window.ACS_RouteTechData = {
        distNM,
        blockMin: block,
        turnMin: baseTurn,
        turnMinOptimized: optTurn,
        totalMin: optimizeON ? totalOpt : totalBase
    };
}

/* ============================================================
   üîµ D ‚Äî ROUTE SCHEDULE EVENT LINKER ‚Äî FINAL VERSION
   ============================================================
   Mantiene toda la l√≥gica viva al cambiar:
   ‚Ä¢ Avi√≥n (model)
   ‚Ä¢ Hora de salida
   ‚Ä¢ Optimized Rotation
   ‚Ä¢ Reload / Safari FIX
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {

    const acSel  = document.getElementById("aircraft");
    const depSel = document.getElementById("departureTime");
    const optBox = document.getElementById("optimizeRotation");

    /* üîπ Evento: cambio de avi√≥n */
    if (acSel) {
        acSel.addEventListener("change", () => {
            autoCalculate();                       // üî• recalcular
            autoGenerateFlightNumber();            // üî• regenerar OUT/IN
        });
    }

    /* üîπ Evento: cambio de hora */
    if (depSel) {
        depSel.addEventListener("change", () => {
            autoCalculate();
        });
    }

    /* üîπ Evento: activar Optimized Rotation */
    if (optBox) {
        optBox.addEventListener("change", () => {
            autoCalculate();
        });
    }

    /* ========================================================
       üîπ SAFARI / CHROME RELOAD FIX
       Al recargar, el avi√≥n queda seleccionado,
       pero sin recalcular. Aqu√≠ se recalcula SOLO si
       hay modelo seleccionado.
       ======================================================== */
    setTimeout(() => {
        const model = acSel?.value || "";
        if (model) {
            autoCalculate();
            autoGenerateFlightNumber();
        }
    }, 60);
});

/* ============================================================
   === CONFIRM ROUTE (ACS v5 ‚Äî Qatar Luxury Edition) ==========
   === Integrado con SLOT ENGINE interno ======================
   ============================================================ */
     
function confirmRoute() {
 /* ================================
   1. Capturar valores del formulario
   ================================ */
const aircraft  = document.getElementById("aircraft").value;
const origin    = document.getElementById("origin").value;
const destination = document.getElementById("destination").value;
const departure = document.getElementById("departureTime").value;   // ‚úÖ FIX
const blockTimeMin = parseInt(ACS_RouteTechData.blockMin, 10);      // ‚úÖ FIX

const flightNumberOut = window.currentFN_Out || null;
const flightNumberIn  = window.currentFN_In  || null;

 /* ================================
   2. Capturar d√≠as seleccionados
   ================================ */

const DAY_IDS = ["mon","tue","wed","thu","fri","sat","sun"];
let days = DAY_IDS.filter(id => document.getElementById(id)?.checked);

// Si el jugador marc√≥ "Every Day" ‚Üí forzar los 7 d√≠as
if (document.getElementById("everyDay")?.checked) {
    days = ["mon","tue","wed","thu","fri","sat","sun"];
}

if (days.length === 0) {
    alert("Please select at least one day.");
    return;
}

  /* ================================
     3. C√°lculo de hora de llegada
     ================================ */
     
  const [depH, depM] = departure.split(":").map(Number);
  const arrivalTotalMin = depH * 60 + depM + blockTimeMin;
  const arrH = Math.floor(arrivalTotalMin / 60) % 24;
  const arrM = arrivalTotalMin % 60;
  const arrival = `${String(arrH).padStart(2, "0")}:${String(arrM).padStart(2, "0")}`;

  /* ================================
     4. ID √∫nico ACS
     ================================ */
  const routeId = "RT_" + Math.floor(100000 + Math.random() * 900000);

  /* ================================
     5. Crear estructura de ruta ACS v5
     ================================ */
     
 const aircraftId = document.getElementById("aircraft").value;

if (!aircraftId || !aircraftId.startsWith("AC_")) {
  alert("Please select a valid aircraft.");
  return;
}

const newRoute = {
  id: routeId,
  aircraftId: aircraftId,      // üî• √öNICO
  origin,
  destination,
  departure,
  arrival,
  blockTimeMin,
  days,
  flightNumberOut,
  flightNumberIn,
  type: "flight"
};
    
/* ============================================================
   FIX ‚Äî FORCE MODELKEY FOR SCHEDULE TABLE
   ============================================================ */

const aircraftRaw = document.getElementById("aircraft").value || "";
const modelKey = aircraftRaw.trim().toUpperCase();

// STOP si no hay modelo
if (!modelKey) {
    alert("Please select an aircraft.");
    return;
}

// Injerta el modelo corregido en newRoute
newRoute.modelKey = modelKey;

// Normaliza campos que la Table NECESITA
newRoute.aircraft = modelKey;
newRoute.type = "flight";                 
newRoute.blockId = "block-" + Date.now(); 
     
  /* ============================================================
     === SLOT ENGINE ‚Äî Integrado correctamente ==================
     ============================================================ */
  function ACS_convertDepartureToArrival(dep, blockMin) {
    if (!dep || !blockMin) return "00:00";
    const [h, m] = dep.split(":").map(Number);
    const total = h * 60 + m + blockMin;
    const ah = String(Math.floor(total / 60) % 24).padStart(2, "0");
    const am = String(total % 60).padStart(2, "0");
    return `${ah}:${am}`;
  }

  const slotRoute = {
    origin: newRoute.origin,
    destination: newRoute.destination,
    weekdays: newRoute.days,
    departureUTC: newRoute.departure,
    arrivalUTC: ACS_convertDepartureToArrival(
      newRoute.departure,
      newRoute.blockTimeMin
    )
  };

  const slotsCreated = ACS_buildSlotsForRoute(slotRoute);

  if (!slotsCreated || slotsCreated.length === 0) {
    alert("‚ö†Ô∏è Slots could not be generated. Check schedule.");
    return;
  }

  const success = ACS_bookRoute(slotRoute);

  if (!success) {
    alert("‚ùå Route cannot be created. Slot unavailable.");
    return;
  }

    /* ============================================================
     6. FINANCE FEE ‚Äî Slot Confirmation (ACS Engine)
     ============================================================ */
  if (typeof ACS_finance_chargeSlotConfirmFee === "function") {
    ACS_finance_chargeSlotConfirmFee(newRoute);
  }

  /* ============================================================
   7. SAVE ‚Äî ROUTE (aircraftId architecture)
   ============================================================ */

// Guardar ruta activa (opcional, para handoff inmediato)
localStorage.setItem("confirmedRoute", JSON.stringify(newRoute));

// Guardar en Schedule Table (source of truth)
const list = JSON.parse(localStorage.getItem("scheduleItems") || "[]");
list.push(newRoute);
localStorage.setItem("scheduleItems", JSON.stringify(list));


  /* ============================================================
     8. Flight Number Management
     ============================================================ */
  markNumbersUsed(newRoute.flightNumberOut, newRoute.flightNumberIn);
  bumpFlightCounter();

  /* ============================================================
     9. Final
     ============================================================ */
  alert("Route successfully added to Schedule.");
  window.location.href = "schedule_table.html";

} // ‚Üê cierre correcto de confirmRoute()

</script>

<!-- ===========================================================
     üü¶ ACS SCRIPT ORDER ‚Äî ROUTE SCHEDULE (FINAL v1.0)
     -----------------------------------------------------------
     ESTE ORDEN ES OBLIGATORIO PARA QUE LOS 4000+ AEROPUERTOS
     SE CARGUEN SIN ERRORES. NO CAMBIARLO NUNCA.
     =========================================================== -->

<!-- 1) ENGINE BASES -->
<script src="./time_engine.js"></script>
<script src="./engine/acs_crew_engine.js"></script>
<script src="./engine/acs_finance.js"></script>

<!-- 1.4) SLOT ENGINE ‚Äî necesita time_engine y antes del loader -->
<script src="./engine/acs_slots_engine.js?v=2.0"></script>

<!-- ===========================================================
     2) AIRPORT LOADER ‚Äî CREA WorldAirportsACS
     Debe cargarse ANTES que los continent scripts
     =========================================================== -->
<script src="engine/airports_loader.js?v=1.0"></script>

<!-- ===========================================================
     3) WORLD ENGINE ‚Äî USA los datos cargados por el loader
     Genera √≠ndices ICAO/IATA, filtros hist√≥ricos, etc.
     =========================================================== -->
<script src="engine/acs_world_engine.js?v=1.0"></script>

<!-- ===========================================================
     4) CONTINENTS ‚Äî AHORA S√ç
     Estos archivos dependen de que WorldAirportsACS YA exista.
     =========================================================== -->
<script src="engine/airports/world_airports_na.js?v=1.0"></script>
<script src="engine/airports/world_airports_sa.js?v=1.0"></script>
<script src="engine/airports/world_airports_eu.js?v=1.0"></script>
<script src="engine/airports/world_airports_me.js?v=1.0"></script>
<script src="engine/airports/world_airports_af.js?v=1.0"></script>
<script src="engine/airports/world_airports_as.js?v=1.0"></script>
<script src="engine/airports/world_airports_oc.js?v=1.0"></script>

<script>
     
document.addEventListener("DOMContentLoaded", () => {
  if (typeof registerTimeListener === "function") {
    registerTimeListener(updateClockDisplay);
    updateClockDisplay();
  }
});
     
</script>
     
<script>
     
/* ============================================================
   üü¶ KEEP ORIGIN & DESTINATION AFTER REFRESH ‚Äî FIX v2
   ============================================================ */

// ‚õî YA NO guardamos destination ‚Äî solo origin
function persistOriginDest() {
    const O = document.getElementById("origin")?.value || "";
    localStorage.setItem("ACS_Route_LastOrigin", O);
}

// Restaurar ORIGIN al cargar, pero NO DESTINATION
document.addEventListener("DOMContentLoaded", () => {
    const storedO = localStorage.getItem("ACS_Route_LastOrigin") || "";
    if (storedO) document.getElementById("origin").value = storedO;
});

// Solo escuchar cambios de ORIGIN
document.getElementById("origin")?.addEventListener("input", persistOriginDest);
document.getElementById("origin")?.addEventListener("change", persistOriginDest);

/* ============================================================
   üîÑ AIRCRAFT SELECTION ‚Äî KEEP ON RELOAD, RESET ON NEW VISIT
   ============================================================ */

window.addEventListener("DOMContentLoaded", () => {
    const sel = document.getElementById("aircraft");
    if (!sel) return;

    // Detectar si llegamos por REFRESH o por navegaci√≥n normal
    let isReload = false;

    try {
        const navEntry = performance.getEntriesByType("navigation")[0];
        if (navEntry && navEntry.type === "reload") {
            isReload = true;
        } else if (performance.navigation && performance.navigation.type === 1) {
            // Fallback Safari viejo
            isReload = true;
        }
    } catch (e) {
        // Si algo falla, asumimos navegaci√≥n normal
        isReload = false;
    }

    if (isReload) {
        // üîÅ REFRESH: restaurar selecci√≥n previa
        const saved = localStorage.getItem("routeSelectedAircraft");
        if (saved) {
            sel.value = saved;
        }
    } else {
        // üÜï Visita nueva: limpiar borrador y dejar "-- Select Aircraft --"
        localStorage.removeItem("routeSelectedAircraft");
    }

    // üíæ Guardar cada vez que el jugador cambie el avi√≥n
    sel.addEventListener("change", () => {
        localStorage.setItem("routeSelectedAircraft", sel.value || "");
    });
});
     
/* ============================================================
   DOM READY FIX (Safari)
   ============================================================ */
document.addEventListener("DOMContentLoaded", () => {
    window.confirmRoute = confirmRoute;
});

</script>
     
</body>
</html>
