<!-- ===========================================================
     === ROUTE SCHEDULE MODULE v3.7 Final Stable | 11 NOV 2025 ===
     Aviation Capital Simulator (ACS)
     Range, Runway & Operational Validation System
     =========================================================== -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Route Schedule - Aviation Capital Simulator</title>
  <link rel="stylesheet" href="styles.css?v=3.1" />
  <style>
    body {
      background-color:#081530;
      color:white;
      font-family:"Segoe UI",sans-serif;
      margin:0;
    }
    h2 {
      color:#FFB300;
      margin-top:2rem;
      text-align:center;
    }
    .sub {
      color:#ccc;
      margin-bottom:2rem;
      text-align:center;
    }
    .schedule-container {
      width:90%;
      max-width:800px;
      margin:0 auto;
      background:#0e1b3c;
      border-radius:10px;
      padding:1.5rem 2rem;
      box-shadow:0 0 10px rgba(0,0,0,0.4);
    }
    label {
      display:block;
      margin-top:1rem;
      font-weight:600;
      color:#FFB300;
    }
    select, input {
      width:100%;
      padding:0.5rem;
      margin-top:0.3rem;
      border-radius:6px;
      border:none;
      background:#12224c;
      color:white;
      font-size:1rem;
      outline:none;
    }
    input[type="checkbox"] {
      appearance:none;
      width:18px;
      height:18px;
      border-radius:4px;
      border:2px solid #3a4a7a;
      background-color:#1e2b55;
      cursor:pointer;
      position:relative;
      transition:all 0.2s ease;
    }
    input[type="checkbox"]:hover { border-color:#2196F3; box-shadow:0 0 6px #2196F3; }
    input[type="checkbox"]:checked { background-color:#2196F3; border-color:#2196F3; }
    input[type="checkbox"]:checked::after {
      content:"‚úî";
      color:white;
      position:absolute;
      top:-2px;
      left:3px;
      font-size:0.9rem;
    }
    .divider { border:none; height:1px; background:rgba(255,179,0,0.6); margin:0.8rem 0 1.2rem; }
    .days-row {
      display:flex;
      justify-content:center;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-top:0.8rem;
    }
    .days-row label { display:flex; align-items:center; gap:6px; color:#ddd; font-size:0.95rem; }
    .options-center { text-align:center; margin-top:0.5rem; }
    .tech-list {
      margin-top:1.5rem;
      background:#102040;
      border-radius:8px;
      padding:1rem;
    }
    .tech-item {
      display:flex;
      justify-content:space-between;
      padding:0.4rem 0;
      border-bottom:1px solid rgba(255,255,255,0.1);
      color:#ddd;
    }
    .tech-item span { color:#FFB300; font-weight:600; }
    .status-line { margin-top:0.8rem; text-align:center; font-weight:600; }
    .status-warning { color:#FFD54F; }
    .status-ok { color:#00E676; }
    .result {
      margin-top:1rem;
      background:#0e2048;
      padding:1rem;
      border-radius:8px;
      color:#ccc;
      text-align:left;
    }
    .acs-btn {
      display:block;
      background-color:#1DB954;
      color:#fff;
      border:none;
      padding:0.7rem 1.4rem;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      margin:1.5rem auto 0.8rem;
      transition:0.2s;
    }
    .acs-btn:hover { background-color:#17a84d; }
    .acs-btn:disabled { opacity:0.4; cursor:not-allowed; background-color:#555 !important; }
    .back-btn {
      display:block;
      margin:0 auto 0.5rem;
      color:#1DB954;
      background:none;
      border:1px solid #1DB954;
      border-radius:6px;
      padding:0.4rem 1rem;
      cursor:pointer;
    }
    .back-btn:hover { background-color:#1DB954; color:white; }
    footer { margin-top:3rem; text-align:center; color:#999; font-size:0.9rem; padding:1rem; }
    #acs-clock {
      color:#1DB954;
      font-weight:600;
      position:absolute;
      top:15px;
      right:25px;
      font-size:1rem;
    }
  </style>
</head>

<body>
  <header class="acs-header">
    <div class="acs-logo">
      <img src="acs_logo.png" alt="ACS Logo" />
      <h1>Aviation Capital Simulator</h1>
    </div>
    <nav class="acs-nav">
      <a href="dashboard.html">Main</a>
      <a href="finance.html">Finance</a>
      <a href="aircraft.html">Aircraft</a>
      <a href="routes.html" class="active">Routes</a>
      <a href="hr.html">HR</a>
      <a href="forum.html">Forum</a>
      <a href="support.html">Support</a>
      <a href="#" class="logout-btn" onclick="handleLogout()">Logout</a>
    </nav>
    <div id="acs-clock"></div>
  </header>

  <main class="acs-main">
    <h2>üß≠ Route Schedule Setup</h2>
    <p class="sub">Plan and evaluate your route performance based on technical parameters and operational constraints.</p>

    <div class="schedule-container">
      <label>Origin (ICAO)</label>
      <input type="text" id="origin" value="LEMD" />

      <label>Destination (ICAO)</label>
      <input type="text" id="destination" placeholder="e.g. EGLL, LFPG, EHAM" />

      <label>Flight Number (Auto)</label>
      <input type="text" id="flightNumber" readonly />

      <label>Aircraft Type</label>
      <select id="aircraft" onchange="autoCalculate()">
        <option value="">-- Select Aircraft --</option>
        <option value="B737-200">Boeing 737-200</option>
        <option value="A320">Airbus A320</option>
        <option value="B767-300ER">Boeing 767-300ER</option>
      </select>

      <label>Departure Time (Local)</label>
      <select id="departureTime" onchange="autoCalculate()"></select>

      <label style="text-align:center; margin-top:1.2rem;">Days of Operation</label>
      <div class="days-row">
        <label><input type="checkbox" id="everyDay" onchange="toggleEveryDay()"> Every Day</label>
        <label><input type="checkbox" id="mon"> Mo</label>
        <label><input type="checkbox" id="tue"> Tu</label>
        <label><input type="checkbox" id="wed"> We</label>
        <label><input type="checkbox" id="thu"> Th</label>
        <label><input type="checkbox" id="fri"> Fr</label>
        <label><input type="checkbox" id="sat"> Sa</label>
        <label><input type="checkbox" id="sun"> Su</label>
      </div>

      <hr class="divider" />
      <div class="options-center">
        <label><input type="checkbox" id="separateDays"> Create each day as a separate route</label>
      </div>
      <hr class="divider" />
      <div class="options-center">
        <label><input type="checkbox" id="optimizeRotation" onchange="toggleOptimization()"> Optimize Rotation (avoid delay & maintenance conflict)</label>
      </div>

      <div id="techData" class="tech-list" style="display:none;">
        <div class="tech-item">Distance (NM): <span id="distance">--</span></div>
        <div class="tech-item">Block Time: <span id="blockTime">--</span></div>
        <div class="tech-item">Turnaround Time: <span id="turnaround">--</span></div>
        <div class="tech-item">Total Rotation: <span id="totalRotation">--</span></div>
        <div class="tech-item">Time to A-Check (h remaining): <span id="serviceA">--</span></div>
        <div class="tech-item">Time to B-Check (h remaining): <span id="serviceB">--</span></div>
        <div class="tech-item">Delay Risk (%): <span id="delayRisk">--</span></div>
        <div class="tech-item">Efficiency Index (%): <span id="effIndex">--</span></div>
      </div>

      <div class="result" id="result"></div>
      <div id="optStatus" class="status-line"></div>

      <button class="acs-btn" id="confirmBtn" onclick="confirmRoute()">CONFIRM ROUTE</button>
      <button class="back-btn" onclick="window.location.href='routes.html'">‚¨Ö Back to Routes</button>
    </div>
  </main>

  <footer>¬© 2025 Aviation Capital Simulator. All rights reserved.</footer>

  <!-- === CLOCK SCRIPT === -->
  <script>
    window.addEventListener("load", () => {
      const c = document.getElementById("acs-clock");
      if (!c) return;
      let simTime = new Date(localStorage.getItem("acsSimTime") || new Date());
      function refreshClock() {
        simTime.setMinutes(simTime.getMinutes() + 1);
        const hh = String(simTime.getHours()).padStart(2,"0");
        const mm = String(simTime.getMinutes()).padStart(2,"0");
        const date = simTime.toDateString().toUpperCase();
        c.textContent = `${hh}:${mm} ‚Äî ${date}`;
        localStorage.setItem("acsSimTime", simTime.toISOString());
      }
      refreshClock();
      setInterval(refreshClock, 1000);
    });
  </script>

  <!-- === GLOBAL AIRPORT DATABASE === -->
  <script src="worldairportsacs.js?v=2.0"></script>
<script>
/* ===========================================================
   === ROUTE VALIDATION & CALCULATION ENGINE ‚Äî v3.7 Final ===
   Includes: Distance, Range, Runway, Category & Aircraft Limits
   =========================================================== */

/* === TIME SELECT OPTIONS === */
const timeSelect = document.getElementById("departureTime");
for (let h = 6; h < 24; h++) {
  for (let m = 0; m < 60; m += 5) {
    const hh = String(h).padStart(2,"0");
    const mm = String(m).padStart(2,"0");
    const opt = document.createElement("option");
    opt.value = `${hh}:${mm}`;
    opt.textContent = `${hh}:${mm}`;
    timeSelect.appendChild(opt);
  }
}
timeSelect.value = "06:00";

/* === GLOBAL CONSTANTS === */
const DAY_IDS = ["mon","tue","wed","thu","fri","sat","sun"];
let rotationOptimized = false;

/* === AIRCRAFT PERFORMANCE DATA === */
const aircraftData = {
  "B737-200": { speed: 420, range: 2000, runway_min_m: 1800, size: "Medium" },
  "A320": { speed: 450, range: 3100, runway_min_m: 2200, size: "Medium" },
  "B767-300ER": { speed: 470, range: 5600, runway_min_m: 2600, size: "Heavy" }
};

/* === LOAD DESTINATION FROM PREVIOUS PAGE === */
window.addEventListener("DOMContentLoaded", () => {
  const storedDest = localStorage.getItem("selectedDestination");
  if (storedDest) {
    document.getElementById("destination").value = storedDest;
    console.log("üß≠ Destination loaded:", storedDest);
  }
});

/* === GET AIRPORT INFO FROM DATABASE === */
function getAirportByICAO(code) {
  code = (code || "").toUpperCase();
  const db = window.WorldAirportsACS || window.worldairportsacs;
  if (!db) {
    console.warn("‚ö†Ô∏è WorldAirportsACS not available.");
    return null;
  }
  for (const region in db) {
    const list = db[region];
    if (!Array.isArray(list)) continue;
    const found = list.find(a => a.icao === code);
    if (found) return found;
  }
  return null;
}

/* === DISTANCE CALCULATION === */
function calcDistanceNM(from, to) {
  const origin = getAirportByICAO(from);
  const dest = getAirportByICAO(to);
  if (!origin || !dest) return 0;
  const R = 3440;
  const lat1 = (origin.latitude * Math.PI) / 180;
  const lat2 = (dest.latitude * Math.PI) / 180;
  const dLat = ((dest.latitude - origin.latitude) * Math.PI) / 180;
  const dLon = ((dest.longitude - origin.longitude) * Math.PI) / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

/* === MAIN CALCULATION FUNCTION === */
function autoCalculate() {
  const origin = document.getElementById("origin").value.toUpperCase();
  const destination = document.getElementById("destination").value.toUpperCase();
  const aircraft = document.getElementById("aircraft").value;
  const departure = document.getElementById("departureTime").value;
  const confirmBtn = document.getElementById("confirmBtn");
  const resultBox = document.getElementById("result");

  if (!origin || !destination || !aircraft) return;
  document.getElementById("techData").style.display = "block";

  const ac = aircraftData[aircraft];
  const distance = calcDistanceNM(origin, destination);
  const speed = ac.speed;
  const turnaround = rotationOptimized ? 1.0 : 0.75;
  const blockTime = distance / speed;
  const totalRotation = (blockTime * 2) + (turnaround * 2);
  const serviceA = 5 - (totalRotation / 2);
  const serviceB = 24 - (totalRotation / 4);
  let delayRisk = Math.min(100, (totalRotation / 5) * 10);
  let effIndex = Math.max(50, 100 - delayRisk / 1.5);
  if (rotationOptimized) { delayRisk *= 0.8; effIndex += 5; }

  document.getElementById("distance").innerText = distance;
  document.getElementById("blockTime").innerText = `${blockTime.toFixed(2)} h`;
  document.getElementById("turnaround").innerText = `${turnaround.toFixed(2)} h`;
  document.getElementById("totalRotation").innerText = `${totalRotation.toFixed(2)} h`;
  document.getElementById("serviceA").innerText = serviceA.toFixed(1);
  document.getElementById("serviceB").innerText = serviceB.toFixed(1);
  document.getElementById("delayRisk").innerText = `${delayRisk.toFixed(1)}%`;
  document.getElementById("effIndex").innerText = `${effIndex.toFixed(1)}%`;

  const originData = getAirportByICAO(origin);
  const destData = getAirportByICAO(destination);
  if (!originData || !destData) {
    resultBox.innerHTML = `<span style="color:#ff7777;">‚ö†Ô∏è Airport data not found in worldairportsacs.js.</span>`;
    confirmBtn.disabled = true;
    return;
  }

  // === VALIDATIONS ===
  let warnings = [];
  let severity = "ok";

  // Range check
  if (distance > ac.range) {
    warnings.push(`Distance ${distance} NM exceeds aircraft range ${ac.range} NM.`);
    severity = "error";
  } else if (distance > ac.range * 0.9) {
    warnings.push(`Route distance near aircraft limit (${distance}/${ac.range} NM).`);
    severity = "warn";
  }

  // Runway check
  if (originData.runway_m < ac.runway_min_m || destData.runway_m < ac.runway_min_m) {
    warnings.push(`Runway below minimum (${ac.runway_min_m} m required).`);
    severity = "error";
  }

  // Category restriction
  const restrictedCats = ["Regional", "Domestic"];
  if (restrictedCats.includes(destData.category) && ac.size === "Heavy") {
    warnings.push(`Destination ${destData.category} not suitable for Heavy aircraft.`);
    severity = "error";
  }

  // Aircraft limit
  if ((destData.aircraft_limit === "Medium" && ac.size === "Heavy") ||
      (originData.aircraft_limit === "Medium" && ac.size === "Heavy")) {
    warnings.push(`Airport restricted to Medium aircraft.`);
    severity = "error";
  }

  // === RESULT OUTPUT ===
  let color = "#00ff99";
  if (severity === "warn") color = "#ffcc66";
  if (severity === "error") color = "#ff5555";
  const acHTML = `<span style="color:${color};font-weight:700;">${aircraft}</span>`;

  if (warnings.length > 0) {
    resultBox.innerHTML = `
      ‚ùå <span style="color:${color};font-weight:600;">Operational restrictions:</span>
      <ul style="color:${color};margin-top:0.5rem;">
        ${warnings.map(w => `<li>${w}</li>`).join("")}
      </ul>
    `;
    confirmBtn.disabled = (severity === "error");
  } else {
    resultBox.innerHTML = `
      ‚úÖ Route validated.<br>
      <strong>${origin} ‚ûú ${destination} ‚ûú ${origin}</strong><br>
      Aircraft: ${acHTML}<br>
      Departure: ${departure}<br><br>
      <strong>Origin:</strong> Runway ${originData.runway_m} m | ${originData.category} | Limit: ${originData.aircraft_limit}<br>
      <strong>Destination:</strong> Runway ${destData.runway_m} m | ${destData.category} | Limit: ${destData.aircraft_limit}<br><br>
      <span style="color:#00ff99;">‚úî Compatible with operational limits.</span>
    `;
    confirmBtn.disabled = false;
  }

  const optStatus = document.getElementById("optStatus");
  optStatus.className = "status-line " + (rotationOptimized ? "status-ok" : "status-warning");
  optStatus.innerHTML = rotationOptimized
    ? "‚úÖ Optimized rotation applied."
    : "‚ö† Non-optimized rotation (45 min ground time)";
}

/* === OTHER UTILITIES === */
function toggleEveryDay() {
  const all = document.getElementById("everyDay").checked;
  DAY_IDS.forEach(id => document.getElementById(id).checked = all);
}
function toggleOptimization() {
  rotationOptimized = document.getElementById("optimizeRotation").checked;
  autoCalculate();
}
function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}

/* === GENERATE FLIGHT NUMBERS === */
document.addEventListener("DOMContentLoaded", () => {
  const flightNumberInput = document.getElementById("flightNumber");
  const userIATA = localStorage.getItem("userIATA") || "AT";
  let lastFlightNumber = parseInt(localStorage.getItem("lastFlightNumber") || "100", 10);
  let usedFlights = JSON.parse(localStorage.getItem("flightNumbers") || "[]");

  function generateFlightPair() {
    let out = `${userIATA}${lastFlightNumber}`;
    let inn = `${userIATA}${lastFlightNumber + 1}`;
    while (usedFlights.includes(out) || usedFlights.includes(inn)) {
      lastFlightNumber += 2;
      out = `${userIATA}${lastFlightNumber}`;
      inn = `${userIATA}${lastFlightNumber + 1}`;
    }
    if (flightNumberInput) flightNumberInput.value = `${out} ‚ûú ${inn}`;
  }

  function waitForDBandCalc(retries = 0) {
    if (typeof WorldAirportsACS !== "undefined" && WorldAirportsACS) {
      generateFlightPair();
      autoCalculate();
      console.log("‚úÖ Database loaded, route calculation initialized.");
    } else if (retries < 10) {
      setTimeout(() => waitForDBandCalc(retries + 1), 400);
    } else {
      document.getElementById("result").innerHTML =
        "<span style='color:#ff7777;'>‚ùå Failed to load worldairportsacs.js file.</span>";
    }
  }

  waitForDBandCalc();
});

/* === CONFIRM ROUTE === */
function confirmRoute() {
  const origin = document.getElementById("origin").value.trim();
  const destination = document.getElementById("destination").value.trim();
  const aircraft = document.getElementById("aircraft").value;
  const departure = document.getElementById("departureTime").value;
  const optimized = document.getElementById("optimizeRotation").checked;
  const selectedDays = DAY_IDS.filter(id => document.getElementById(id).checked);

  if (!origin || !destination || !aircraft || !departure || selectedDays.length === 0) {
    alert("‚ö†Ô∏è Please complete all required fields and select at least one day before confirming.");
    return;
  }

  const rawFN = document.getElementById("flightNumber").value || "";
  const match = rawFN.match(/^([A-Z]{2}\d+)\s*[\u2192\u279C\u27A1\-\>]*\s*([A-Z]{2}\d+)$/) || [];
  const flightNumberOut = match[1];
  const flightNumberIn = match[2];

  localStorage.setItem("confirmedRoute", JSON.stringify({
    origin, destination, aircraft, departure, optimized,
    days: selectedDays, flightNumberOut, flightNumberIn
  }));

  alert(`‚úÖ Route confirmed!\n${flightNumberOut || ""} / ${flightNumberIn || ""}`);
  window.location.href = "routes.html";
}
</script>
</body>
</html>
