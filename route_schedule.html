<!-- ============================================================
     === ROUTE SCHEDULE MODULE ‚Äî Qatar Luxury Edition ===========
     ------------------------------------------------------------
     Version:  v3.0 | Date: 09 DEC 2025
     ============================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Route Schedule - Aviation Capital Simulator</title>

  <!-- ======== ACS Styles ======== -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- ======== ACS Favicons (A Confirmado) ======== -->
  <link rel="icon" type="image/png" sizes="16x16" href="acs_logo_16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="acs_logo_32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="acs_logo_64.png">
  <link rel="apple-touch-icon" href="acs_logo_180.png">

<style>
/* ============================================================
     === ROUTE SCHEDULE ‚Äî Qatar Luxury Edition CLEAN v1.1 ======
   ============================================================ */

body {
  margin: 0;
  background-color: #081530;
  color: white;
  font-family: "Poppins", sans-serif;
}

/* ============================================================
     === GLOBAL HEADER ‚Äî EXACT DASHBOARD COPY =================
   ============================================================ */

.acs-header {
  position: fixed;
  top: 0;
  width: 100%;
  backdrop-filter: blur(9px);
  background: rgba(12,23,50,0.45);
  padding: 0.8rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid #ffb300;
  z-index: 5000;
}

.acs-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.acs-left img {
  height: 46px;
}

.acs-left h1 {
  font-size: 1.15rem;
  margin: 0;
  color: #ffb300;
  letter-spacing: 0.5px;
}

.acs-nav {
  flex: 1;
  display: flex;
  justify-content: center;
  gap: 2rem;
}

.acs-nav a {
  position: relative;
  font-size: 1rem;
  letter-spacing: 0.4px;
  color: #dbe4ff;
  text-decoration: none;
  transition: 0.25s ease;
  padding-bottom: 6px;
}

.acs-nav a:hover,
.acs-nav a.active {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.6);
}

.acs-nav a.active::after,
.acs-nav a:hover::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to right, #ffb300, #ffe7a0);
  border-radius: 2px;
  box-shadow: 0 0 8px rgba(255,200,60,0.45);
}

.acs-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.support-btn {
  padding: 0.45rem 1.1rem;
  border-radius: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  color: #8AB4FF;
  border: 1px solid rgba(138,180,255,0.45);
  background: rgba(138,180,255,0.08);
  backdrop-filter: blur(6px);
  transition: 0.25s ease;
}

.support-btn:hover {
  background: rgba(138,180,255,0.20);
  box-shadow: 0 0 14px rgba(138,180,255,0.55);
  color: #dfe9ff;
}

.logout-btn {
  padding: 0.45rem 1.1rem;
  border: 1px solid #ffb300;
  border-radius: 12px;
  background: rgba(255,179,0,0.05);
  color: #ffb300;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
}

.logout-btn:hover {
  background: #ffb300;
  color: #0c1f3c;
}

.acs-clock-header {
  font-family: "Orbitron", monospace;
  padding: 0.4rem 0.8rem;
  background: rgba(0,255,128,0.08);
  border-radius: 8px;
  font-size: 0.95rem;
  color: #00ff80;
}

/* ============================================================
     === MAIN CONTENT ==========================================
   ============================================================ */

.acs-main {
  padding: 105px 2rem 70px;
  max-width: 900px;
  margin: 0 auto;
  text-align: center;
}

h2 {
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255,179,0,0.4);
}

.sub {
  color: #cbd6ff;
  margin-bottom: 2.2rem;
}

/* ============================================================
     === CENTRAL CARD ‚Äî Qatar Luxury ===========================
   ============================================================ */

.schedule-container {
  background: linear-gradient(180deg, rgba(20,35,70,0.75), rgba(10,18,40,0.85));
  border-radius: 22px;
  padding: 1.8rem 2rem;
  box-shadow: 0 8px 32px rgba(0,0,0,0.42);
  border: 1px solid rgba(255,179,0,0.18);
  margin-bottom: 3rem;
  text-align: left;
}

/* ============================================================
     === FORM ELEMENTS ‚Äî CLEANED ===============================
   ============================================================ */

label {
  display: block;
  margin-top: 1rem;
  font-weight: 600;
  color: #ffb300;
}

input, select {
  width: 100%;
  padding: 0.7rem;
  margin-top: 0.3rem;
  border-radius: 12px;
  border: 1px solid rgba(255,179,0,0.18);
  background: #0c1a34;
  color: #fff;
  font-size: 1rem;
  transition: 0.2s;
  outline: none;
}

input:focus, select:focus {
  border-color: #ffca50;
  box-shadow: 0 0 8px rgba(255,200,60,0.45);
}

/* Origen/Destino ‚Äî readonly */
input[readonly] {
  background: #0a1530;
  opacity: 0.85;
  cursor: not-allowed;
}

/* Clean Aircraft select ‚Äî FIXED (all aircraft visible) */
select#aircraft option {
  display: block;
}

/* Checkboxes cockpit ACS */
input[type="checkbox"] {
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 6px;
  border: 2px solid #3a4a7a;
  background-color: #1e2b55;
  cursor: pointer;
  position: relative;
  transition: all 0.2s ease;
}

input[type="checkbox"]:checked {
  background-color: #00a86b;
  border-color: #00a86b;
}

input[type="checkbox"]:checked::after {
  content: "‚úî";
  color: white;
  position: absolute;
  top: -3px;
  left: 3px;
  font-size: 0.85rem;
}

.days-row {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 14px;
  margin-top: 0.8rem;
}

.divider {
  border: none;
  height: 1px;
  background: linear-gradient(to right, rgba(255,200,60,0.7), rgba(255,200,60,0.3));
  margin: 1.4rem 0;
}

/* ============================================================
     === TECH PANEL ============================================
   ============================================================ */

.tech-list {
  margin-top: 1.5rem;
  background: rgba(10,18,40,0.8);
  border-radius: 16px;
  padding: 1rem 1.2rem;
  border: 1px solid rgba(255,179,0,0.22);
  box-shadow: 0 4px 22px rgba(0,0,0,0.35);
}

.tech-item {
  display: flex;
  justify-content: space-between;
  padding: 0.45rem 0;
  border-bottom: 1px solid rgba(255,255,255,0.07);
  color: #d7e2ff;
}

.tech-item span {
  color: #ffb300;
  font-weight: 600;
}
     
/* üÖ∞Ô∏è1 ‚Äî ALIGN RIGHT FOR TECH VALUES ‚Äî v1.0 | 09 DEC 2025 */
.tech-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tech-item span {
    margin-left: auto;
    text-align: right;
    min-width: 120px;   /* asegura columna derecha alineada */
    display: inline-block;
}
     
/* ============================================================
     === BUTTONS ===============================================
   ============================================================ */

.acs-btn {
  display: block;
  background: #00a86b;
  color: #fff;
  padding: 0.8rem 1.5rem;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  margin: 1.5rem auto 0.8rem;
  transition: 0.2s ease;
  border: none;
}

.acs-btn:hover {
  background: #00794f;
}

.back-btn {
  display: block;
  margin: 0 auto 0.5rem;
  color: #00a86b;
  background: none;
  border: 1px solid #00a86b;
  border-radius: 10px;
  padding: 0.45rem 1.2rem;
  cursor: pointer;
  transition: 0.2s;
}

.back-btn:hover {
  background: #00a86b;
  color: #081530;
}

.result {
  margin-top: 1rem;
  background: #0b1838;
  padding: 1rem;
  border-radius: 14px;
  color: #cbd6ff;
}

.status-line {
  margin-top: 0.8rem;
  font-weight: 600;
  text-align: center;
}

.status-ok { color: #00ff80; }
.status-warning { color: #ffd54f; }

footer {
  text-align: center;
  padding: 20px;
  color: #7c8bb8;
  font-size: 0.9rem;
  margin-top: 40px;
}
</style>
</head>

<body>

<header class="acs-header">
  <div class="acs-left">
    <img src="acs_logo.png" alt="ACS Logo">
    <h1>Aviation Capital Simulator</h1>
  </div>

  <nav class="acs-nav">
    <a href="dashboard.html">Main</a>
    <a href="finance.html">Finance</a>
    <a href="aircraft.html">Aircraft</a>
    <a href="routes.html" class="active">Routes</a>
    <a href="hr.html">HR</a>
    <a href="forum.html">Forum</a>
  </nav>

  <div class="acs-right">
    <a href="support.html" class="support-btn">Support</a>
    <a class="logout-btn" onclick="handleLogout()">Logout</a>
    <div class="acs-clock-header" id="acs-clock">00:00 ‚Äî 01 JAN 2025</div>
  </div>
</header>

<main class="acs-main">

  <h2>üß≠ Route Schedule Setup</h2>
  <p class="sub">Plan and evaluate your route performance based on technical parameters and operational constraints.</p>

  <div class="schedule-container">

    <!-- ORIGEN Y DESTINO ‚Äî Limpios y bloqueados -->
    <label>Origin (ICAO)</label>
    <input type="text" id="origin" readonly />

    <label>Destination (ICAO)</label>
    <input type="text" id="destination" readonly />

    <!-- N√∫mero de vuelo ‚Äî VAC√çO, motor intacto pero no se ejecuta -->
       
    <label>Flight Number (Auto)</label>
    <input type="text" id="flightNumber" readonly />

    <!-- Aircraft limpia -->
       
    <label>Aircraft Type</label>
       
    <!-- A2: se a√±ade autoGenerateFlightNumber al onchange -->
       
    <select id="aircraft" onchange="autoCalculate(); autoGenerateFlightNumber();">
  <option value="">-- Select Aircraft --</option>
</select>

<script>
     
/* ============================================================
   üõ´ ACS ROUTE SCHEDULE ‚Äî AIRCRAFT SOURCE (ACTIVE + PENDING)
   ------------------------------------------------------------
   PASO 1 DEFINITIVO:
   - Fuente operativa: Active + Pending
   - Clave l√≥gica: aircraftId
   - UI: model + registration + status
   ============================================================ */

/* ============================================================
   üüß A8 ‚Äî GET OPERATIONAL FLEET (FIXED)
   ============================================================ */
function RS_getOperationalFleet() {

  const raw = JSON.parse(localStorage.getItem("ACS_MyAircraft")) || [];
  if (!Array.isArray(raw)) return [];

  const base = JSON.parse(localStorage.getItem("ACS_activeUser"))?.base?.icao
            || JSON.parse(localStorage.getItem("ACS_activeUser"))?.airline?.base
            || null;

  return raw.filter(ac => {

    // ‚úÖ SOLO condiciones REALES
    const isActive =
      (ac.status || "").toLowerCase() === "active";

    const sameBase =
      !base || ac.base === base;

    return isActive && sameBase;
  });
}

/* ============================================================
   üß≠ POPULATE AIRCRAFT SELECTOR ‚Äî FINAL (MOTOR √öNICO)
   ============================================================ */
function RS_populateAircraftSelector() {

  const select = document.getElementById("aircraft");
  if (!select) return;

  select.innerHTML = `<option value="">-- Select Aircraft --</option>`;

  const fleet = RS_getOperationalFleet();

  if (!fleet.length) {
    console.warn("‚ö† No operational aircraft (Active or Pending) found");
    return;
  }

  fleet.forEach(ac => {

    const opt = document.createElement("option");

    opt.value = ac.id;
    opt.textContent = `${ac.model || "Unknown"} ‚Ä¢ ${ac.registration || "N/A"} ‚Ä¢ ${
      (ac.status || "").toLowerCase().includes("pending") ? "Pending" : "Active"
    }`;

    opt.dataset.speed    = ac.speed || 440;
    opt.dataset.range    = ac.range || 1500;
    opt.dataset.category = ac.category || "";

    select.appendChild(opt);
  });
}

/* ============================================================
   üüß A9 ‚Äî rs_populateAircraftSelect (ALIAS √öNICO Y SEGURO)
   ============================================================ */
function rs_populateAircraftSelect(selectedId = "") {

  RS_populateAircraftSelector();

  const sel = document.getElementById("aircraft");
  if (sel && selectedId) {
    sel.value = selectedId;
  }
}

/* ============================================================
   üü¶ R1 ‚Äî ROUTE SCHEDULE CORE INIT CANONICAL (ACS OFFICIAL)
   ------------------------------------------------------------
   ‚úî Un solo punto de init
   ‚úî CREATE limpio (sin aircraft preseleccionado)
   ‚úî EDIT precarga aircraft correcto
   ‚úî AutoCalculate restaurado
   ‚úî AutoGenerateFlightNumber restaurado
   ‚úî Tech panel vuelve a pintar
   ‚úî Safari reload estable
   ‚úî Elimina resets fantasma
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {

  console.log("üü¢ ROUTE SCHEDULE ‚Äî CORE INIT START");

  const originInput = document.getElementById("origin");
  const destInput   = document.getElementById("destination");
  const acSel       = document.getElementById("aircraft");
  const depSel      = document.getElementById("departureTime");
  const optBox      = document.getElementById("optimizeRotation");
  const fnInput     = document.getElementById("flightNumber");

  // ============================================================
  // 1Ô∏è‚É£ ORIGIN / DESTINATION (SOLO DESDE ROUTES ‚Üí ROUTE_SCHEDULE)
  // ============================================================

  const storedOrigin = localStorage.getItem("ACS_selectedOrigin");
  const storedDest   = localStorage.getItem("ACS_selectedDestination");

  if (storedOrigin && storedDest) {
    originInput.value = storedOrigin.toUpperCase();
    destInput.value   = storedDest.toUpperCase();

    localStorage.removeItem("ACS_selectedOrigin");
    localStorage.removeItem("ACS_selectedDestination");
  }

  originInput.readOnly = true;
  destInput.readOnly   = true;

  // ============================================================
  // 2Ô∏è‚É£ DETECTAR MODO (CREATE vs EDIT)
  // ============================================================

  let editCtx = null;
  try {
    editCtx = JSON.parse(localStorage.getItem("ACS_ROUTE_EDIT") || "null");
  } catch (e) {
    editCtx = null;
  }

  const isEditMode = !!(editCtx && editCtx.mode === "EDIT");

  console.log("üß≠ ROUTE MODE:", isEditMode ? "EDIT" : "CREATE");

  // ============================================================
  // 3Ô∏è‚É£ POPULAR AIRCRAFT SELECTOR (SIEMPRE LIMPIO EN CREATE)
  // ============================================================

  // üîí CREATE MODE: el jugador decide, nunca el sistema
  rs_populateAircraftSelect(
  isEditMode ? (editCtx.aircraftId || "") : null
 );

  if (!isEditMode && acSel) {
  acSel.value = ""; // placeholder obligatorio
 }

  // ============================================================
  // 4Ô∏è‚É£ EN EDIT ‚Üí PRECARGAR DATOS COMPLETOS
  // ============================================================

  if (isEditMode) {

    // Basic
    if (editCtx.origin)      originInput.value = editCtx.origin;
    if (editCtx.destination) destInput.value  = editCtx.destination;
    if (editCtx.departure)   depSel.value      = editCtx.departure;

    // Aircraft
    if (editCtx.aircraftId) {
      acSel.value = editCtx.aircraftId;
    }

    // Flight numbers (NO regenerar)
    if (editCtx.flightNumberOut && editCtx.flightNumberIn) {
      fnInput.value = `${editCtx.flightNumberOut} ‚ûú ${editCtx.flightNumberIn}`;
    }

    // Days
    const DAY_IDS = ["mon","tue","wed","thu","fri","sat","sun"];
    DAY_IDS.forEach(d => document.getElementById(d).checked = false);
    document.getElementById("everyDay").checked = false;

    const days = Array.isArray(editCtx.days) ? editCtx.days : [];

    if (days.length === 7) {
      document.getElementById("everyDay").checked = true;
      DAY_IDS.forEach(d => document.getElementById(d).checked = true);
    } else {
      days.forEach(d => {
        if (document.getElementById(d)) {
          document.getElementById(d).checked = true;
        }
      });
    }

    // UI
    const notice = document.createElement("div");
    notice.style.color = "#FFB300";
    notice.style.marginBottom = "1rem";
    notice.style.fontWeight = "600";
    notice.innerHTML =
      `‚úèÔ∏è Editing route: <strong>${editCtx.origin} ‚ûú ${editCtx.destination}</strong>`;
    document.querySelector(".schedule-container")?.prepend(notice);

    const btn = document.querySelector(".acs-btn");
    if (btn) btn.textContent = "UPDATE ROUTE";
  }

  // ============================================================
  // 5Ô∏è‚É£ EVENT LINKER ‚Äî MOTOR REAL
  // ============================================================

  if (acSel) {
    acSel.addEventListener("change", () => {
      if (typeof autoCalculate === "function") autoCalculate();
      if (!isEditMode && typeof autoGenerateFlightNumber === "function") {
        autoGenerateFlightNumber();
      }
    });
  }

  if (depSel) {
    depSel.addEventListener("change", () => {
      if (typeof autoCalculate === "function") autoCalculate();
    });
  }

  if (optBox) {
    optBox.addEventListener("change", () => {
      if (typeof autoCalculate === "function") autoCalculate();
    });
  }

  // ============================================================
  // 6Ô∏è‚É£ RELOAD SAFETY (Safari / Chrome)
  // ============================================================

  setTimeout(() => {

    const model = acSel?.value || "";

    // üîí Solo recalcular si el usuario eligi√≥ avi√≥n manualmente
       
   if (model && document.activeElement === acSel) {
   if (typeof autoCalculate === "function") autoCalculate();
   if (!isEditMode && typeof autoGenerateFlightNumber === "function") {
    autoGenerateFlightNumber();
   }
 }

  }, 120);

  // ============================================================
  // 7Ô∏è‚É£ EXPORT CORE FUNCTIONS (INLINE SAFE)
  // ============================================================

  if (typeof confirmRoute === "function") {
    window.confirmRoute = confirmRoute;
  }

  if (typeof autoCalculate === "function") {
    window.autoCalculate = autoCalculate;
  }

  if (typeof autoGenerateFlightNumber === "function") {
    window.autoGenerateFlightNumber = autoGenerateFlightNumber;
  }

  console.log("üü¢ ROUTE SCHEDULE ‚Äî CORE INIT COMPLETED");

});
     
/* ============================================================
   ‚úÖ COMPAT LAYER ‚Äî NO ROMPER llamadas viejas
   ------------------------------------------------------------
   En tu HTML hay llamadas mezcladas a:
   - loadAircraftById()
   - loadAvailableAircraft()
   Las unificamos a un solo motor robusto.
   ============================================================ */

function loadAircraftById() {
  rs_populateAircraftSelect("");
}

function loadAvailableAircraft() {
  // Legacy name ‚Äî ahora robusto (NO filtra por base)
  rs_populateAircraftSelect("");
}

/* ============================================================
   üü¶ SINGLE INIT POINT (GUARD) ‚Äî evita doble init destructivo
   ------------------------------------------------------------
   Tu archivo tiene varios DOMContentLoaded.
   Este guard asegura que la parte cr√≠tica (origin/dest + aircraft)
   se ejecute de forma segura.
   ============================================================ */

function RS_initCoreOnce() {
  if (window.__RS_CORE_INIT_DONE) return;
  window.__RS_CORE_INIT_DONE = true;

  const originInput = document.getElementById("origin");
  const destInput   = document.getElementById("destination");

  if (originInput && destInput) {
    originInput.value = (localStorage.getItem("ACS_selectedOrigin") || originInput.value || "").toUpperCase();
    destInput.value   = (localStorage.getItem("ACS_selectedDestination") || destInput.value || "").toUpperCase();

    originInput.readOnly = true;
    destInput.readOnly   = true;

    localStorage.removeItem("ACS_selectedOrigin");
    localStorage.removeItem("ACS_selectedDestination");
  }

  // ‚ùå NO persistir aircraft en Route Schedule
  rs_populateAircraftSelect(null);

  // üíæ Persistencia de selecci√≥n (ya tienes otro bloque, esto no estorba)
  const sel = document.getElementById("aircraft");
  if (sel) {
    sel.addEventListener("change", () => {
      localStorage.setItem("routeSelectedAircraft", sel.value || "");
    });
  }
}

// Ejecutar
document.addEventListener("DOMContentLoaded", RS_initCoreOnce);
     
</script>

    <label>Departure Time (Local)</label>
    <!-- A2: se a√±ade autoGenerateFlightNumber al onchange -->
    <select id="departureTime" onchange="autoCalculate(); autoGenerateFlightNumber();"></select>

    <label style="text-align:center;margin-top:1.2rem;">Days of Operation</label>
    <div class="days-row">
      <label><input type="checkbox" id="everyDay" onchange="toggleEveryDay()"> Every Day</label>
      <label><input type="checkbox" id="mon"> Mo</label>
      <label><input type="checkbox" id="tue"> Tu</label>
      <label><input type="checkbox" id="wed"> We</label>
      <label><input type="checkbox" id="thu"> Th</label>
      <label><input type="checkbox" id="fri"> Fr</label>
      <label><input type="checkbox" id="sat"> Sa</label>
      <label><input type="checkbox" id="sun"> Su</label>
    </div>

    <hr class="divider" />

    <div class="options-center" style="text-align:center;">
      <label><input type="checkbox" id="separateDays"> Create each day as a separate route</label>
    </div>

    <hr class="divider" />

    <div class="options-center" style="text-align:center;">
      <label><input type="checkbox" id="optimizeRotation" onchange="toggleOptimization()"> Optimize Rotation (avoid delay & maintenance conflict)</label>
    </div>

    <div id="techData" class="tech-list" style="display:none;">
      <div class="tech-item">Distance (NM): <span id="distance">--</span></div>
      <div class="tech-item">Block Time: <span id="blockTime">--</span></div>
      <div class="tech-item">Turnaround Time: <span id="turnaround">--</span></div>
      <div class="tech-item">Total Rotation: <span id="totalRotation">--</span></div>
      <div class="tech-item">Delay Risk (%): <span id="delayRisk">--</span></div>
      <div class="tech-item">Efficiency Index (%): <span id="effIndex">--</span></div>
    </div>

    <div class="result" id="result"></div>
    <div id="optStatus" class="status-line"></div>

    <button class="acs-btn">CONFIRM ROUTE</button>
    <button class="back-btn" onclick="window.location.href='routes.html'">‚¨Ö Back to Routes</button>
  </div>
</main>

<footer>¬© 2025 Aviation Capital Simulator. All rights reserved.</footer>

<!-- ============================================================
     === JAVASCRIPT ORIGINAL ‚Äî MOTOR INTACTO ===================
   ============================================================ -->


<script>

/* ============================================================
   === BASE: GENERAR HORARIOS DE SALIDA ========================
   ============================================================ */
     
const timeSelect = document.getElementById("departureTime");
for (let h = 6; h < 24; h++) {
  for (let m = 0; m < 60; m += 5) {
    const hh = String(h).padStart(2,"0");
    const mm = String(m).padStart(2,"0");
    const opt = document.createElement("option");
    opt.value = `${hh}:${mm}`;
    opt.textContent = `${hh}:${mm}`;
    timeSelect.appendChild(opt);
  }
}
timeSelect.value = "06:00";

function toggleEveryDay() {
  const all = document.getElementById("everyDay").checked;
  ["mon","tue","wed","thu","fri","sat","sun"].forEach(id => {
    document.getElementById(id).checked = all;
  });
}

function toggleOptimization() {
  window.rotationOptimized = document.getElementById("optimizeRotation").checked;
}

function handleLogout() {
  alert("üëã Session closed. See you soon, Captain!");
  window.location.href = "login.html";
}

/* ============================================================
   üü¶ FLIGHT NUMBER ENGINE ‚Äî IATA CONNECTED v1.1 (COMPLETO)
   ============================================================ */

// Input del n√∫mero de vuelo
const flightNumberInput = document.getElementById("flightNumber");

// Traer IATA guardado en create_airline
let userIATA = localStorage.getItem("userIATA") || "AT";
if (!localStorage.getItem("userIATA")) {
  console.warn("‚ö†Ô∏è No userIATA found ‚Äî using default AT");
}

// Contadores globales
let lastFlightNumber = parseInt(
  localStorage.getItem("lastFlightNumber") || "100",
  10
);
let usedFlights = JSON.parse(
  localStorage.getItem("flightNumbers") || "[]"
);

/* ============================================================
   üüß A3 ‚Äî Safe Flight Pair Generator (OUT ‚Üí IN)
   ============================================================ */
function generateFlightPair() {

  let num  = lastFlightNumber;
  let out  = `${userIATA}${num}`;
  let inn  = `${userIATA}${num + 1}`;

  // Evitar n√∫meros ya usados
  while (usedFlights.includes(out) || usedFlights.includes(inn)) {
    num += 2;
    out = `${userIATA}${num}`;
    inn = `${userIATA}${num + 1}`;
  }

  // Actualizar el contador global
  lastFlightNumber = num;

  // Pintar en input
  if (flightNumberInput) {
    flightNumberInput.value = `${out} ‚ûú ${inn}`;
  }

  return { out, inn };
}

/* ============================================================
   üü¶ AUTO-GENERATE FLIGHT NUMBER (LLAMADO DESDE EL SELECT)
   ============================================================ */
function autoGenerateFlightNumber() {

  // Necesitamos IATA v√°lido
  if (!userIATA || userIATA.length !== 2) {
    console.warn("‚ùå IATA code missing or invalid");
    return;
  }

  const origin = document.getElementById("origin").value.trim();
  const dest   = document.getElementById("destination").value.trim();
  const ac     = document.getElementById("aircraft").value;

  // Solo generar si todo est√° seleccionado
  if (!origin || !dest || !ac) return;

  // Generamos nueva pareja OUT/IN
  const pair = generateFlightPair();

  if (flightNumberInput) {
    flightNumberInput.value = `${pair.out} ‚ûú ${pair.inn}`;
  }
}

/* ============================================================
   üü¶ FLIGHT NUMBER UTILITIES (NO TOCAR)
   ============================================================ */

function bumpFlightCounter() {
  lastFlightNumber += 2;
  localStorage.setItem("lastFlightNumber", String(lastFlightNumber));
}

function markNumbersUsed(out, inn) {
  usedFlights.push(out, inn);
  localStorage.setItem("flightNumbers", JSON.stringify(usedFlights));
}

function freeNumbers(out, inn) {
  if (!out || !inn) return;
  usedFlights = usedFlights.filter(n => n !== out && n !== inn);
  localStorage.setItem("flightNumbers", JSON.stringify(usedFlights));
}

/* ============================================================
   üüß B1 ‚Äî ROUTE SCHEDULE EDIT MODE ‚Äî CANONICAL INIT (v1)
   ------------------------------------------------------------
   REGLAS (ACS):
   ‚úÖ EDIT = precargar y EDITAR (NO borrar / NO recrear)
   ‚úÖ NO override confirmRoute aqu√≠
   ‚úÖ NO freeNumbers aqu√≠
   ‚úÖ Solo prepara contexto + UI
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {

  const raw = localStorage.getItem("ACS_ROUTE_EDIT");
  if (!raw) return; // üü¢ CREATE MODE

  let ctx = null;
  try {
    ctx = JSON.parse(raw);
  } catch (e) {
    console.warn("‚ö† Invalid ACS_ROUTE_EDIT JSON, ignored");
    return;
  }

  if (!ctx || ctx.mode !== "EDIT") return;

  // ‚úÖ Flag global (para que confirm router decida luego)
  window.__RS_IS_EDIT_MODE = true;
  window.__RS_EDIT_CTX = ctx;

  console.log("‚úèÔ∏è ROUTE SCHEDULE ‚Äî EDIT MODE ACTIVE", ctx);

  const $ = id => document.getElementById(id);

  // ============================================================
  // 1) BASIC FIELDS
  // ============================================================
  if ($("origin")) {
    $("origin").value = (ctx.origin || $("origin").value || "").toUpperCase();
    $("origin").readOnly = true;
  }

  if ($("destination")) {
    $("destination").value = (ctx.destination || $("destination").value || "").toUpperCase();
    $("destination").readOnly = true;
  }

  if (ctx.departure && $("departureTime")) {
    $("departureTime").value = ctx.departure;
  }

  // ============================================================
  // 2) AIRCRAFT (by aircraftId) ‚Äî usa tu motor can√≥nico
  // ============================================================
  if (ctx.aircraftId && typeof rs_populateAircraftSelect === "function") {
    rs_populateAircraftSelect(ctx.aircraftId);
  } else if (typeof rs_populateAircraftSelect === "function") {
    rs_populateAircraftSelect("");
  }

  // ============================================================
  // 3) FLIGHT NUMBERS ‚Äî PRESERVAR (NO REGENERAR)
  // ============================================================
  if (ctx.flightNumberOut && ctx.flightNumberIn && $("flightNumber")) {
    $("flightNumber").value = `${ctx.flightNumberOut} ‚ûú ${ctx.flightNumberIn}`;
  }

  // ============================================================
  // 4) DAYS ‚Äî RESTORE (EveryDay vs individual)
  // ============================================================
  const DAY_IDS = ["mon","tue","wed","thu","fri","sat","sun"];

  DAY_IDS.forEach(d => { if ($(d)) $(d).checked = false; });
  if ($("everyDay")) $("everyDay").checked = false;

  const days = Array.isArray(ctx.days) ? ctx.days : [];

  if (days.length === 7) {
    if ($("everyDay")) $("everyDay").checked = true;
    DAY_IDS.forEach(d => { if ($(d)) $(d).checked = true; });
  } else {
    days.forEach(d => { if ($(d)) $(d).checked = true; });
  }

  // ============================================================
  // 5) UI NOTICE + BUTTON LABEL
  // ============================================================
  const container = document.querySelector(".schedule-container");
  if (container) {
    const notice = document.createElement("div");
    notice.style.color = "#FFB300";
    notice.style.marginBottom = "1rem";
    notice.style.fontWeight = "600";
    notice.innerHTML = `‚úèÔ∏è Editing route: <strong>${(ctx.origin||"").toUpperCase()} ‚ûú ${(ctx.destination||"").toUpperCase()}</strong>`;
    container.prepend(notice);
  }

  const btn = document.querySelector(".acs-btn");
  if (btn) btn.textContent = "UPDATE ROUTE";

  // ============================================================
  // 6) (Opcional) recalcular tech al entrar en EDIT si ya hay avi√≥n
  // ============================================================
  setTimeout(() => {
    const acSel = $("aircraft");
    if (acSel && acSel.value) {
      if (typeof autoCalculate === "function") autoCalculate();
      // üîí NO generar flight number en EDIT
    }
  }, 80);

});

/* ============================================================
   === GLOBAL DISTANCE ENGINE ‚Äî FIX v2 (NM)
   ------------------------------------------------------------
   Evita error: "Can't find variable: distanceNM"
   ============================================================ */
     
function distanceNM(lat1, lon1, lat2, lon2) {

    const R = 3440.065; // Earth radius in NM
    const toRad = x => (x * Math.PI) / 180;

    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);

    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) ** 2;

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return Math.round(R * c);
}
     
/* ============================================================
   üü¶ FASE 2 ‚Äî TECH ENGINE (Distance / Time / Cost / Crew)
   ============================================================ */

// 1) Distancia (NM)
function rs_getDistanceNM(origin, dest) {
  if (!origin || !dest) return 0;
  let O = null, D = null;

  for (const cont in WorldAirportsACS) {
    const list = WorldAirportsACS[cont];
    if (!Array.isArray(list)) continue;
    O = O || list.find(a => a.icao === origin);
    D = D || list.find(a => a.icao === dest);
  }

  if (!O || !D) return 0;
  return distanceNM(O.latitude, O.longitude, D.latitude, D.longitude);
}

// 2) Block Time
     
function rs_getBlockTime(distance, speed) {
  if (!distance || !speed) return 0;
  const cruise = distance / speed;
  const climbDesc = 0.25;
  return Math.round((cruise + climbDesc) * 60);
}

// 3) Turnaround
     
/* ============================================================
   üõ´ TURNAROUND REAL (1940‚Äì2026) ‚Äî FINAL v4
   ============================================================ */
     
function rs_getTurnaround(category) {

    if (!category) return 45; // default seguro

    const c = category.toUpperCase();

    // ============================
    // 1) LIGHT / SMALL (DC-3, Cessna, Beech)
    // ============================
    if (c.includes("SMALL") || c.includes("LIGHT") ||
        c.includes("DC-3") || c.includes("PIPER") || c.includes("CESSNA")) {
        return 35;  
    }

    // ============================
    // 2) TURBOPROP / ATR / Regional Early
    // ============================
    if (c.includes("ATR") || c.includes("TURBO") ||
        c.includes("REGIONAL")) {
        return 45;
    }

    // ============================
    // 3) Narrow-body Jets (A320, 737, 727, MD-80, Tu-154)
    // ============================
    if (c.includes("NARROW") || 
        c.includes("A320") || c.includes("A318") || c.includes("A319") ||
        c.includes("A321") ||
        c.includes("737")  || c.includes("727")  ||
        c.includes("MD-80") || c.includes("TU-154") || c.includes("DC-9")) {
        return 50;
    }

    // ============================
    // 4) Wide-body Jets (A300, A310, 767, L-1011, DC-10, 787)
    // ============================
    if (c.includes("WIDE")  ||
        c.includes("A300")  || c.includes("A310") ||
        c.includes("767")   || c.includes("787")  ||
        c.includes("L-1011") || c.includes("DC-10")) {
        return 60;
    }

    // ============================
    // 5) Large Heavy Jets (747, A340, DC-8, 707)
    // ============================
    if (c.includes("HEAVY") ||
        c.includes("747") || c.includes("A340") ||
        c.includes("707") || c.includes("DC-8")) {
        return 75;
    }

    // ============================
    // 6) A380 (Ultra Heavy)
    // ============================
    if (c.includes("A380")) {
        return 90;
    }

    // Default
    return 50;
}
     
/* ============================================================
   üü¶ OPTIMIZATION BUFFER ‚Äî FINAL v2
   ============================================================ */
     
function rs_getOptimizedTurnaround(baseTurn, category) {
    if (!document.getElementById("optimizeRotation").checked) {
        return baseTurn; // sin optimizaci√≥n
    }

    const c = (category || "").toUpperCase();

    // Light / Small
    if (c.includes("SMALL") || c.includes("DC-3") || c.includes("PIPER")) {
        return baseTurn + 10;
    }

    // Turboprop / Regional
    if (c.includes("ATR") || c.includes("TURBO") || c.includes("REGIONAL")) {
        return baseTurn + 10;
    }

    // Narrow-body
    if (c.includes("A320") || c.includes("737") || c.includes("MD-80") || c.includes("TU-154")) {
        return baseTurn + 15;
    }

    // Wide-body
    if (c.includes("A300") || c.includes("767") || c.includes("DC-10") || c.includes("L-1011")) {
        return baseTurn + 20;
    }

    // Heavy / 747 / DC-8 / 707
    if (c.includes("747") || c.includes("A340") || c.includes("707") || c.includes("DC-8")) {
        return baseTurn + 25;
    }

    // A380
    if (c.includes("A380")) {
        return baseTurn + 30;
    }

    return baseTurn + 15;
}

// 4) Fuel
     
function rs_getFuelBurn(category) {
  if (!category) return 2400;
  const c = category.toUpperCase();
  if (c.includes("ATR")) return 900;
  if (c.includes("REGIONAL")) return 1800;
  return 2500;
}

// 5) Crew
function rs_getCrewNeeded(category) {
  const c = (category || "").toUpperCase();
  if (c.includes("ATR")) return { pilots: 2, cabin: 2 };
  if (c.includes("REGIONAL")) return { pilots: 2, cabin: 2 };
  return { pilots: 2, cabin: 3 };
}

// 6) Costos
function rs_getTripCost(distance, blockMin, category) {
  const fuelKG = rs_getFuelBurn(category) * (blockMin / 60);
  const fuelCost = fuelKG * 0.85;
  return {
    fuelCost: Math.round(fuelCost),
    handling: 350,
    maintenance: 180,
    total: Math.round(fuelCost + 350 + 180)
  };
}

/* ============================================================
   üõ´ ACS RANGE CHECK ‚Äî SIMPLE & REALISTIC v2.0
   ============================================================ */
/*
    REGLAS:
    - Hasta (range - 15 NM) ‚Üí sin penalizaci√≥n (normal ops)
    - De (range - 15) a range ‚Üí penalizaci√≥n proporcional (m√°x 35%)
    - > range ‚Üí NO permitido
*/
function ACS_checkRangeSimple(distNM, publishedRange) {

    if (!distNM || !publishedRange) {
        return { ok: true, penalty: 0, msg: "No range data" };
    }

    // Nuevo rango libre sin penalizaci√≥n
    const freeLimit = publishedRange - 15;   // Ej: 510 ‚Üí 495

    // üü© 1) Perfectamente dentro del rango operativo
    if (distNM <= freeLimit) {
        return {
            ok: true,
            penalty: 0,
            msg: "‚úî Within safe operational range"
        };
    }

    // üü® 2) Cerca del l√≠mite ‚Üí penalizaci√≥n suave
    if (distNM <= publishedRange) {

        const ratio = (distNM - freeLimit) / (publishedRange - freeLimit);  // 0 ‚Üí 1 lineal
        const penalty = Math.min(0.35, ratio);  // M√°ximo 35%

        return {
            ok: true,
            penalty,
            msg: `‚ö† Near max range ‚Äî payload reduced by ${(penalty * 100).toFixed(0)}%`
        };
    }

    // üü• 3) Excedido ‚Üí no permitido
    return {
        ok: false,
        penalty: 1,
        msg: "‚ùå Route exceeds aircraft maximum published range"
    };
}

     
/* ============================================================
   üü¶ C) CREW ENGINE ‚Äî Reemplazo para Route Schedule
   ------------------------------------------------------------
   Usa ACS_CrewEngine.getCrewFromDatabase(modelo_exacto)
   ============================================================ */

/**
 * Devuelve crew REAL a partir del REG del avi√≥n seleccionado.
 * Entrada: registration (ej: "N123AA")
 * Salida: { pilots, flight_engineers, navigators, radio_ops, cabin, total }
 */
function rs_getCrewReal(registration) {

  // Fallback universal si algo falla
  const fallback = {
    pilots: 2,
    flight_engineers: 0,
    navigators: 0,
    radio_ops: 0,
    cabin: 2,
    total: 4
  };

  if (!registration) return fallback;

  // Obtener flota
  const fleet = JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");
  const ac = fleet.find(a => a.registration === registration);

  if (!ac || !ac.model) return fallback;

  // Crew REAL seg√∫n el modelo exacto (A300, Tu-154, DC-10, MD-80, Do328‚Ä¶)
  try {
    return ACS_CrewEngine.getCrewFromDatabase(ac.model);
  } catch (e) {
    console.warn("CrewEngine error:", e);
    return fallback;
  }
}

// üõ†Ô∏è A2 ‚Äî MODEL NORMALIZER ‚Äî v1.0
// Normaliza cualquier modelo a formato seguro
     
function normalizeModel(model) {
    if (!model) return "";
    return model
        .normalize("NFKC")        // corrige Unicode raro
        .replace(/\s+/g, " ")     // colapsa espacios m√∫ltiples
        .replace(/\u00A0/g, " ")  // elimina espacios no separables
        .trim();                  // limpia izquierda/derecha
}
     
/* ============================================================
   üîµ B ‚Äî AUTO CALCULATE (NO REGISTRATIONS)
   ============================================================ */

function autoCalculate() {

  const origin = document.getElementById("origin").value.trim();
  const dest   = document.getElementById("destination").value.trim();
  const aircraftId = document.getElementById("aircraft").value;

  if (!origin || !dest || !aircraftId) {
    document.getElementById("techData").style.display = "none";
    return;
  }

  const fleet = JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");
  const ac = fleet.find(a => a.id === aircraftId);

  if (!ac) {
    console.warn("Aircraft not found:", aircraftId);
    return;
  }

  const speed    = ac.speed || 440;
  const category = ac.category || "";
  const range    = ac.range || 1500;


    // üîπ Distancia
    const distNM = rs_getDistanceNM(origin, dest);

    // üîπ Block time
    const block = rs_getBlockTime(distNM, speed);

    // üîπ Turnaround
    const baseTurn = rs_getTurnaround(category);
    const optimizeON = document.getElementById("optimizeRotation")?.checked || false;

    const optTurn = optimizeON
        ? rs_getOptimizedTurnaround(baseTurn, category)
        : baseTurn;

    const totalBase = block + baseTurn + block;
    const totalOpt  = block + optTurn  + block;

    // üî• Mostrar bloque t√©cnico
    document.getElementById("techData").style.display = "block";

    document.getElementById("distance").textContent = distNM;
    document.getElementById("blockTime").textContent =
        `${Math.floor(block/60)}h ${block%60}m`;

    if (!optimizeON) {
        document.getElementById("turnaround").innerHTML = `${baseTurn} min`;
    } else {
        document.getElementById("turnaround").innerHTML =
            `${baseTurn} min<br><span style="color:#ffd54f">Optimized: ${optTurn} min</span>`;
    }

    if (!optimizeON) {
        document.getElementById("totalRotation").innerHTML =
            `${Math.floor(totalBase/60)}h ${totalBase%60}m`;
    } else {
        document.getElementById("totalRotation").innerHTML =
            `${Math.floor(totalBase/60)}h ${totalBase%60}m<br>
             <span style="color:#ffd54f">Optimized: ${Math.floor(totalOpt/60)}h ${totalOpt%60}m</span>`;
    }

    document.getElementById("delayRisk").textContent = "3%";
    document.getElementById("effIndex").textContent  = "90%";

    // Guardar para confirmRoute
    window.ACS_RouteTechData = {
        distNM,
        blockMin: block,
        turnMin: baseTurn,
        turnMinOptimized: optTurn,
        totalMin: optimizeON ? totalOpt : totalBase
    };
}

/* ============================================================
   üîµ ROUTE SCHEDULE EVENT LINKER ‚Äî FINAL RESTORE (AUTO + TECH)
   ------------------------------------------------------------
   Reactiva:
   ‚Ä¢ Auto c√°lculo t√©cnico
   ‚Ä¢ Auto flight number
   ‚Ä¢ Recalculo en reload Safari
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {

  const acSel  = document.getElementById("aircraft");
  const depSel = document.getElementById("departureTime");
  const optBox = document.getElementById("optimizeRotation");

  /* üîπ Cambio de avi√≥n ‚Üí recalcula + genera flight number */
     
  if (acSel) {
    acSel.addEventListener("change", () => {
      if (typeof autoCalculate === "function") autoCalculate();
      if (typeof autoGenerateFlightNumber === "function") autoGenerateFlightNumber();
    });
  }

  /* üîπ Cambio de hora ‚Üí recalcula */
     
  if (depSel) {
    depSel.addEventListener("change", () => {
      if (typeof autoCalculate === "function") autoCalculate();
    });
  }

  /* üîπ Cambio optimizaci√≥n */
     
  if (optBox) {
    optBox.addEventListener("change", () => {
      if (typeof autoCalculate === "function") autoCalculate();
    });
  }

  /* üîπ Reload FIX (Safari / Chrome) */
     
  setTimeout(() => {
    const model = acSel?.value || "";
    if (model) {
      if (typeof autoCalculate === "function") autoCalculate();
      if (typeof autoGenerateFlightNumber === "function") autoGenerateFlightNumber();
    }
  }, 80);

});

/* ============================================================
   üî• D1 ‚Äî AIRCRAFT CONFLICT CHECK ENGINE ‚Äî CANONICAL v1
   ------------------------------------------------------------
   REGLAS:
   - Mismo aircraftId
   - Mismo d√≠a
   - Solape horario
   - Bloquea CREATE y EDIT
   ============================================================ */

function RS_hasAircraftConflict(list, aircraftId, day, depMin, arrMin, ignoreIds = []) {

  return list.some(f => {

    if (f.type !== "flight") return false;
    if (f.aircraftId !== aircraftId) return false;
    if (f.day !== day) return false;
    if (ignoreIds.includes(f.id)) return false;

    const fDep = Number(f.depAbsMin ?? (parseInt(f.departure.split(":")[0]) * 60 + parseInt(f.departure.split(":")[1])));
    const fArr = Number(f.arrAbsMin ?? (parseInt(f.arrival.split(":")[0]) * 60 + parseInt(f.arrival.split(":")[1])));

    // üî¥ SOLAPE REAL
    // (nuevo sale antes de que el viejo llegue)  Y
    // (nuevo llega despu√©s de que el viejo sale)
    if (depMin < fArr && arrMin > fDep) {
      return true;
    }

    return false;
  });
}

/* ============================================================
   üüß C1 ‚Äî CONFIRM ROUTE ROUTER (CREATE vs EDIT) ‚Äî CANONICAL v1
   ------------------------------------------------------------
   REGLAS:
   ‚úÖ Una sola entrada confirmRoute()
   ‚úÖ Decide CREATE o EDIT por flag __RS_IS_EDIT_MODE
   ‚úÖ CREATE = inserta vuelos nuevos
   ‚úÖ EDIT   = actualiza vuelos existentes (NO borrar / NO recrear)
   ============================================================ */

function confirmRoute() {

  if (window.__ACS_CONFIRM_RUNNING) {
    console.warn("üõë confirmRoute blocked ‚Äî already running");
    return;
  }
  window.__ACS_CONFIRM_RUNNING = true;

  if (window.__RS_IS_EDIT_MODE) {
    confirmRouteEdit();
  } else {
    confirmRouteCreate();
  }
}

/* ============================================================
   üü¶ C2 ‚Äî CONFIRM ROUTE CREATE (TU MOTOR ACTUAL, LIMPIO)
   ============================================================ */

function confirmRouteCreate() {

  /* ================================
     1) Capturar valores del formulario
     ================================ */

  const origin      = (document.getElementById("origin")?.value || "").trim();
  const destination = (document.getElementById("destination")?.value || "").trim();
  const departure   = (document.getElementById("departureTime")?.value || "").trim();
  const aircraftSel = document.getElementById("aircraft");
  const selectedAircraftId = aircraftSel ? (aircraftSel.value || "").trim() : "";

  if (!selectedAircraftId || !/^AC[-_]/.test(selectedAircraftId)) {
    alert("Please select a valid aircraft.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  const blockTimeMin = parseInt((window.ACS_RouteTechData?.blockMin ?? ""), 10);
  if (!Number.isFinite(blockTimeMin) || blockTimeMin <= 0) {
    alert("‚õî Block time invalid. Please recalculate route.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  if (!origin || !destination || !departure) {
    alert("‚ö†Ô∏è Please complete all fields before confirming.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  /* ================================
     Flight Numbers
     ================================ */

  const rawFN = document.getElementById("flightNumber")?.value?.trim() || "";
  const match = rawFN.match(/^([A-Z]{2}\d+)\s*‚ûú\s*([A-Z]{2}\d+)$/);
  if (!match) {
    alert("‚õî Invalid flight number.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  const flightNumberOut = match[1];
  const flightNumberIn  = match[2];

  /* ================================
     Days
     ================================ */

  const DAY_IDS = ["mon","tue","wed","thu","fri","sat","sun"];
  let days = DAY_IDS.filter(id => document.getElementById(id)?.checked);

  if (document.getElementById("everyDay")?.checked) {
    days = ["mon","tue","wed","thu","fri","sat","sun"];
  }

  if (!days.length) {
    alert("Please select at least one day.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  /* ================================
     Arrival
     ================================ */

  const [depH, depM] = departure.split(":").map(Number);
  const arrivalTotalMin = depH * 60 + depM + blockTimeMin;
  const arrH = Math.floor(arrivalTotalMin / 60) % 24;
  const arrM = arrivalTotalMin % 60;
  const arrival = `${String(arrH).padStart(2, "0")}:${String(arrM).padStart(2, "0")}`;

  /* ================================
     Fleet
     ================================ */

  let fleet = JSON.parse(localStorage.getItem("ACS_MyAircraft") || "[]");
  const acObj = fleet.find(a => a.id === selectedAircraftId);

  if (!acObj || !acObj.model) {
    alert("‚ö† Aircraft model not found in fleet.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  const modelKey = acObj.model.toUpperCase();

  let finalDistanceNM = Number(window.ACS_RouteTechData?.distNM);
  if (!Number.isFinite(finalDistanceNM) || finalDistanceNM <= 0) {
    finalDistanceNM = rs_getDistanceNM(origin, destination);
  }

  const isEveryDay = document.getElementById("everyDay")?.checked === true;
  const blockId = isEveryDay ? ("BLOCK_" + Date.now()) : null;

  /* ================================
   INSERT NEW FLIGHTS (WITH CONFLICT CHECK)
   ================================ */

  let current = JSON.parse(localStorage.getItem("scheduleItems") || "[]");
  const newItems = [];

  days.forEach(day => {

    const depAbsMin = depH * 60 + depM;
    const arrAbsMin = arrivalTotalMin % (24 * 60);

    // üî• CHECK CONFLICT
    const conflict = RS_hasAircraftConflict(
      current,
      selectedAircraftId,
      day,
      depAbsMin,
      arrAbsMin
    );

    if (conflict) {
      alert(`‚õî Aircraft conflict detected on ${day.toUpperCase()}.\nThis aircraft already has a flight in this time window.`);
      window.__ACS_CONFIRM_RUNNING = false;
      throw new Error("Aircraft conflict");
    }

    const flight = {
      type: "flight",
      id: `RT_${Date.now()}_${day}`,
      blockId: blockId,

      aircraftId: selectedAircraftId,
      aircraft: modelKey,

      origin,
      destination,

      departure,
      arrival,
      depAbsMin,
      arrAbsMin,

      flightNumberOut,
      flightNumberIn,

      distance: finalDistanceNM,
      blockTime: blockTimeMin,

      day: day,
      status: "scheduled"
    };

    newItems.push(flight);
  });

  const updated = current.concat(newItems);
  localStorage.setItem("scheduleItems", JSON.stringify(updated));

  window.__ACS_CONFIRM_RUNNING = false;

  // üîÅ volver a tabla
  window.location.href = "schedule_table.html";
}

/* ============================================================
   üü® C3 ‚Äî CONFIRM ROUTE EDIT (UPDATE IN PLACE REAL) ‚Äî v1
   ------------------------------------------------------------
   REGLAS:
   ‚úÖ NO borrar rutas
   ‚úÖ NO recrear rutas completas
   ‚úÖ Modificar vuelos existentes
   ‚úÖ Mantener flight numbers
   ============================================================ */

function confirmRouteEdit() {

  const ctx = window.__RS_EDIT_CTX;
  if (!ctx) {
    console.error("‚ùå EDIT MODE without context");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  /* ================================
     1) Leer formulario
     ================================ */

  const origin      = (document.getElementById("origin")?.value || "").trim();
  const destination = (document.getElementById("destination")?.value || "").trim();
  const departure   = (document.getElementById("departureTime")?.value || "").trim();
  const aircraftId  = document.getElementById("aircraft")?.value || "";

  if (!origin || !destination || !departure || !aircraftId) {
    alert("‚ö†Ô∏è Please complete all fields before updating.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  const rawFN = document.getElementById("flightNumber")?.value?.trim() || "";
  const match = rawFN.match(/^([A-Z]{2}\d+)\s*‚ûú\s*([A-Z]{2}\d+)$/);
  if (!match) {
    alert("‚õî Invalid flight number.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  const flightNumberOut = match[1];
  const flightNumberIn  = match[2];

  const blockTimeMin = parseInt((window.ACS_RouteTechData?.blockMin ?? ""), 10);
  if (!Number.isFinite(blockTimeMin) || blockTimeMin <= 0) {
    alert("‚õî Block time invalid. Please recalculate route.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  /* ================================
     Days nuevos
     ================================ */

  const DAY_IDS = ["mon","tue","wed","thu","fri","sat","sun"];
  let newDays = DAY_IDS.filter(id => document.getElementById(id)?.checked);

  if (document.getElementById("everyDay")?.checked) {
    newDays = ["mon","tue","wed","thu","fri","sat","sun"];
  }

  if (!newDays.length) {
    alert("Please select at least one day.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  /* ================================
     Arrival recalculado
     ================================ */

  const [depH, depM] = departure.split(":").map(Number);
  const arrivalTotalMin = depH * 60 + depM + blockTimeMin;
  const arrH = Math.floor(arrivalTotalMin / 60) % 24;
  const arrM = arrivalTotalMin % 60;
  const arrival = `${String(arrH).padStart(2, "0")}:${String(arrM).padStart(2, "0")}`;

  /* ================================
     Cargar tabla actual
     ================================ */

  let list = JSON.parse(localStorage.getItem("scheduleItems") || "[]");

  // Vuelos originales de esta ruta (por routeId o blockId)
  const routeId  = ctx.routeId || ctx.routeKey || null;
  const blockId  = ctx.blockId || null;

  let originalFlights = list.filter(it =>
    (routeId && it.routeId === routeId) ||
    (blockId && it.blockId === blockId)
  );

  if (!originalFlights.length) {
    alert("‚ùå Original route not found in schedule.");
    window.__ACS_CONFIRM_RUNNING = false;
    return;
  }

  /* ================================
   Construir nueva versi√≥n de vuelos (WITH CONFLICT CHECK)
   ================================ */

  const updatedFlights = [];
  const ignoreIds = originalFlights.map(f => f.id);

  newDays.forEach(day => {

    const depAbsMin = depH * 60 + depM;
    const arrAbsMin = arrivalTotalMin % (24 * 60);

    // üî• CHECK CONFLICT (ignora los propios vuelos)
    const conflict = RS_hasAircraftConflict(
      list,
      aircraftId,
      day,
      depAbsMin,
      arrAbsMin,
      ignoreIds
    );

    if (conflict) {
      alert(`‚õî Aircraft conflict detected on ${day.toUpperCase()}.\nThis aircraft already has a flight in this time window.`);
      window.__ACS_CONFIRM_RUNNING = false;
      throw new Error("Aircraft conflict");
    }

    // Buscar vuelo existente para ese d√≠a
    let old = originalFlights.find(f => f.day === day);

    if (old) {
      // ‚úèÔ∏è UPDATE IN PLACE
      old.origin      = origin;
      old.destination = destination;
      old.departure   = departure;
      old.arrival     = arrival;
      old.depAbsMin   = depAbsMin;
      old.arrAbsMin   = arrAbsMin;
      old.aircraftId  = aircraftId;
      old.flightNumberOut = flightNumberOut;
      old.flightNumberIn  = flightNumberIn;
      old.blockTime   = blockTimeMin;
      old.status      = "scheduled";

      updatedFlights.push(old);
    } else {
      // ‚ûï NUEVO d√≠a agregado
      const base = originalFlights[0];

      const newFlight = {
        ...base,
        id: `${base.id}_EXT_${day}`,
        day: day,
        departure,
        arrival,
        depAbsMin,
        arrAbsMin,
        aircraftId,
        flightNumberOut,
        flightNumberIn,
        blockTime: blockTimeMin,
        status: "scheduled"
      };

      updatedFlights.push(newFlight);
    }
  });

  /* ================================
     Eliminar d√≠as quitados
     ================================ */

  const keptIds = updatedFlights.map(f => f.id);

  list = list.filter(it => {
    if (
      (routeId && it.routeId === routeId) ||
      (blockId && it.blockId === blockId)
    ) {
      return keptIds.includes(it.id);
    }
    return true;
  });

  /* ================================
     Guardar nueva tabla
     ================================ */

  const finalList = list.concat(updatedFlights);
  localStorage.setItem("scheduleItems", JSON.stringify(finalList));

  // limpiar edit context
  localStorage.removeItem("ACS_ROUTE_EDIT");

  window.__ACS_CONFIRM_RUNNING = false;

  /* ================================
     CHIP + REDIRECT
     ================================ */

  showEditSuccessChip();
}

/* ============================================================
   üü¢ C4 ‚Äî CHIP ‚ÄúEDIT SUCCESSFULLY‚Äù + REDIRECT
   ============================================================ */

function showEditSuccessChip() {

  const chip = document.createElement("div");
  chip.textContent = "‚úÖ Edit successfully";
  chip.style.position = "fixed";
  chip.style.top = "120px";
  chip.style.left = "50%";
  chip.style.transform = "translateX(-50%)";
  chip.style.padding = "10px 22px";
  chip.style.background = "linear-gradient(135deg,#00ff80,#00a86b)";
  chip.style.color = "#081530";
  chip.style.fontWeight = "700";
  chip.style.borderRadius = "14px";
  chip.style.boxShadow = "0 0 22px rgba(0,255,128,0.6)";
  chip.style.zIndex = "9999";

  document.body.appendChild(chip);

  setTimeout(() => {
    chip.remove();
    window.location.href = "schedule_table.html";
  }, 750);
}

/* ============================================================
   üü¶ C5 ‚Äî BUTTON BIND √öNICO
   ============================================================ */

document.addEventListener("DOMContentLoaded", () => {

  const btn = document.querySelector(".acs-btn");
  if (!btn) {
    console.warn("‚ö† Confirm Route button not found");
    return;
  }

  btn.onclick = null;
  btn.addEventListener("click", e => {
    e.preventDefault();
    confirmRoute();
  });

  console.log("üü¢ Confirm Route bound (CREATE / EDIT router active)");
});

</script>

<!-- ===========================================================
     üü¶ ACS SCRIPT ORDER ‚Äî ROUTE SCHEDULE (FINAL v1.0)
     -----------------------------------------------------------
     ESTE ORDEN ES OBLIGATORIO PARA QUE LOS 4000+ AEROPUERTOS
     SE CARGUEN SIN ERRORES. NO CAMBIARLO NUNCA.
     =========================================================== -->

<!-- 1) ENGINE BASES -->
<!-- ============================================================
     ‚è≥ ACS TIME ENGINE V12 ‚Äî 24/7 RECOVERY LAYER
     ============================================================ -->
<script src="acs_time_recovery.js"></script>
<script src="time_engine.js"></script>

<script src="./engine/acs_crew_engine.js"></script>
<script src="./engine/acs_finance.js"></script>

<!-- 1.4) SLOT ENGINE ‚Äî necesita time_engine y antes del loader -->
<script src="./engine/acs_slots_engine.js?v=2.0"></script>

<!-- ===========================================================
     2) AIRPORT LOADER ‚Äî CREA WorldAirportsACS
     Debe cargarse ANTES que los continent scripts
     =========================================================== -->
<script src="engine/airports_loader.js?v=1.0"></script>

<!-- ===========================================================
     3) WORLD ENGINE ‚Äî USA los datos cargados por el loader
     Genera √≠ndices ICAO/IATA, filtros hist√≥ricos, etc.
     =========================================================== -->
<script src="engine/acs_world_engine.js?v=1.0"></script>

<!-- ===========================================================
     4) CONTINENTS ‚Äî AHORA S√ç
     Estos archivos dependen de que WorldAirportsACS YA exista.
     =========================================================== -->
<script src="engine/airports/world_airports_na.js?v=1.0"></script>
<script src="engine/airports/world_airports_sa.js?v=1.0"></script>
<script src="engine/airports/world_airports_eu.js?v=1.0"></script>
<script src="engine/airports/world_airports_me.js?v=1.0"></script>
<script src="engine/airports/world_airports_af.js?v=1.0"></script>
<script src="engine/airports/world_airports_as.js?v=1.0"></script>
<script src="engine/airports/world_airports_oc.js?v=1.0"></script>

<script>
     
document.addEventListener("DOMContentLoaded", () => {
  if (typeof registerTimeListener === "function") {
    registerTimeListener(updateClockDisplay);
    updateClockDisplay();
  }
});
     
</script>
     
<script>
     
/* ============================================================
   üü¶ KEEP ORIGIN & DESTINATION AFTER REFRESH ‚Äî FIX v2
   ============================================================ */

// ‚õî YA NO guardamos destination ‚Äî solo origin
function persistOriginDest() {
    const O = document.getElementById("origin")?.value || "";
    localStorage.setItem("ACS_Route_LastOrigin", O);
}

// Restaurar ORIGIN al cargar, pero NO DESTINATION
document.addEventListener("DOMContentLoaded", () => {
    const storedO = localStorage.getItem("ACS_Route_LastOrigin") || "";
    if (storedO) document.getElementById("origin").value = storedO;
});

// Solo escuchar cambios de ORIGIN
document.getElementById("origin")?.addEventListener("input", persistOriginDest);
document.getElementById("origin")?.addEventListener("change", persistOriginDest);


</script> 
              
</body>
</html>
